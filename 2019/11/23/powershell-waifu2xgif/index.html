<!doctype html><html lang="zh-Hans"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no" name="viewport"><meta content="webkit" name="renderer"><meta content="webkit" name="force-rendering"><meta content="✨小透明・宸✨" name="author"><meta content="" name="keywords"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon shortcut" type="image/ico"><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon"><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="apple-touch-icon"><link href="/atom.xml" rel="alternate" type="application/atom+xml"><title>使用 waifu2x-caffe 和 ImageMagick 放大 GIF 动图 | 存在感消失的地方|ω•`)</title><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":"https://akarin.dev","headline":"使用 waifu2x-caffe 和 ImageMagick 放大 GIF 动图","datePublished":"2019-11-23T03:28:42.000Z","dateModified":"2019-11-23T03:28:42.000Z","author":{"@type":"Person","name":"✨小透明・宸✨","image":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"},"description":"身处寒夜 把握星光✨"},"publisher":{"@type":"Organization","name":"存在感消失的地方|ω•`)","logo":"https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png"},"keywords":"","description":"表情包高清重制工具ꉂ(ˊᗜˋ*)"}</script><script>/MSIE|Trident/.test(navigator.userAgent)&&(location.href="../../../../upgrade-browser.html")</script><script>window.switchDark=t=>{const a={auto:"mdui-theme-layout-auto",enable:"mdui-theme-layout-dark",disable:""};(t=t||localStorage.getItem("dark"))in a||(t="auto");for(const e in a)a[e]&&document.body.classList[e===t?"add":"remove"](a[e]);localStorage.setItem("dark",t)},addEventListener("DOMContentLoaded",()=>switchDark());</script><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/css/mdui.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/combine/npm/aplayer@1/dist/APlayer.min.css,npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css,npm/prism-themes@1/themes/prism-vsc-dark-plus.min.css,gh/TransparentLC/transparentlc.github.io/css/style.min.css" rel="stylesheet"><style>*{--sidebar-image:url(https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/sidebar_header.jpg);--sidebar-image-color:#958981;--banner-image:url(https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/daily_pic.png);--banner-image-color:#f09ea3;--post-thumbnail-color:#f09ea3;--copy-code-btn-color:#fff}</style><meta content="Hexo 5.4.0" name="generator"></head><body class="mdui-drawer-body-left mdui-theme-accent-pink mdui-theme-primary-pink"><button class="mdui-fab mdui-m-a-2 mdui-shadow-0 mdui-text-color-grey-700" mdui-drawer="{target:'#akarin-drawer'}" style="position:fixed;z-index:1"><i class="material-icons mdui-icon">menu</i></button><nav class="mdui-drawer mdui-drawer-full-height mdui-shadow-6" id="akarin-drawer"><div class="akarin-util-bg-cover mdui-p-x-2" id="akarin-drawer-media"><img src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg" class="akarin-hover-spin mdui-img-circle mdui-m-t-4" id="akarin-drawer-avatar"><div class="akarin-util-text-gradient mdui-card-media-covered"><div class="mdui-card-primary"><div class="mdui-typo-subheading">✨小透明・宸✨</div><div class="akarin-util-opacity-half mdui-typo-caption">存在感消失的地方|ω•`)</div></div></div></div><div class="mdui-list" mdui-collapse><div><a href="../../../../" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">home</i> <span class="mdui-list-item-content">主页</span></a></div><div><a href="../../../../about" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">person</i> <span class="mdui-list-item-content">关于</span></a></div><div><a href="../../../../friend" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">link</i> <span class="mdui-list-item-content">友链</span></a></div><div><a href="https://github.com/TransparentLC" target="_blank" rel="noopener" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">code</i> <span class="mdui-list-item-content">GitHub</span></a></div><div><a href="../../../../archives" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">collections_bookmark</i> <span class="mdui-list-item-content">归档</span> <small class="akarin-drawer-badge mdui-color-theme-accent">29</small></a></div><div><a href="../../../../atom.xml" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">rss_feed</i> <span class="mdui-list-item-content">RSS</span></a></div><div class="mdui-divider"></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">brightness_4</i> <span class="mdui-list-item-content">深色模式</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item" data-dark="auto"><span class="mdui-list-item-content">根据系统主题切换</span></div><div class="mdui-ripple mdui-list-item" data-dark="enable"><span class="mdui-list-item-content">启用</span></div><div class="mdui-ripple mdui-list-item" data-dark="disable"><span class="mdui-list-item-content">禁用</span></div></div></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">insert_chart</i> <span class="mdui-list-item-content">访问统计</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_pv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访客数</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_uv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">页面访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_page_pv">Loading</small></div></div></div></div></nav><picture id="akarin-top" title="返回顶部"><source srcset="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.avif" type="image/avif"><source srcset="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.webp" type="image/webp"><img src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.png"></picture><div style="padding-top:20px"></div><div class="mdui-hidden-sm-down" style="padding-top:40px"></div><div class="mdui-hidden-md-down" style="padding-top:40px"></div><main class="mdui-container" style="max-width:1024px"><div class="akarin-util-rounded-5 mdui-card mdui-shadow-4"><div class="mdui-ripple akarin-post-bg akarin-util-bg-cover" data-src="https://ae01.alicdn.com/kf/Ha99f59e5b664445dbade3c83cec5543bQ.jpg" data-src-avif="https://bj.bcebos.com/im-cs/afe114e1903de5ad737122b2bd4d2647.avif" data-src-webp="https://ae01.alicdn.com/kf/H493c33c82b144df7aab33e423f7a3522h.jpg"><div class="akarin-util-bg-cover akarin-post-bg akarin-blurred-cover" style="background-image:url(data:image/jpeg;base64,/9j/4AAQSkZJRgABAQIAJQAlAAD/2wCEAAUFBQUFBQUGBgUICAcICAsKCQkKCxEMDQwNDBEaEBMQEBMQGhcbFhUWGxcpIBwcICkvJyUnLzkzMzlHREddXX0BBQUFBQUFBQYGBQgIBwgICwoJCQoLEQwNDA0MERoQExAQExAaFxsWFRYbFykgHBwgKS8nJScvOTMzOUdER11dff/CABEIAEAAQAMBIgACEQEDEQH/xAAzAAACAgMBAQAAAAAAAAAAAAAFBgQHAAIDAQgBAAMBAQEAAAAAAAAAAAAAAAEDBAUCAP/aAAwDAQACEAMQAAAA+yxJZDndsxLGTUtvsbW6QhLCkiMDkoANdOiu9ItVWbZK6U7z1VnYgcnGV7P0JrOD4WIr9tr4RTsXG/UZcPGQMKMPDmYYqsUbza0Wr+qVt4WzRYQyf//EACIQAAIDAAIDAQADAQAAAAAAAAIDAQQFBhEAEhMhBxQzI//aAAgBAQABDADy/YYJEEfgRoKOq86yRZNXSl9cDjqSi4zo+xjsbpe0dj2K7ftP6MdxMT4RwAx3PnI32HHVRWiS8DjKsgNGxTeyW4+8DBXBokHE4I6YDp7YxQT2bv2WDMATHftN8MH2gpmLMx6REzMeHVRY/wBIKJ2+RbNC1WW6BlCMgH00QDfnaK3q5V346KRhIuqMkRk/QhUEBER33TEBMvWCgbkMnqQnwxfJyUmURyTGbq69JIMECXbhSpkU/wDYX1NcbVQp7kLtzMtFRdHvFDQRqCEIM67qI2CkZd376F9yrZpj5ivYuvckycTSSyyGjVoWUSYO076E1zeyY9Y/kdMbdZ1WrJ1uRj/eXUYj3aVO3Qp2W2uy+GdYVZUl4SXrv3aQ7FdDf000ETSfnOpXLCate+xW0qysQnkOS3T4wP1Z6G/DBCz+ao8Db2KSRpovtWvP1Du4jLejchlnitgn5lNrAiY0MK3X2D1KoJeYHotQxlikKGRX9TKw0ogtjaoqr2EH2mZsqvUZtVxMAz8ydKzLeu63J676WchFelEzwTlFLYqU6bpXW0WL9ojoYmYrQMfi4818bSv/ADGrorqqz+JoRaC7fOLlrdxS2M5tYPQG8pzdfj9PNzo/y/j56NjHu415f1PlvAL9MhvZf0kP/8QAKRAAAgEDAwQBBAMBAAAAAAAAAQIRAAMhEjFBBBNRYTIicYGxEDNS0f/aAAgBAQANPwCgM+WpIPxGxODQjVIoLIJEA0eYgCBXMD+eouhGiJAOQ4mPjFdXGu2WJti5GdAOQCagh45IwcUcKQuoCBMVpDwBMasTFOSNgCdP/IqBEiK4xOaSGW6AZRhyKt9ave0CGjhjPFKmsPEiWNXcC8mbbRz5U0AAV40+jzWqVgTzuTmiRvvQj7b1IZdlEARH2p1UPOzKckH1irJ7bqcTFBQ2hhBE7H8Uc2J8rMrSAfTus0c+BSpqlgZPsVOkNhVE/eK6Zhbuf7Ups2fNW0DMwMSCJB9g1bfRduzuhwYFEi4j2jmGYEMCavIHIAibnlP3VyCsmSAaZbQVAfqZgZiOQavdR3jZvIWAcmYVuFpe0yhDOIMx7Aq2NL9s4e3OKEtHnGRQbXZYH4xxmlvFH7kKY3BnEiiB2yDgrtNO6MA8B1IEQCeKALC2L8q54mBsauBNWcLo2gUgLQwgXEG+gA5jeKaQhdCklNiJ4Na5W2V3aM5PFX9asWT6QqYMA4M106C2bHxDquA1v1Uc1M0BLp2dZduMyIFJ8GZYS37VTOag9pjsD+OKFiLnU2ZBuMOCeIFdHcldeTou5BBq24dXT+y0RmcfsV//xAAgEQEAAgMAAgIDAAAAAAAAAAABAhEAAyESMQRRQWFx/9oACAECAQE/APkszWEWlazVeiVeT4vvL/eDkqfZmstkPTpjGWr12H19ZFvNkJ7duzy2y8CVAZo49vpb/TmLGYlfjAI8yMCDJjfW0wJEiijI0GLef//EACIRAAICAQQCAwEAAAAAAAAAAAECAxEAEhMhMQQiMlFhgf/aAAgBAwEBPwCBQz8jjHQSoWVbo5Q+sYYvXeTldmAx0GItgMreHA0uByPvHBWwe8hqJImEQ1FbtsYK8qLYC6qHN0G5w+Ah22gYBl71HvPKh21JJ9g2k/zGmZwuqiQAAfwYhhCF3k9x8VAyLzgY6HDk1X5kjiVjE/BB4Of/2Q==)"></div><div class="akarin-util-text-gradient akarin-post-title"><div class="mdui-card-primary"><div class="mdui-card-primary-title mdui-text-color-white-text">使用 waifu2x-caffe 和 ImageMagick 放大 GIF 动图</div></div></div></div><div class="mdui-valign mdui-card-header"><div><img src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg" class="akarin-hover-spin mdui-card-header-avatar"><div class="mdui-card-header-title">✨小透明・宸✨</div><div class="mdui-card-header-subtitle">2019-11-23 11:28:42</div></div></div><article class="mdui-p-a-3 mdui-card-content mdui-typo"><link href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" rel="stylesheet" class="aplayer-secondary-style-marker"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/65506510" target="_blank" rel="noopener">Pixiv ID: 65506510 「干物妹!うまるちゃん」 by にゃー</a></p></blockquote><p>因为收集了很多<del>萌萌的</del>动图表情包，然鹅它们的分辨率都太低了，所以就有了将这些表情包高清化的想法(๑‾ ꇴ ‾๑)</p><p>比如下面的这只小埋，分辨率就只有 176x180……</p><img data-src="https://ae01.alicdn.com/kf/U1808e810afb9470f934d2b985e7c9dbfV.gif" data-src-webp="https://ae01.alicdn.com/kf/H455654f7eda74c0ca13a5cc4100a06ben.jpg"><p>放大动漫图片一般都是使用 waifu2x 算法，因为自己有 N 卡所以会使用 N 卡专用的 <a href="https://github.com/lltcggie/waifu2x-caffe" target="_blank" rel="noopener">waifu2x-caffe</a>，虽然能把 GIF 拖进去但是放大后的图片会变成<strong>只有第一帧的静态图片</strong>，所以就需要别的方法了。</p><p>在 Google 上找了一下，找到了<a href="https://nichijou.date/archives/6/gif2x.html" target="_blank" rel="noopener">这篇文章</a>，尝试用 [ImageMagick] 把 GIF 的每一帧拆出来，使用 waifu2x 放大每一张图以后再拼回去，倒是个不错的想法（我好像用类似的方法，不过是用来放大视频 233）</p><p>因为步骤还是有些繁琐，所以原文也写了若干个 <strong>Bash 脚本</strong>来自动完成使用 ImageMagick 拆图和生成 GIF 的步骤，不过 waifu2x-caffe 明明是 Windows 上的软件，难道作者是想着把图片从 Linux 复制到 Windows 里面，放大以后再拼回去？还是有点麻烦，所以就打算自己写个 PowerShell 脚本，自动在 Windows 系统内直接完成所有操作∠( ᐛ 」∠)_</p><p>在写脚本之前，首先需要准备两个软件：</p><ol><li><a href="https://github.com/lltcggie/waifu2x-caffe/releases" target="_blank" rel="noopener">waifu2x-caffe</a></li><li><a href="https://imagemagick.org/script/download.php#windows" target="_blank" rel="noopener">ImageMagick</a></li></ol><p>对于 waifu2x-caffe，<strong>只有 N 卡才可以使用 GPU 加速</strong>，A 或 I 卡用户就只能选择<del>慢如蜗牛</del>的 CPU 计算了，当然也可以另请高明，使用其它调用 waifu2x 算法的软件～</p><p>N 卡用户还可以考虑开启 cuDNN 继续提速，只需要找一个 <a href="https://alilin-my.sharepoint.com/personal/ebolyhgj_xlu_me/_layouts/15/download.aspx?share=EU0iM7-ZePZCm_sBJ2sVU1kBO5HHL5AnkvYnMxR1g4h6hg" target="_blank" rel="noopener"><code>cudnn64_7.dll</code></a> 和 <code>waifu2x-caffe.exe</code> 放在同一个目录就可以了。</p><h1 id="指定路径"><a href="#指定路径" class="headerlink" title="指定路径"></a>指定路径</h1><p>waifu2x-caffe 有图形界面，不过脚本里调用的是它的命令行版程序。先在脚本里指定一些路径：</p><pre class="language-powershell line-numbers" data-language="powershell"><code class="language-powershell"><span class="token comment"># waifu2x-caffe和ImageMagick的程序路径</span>
<span class="token variable">$Waifu2xCUIPath</span> = <span class="token string">'D:\waifu2x-caffe\waifu2x-caffe-cui.exe'</span>
<span class="token variable">$MagickPath</span> = <span class="token string">'D:\ImageMagick-7.0.8-Q16-HDRI\magick.exe'</span>

<span class="token comment"># 将路径转换为绝对路径</span>
<span class="token variable">$InputFile</span> = <span class="token variable">$ExecutionContext</span><span class="token punctuation">.</span>SessionState<span class="token punctuation">.</span>Path<span class="token punctuation">.</span>GetUnresolvedProviderPathFromPSPath<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span>
<span class="token variable">$OutputFile</span> = <span class="token variable">$ExecutionContext</span><span class="token punctuation">.</span>SessionState<span class="token punctuation">.</span>Path<span class="token punctuation">.</span>GetUnresolvedProviderPathFromPSPath<span class="token punctuation">(</span><span class="token variable">$OutputFile</span><span class="token punctuation">)</span>

<span class="token comment"># 指定GIF帧的保存路径</span>
<span class="token variable">$InputDirectory</span> = <span class="token namespace">[IO.Path]</span>::GetDirectoryName<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span>
<span class="token variable">$OutputDirectory</span> = <span class="token namespace">[IO.Path]</span>::GetDirectoryName<span class="token punctuation">(</span><span class="token variable">$OutputFile</span><span class="token punctuation">)</span>
<span class="token variable">$SourceDirectory</span> = <span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\temp_frames_source'</span><span class="token punctuation">)</span>
<span class="token variable">$UpscaledDirectory</span> = <span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\temp_frames_upscaled'</span><span class="token punctuation">)</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="拆分图片"><a href="#拆分图片" class="headerlink" title="拆分图片"></a>拆分图片</h1><p>GIF 图片把帧拆出来不难，但是除了每一帧的图片，还应该把每一帧的时间信息保存下来，否则就没办法把放大后的图片拼回 GIF 了。ImageMagick 的 identify 工具可以获取 GIF 每一帧的时间，还可以使用类似于 <code>printf()</code> 的格式化字符串自定义输出。为了方便起见，这里就直接把输出格式自定义为<strong>后面合成 GIF 时需要的参数</strong>：</p><pre class="language-powershell line-numbers" data-language="powershell"><code class="language-powershell">&amp;<span class="token variable">$MagickPath</span> identify <span class="token operator">-</span>format <span class="token punctuation">(</span><span class="token string">"-delay %T \`""</span> <span class="token operator">+</span> <span class="token variable">$UpscaledDirectory</span><span class="token punctuation">.</span>Replace<span class="token punctuation">(</span><span class="token string">'\'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\\frame-%s.png\`" "</span><span class="token punctuation">)</span> <span class="token variable">$InputFile</span><span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre><p>把上面的小埋丢进来，得到的输出是这样的（已添加换行）：</p><pre class="line-numbers language-plaintext" data-language="plaintext"><code class="language-plaintext">-delay 10 &quot;C:\Users\Admin\Desktop\temp_frames_upscaled\frame-0.png&quot;
-delay 10 &quot;C:\Users\Admin\Desktop\temp_frames_upscaled\frame-1.png&quot;
-delay 10 &quot;C:\Users\Admin\Desktop\temp_frames_upscaled\frame-2.png&quot;
-delay 10 &quot;C:\Users\Admin\Desktop\temp_frames_upscaled\frame-3.png&quot;
...<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从这里也可以看出，原图中的每一帧的时间都是 0.1 秒。可以将这些输出保存到文件中，只要添加管道输出 <code>Out-File ($InputDirectory + &#39;\&#39; + [IO.Path]::GetFileNameWithoutExtension($InputFile) +&#39;.txt&#39;) -Encoding utf8</code> 就可以了。</p><p>然后就是拆图的操作：</p><pre class="language-powershell line-numbers" data-language="powershell"><code class="language-powershell"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token variable">$SourceDirectory</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mkdir <span class="token variable">$SourceDirectory</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
<span class="token punctuation">&#125;</span>
&amp;<span class="token variable">$MagickPath</span> convert <span class="token operator">-</span>coalesce <span class="token variable">$InputFile</span> <span class="token punctuation">(</span><span class="token variable">$SourceDirectory</span> <span class="token operator">+</span> <span class="token string">'\frame.png'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://aotu.io/notes/2018/06/06/ImageMagick_intro/" target="_blank" rel="noopener">《图像处理 - ImageMagick 简单介绍与案例》</a>：</p><p>“-coalesce：根据图像 -dispose 元数据的设置覆盖图像序列中的每个图像，以重现动画序列中每个点的动画效果。下面用一张结果对比图来解释这句话。”</p><img data-src="https://ae01.alicdn.com/kf/H23c66bff65844ca5ab61e84cba6efafdD.jpg" data-src-webp="https://ae01.alicdn.com/kf/H3e62f8d1ec9347eda59e51c0a9032983n.jpg"></blockquote><p>拆完图片以后，就能在 <code>temp_frames_source</code> 文件夹下看到一批 <code>frame-0.png</code>、<code>frame-1.png</code>……了。</p><img data-src="https://ae01.alicdn.com/kf/U7e809dbecb0041269982ca870c89569bG.png" data-src-webp="https://ae01.alicdn.com/kf/H093c6638846749cd9ef8de545ed18439y.jpg"><h1 id="使用-waifu2x-放大"><a href="#使用-waifu2x-放大" class="headerlink" title="使用 waifu2x 放大"></a>使用 waifu2x 放大</h1><p>waifu2x-caffe 支持将一整个文件夹输入，放大文件夹中的所有图片，所以这一步其实还是挺简单的？</p><pre class="language-powershell line-numbers" data-language="powershell"><code class="language-powershell">&amp;<span class="token variable">$Waifu2xCUIPath</span> <span class="token operator">-</span>i <span class="token variable">$SourceDirectory</span> <span class="token operator">-</span>o <span class="token variable">$UpscaledDirectory</span> <span class="token operator">-</span>y cunet <span class="token operator">-</span>m noise_scale <span class="token operator">-</span>s 2 <span class="token operator">-</span>n 3 <span class="token operator">-</span>p cudnn <span class="token operator">-</span>b 8 <span class="token operator">-</span>t 1 <span class="token operator">--</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span><span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre><p>上面这个是我习惯使用的配置：3 级降噪、CUnet 模型、放大 2 倍、使用 cuDNN 和 TTA 模式。如果要修改的话，可以参考 <a href="https://github.com/lltcggie/waifu2x-caffe#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E5%85%B1%E9%80%9A" target="_blank" rel="noopener">README.md</a> 里面的命令行参数说明～（请自备 Google 翻译）</p><p>这一步执行之后，在 <code>temp_frames_upscaled</code> 文件夹中也会出现放大后的每一帧的图片。</p><h1 id="合成-GIF"><a href="#合成-GIF" class="headerlink" title="合成 GIF"></a>合成 GIF</h1><p>使用 ImageMagick 从帧序列合成 GIF 的命令是 <code>magick -dispose previous -delay 10 frame-0.png -delay 10 frame-1.png ... -delay 10 frame-X.png output.gif</code>，可以通过拼接字符串来生成这些命令行参数：</p><pre class="language-powershell line-numbers" data-language="powershell"><code class="language-powershell"><span class="token variable">$Params</span> = <span class="token string">'-dispose previous '</span>
<span class="token variable">$Params</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token namespace">[IO.File]</span>::ReadAllText<span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\'</span> <span class="token operator">+</span> <span class="token namespace">[IO.Path]</span>::GetFileNameWithoutExtension<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Replace<span class="token punctuation">(</span><span class="token string">"`r`n"</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span>
<span class="token variable">$Params</span> <span class="token operator">+=</span> <span class="token string">'"'</span> <span class="token operator">+</span> <span class="token variable">$OutputFile</span> <span class="token operator">+</span> <span class="token string">'"'</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token variable">$OutputDirectory</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mkdir <span class="token variable">$OutputDirectory</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
<span class="token punctuation">&#125;</span>
<span class="token function">Start-Process</span> <span class="token operator">-</span>FilePath <span class="token variable">$MagickPath</span> <span class="token operator">-</span>ArgumentList <span class="token variable">$Params</span> <span class="token operator">-</span>NoNewWindow <span class="token operator">-</span>Wait<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中，帧序列的参数之前已经通过格式化输出保存到了文件中，在这里直接读取就可以了。</p><h1 id="完整脚本"><a href="#完整脚本" class="headerlink" title="完整脚本"></a>完整脚本</h1><pre class="language-powershell line-numbers" data-language="powershell"><code class="language-powershell"><span class="token keyword">function</span> Invoke<span class="token operator">-</span>Waifu2xGIF<span class="token punctuation">(</span><span class="token namespace">[String]</span><span class="token variable">$InputFile</span><span class="token punctuation">,</span> <span class="token namespace">[String]</span><span class="token variable">$OutputFile</span><span class="token punctuation">,</span> <span class="token namespace">[Float]</span><span class="token variable">$Scale</span> = 2<span class="token punctuation">,</span> <span class="token namespace">[Switch]</span><span class="token variable">$TTA</span> = <span class="token boolean">$false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$Waifu2xCUIPath</span> = <span class="token string">'D:\waifu2x-caffe\waifu2x-caffe-cui.exe'</span>
    <span class="token variable">$MagickPath</span> = <span class="token string">'D:\ImageMagick-7.0.8-Q16-HDRI\magick.exe'</span>

    <span class="token variable">$InputFile</span> = <span class="token variable">$ExecutionContext</span><span class="token punctuation">.</span>SessionState<span class="token punctuation">.</span>Path<span class="token punctuation">.</span>GetUnresolvedProviderPathFromPSPath<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span>
    <span class="token variable">$OutputFile</span> = <span class="token variable">$ExecutionContext</span><span class="token punctuation">.</span>SessionState<span class="token punctuation">.</span>Path<span class="token punctuation">.</span>GetUnresolvedProviderPathFromPSPath<span class="token punctuation">(</span><span class="token variable">$OutputFile</span><span class="token punctuation">)</span>

    <span class="token variable">$InputDirectory</span> = <span class="token namespace">[IO.Path]</span>::GetDirectoryName<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span>
    <span class="token variable">$OutputDirectory</span> = <span class="token namespace">[IO.Path]</span>::GetDirectoryName<span class="token punctuation">(</span><span class="token variable">$OutputFile</span><span class="token punctuation">)</span>
    <span class="token variable">$SourceDirectory</span> = <span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\temp_frames_source'</span><span class="token punctuation">)</span>
    <span class="token variable">$UpscaledDirectory</span> = <span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\temp_frames_upscaled'</span><span class="token punctuation">)</span>

    &amp;<span class="token variable">$MagickPath</span> identify <span class="token operator">-</span>format <span class="token punctuation">(</span><span class="token string">"-delay %T \`""</span> <span class="token operator">+</span> <span class="token variable">$UpscaledDirectory</span><span class="token punctuation">.</span>Replace<span class="token punctuation">(</span><span class="token string">'\'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\\frame-%s.png\`" "</span><span class="token punctuation">)</span> <span class="token variable">$InputFile</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\'</span> <span class="token operator">+</span> <span class="token namespace">[IO.Path]</span>::GetFileNameWithoutExtension<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'.txt'</span><span class="token punctuation">)</span> <span class="token operator">-</span>Encoding utf8
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token variable">$SourceDirectory</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mkdir <span class="token variable">$SourceDirectory</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token punctuation">&#125;</span>
    &amp;<span class="token variable">$MagickPath</span> convert <span class="token operator">-</span>coalesce <span class="token variable">$InputFile</span> <span class="token punctuation">(</span><span class="token variable">$SourceDirectory</span> <span class="token operator">+</span> <span class="token string">'\frame.png'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

    &amp;<span class="token variable">$Waifu2xCUIPath</span> <span class="token operator">-</span>i <span class="token variable">$SourceDirectory</span> <span class="token operator">-</span>o <span class="token variable">$UpscaledDirectory</span> <span class="token operator">-</span>y cunet <span class="token operator">-</span>m noise_scale <span class="token operator">-</span>s <span class="token variable">$Scale</span> <span class="token operator">-</span>n 3 <span class="token operator">-</span>p cudnn <span class="token operator">-</span>b 8 <span class="token operator">-</span>t <span class="token punctuation">(</span><span class="token namespace">[Int32]</span><span class="token namespace">[Bool]</span><span class="token variable">$TTA</span><span class="token punctuation">)</span> <span class="token operator">--</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

    <span class="token variable">$Params</span> = <span class="token string">'-dispose previous '</span>
    <span class="token variable">$Params</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token namespace">[IO.File]</span>::ReadAllText<span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\'</span> <span class="token operator">+</span> <span class="token namespace">[IO.Path]</span>::GetFileNameWithoutExtension<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Replace<span class="token punctuation">(</span><span class="token string">"`r`n"</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token variable">$Params</span> <span class="token operator">+=</span> <span class="token string">'"'</span> <span class="token operator">+</span> <span class="token variable">$OutputFile</span> <span class="token operator">+</span> <span class="token string">'"'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token variable">$OutputDirectory</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mkdir <span class="token variable">$OutputDirectory</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">Start-Process</span> <span class="token operator">-</span>FilePath <span class="token variable">$MagickPath</span> <span class="token operator">-</span>ArgumentList <span class="token variable">$Params</span> <span class="token operator">-</span>NoNewWindow <span class="token operator">-</span>Wait

    <span class="token function">Remove-Item</span> <span class="token variable">$SourceDirectory</span> <span class="token operator">-</span>Recurse
    <span class="token function">Remove-Item</span> <span class="token variable">$UpscaledDirectory</span> <span class="token operator">-</span>Recurse
    <span class="token function">Remove-Item</span> <span class="token punctuation">(</span><span class="token variable">$InputDirectory</span> <span class="token operator">+</span> <span class="token string">'\'</span> <span class="token operator">+</span> <span class="token namespace">[IO.Path]</span>::GetFileNameWithoutExtension<span class="token punctuation">(</span><span class="token variable">$InputFile</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'.txt'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 调用示例</span>
Invoke<span class="token operator">-</span>Waifu2xGIF <span class="token operator">-</span>InputFile <span class="token string">'input.gif'</span> <span class="token operator">-</span>OutputFile <span class="token string">'output.gif'</span> <span class="token operator">-</span>Scale 2 <span class="token operator">-</span>TTA<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后是放大为原图尺寸 4 倍的小埋：</p><img data-src="https://ae01.alicdn.com/kf/Ub24ed8600a8745e585e89b82966e9ebb5.gif" data-src-webp="https://ae01.alicdn.com/kf/Ha54c7793e9c848669519a7ba6d1ed6255.jpg"><p>因为 GIF 格式过于古老，压缩效率太低，所以图片分辨率变大的话文件大小也会大量增加。可以使用 <a href="https://ezgif.com/optimize" target="_blank" rel="noopener">这个在线小工具</a> 对 GIF 进一步进行各种有损压缩，降低文件大小。</p><p>（为了进一步压缩，上面的动图已经转换成 Animated WebP 了）</p><blockquote class="mdui-m-b-0 mdui-m-x-0 mdui-p-y-1" style="border-left:4px solid rgba(0,0,0,.36)"><strong>本作品采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</strong><br><strong>本文作者：✨小透明・宸✨</strong><br><strong>本文链接：<a href="https://akarin.dev/2019/11/23/powershell-waifu2xgif/">https://akarin.dev/2019/11/23/powershell-waifu2xgif/</a></strong></blockquote></article><div class="mdui-p-a-3 mdui-color-white" id="lv-container" data-id="city" data-uid="MTAyMC80NDUwOC8yMTAzOQ=="><script>(()=>{const e=document.createElement("script");e.src="https://cdn-city.livere.com/js/embed.dist.js",e.async=!0,document.body.appendChild(e)})()</script></div></div><div class="mdui-valign mdui-m-t-2"><a href="../../../../2020/01/10/php-websocket-server/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_left</i> </a><span class="mdui-typo-body-1-opacity mdui-text-left mdui-m-l-1" title="使用 PHP 的 Ratchet 框架搭建 WebSocket 服务端">上一篇</span> <span class="mdui-typo-body-1-opacity mdui-text-center" style="flex-grow:1"></span> <span class="mdui-typo-body-1-opacity mdui-text-right mdui-m-r-1" title="2019 年暨南大学“新生杯”CTF Write-Up">下一篇</span> <a href="../../16/2019-jnu-ctf-writeup/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_right</i></a></div></main><footer class="mdui-container mdui-m-y-5 mdui-typo" style="display:flex;max-width:1024px"><div class="mdui-typo-body-1-opacity mdui-text-left">Copyright © 2021 ✨小透明・宸✨<br>Hosted by <a href="https://github.com/TransparentLC/transparentlc.github.io" target="_blank">Github Pages</a></div><div style="flex-grow:1"></div><div class="mdui-typo-body-1-opacity mdui-text-right">Powered by <a href="https://hexo.io" target="_blank">Hexo</a> <span class="mdui-hidden-xs-down">5.4.0</span><br>Theme - <a href="https://github.com/TransparentLC/hexo-theme-akarin" target="_blank">Akarin</a></div></footer><script src="https://cdn.jsdelivr.net/combine/npm/aplayer@1/dist/APlayer.min.js,gh/TransparentLC/transparentlc.github.io/js/mdui.min.js,npm/medium-zoom@1/dist/medium-zoom.min.js,npm/instant.page@5/instantpage.min.js,gh/TransparentLC/transparentlc.github.io/js/script.min.js"></script><script src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/bsz.min.js" async></script><script>/MicroMessenger/.test(navigator.userAgent)&&(()=>{const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/fuck-wechat.min.js",document.body.appendChild(e)})()</script></body></html>