<!doctype html><html lang="zh-Hans"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no" name="viewport"><meta content="webkit" name="renderer"><meta content="webkit" name="force-rendering"><meta content="✨小透明・宸✨" name="author"><meta content="" name="keywords"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon shortcut" type="image/ico"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="apple-touch-icon"><link href="/atom.xml" rel="alternate" type="application/atom+xml"><title>西方 Project 幡紫龙 C74 版汉化（魔改）记录 | 存在感消失的地方|ω•`)</title><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://akarin.dev/2024/01/19/banshiryuu-modification/"},"headline":"西方 Project 幡紫龙 C74 版汉化（魔改）记录","datePublished":"2024-01-19T15:37:09.000Z","dateModified":"2024-01-19T15:37:09.000Z","author":{"@type":"Person","name":"✨小透明・宸✨","image":{"@type":"ImageObject","url":"https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"},"description":"身处寒夜 把握星光✨"},"publisher":{"@type":"Organization","name":"存在感消失的地方|ω•`)","logo":"https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png"},"keywords":"","description":"因为似乎没有人做过就试试看了…_φ(･ω･` )"}</script><meta content="存在感消失的地方|ω•`)" property="og:site_name"><meta content="西方 Project 幡紫龙 C74 版汉化（魔改）记录" property="og:title"><meta content="因为似乎没有人做过就试试看了…_φ(･ω･` )" property="og:description"><meta content="article" property="og:type"><meta content="https://akarin.dev/2024/01/19/banshiryuu-modification/" property="og:url"><meta content="https://p.sda1.dev/15/993a03b9fcfeb021d6ffc55efe7227ca/GsLNKChO.jpg" property="og:image"><meta content="2024-01-19T15:37:09.000Z" property="article:published_time"><meta content="2024-01-19T15:37:09.000Z" property="article:modified_time"><meta content="✨小透明・宸✨" property="article:author"><script>document.documentMode&&(location.href="../../../../upgrade-browser.html")</script><script>document.addEventListener("WeixinJSBridgeReady",(()=>{const e=document.createElement("script");e.src="https://fastly.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/fuck-wechat.min.js",document.body.appendChild(e)}))</script><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/css/mdui.min.css" rel="stylesheet"><link href="https://gcore.jsdelivr.net/combine/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css,npm/prism-themes@1/themes/prism-vsc-dark-plus.min.css,npm/aplayer@1/dist/APlayer.min.css,gh/TransparentLC/transparentlc.github.io@879beec/css/style.min.css" rel="stylesheet"><style>*{--sidebar-image:url(https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/sidebar_header.jpg);--sidebar-image-color:#958981;--banner-image:url(https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/daily_pic.png);--banner-image-color:#f09ea3;--post-thumbnail-color:#f09ea3;--copy-code-btn-color:#fff}.MathJax[jax=SVG][display=true]{display:block;text-align:center;margin:1em 0}</style><meta content="Hexo 7.3.0" name="generator"></head><body class="mdui-drawer-body-left mdui-theme-accent-pink mdui-theme-primary-pink"><script>window.switchDark=t=>{const a={auto:"mdui-theme-layout-auto",enable:"mdui-theme-layout-dark",disable:""};(t=t||localStorage.getItem("dark"))in a||(t="auto");for(const e in a)a[e]&&document.body.classList[e===t?"add":"remove"](a[e]);localStorage.setItem("dark",t)},switchDark()</script><button class="mdui-fab mdui-m-a-2 mdui-shadow-0 mdui-text-color-grey-700" mdui-drawer="{target:'#akarin-drawer'}" style="position:fixed;z-index:1"><i class="material-icons mdui-icon">menu</i></button><nav class="mdui-drawer mdui-drawer-full-height mdui-shadow-6" id="akarin-drawer"><div class="akarin-util-bg-cover mdui-p-x-2" id="akarin-drawer-media"><img class="akarin-hover-spin mdui-img-circle mdui-m-t-4" src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg" id="akarin-drawer-avatar"><div class="akarin-util-text-gradient mdui-card-media-covered"><div class="mdui-card-primary"><div class="mdui-typo-subheading">✨小透明・宸✨</div><div class="akarin-util-opacity-half mdui-typo-caption">存在感消失的地方|ω•`)</div></div></div></div><div class="mdui-list" mdui-collapse><div><a href="../../../../" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">home</i> <span class="mdui-list-item-content">主页</span></a></div><div><a href="../../../../about/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">person</i> <span class="mdui-list-item-content">关于</span></a></div><div><a href="../../../../friend/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">link</i> <span class="mdui-list-item-content">友链</span></a></div><div><a href="https://github.com/TransparentLC" target="_blank" rel="noopener" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">code</i> <span class="mdui-list-item-content">GitHub</span></a></div><div><a href="https://github.com/TransparentLC.gpg" target="_blank" rel="noopener" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">vpn_key</i> <span class="mdui-list-item-content">PGP 公钥</span></a></div><div><a href="../../../../archives/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">collections_bookmark</i> <span class="mdui-list-item-content">归档</span> <small class="akarin-drawer-badge mdui-color-theme-accent">34</small></a></div><div><a href="../../../../atom.xml" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">rss_feed</i> <span class="mdui-list-item-content">RSS</span></a></div><div class="mdui-divider"></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">brightness_4</i> <span class="mdui-list-item-content">深色模式</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item" data-dark="auto"><span class="mdui-list-item-content">根据系统主题切换</span></div><div class="mdui-ripple mdui-list-item" data-dark="enable"><span class="mdui-list-item-content">启用</span></div><div class="mdui-ripple mdui-list-item" data-dark="disable"><span class="mdui-list-item-content">禁用</span></div></div></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">insert_chart</i> <span class="mdui-list-item-content">访问统计</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_pv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访客数</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_uv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">页面访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_page_pv">Loading</small></div></div></div></div></nav><picture id="akarin-top" title="返回顶部"><source srcset="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.avif" type="image/avif"><source srcset="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.webp" type="image/webp"><img src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.png"></picture><div style="padding-top:20px"></div><div class="mdui-hidden-sm-down" style="padding-top:40px"></div><div class="mdui-hidden-md-down" style="padding-top:40px"></div><main class="mdui-container" style="max-width:1024px"><div class="akarin-util-rounded-5 mdui-card mdui-shadow-4"><div class="mdui-ripple akarin-post-bg akarin-util-bg-cover" data-src="https://p.sda1.dev/15/993a03b9fcfeb021d6ffc55efe7227ca/GsLNKChO.jpg" data-src-avif="https://p.sda1.dev/15/6ac37a4368062d0135b4dd1fc3cc9cc4/1AHR-Ot2.jpg" data-src-webp="https://p.sda1.dev/15/8650081899fccd4259247727e49b2a5f/IarXc8L4.webp"><div class="akarin-blurred akarin-post-bg akarin-util-bg-cover" style="background-image:url(data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAxAEADASIAAhEBAxEB/8QAHAAAAgMBAQEBAAAAAAAAAAAAAAYEBQcDAQII/8QANBAAAgEDAwEDCwIHAAAAAAAAAQIDAAQRBRIhEwYxURQiIzM1QWFxcnPBFZEyQlJidIKz/8QAGQEAAwEBAQAAAAAAAAAAAAAAAgMEBQAB/8QAKxEAAgIAAwUHBQAAAAAAAAAAAQIAAxESIgQxMjOxBRQhQUJxciNzgZGh/9oADAMBAAIRAxEAPwCv6te9Wqrq171jjGeK057LTq0dWqsSk0zaXaWxt1uJQGbO/wA84QBeMEe+l22pUuZjDrqe1sqDEyDHOgJLZ7uMeNfal5RI+4eaMnJq+u7XT0yoWFZU9J5hJOPBgSeKTbi6WSaR0QIrE4UdwoKb0uBKQ7aXqIVxJvWo61V8bo2/fJtwpI4zk+Fc+rT4nCcLS1ur1nWBNxUZNR/SB2jKkMucg8Y299MPYy4RzfbWB4j9/hmo+o2ovO0V1Ap2gQCRjjuOzjNR95y3WIxGUAEGdjqwMpoZHMiBM7icDFaLZ2dpMkdrfOUiaNQWH8rgg/t3ilTRNOkjIu7kYYjMcfh8TTTYTLcrLMIDL5NNFIFU5MiZwy4qS9+8WgVnSm8ma1VY2fZmNoOa3wVRvl3rVhp1q0EtqfSvwwzuygzh81mmrWotJmwTh2JUY4xT2mqPe21+09jEwtojJE6MwCAHaIz44zmkzVJutYpM44B2Sf2sO5q6jPU6WehtJgaXpsqYEWpq8ZWWEEl9cpBGQC2Tk9wxRd281rcvbyY3rVnoEMttqVqz4Kz2pkUil/WtSSbVrw71IEhXP0DH4qxb895AcZMn9maOLCMOg6a2lXOokyllc4jGBjZ8T4ipm608tmlRfTTKC7cklUwB8hS1pWrXF11klfdtUDNcrW/xqt0hOSykL8xzWfbW+seYXEyvYBWLkawAktlXrjHTq4BNOOgjR/JIhFsFwfWsODwTWbw3KPBA/V525A97HHd+9aN2W0N9NtjPdnNzKgUj+hfCu2WhjmJ4N3vL+1LqsqKDr3jDyjDILEWF5EqqiSRSbiBgkbeSTWb6pY2lpPeWgTEP75UjOcmtTznKkDbtwR7sGsT1kXVnfXNnK2QiGOAscDpseMmqL6nas5TgAQSJDsFqLfqGOZSJH06f9NZLKeVSEQlHY8jn80vaXp0Nzqc0s7B4hI82zuBYniuGt30TXgVGyUQKx+IqRoUpdp3HuAFCtf0s53kSfagiX2hNwOAld2f9bc/bqNH7Zj+8tFFOfjt+EGjmJ9xY09nvaWm/5af9K/QTd6fV+KKKeOXX7HrBu5r/AI6T1e9/n+Kyvt97QtPtfmiivV9XxPSCnGnyExOX1r/UaaOzf8F1/rRRSrOV+oNm9vef/9k)"></div><div class="akarin-util-text-gradient akarin-post-title"><div class="mdui-card-primary"><div class="mdui-card-primary-title mdui-text-color-white-text">西方 Project 幡紫龙 C74 版汉化（魔改）记录</div></div></div></div><div class="mdui-valign mdui-card-header"><div><img class="akarin-hover-spin mdui-card-header-avatar" src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"><div class="mdui-card-header-title">✨小透明・宸✨</div><div class="mdui-card-header-subtitle">2024-01-19 23:37:09</div></div></div><article class="mdui-typo mdui-card-content mdui-p-a-3"><p>西方 Project 是一个弹幕射击类游戏系列，前两作由东京电机大学的学生社团 Amusement Makers 制作，第三作由前 AM 成员组成的“被瞬杀之道？（瞬殺サレ道？）”制作。此系列的三个游戏为秋霜玉、稀翁玉、幡紫龙，是基于在概念上对应 AM 的先辈 ZUN（后来成立了个人社团上海爱丽丝幻乐团）的东方 Project 而制作的作品，而前两作也有 ZUN 的参与制作及东方 Project 的客串出场。</p><p>……嘛，以上的介绍是从 <a href="https://thwiki.cc/%E8%A5%BF%E6%96%B9Project" target="_blank" rel="noopener">THBWiki</a> 复制粘贴过来的。总之在最近通关了东方 Project 所有 Windows 整数作的 Normal 难度之后打算试点新东西，再加上之前也有通关秋霜玉 Normal 的经历，于是就找到了幡紫龙。（也许以后还会试试稀翁玉？）</p><p>不过这一作似乎没有汉化？</p><p>在查找角色设定和剧情的相关资料的时候，偶然看到了在国外的车万论坛 Maidens of the Kaleidoscope 上关于西方各作的英文补丁的<a href="https://www.shrinemaiden.org/forum/index.php?topic=19231.0" target="_blank" rel="noopener">讨论帖</a>，其中有人提到制作英文版的最大阻碍是对游戏数据包的封包，大概也是这么久以来幡紫龙一直没有汉化版的原因之一，另一个原因也许是太冷门了。</p><p>解包工具早就已经有人写出来了，也就是 NamelessLegacy 的 <a href="https://github.com/nmlgc/pbg6ext" target="_blank" rel="noopener">pbg6ext</a>。然后 Clb184 制作了 <a href="https://github.com/Clb184/BSRtk" target="_blank" rel="noopener">BSRtk</a>，可以反编译和编译游戏中的二进制脚本，不过仍然没有实现封包功能。</p><p>于是，从“随便试试看”这样的想法开始，我对幡紫龙的主程序动手了…_φ(･ω･` )</p><p>然后顺便就把汉化做出来了，想要下载的话可以去<a href="https://file.akarin.dev/s/n3tN" target="_blank" rel="noopener">这里</a>。</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1280*960),960px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg" data-src-webp="https://p.sda1.dev/15/7b94453677c912bb809f832d6ee7f569/QwcHiDgy.webp" data-src-avif="https://p.sda1.dev/15/dc97281928aee94018e330e7d3383837/j_4UmP2a.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAcCBgEDBf/EACcQAAICAgEDAgcBAAAAAAAAAAECAxEABBIFMVEHYQYTFCEzQaLh/8QAFgEBAQEAAAAAAAAAAAAAAAAABAMF/8QAIBEAAQQCAgMBAAAAAAAAAAAAAQACERIDITFBExQiUf/aAAwDAQACEQMRAD8AucnWNsbejsmaWOCbYREQ0UKEUa492Jy5hj88U0osC2WSgK9sSCepabEvN+hqxqPgpkACFe5us6S+o22Y5poug80hW3I2e38ZZzAwjeyN7B5SH5BlgEAVkAAdJYwlX1itrYk5Vx+/bz4zRMDw4A1Tcrv2yELuVjCp+T9k1WQ2pGjBQxcqN2G/zLfHhDdXqs4My+xYzW36j6fWjcBZTItA9uJvGV0LQ1k+E+tz8CS0JZSR4sGhhhhol7dnlLY+Q4wAaylvFEihCWRlIug6gjMbDw3S+PY4YYoY2l3aOchX/9k"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg" alt="undefined" title="undefined"></noscript></figure><p>不过，由于我的日语水平大概只有 N95 级别（笑），所以这个汉化版大部分是复制粘贴了 THBWiki 上现有的翻译，<strong>剩余的文本则通过 DeepL 和 ChatGPT <del>和脑补</del>完成翻译</strong>（可能有人会在意这个），略有改动。可能会有不准确的地方……在这里留言指出的话，我会尝试修正的！</p><blockquote><p>汉化是基于 C74 v3.001 版的主程序进行的（SHA-256：<code>07f2033073f1c890dcd25324dcf81778e88e8e0039a1a1d52e4889c17b9b8091</code>）。幡紫龙还有一个更早的 C67 版，不过关卡设计、游戏系统、界面等都有很大的差别，基本上可以当成两个不同的游戏了。我暂时没有汉化 C67 版的打算。</p><p>顺便一提，使用更新补丁时可能会由于编码问题导致无法找到游戏主程序而出错，这种情况下需要把游戏主程序的文件名改为 <code>敠巼棾.exe</code>（用 Shift-JIS 编码的“幡紫竜.exe”按照 GBK 解码的效果）。</p></blockquote><h1 id="PBG6-数据包格式介绍"><a href="#PBG6-数据包格式介绍" class="headerlink" title="PBG6 数据包格式介绍"></a>PBG6 数据包格式介绍</h1><p>幡紫龙使用的数据包，也就是那些扩展名 <code>.ac6</code> 的文件，暂且根据文件头的 magic number 记作 PBG6。</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/743*236),236px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png" data-src-webp="https://p.sda1.dev/15/433a2b4615058b3e3763702709d90f42/SdvSuz1X.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAKACADASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAwIEB//EACMQAAIBAwQBBQAAAAAAAAAAAAECAAMREiEiMUEEMjNDcXP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/xAAYEQEBAQEBAAAAAAAAAAAAAAABAAIRMf/aAAwDAQACEQMRAD8A11GQE6NsbHQRQ/YepYwU+f8AUxR6RHsM6QLPaSNfblUueyYyVs2QK3NwBtPA75ldfdH1B8F3avTyYnYeTD2uF//Z"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png" alt="undefined" title="undefined"></noscript></figure><p>通过阅读 <a href="https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp" target="_blank" rel="noopener">pbg6ext 的代码</a>（当然自己从头分析也不难）可知，整个 PBG6 文件一共由三个部分组成：</p><ul><li>文件头（固定 16 bytes）<ul><li><code>uint8_t[4]</code> 数据包格式的 magic number <code>PBG6</code></li><li><code>uint32_t</code> 目录数据在数据包文件中的位置</li><li><code>uint32_t</code> 目录解密后的大小</li><li><code>uint32_t</code> 目录解密后的 CRC32</li></ul></li><li>加密的各个文件数据</li><li>加密的目录数据</li></ul><p>目录数据的开头是一个 <code>uint32_t</code>，用于记录数据包中包含的文件数量，之后是若干段各个文件的信息，每一段由以下数据组成：</p><ul><li><code>uint8_t[]</code> Shift-JIS 编码的以 <code>0x00</code> 结束的文件名，以根目录的斜杠开始，例如：<code>/foo.bar</code></li><li><code>uint32_t</code> 文件解密前的大小</li><li><code>uint32_t</code> 文件解密后的大小</li><li><code>uint32_t</code> 文件数据在数据包文件中的位置</li><li><code>uint32_t</code> 文件解密后的 CRC32</li></ul><p>知道了 PBG6 的格式，就可以自己写一个简单的封包工具了：</p><pre class="language-python line-numbers" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> zlib

srcPath <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Input ac6 path: '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
ac6Path <span class="token operator">=</span> srcPath <span class="token operator">+</span> <span class="token string">'.ac6'</span>

tocContent <span class="token operator">=</span> <span class="token string">b''</span>
tocCount <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>ac6Path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'PBG6'</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'XXXX'</span><span class="token punctuation">)</span> <span class="token comment"># toc pos</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'XXXX'</span><span class="token punctuation">)</span> <span class="token comment"># toc size</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'XXXX'</span><span class="token punctuation">)</span> <span class="token comment"># toc crc32</span>
    <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>
            srcFile <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>
            ac6File <span class="token operator">=</span> srcFile<span class="token punctuation">.</span>removeprefix<span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>ac6File<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> g<span class="token punctuation">:</span>
                d <span class="token operator">=</span> g<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            tocContent <span class="token operator">+=</span> ac6File<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'shift_jis'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span>
            tocContent <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
            tocContent <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
            tocContent <span class="token operator">+=</span> f<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
            tocContent <span class="token operator">+=</span> zlib<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>d<span class="token punctuation">)</span>
            tocCount <span class="token operator">+=</span> <span class="token number">1</span>
    tocContent <span class="token operator">=</span> tocCount<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token operator">+</span> tocContent
    tocPos <span class="token operator">=</span> f<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>tocContent<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>tocPos<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tocContent<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>zlib<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>tocContent<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>……如果不考虑加密的话。</p><p>之前提过，PBG6 是使用了某种加密（或者说是压缩，这里就不区分了）算法来存储目录和文件数据的，而且该算法似乎不是 Deflate 或 LZ 系列之类的任何一种标准算法。</p><p>pbg6ext 之所以能实现解包，那是因为原作者直接<a href="https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp#L128" target="_blank" rel="noopener">照抄</a>了从幡紫龙主程序反编译出来的解包部分的汇编代码，所以这工具的变量名也都是各种寄存器名称……</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/839*949),949px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png" data-src-webp="https://p.sda1.dev/15/8e24066b20674d69c48add43108a0cbd/1iYDaRWm.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgABwDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIBAwf/xAAjEAACAgEDAwUAAAAAAAAAAAAAAQIRQQMSgRMxQgQiUqGx/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD3SWlGLWVbq0sHTpzfk1wXNKk2r9z/AEuLV0oNcFGr0zzqfQ6D+QBBkktl32k6xkKV+dPgnUlUMVukVpTl22gaAAP/2Q"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png" alt="undefined" title="undefined"></noscript></figure><blockquote><p>Actually, I didn’t write it. I just copied the code from Banshiryuu’s assembly, which is made obvious by the variable names in the decrypt function. I have no clue what this is actually doing or if this is some known algorithm.</p><p>Writing a repacker would be the actually interesting part, but this game is bland anyway.</p><p>——pbg6ext 的 <a href="https://github.com/nmlgc/pbg6ext/blob/master/Readme.txt" target="_blank" rel="noopener">README</a></p></blockquote><p>如果手上只有这堆汇编代码的话，写出对应的压缩代码当然就是十分困难的事情了。显而易见，无法实现压缩的话也就无法实现封包，把汉化过的脚本和图片资源导入游戏什么的完全没办法啊……</p><blockquote><p>… so we still need a hardcore hacker to have the tools which will allow us to extract and repack the game data. :V</p><p>——Maidens of the Kaleidoscope 上的讨论帖<a href="https://www.shrinemaiden.org/forum/index.php?topic=19231.msg1236359#msg1236359" target="_blank" rel="noopener">“SEIHOU Project English Patch Question”</a></p></blockquote><h1 id="对读取数据包的分析和魔改"><a href="#对读取数据包的分析和魔改" class="headerlink" title="对读取数据包的分析和魔改"></a>对读取数据包的分析和魔改</h1><p>翻出 IDA 把主程序拖进去分析。根据 pbg6ext 的那段从汇编转写过来的 C++ 代码，试着搜索对应的汇编代码，在尝试了很多次之后找到了位于 <code>sub_42D8D0</code> 的解密算法：</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png" data-src-webp="https://p.sda1.dev/15/974ef00780ce0e69e6d8c516edb07925/FmGj9hnJ.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAEDBAIFB//EACgQAAIBBAECBAcAAAAAAAAAAAECAAMEESEScZEUYaHRFSIjMTJRVP/EABYBAQEBAAAAAAAAAAAAAAAAAAIBAP/EABsRAAMAAgMAAAAAAAAAAAAAAAABESGRAjFx/9oADAMBAAIRAxEAPwDs9GwerSar4hwN61r0jo2VbYW6bJ/ePaWrWpRW1wzfNvW5LTBDAfbKjyi7qwBcUmnnbF8PuSMG4Pp7RNZXCqWNxoeQ9pZ49e8G/FukE92M1qVXLBipyRjORM1yzDlzXHQwhLSRE/I/0P2gznifrt2hCYp//9k"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png" alt="undefined" title="undefined"></noscript></figure><p>和 pbg6ext 的代码对比一下还是能辨认出来是同一个东西的，当然因为这是反编译的产物所以看上去糟了很多。</p><p>然后，可以通过动态调试下断点看调用栈，或者用 Sysinternals 的 procmon 检查使用 <code>ReadFile</code> 读取 PBG6 的前 16 bytes（也就是文件头）的地方，从而找到 <code>sub_42D2C0</code> 这个读取 PBG6 的函数：</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png" data-src-webp="https://p.sda1.dev/15/9c403551b04393ffd6c6d5e3f860a94a/pcQmvfKQ.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMBBAUH/8QAJRAAAgICAQMDBQAAAAAAAAAAAQIAAxEhBBIUcRNBkSIxVGHR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgEA/8QAGxEBAAICAwAAAAAAAAAAAAAAAAERAjEhUZH/2gAMAwEAAhEDEQA/AOzU8B7aTb3DgYOta8ak1cK8Ehb3Od51/Jb4llK8XDH6t4jKqVsfbYGjo7i3YxjG+fSuz5GMG5vhYNxOSASbGx4WXhSo+7MfJg6KEbHspgqO5Jlpa5IYqckYzkRiMevOXT96hCVKP6z+Q/xIZyVYeux17iEJlf/Z"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png" alt="undefined" title="undefined"></noscript></figure><ul><li><code>v9 != 910639696</code> 这个常数就是用小端序表示的 magic number <code>PBG6</code>，即 <code>0x36474250</code>。</li><li><code>v7 = sub_42DC90((int)v6, v5, dwBytes), (v2 = (void *)v7) != 0</code> 调用了解密算法。</li><li><code>v8 = sub_42DB50(v7, dwBytes, 0), v12 == v8</code> 计算解密后数据的 CRC32，并检查和文件中记录的值是否一致。</li></ul><p>其实一开始只知道 PBG6 使用了校验和，但是不知道具体算法，点进 <code>sub_42DB50</code> 也没能认出来，只是用解包后的文件随便试了一下才发现是 CRC32。不过就算不知道，把校验过程直接去掉也是可以的。</p><p>继续查看 <code>sub_42DC90</code>，可以看到这里分配了一块内存区域用于保存解密后的数据（调用的就是 <code>sub_42D8D0</code>，不过不知道怎么被反编译成了函数指针的样子），解密成功则返回这个区域的地址。</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png" data-src-webp="https://p.sda1.dev/15/057c9b1676cbb7688988d425cfd69292/c7uzRR1J.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAQBAwIFB//EACQQAAEEAQIGAwAAAAAAAAAAAAEAAgMRBBIhFDGBkaHRI1TB/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/8QAGhEBAQACAwAAAAAAAAAAAAAAAAECIRGR4f/aAAwDAQACEQMRAD8A7LDhGSIycS4XdN228KY8SRuoDJf1r0n8SeJuGWE042mWMeRTiKHKk3fiZjJvfdIcLLW+UPA/FkcaWjeSOzfSeUHkVPCmsZK8kOLTZFXYVzZXl273tHRCEiRbrP2H9lDnnSfnd2QhYv/Z"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png" alt="undefined" title="undefined"></noscript></figure><p>暂时先分析到这里。那我是怎么使封包变得可行，从而实现汉化的呢？在给出答案之前，可以试着自己大胆猜想一下。</p><p>可以稍微提示一下……这个汉化是魔改了主程序的，而使封包变得可行的方法在前面的某个地方已经给出线索了。</p><blockquote><p><strong>“……如果不考虑加密的话。”</strong></p></blockquote><p>原来的主程序是从数据包读取加密的数据，解密后再使用。既然我们无法自行实现封包的加密，那把这一层直接去掉不就可以了吗？</p><p>一边是对数据包进行重新封包，保持 PBG6 的格式不变，但是不进行加密的步骤。另一边是修改 <code>sub_42DC90</code> 的代码，把解密操作去掉，改成直接使用数据包中的数据，也就是把这部分改成一个 <code>memcpy</code>。这样就没有什么加密解密的事情了。</p><p><code>sub_42DC90</code> 对应的汇编如下：</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1482*897),897px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png" data-src-webp="https://p.sda1.dev/15/1434dc2f2ed48b31adb5407faa28e618/_FDeJNoy.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAATACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAIDBAEFB//EACMQAAICAQMEAwEAAAAAAAAAAAECAAMhBBGREyIxQRIUYVH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgD/xAAaEQACAgMAAAAAAAAAAAAAAAAAARIhAjFh/9oADAMBAAIRAxEAPwDsq6RDUj9R+/8AfGfUWum0al6VtIVcjJJltCpopAOQc8zFTKuusdz2bDMXdMiKA6e5bihvHJk/0tQE+TWbfhMayypriQ267yw19RQ948SXgq2Mes1aKuwx6k6kr4hCJQ3Uf+jgQNjbHI4EITGP/9k"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png" alt="undefined" title="undefined"></noscript></figure><p>而我的操作就是从 <code>.text:0042DCA8</code> 开始（这部分以上是 <code>if (!v5) return 0;</code>），用汇编的串传送指令（还好当时学的汇编语言没完全还给老师……）实现这个简单的 <code>memcpy</code>，再处理好返回值和栈平衡，剩下的部分用 <code>nop</code> 填充：</p><pre class="language-nasm line-numbers" data-language="nasm"><code class="language-nasm">arg_0 <span class="token operator">=</span> dword ptr <span class="token number">4</span> <span class="token comment">; 解密前数据的地址</span>
arg_4 <span class="token operator">=</span> dword ptr <span class="token number">8</span> <span class="token comment">; 解密前数据的大小</span>
dwBytes <span class="token operator">=</span> dword ptr <span class="token number">0Ch</span> <span class="token comment">; 解密后数据的大小</span>

push <span class="token register variable">ebx</span>
mov  <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">+</span>dwBytes<span class="token operator">]</span>
push <span class="token register variable">esi</span>
push <span class="token register variable">edi</span>
push <span class="token register variable">ebx</span> <span class="token comment">; dwBytes</span>
push <span class="token number">0</span> <span class="token comment">; uFlags</span>
mov  <span class="token register variable">edi</span>, <span class="token register variable">ecx</span>
call <span class="token register variable">ds</span>:<span class="token keyword">GlobalAlloc</span>
mov  <span class="token register variable">esi</span>, <span class="token register variable">eax</span> <span class="token comment">; 此时esi存储的就是v5</span>
test <span class="token register variable">esi</span>, <span class="token register variable">esi</span>
jz   short loc_42DCC6 <span class="token comment">; if (!v5) return 0;</span>
<span class="token comment">; 从这里开始覆盖</span>
<span class="token comment">; 从esi向edi复制ecx字节，通过rep movsb调用</span>
push <span class="token register variable">esi</span>                   <span class="token comment">; 56</span>
mov  <span class="token register variable">edi</span>, <span class="token register variable">esi</span>              <span class="token comment">; 89 F7</span>
mov  <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">010h</span><span class="token operator">+</span>arg_0<span class="token operator">]</span> <span class="token comment">; 8B 74 24 14</span>
mov  <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">010h</span><span class="token operator">+</span>arg_4<span class="token operator">]</span> <span class="token comment">; 8B 4C 24 18</span>
rep  movsb                 <span class="token comment">; F3 A4</span>
pop  <span class="token register variable">esi</span>                   <span class="token comment">; 5E</span>
mov  <span class="token register variable">eax</span>, <span class="token register variable">esi</span>              <span class="token comment">; 89 F0</span>
pop  <span class="token register variable">edi</span>                   <span class="token comment">; 5F</span>
pop  <span class="token register variable">esi</span>                   <span class="token comment">; 5E</span>
pop  <span class="token register variable">ebx</span>                   <span class="token comment">; 5B</span>
retn <span class="token number">0Ch</span>                   <span class="token comment">; C2 0C 00</span>
nop                        <span class="token comment">; 90</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如此修改之后，IDA 也能认出它是 <code>memcpy</code> 了：</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1285*897),897px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png" data-src-webp="https://p.sda1.dev/15/856f5cb1eff39b46dc67a3503794702f/3jvhOwjP.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAWACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAQDBQECB//EACcQAAEDAwEHBQAAAAAAAAAAAAEAAiEDBBESFBUiIzFxkjJBUmGR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAIB/8QAGxEAAgIDAQAAAAAAAAAAAAAAAAERIQIxkXH/2gAMAwEAAhEDEQA/AOyMtHOph+0PwcxgROIhSUrWpIbcvMz6VPbu5VNhE56Y+wVYLW9qCVild9Ft33JAzcH8AQ6xrtBJuI7BMoUx70oq2aoOsgn3TLHOEGo89ihC0G+sfOp5LBfB46nkhCA//9k"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png" alt="undefined" title="undefined"></noscript></figure><p>实际运行测试一下，主程序也能正常读取重新封过的去掉了加密的数据包。这样对于汉化来说最大的阻碍就解决了。</p><h1 id="修改编码和字体"><a href="#修改编码和字体" class="headerlink" title="修改编码和字体"></a>修改编码和字体</h1><p>前面也提过，主程序使用的是 Shift-JIS 编码，汉化的话就需要改成 GBK 编码。创建字体使用的是 <a href="https://learn.microsoft.com/zh-cn/windows/win32/api/wingdi/nf-wingdi-createfonta" target="_blank" rel="noopener"><code>CreateFontA</code></a>，其中参数 <code>DWORD iCharSet</code> 就是用来设定编码的。<code>sub_4257B0</code> 调用了这个函数：</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1208*897),897px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png" data-src-webp="https://p.sda1.dev/15/9773ddbb20ca142eccefe7c5fb992f35/Kx1PkFg2.webp"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgABAQACAwAAAAAAAAAAAAAAAAQBAgMFB//EACYQAAIBAwIGAgMAAAAAAAAAAAECAAMEEUFxEhMhNFGRFFSxwdL/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/xAAdEQACAQQDAAAAAAAAAAAAAAAAARECEiGRMWGx/9oADAMBAAIRAxEAPwD2KnaM6B/kNg56dOk3p2tdWIFycnyR+hLbbt03aVVKSCgjasVibnHiAqFznZOLC7K9wMeRj84g2N0q5NcYG38ytMDI4h7iC3t7FB1VKoVRUycbGcquzHHHrqp03iJppVza/wBhPUwatbhI5yeoiRH/2Q"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png" alt="undefined" title="undefined"></noscript></figure><p>中间的 <code>0x80 (SHIFTJIS_CHARSET)</code> 需要改成 <code>0x86 (GB2312_CHARSET)</code>。由于还没有修改游戏脚本，所以这个时候进入游戏会看到把 Shift-JIS 编码的文本当成 GBK 编码而出现的乱码。</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/640*480),480px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg" data-src-webp="https://p.sda1.dev/15/fa3d3827d331b42389c039f95f72dcdd/6p5Tgmx0.webp" data-src-avif="https://p.sda1.dev/15/ef74850433873e0573027bee07b1c579/5fLB8hWl.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMCBAUH/8QAIxAAAgICAgIBBQAAAAAAAAAAAQIDBAARBRIhIiMTMUFRgf/EABgBAAIDAAAAAAAAAAAAAAAAAAACAQME/8QAIBEAAgIBBAMBAAAAAAAAAAAAAQIAAxEEITFhEjNyUv/aAAwDAQACEQMRAD8A51XMH167zAtF29wG2dfzRxcqV3mndYfjMhMfdjvr+BlcsygnQxnyE78DNmnrDISc8yi52UgDxxznG8DDG3TSBCD4IO9axUrusrEOTknWRkKeuMVFWM7Oz9sL0C1jH6i1MS+5HEWrAEbzb4O/xtPlKk9+sLNVGJkj8HeGGPpRmpvqFoBsU9SXM2qF3lLdrj6pgqs+0i/QzFKPJt1U6wwyNT6x9QpUB2PU/9k"><noscript><img class="mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid" src="https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg" alt="undefined" title="undefined"></noscript></figure><p>有些游戏不仅需要改编码，还会进行<a href="https://github.com/Inori/FuckGalEngine/blob/master/_general_tools/%E8%BE%B9%E7%95%8C%E6%A3%80%E6%B5%8B.txt" target="_blank" rel="noopener">字符边界检查</a>，保证文本数据的每个字节都在 Shift-JIS 的范围内。不过幡紫龙没有添加边界检查。</p><p>另外，原来的无衬线体在这里变成了宋体，这也是因为修改了编码后就无法找到字体了。在这里下断点可以找到使用的字体名称：</p><ul><li><code>.rdata:0046EF88</code> <code>82 6C 82 72 20 82 6F 96 BE 92 A9</code>（Shift-JIS 编码的“ＭＳ Ｐ明朝”）</li><li><code>.rdata:0046EF94</code> <code>82 6C 82 72 20 82 6F 83 53 83 56 83 62 83 4E</code>（Shift-JIS 编码的“ＭＳ Ｐゴシック”）</li><li><code>.rdata:0046EFA4</code> <code>82 6C 82 72 20 96 BE 92 A9</code>（Shift-JIS 编码的“ＭＳ 明朝”）</li><li><code>.rdata:0046EFB0</code> <code>82 6C 82 72 20 83 53 83 56 83 62 83 4E</code>（Shift-JIS 编码的“ＭＳ ゴシック”）</li></ul><p>分别改成 GBK 编码的“宋体” <code>CB CE CC E5</code> 和“黑体” <code>BA DA CC E5</code>。</p><p>类似地，可以通过搜索调用 <code>CreateWindowExA</code> 的地方和断点调试找到窗口标题的位置：<code>.rdata:0046D464</code> <code>94 A6 8E 87 97 B3 20 81 60 82 CE 82 F1 82 B5 82 E8 82 E3 82 A4 81 60</code> （Shift-JIS 编码的“幡紫竜 〜ばんしりゅう〜”），改成 GBK 编码的“幡紫龙” <code>E1 A6 D7 CF C1 FA</code>。</p><p>之后就是修改脚本、改图嵌字之类的和主程序修改无关的琐碎工作了。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/110299012" target="_blank" rel="noopener">Pixiv ID: 110299012 「:p」 by 白河</a></p></blockquote><blockquote class="mdui-m-b-0 mdui-m-x-0 mdui-p-y-1" style="border-left:4px solid rgba(0,0,0,.36)"><strong>本作品采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载，也不允许被自动抓取用于生成式 AI 相关服务。</strong><br><strong>本文作者：✨小透明・宸✨</strong><br><strong>本文链接：<a href="https://akarin.dev/2024/01/19/banshiryuu-modification/">https://akarin.dev/2024/01/19/banshiryuu-modification/</a></strong></blockquote></article><div class="mdui-typo mdui-p-b-3 mdui-p-x-3" style="box-sizing:border-box" id="artalk-container"></div><script>(()=>{const e=document.createElement("link");e.rel="stylesheet",e.href="https://cdn.jsdelivr.net/npm/artalk@2/dist/Artalk.css";const t=document.createElement("style");t.innerHTML=".atk-comment > .atk-main > .atk-body img:not([atk-emoticon]){max-height:160px}"+[["pink","#ff4081","#ff80ab"]].map((([e,t,n])=>`.mdui-theme-accent-${e} .artalk,.mdui-theme-accent-${e} .artalk-layer-wrap,.mdui-theme-accent-${e} .artalk.atk-dark-mode,.mdui-theme-accent-${e} .artalk-layer-wrap.atk-dark-mode{--at-color-main:${t};--at-color-light:${n}}`)).join("");const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/artalk@2/dist/Artalk.js",n.async=!0,n.onload=()=>{Artalk.use((e=>{let t=0;const n={},a=(e,a)=>{const r=`__atk_tex_id_${t++}__`;return n[r]={tex:e,isBlock:a},r},r={name:"blockMath",level:"block",tokenizer:e=>{const t=/^(?:\s{0,3})\$\$((?:[^\n]|\n[^\n])+?)\n{0,1}\$\$/.exec(e);if(t)return{type:"html",raw:t[0],text:a(t[1],!0)}}},o={name:"inlineMath",level:"inline",start:e=>{const t=e.search(/\$.*?\$/);return-1!==t?t:e.length},tokenizer:e=>{const t=/^\$(.*?)\$/.exec(e);if(t)return{type:"html",raw:t[0],text:a(t[1],!1)}}};e.on("mounted",(()=>{e.getMarked().use({extensions:[r,o]}),e.updateConf({markedReplacers:[e=>e=e.replace(/(__atk_tex_id_\d+__)/g,((e,t)=>{const{tex:a,isBlock:r}=n[t];delete n[t];const o=`https://www.zhihu.com/equation?tex=${encodeURIComponent(a)}`;return r?`<p style="text-align:center"><img src="${o}"></p>`:`<img style="vertical-align:middle" src="${o}">`}))]})}))})),Artalk.use((e=>e.on("list-loaded",(()=>e.getCommentNodes().forEach((e=>Array.from(e.getRender().$content.querySelectorAll("img:not([atk-emoticon])")).forEach((e=>{e.classList.add("mdui-img-rounded"),mediumZoom(e,{margin:16,scrollOffset:8,background:"rgba(0,0,0,.85)"})})))))))),Artalk.init({el:"#artalk-container",server:"https://comment.akarin.dev",site:"存在感消失的地方|ω•`)"})},document.head.appendChild(e),document.head.appendChild(t),document.body.appendChild(n)})()</script></div><div class="mdui-valign mdui-m-t-2"><a href="../../../../2025/01/18/migrate-from-livere-to-artalk/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_left</i> </a><span class="mdui-typo-body-1-opacity mdui-text-left mdui-m-l-1" title="将评论系统从来必力（LiveRe）迁移到 Artalk">上一篇</span> <span class="mdui-typo-body-1-opacity mdui-text-center" style="flex-grow:1"></span> <span class="mdui-typo-body-1-opacity mdui-text-right mdui-m-r-1" title="在 Windows 下检测深色模式并监听变化">下一篇</span> <a href="../../../../2023/03/29/detect-dark-theme-on-windows/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_right</i></a></div></main><footer class="mdui-typo mdui-container mdui-m-y-5" style="display:flex;max-width:1024px"><div class="mdui-typo-body-1-opacity mdui-text-left">Copyright © 2025 ✨小透明・宸✨<br>Hosted by <a href="https://github.com/TransparentLC/transparentlc.github.io" target="_blank">Github Pages</a></div><div style="flex-grow:1"></div><div class="mdui-typo-body-1-opacity mdui-text-right">Powered by <a href="https://hexo.io" target="_blank">Hexo</a> <span class="mdui-hidden-xs-down">7.3.0</span><br>Theme - <a href="https://github.com/TransparentLC/hexo-theme-akarin" target="_blank">Akarin</a></div></footer><script src="https://gcore.jsdelivr.net/combine/gh/TransparentLC/transparentlc.github.io/js/mdui.min.js,npm/medium-zoom@1/dist/medium-zoom.min.js,npm/instant.page@5/instantpage.min.js,npm/aplayer@1/dist/APlayer.min.js,gh/TransparentLC/transparentlc.github.io@879beec/js/script.min.js"></script><script src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/bsz.min.js" async></script></body></html>