<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>存在感消失的地方|ω•`)</title>
  <icon>https://akarin.dev/img/favicon.png</icon>
  
  <link href="https://akarin.dev/atom.xml" rel="self"/>
  
  <link href="https://akarin.dev/"/>
  <updated>2025-03-25T11:26:47.000Z</updated>
  <id>https://akarin.dev/</id>
  
  <author>
    <name>✨小透明・宸✨</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>关于同人的访谈：一位东方同人创作者的经历和视角</title>
    <link href="https://akarin.dev/2025/03/25/interview-of-doujin-culture/"/>
    <id>https://akarin.dev/2025/03/25/interview-of-doujin-culture/</id>
    <published>2025-03-25T11:26:47.000Z</published>
    <updated>2025-03-25T11:26:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>众所周知，我是个车车人。众所周知，东方 Project 经常作为<abbr title="一般是指月姬、东方 Project、寒蝉鸣泣之时，顺便一提这似乎是从中文圈开始出现的说法">“三大同人奇迹”</abbr>之一而被提及。我所在的东方群里有位叫蔼石的群友，组建了自己的同人社团“有顶天变电站”（群号 <a href="https://qm.qq.com/q/nDnHUy9KQo">795355401</a>，虽然这样很像植入广告但是还是应该宣传一下x），同时制作过很多<a href="https://www.bilibili.com/video/av112862613735945">相当有意思的制品</a>。最近有群友认识的学姐在做同人文化相关的研究，需要招募一些访谈对象，于是蔼石填写了招募的问卷，并进行了一次时长大约一个半小时的访谈，内容包含了自己了解和参与同人文化的过程，对目前东方圈内以及圈外的同人文化现状的看法，等等等等。</p><p>虽然最初是蔼石本人在获得研究者的授权后发到了群里，不过我觉得这种有意义的内容只是藏在聊天记录里的话有点可惜了，所以在得到授权后就决定放到这里了 (^_^;</p><p>访谈的文本量大概是<strong>两万四千字</strong>，全部读完可能需要相当长的一段时间。还好有语音识别，不然手打的话不知道要打多久 (^_^; 然后再校对一遍。以及，篇幅这么长只有文字的话阅读起来就太枯燥了，也是为了补充信息，我会在一些适合的位置插入相关的链接、注释以及和上下文相关的图片，基本上是我自己或者蔼石提供的图 …_φ(･ω･&#96; )</p><p>在阅读之前，我假定你对访谈中涉及到的 ACG 相关用语已经有了基本的了解，实在不清楚的话可以去 Google、百度、萌娘百科，或者问 ChatGPT 和 DeepSeek 老师也行吧 ^_^</p><p>以下就是访谈内容了。访谈者和受访者（也就是蔼石）的发言分别用 <span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 和 <span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 来表示。</p><hr><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 首先非常感谢你可以接受我的访谈邀请，我是中大社会学的学生，现在在写毕业论文。这个访谈主要是关于同人文化的一些问题，主要是想了解你的感受和经历，所以你畅所欲言，答案不被限制。所有涉及到的个人信息都会被严格保密。如果有你不希望我写在论文里，但是你仍然想向我分享的内容，你也可以提前说明，我会充分尊重你的意愿。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 没问题。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 接下来想问一些你的个人信息，就是你现在的常住地主要是在哪里？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我在中山大学珠海校区算常住地吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 算的，你现在主要是在珠海那边读大学？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 好。你现在比较热衷的作品，就是 IP 有哪一些？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我现在主要做东方 Project 制品，还有写同人文。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是在东方这个 IP 里面，你既是一个读者，也是一个创作者对吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那这边如何称呼你？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 叫我蔼石就可以。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那接下来想问你一些关于你在同人文化里面的一些实践的问题，你第一次接触到同人文化到现在有几年了？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 很早之前，就是我上小学一年级的时候，当时家里就有一本百度贴吧柯南吧的同人文集，当时是以出版物形式做出来的，所以我一开始以为这是一个官方出版物，不过后来我读了读，发现不对，这个后面还有致谢，是同人作品，从这开始我才知道有这种同人文这种东西，还可以做出版物。后来接触同人，也就是自己开始创作就比较晚了。我上高中之后，我才开始去写一些东西，然后去试着做一些制品。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是你接触到同人文化其实还是比较早，大概十多年前这样子。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对是这样。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以你第一次接触到那个同人本的时候，大概是在哪里接触到，为什么会突然发现有一本这样的东西？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我当时是在二手书摊，就是我的妈妈是在学校，他们有学生捐的这种书，有老师就会选一些放在图书角，然后就肯定有那种不合适的，我家里人反而就给我拿回来了，通过这种渠道拿到我的手里了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是一个可能比较巧妙的方式，你就接触到了这个同人本。那你第一次接触到这种同人文化的时候，你的感受是怎么样的？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 巧合吧，我觉得还挺惊喜的，就是这种创作的自由还能获得承认，我当时还觉得这种东西能做成出版物相当地厉害，头一次接触到非官方的东西能获得观众的承认这种感觉。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是你觉得他们可以创作出来，并且可以变成出版物，你觉得非常厉害，然后第一次接触到的时候也是感觉非常的震惊，对吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 是这样。</p><blockquote><p>后来蔼石说，这本同人文集也有可能是盗版书商为了牟利而盗用贴吧的同人文章，汇编成册并伪装成官方出版物的产物。至于这本同人文集长什么样子，我和蔼石都尝试搜索过，但是已经不可考了。</p></blockquote><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那在你进入同人圈子这个过程中，有没有一些关键的事件或者人物对你产生过重要的影响？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 关键的事件的确有，因为我参加的第一个同人展就是东方的 only 展，然后当时觉得如果只作为一个观众来看的话，可能参加一次就觉得有些无聊了，但是如果是自己做东西自己去推销，还有自己去跟别人去介绍我做的这些东西，我用了什么样的努力，会觉得更有存在的价值吧，就这种卖出去的东西是我自己的心血，我自己一点一点设计，然后我最后也是纯手工做出来，然后再卖给他，他也非常喜欢，这个时候我会觉得很有存在感，大概是这么一个心路历程。一开始可能会觉得和大家一起玩的时候，没有那么地能体现出我的能力。当时看到那些摊主能卖他们做的东西的时候，我就觉得很羡慕。然后我一开始想创作的话，也需要一个渠道，因为画师还有类似于技术的问题都不是我一开始能掌握的。我可以问我一些朋友这些东西能不能做，然后我有约稿的画师，是我的高中同学，然后我就可以一点一点去尝试去完成。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 因为我一开始是不会做设计也不会约稿的，我就是靠着类似于我认识了会做这个东西的人，比如会做 NFC 卡的这个人，他不会画画，他也不知道从哪里可以约稿，然后我正好认识一个画师，然后我就开始在双方之间斡旋，我就约稿，然后谈价钱，然后再制作这个。我们是在 NFC 卡上面贴 LED，用手机的 NFC 给这个卡供电，然后上面的 LED 就可以发光，但是这些 LED 的位置是需要画师去设计的，设计好之后贴到上面才可以量产，然后来卖，中间的交流都基本上需要我来给双方提建议，包括后面定价做宣传海报，这些都是我自己一个人做的。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1024*768),768px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/e1adf420c5969082605b41b736d612b2/3ISZ.avif" data-src-webp="https://p.sda1.dev/22/ff3fcc7c2dcf53a2eb887fbb5a9ac8cf/7MxM.webp" data-src="https://p.sda1.dev/22/dd16e41fa5f3d6f02fb6b9d05c2821d6/AOcN.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRnYBAABXRUJQVlA4IGoBAABQBwCdASogABgAPrVSn0yul5bUBVRwC0S2AFiEwDejXZX6AHSar8EAA61zNvmNrS22bPgrrgUv/N1KqYMVQyJ8U06QAP76D5UYLluX5EeeTMv2kYSpih6rYCOm32xNlccD3cPARLC8shNPtsoNbJpRmyzGRZTBbEM6bbFUh9fERcw4zbbynAL2WFU78ITL8YC6o7xvChzv953ktcwYhNcACmPe8Rane/5IxaacPDHXKMeO2LVD+Kfqw7A6BFP3BfxtLKfwwD104cp0posJ07vjs5OIgX04G1q1CeX/EogI0yDY7H0GOcLtSFvEFUZ8NQ69hK/p6WjIBt1kpRe1AtN/diVziBD3AuJJ1/gAlSfk+uqdtMmr/DuTi4GG9QGLK+53SgfE9lRzrbmANwKYva/RK/4LfTVN6efin6fmZLEmGOl2hry3Fm1sBgszkfIKMnxGoHmgzKwXJwqHrg/h/5/aJvOAC/BjAegAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/dd16e41fa5f3d6f02fb6b9d05c2821d6/AOcN.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>蔼石制作的同人周边以 NFC 卡为主，卡面上有作为装饰的 LED 灯，刷卡时会亮起来。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你是什么时候参加的东方 only ？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 第一次参加是 2023 年的 10 月份国庆，因为我在上大学之前家里人基本上不会让我出门，当时我只能在家里写同人文。后面因为考上大学了，家里人基本上就不管我了。我老家是在哈尔滨，我考到广东之后基本上就管不到我了，我就想去哪里就去哪里了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 这个其实我还可以说一下，就是我第一次参加同人展，是以顾客形式出现的，从这以后我就想去当一个创作者，所以我想看一下真正的摊主是什么样的。我就找了一下同学校的有一位东方社团的主推，我去找他，他当时说缺一个做摊的人，我说我能不能去做摊，然后当时那个展子是在深圳的一个高校的东方的展会，叫 THUP，我当时就去问他这个能不能去，他说可以，然后我们两个就一起去出了一下展，当时我帮他去做推销。我当时的感受就是，那些创作者们可能做出来的东西会很……怎么说，就是感觉做出来的很好，但是他们不一定有这种去把自己的产品的优势介绍给别人的这种能力，不是所有的这种创作者都能向顾客准确地表达出他们产品的优势。当时他卖得非常好，因为那个展可能也就一百多人，但是销售额很好看，所以他也很高兴，后来也主动邀请我去帮他做摊，我当时就觉得我是有这种天赋的，我可以很准确地跟这个顾客表达出我想表达的东西，所以我自己去做东西的话也能成功，我就找到了两个朋友类似于给他们牵线搭桥，自己开了一个社团。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 第二次参展差不多是 23 年 11 月，然后到后来 24 年 1 月份我说我们搞一个社团吧，然后到了 24 年的 3 月份就广州的 THO，当时是我们第一次出摊，我们把东西做了出来。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1344*756),756px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/94a79d76763985476e1fa14e35c60e2b/ihXR.avif" data-src-webp="https://p.sda1.dev/22/f1f142c5185e1de7fddb9be4bd1e7f30/GRpt.webp" data-src="https://p.sda1.dev/22/ab16b8a3e31ff0bc00dd3b429c4cd47d/jB5s.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRh4BAABXRUJQVlA4IBIBAAAQBQCdASogABIAPrVUo00uiEoCADgFoloAJ0zGCXEOhUKb3RhWJ9lsLMeARAjMsx3QAP74RYkazMmxS/7vJyHzgnrQgp/U3xfDc0SbDEuSVSxAN1y0SweSrETYSYaMLE+k0G8q8C4IDtEIlmSGW7Q+0LZicXsLU7ZvC3/IREqa1IAff9oz5LBvchgD9xnkFobztrrBzSgB6yuVxnDsaKh/uN6v3P4ybSxuz2+BF2LEOwLD1pvfHJ4/t5xBm7T4PgLbGyIgns5fCV9FTnv61bx4Ou39VCK693foVtQAWvJ8e9SXD9/Jv5wR7W5b7+Tfzf6Tu1uhsYUtputp+JolZLhQWuaaxnVDBUAPY+GwEKTXIAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/ab16b8a3e31ff0bc00dd3b429c4cd47d/jB5s.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>广州的东方 only 活动，第十三届“东方游剧天”现场的签绘墙，蔼石的社团在这次活动中也有参展。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是在你不断地去接触同人文化，或者说同人展这样的过程中，你自己也会产生自己也很适合做这样的东西，并且也热爱去做这样的东西的想法，所以慢慢地就去组织了一些社团或者一些社群，去进行更加广泛的活动对吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 是这样。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 方便问一下，你现在是哪个专业的？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我是学微电子的。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你作为一个像你刚刚说的这样的一个同人的读者和创作者，你现在典型的日常活动有哪些？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 自己同人创作？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 都可以，作为读者和创作者的典型，一场活动也可以。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我平常会参加一些同人文比赛，这个就要比我做开始做同人、搞社团、开始做同人制品还要早了。我差不多 22 年的时候就开始写东方的同人文了，当时上高中由于疫情的原因一直在家里闲着没事就开始写一些同人文，然后参加文赛的话，因为东方同人文赛是相对来说非常成熟的，大概开了已经十多年的那种，每年两次的那种文赛，所以大家参加的话，可能一次能收到一百多篇，竞争相当地激烈。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 也有那种类似于杂志类型的征稿，你可以把杂谈或四格漫画投在上面，我会试着写一些同人文去投。一般都是先投文赛，后面再试着去投一些刊物，因为在文赛拿奖之后，投刊物就会更容易上刊一些。然后同人刊物的话，我自己也会买一些。一些同人作者会把自己写出来的文章印出来，然后在展会上发给其他的同人爱好者。我自己没有做过这种事，但是我会很乐意去帮别人卖他们做出来的同人志，类似于我不收他们的那个寄售费用，直接放到我的摊位上帮忙推销，然后我甚至还可能会搭一些赠品进去这样，因为我很喜欢他们做的这种形式，为了让他们多做一点，我自己亏一些钱无所谓。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 然后同人创作的话，我自己的寝室里有一个小流水线，我现在就在做这个同人制品，我在给你打电话的同时我也在做。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你们一整个宿舍都在做相关的？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 并不是我自己一个人，我自己能完成从生产到包装的全过程，我基本上什么都能干，这个宣传的 QQ 群是我来运营，然后海报是我来做，然后这个产品是需要加工的，我自己还要加工给它包装好，这些都是我自己来做。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/860*502),502px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/ecd8f5ef61c63063267145cfb3bc26a3/U74q.avif" data-src-webp="https://p.sda1.dev/22/ed68df016801d1c32554d1cae43bd869/VqZg.webp" data-src="https://p.sda1.dev/22/f569ea48e8d67ee421ec17a620ebe4b9/p5X6.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRuYAAABXRUJQVlA4INoAAACQBgCdASogABMAPrVIoEumrZUYDAQAcAtEswBOmWn5OTqi2VKNfAS1hjE+PixpXf8YhsyeBTqtZZBOkzgAAPpqzeCx1/RtoswqScd44C9nsMAyzBVGzjR7X/Rf8ULFmCx9j4J/0KSMCulJ1BhdXcmK+dtVuHBw53IJV70vZGIvxyFt89QmQY6gAH0F16U+VdGTcOfhzHbEEH8W7U/eWCkHgAMsukS1SAqammqIPlWhGa1+uaTQRWX0PClxCd0C3jwR5NNN5TjffHVsvyID945vR5JPP1iL3AAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/f569ea48e8d67ee421ec17a620ebe4b9/p5X6.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>蔼石的社团“有顶天变电站”的宣传 banner。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你对于同人文化有非常深的参与的程度，就是大概是从大学的时候开始的。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对，的确是。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那就是从一个刚进入这个圈子的一个参与者，到现在变成一个参与程度非常深，然后同时运营着交到了非常多的朋友的社群，这样的一个经验。你是有一个怎样的心态的转变，还有你是怎么做到这件事情的？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我总结出来的大概就是只有那种未知的事情，才是真正能体会到喜悦的吧。如果你在一开始准备进行创作的时候，你就知道自己会获得成功了，做出来的产品将会是什么样的，等到做好的时候反而不会带给你那种特别大的喜悦。只有比如说你一出摊，你预期的销售额比如说就五百块钱，最后卖了一千，或者全部卖光了，然后再加上顾客会夸你的东西物美价廉，会觉得这个东西很好玩，发出惊叹的时候，那种喜悦是会逐渐改变你的。就类似于说一开始你会觉得做这个东西很累，比如说那个产品当时是要通宵去贴的，因为第二天就有展会，然后第一天晚上我可能还什么都没有做好，所以我就要连夜包装打好装备，第二天又背着老沉的箱子去走很远的路，但是一旦把东西放下，然后开始卖的时候，大家去夸说这个东西设计的好精巧，然后很喜欢这样的东西。包括这个跟人互动，跟他们说“老师能不能跟你集个邮”，就会觉得是跟人互动的那种喜悦，是一开始你去做它的时候完全无法预料到的，你会觉得自己完全地参与到了这个活动当中，成为了大家的焦点，这个时候你就会觉得做这个东西完全地值得了，什么赚什么钱之类的都根本没那么重要。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是这个过程，还有那些可能比较正向的一些结果会比较吸引你去进行下一次的贩卖或者组织，然后你从中会获得那种存在感，或者说成就感，会和经济利益相比起来让你更加开心。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你刚刚也有提到，就是你会去参加一些东方的同人作品的比赛，它是谁组织的？是爱好者组织还是说是什么？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 因为东方的官方在日本，他们可能自己会有一些征集的活动，一般会征集绘画类的，这种基本上跟国内完全没有关系。国内的东方圈子基本上是完全去中心化的，就是有人组织，参加的人多了口碑就会越来越好，类似于这样的正反馈。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 就是爱好者自己组织的一个比赛，到现在就变成约定俗成的一个比赛了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对，爱好者自行组织的，也有金主提供<abbr title="值得一提的是这个奖金是相当丰厚的，而且有很多举办文赛的官方其实并不会制作制品回本">奖金</abbr>。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/900*1200),1200px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/c2c992fbc23f97728344f7d2336565bc/UaWz.avif" data-src-webp="https://p.sda1.dev/22/a9ec721b2403337923a32ec0e59ecd03/6Kon.webp" data-src="https://p.sda1.dev/22/2ec19e5efab0a355a925481628e50c95/XwGx.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRgwBAABXRUJQVlA4IAABAADQBQCdASoYACAAPqVCmUmjo5Db/VQAYApEsYBbZtno/gX6FA6/Oglf/9y0tYIk1TXLddj+6TgAAP71HcOVrwrSlnbzH/bB4bktUbLw/EMNxKfwdoaUEGh9wYRCku5A9JhZn4X0m6qRy67clUzYg4LKYxz3TZCXnC/fobLO9CYQNOgsRGR/+uMnh4/0Gle/uYScHRCi0AGQExTCSUrdFKkpPoLEziOoBan6yzrge1MPpZ15y6QA5y0zRJawhrqXD5D4LDkzKcG7SjDothklDaVlpmusrNTABNAe0yp2jX6snoih4uR+2mXJjtsz+9uLc8e7o6GQThfNEpddp49qxxgA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/2ec19e5efab0a355a925481628e50c95/XwGx.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>“乡里奇谈”和“乡音”分别是两个规模较大的东方同人征文比赛和刊物，这张海报是主办方最近一届活动的<a href="https://www.bilibili.com/read/cv40445423">征稿宣传</a>。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你觉得东方这个 IP 吸引你去进行同人创作，还有进行一些同人活动的点是在哪里？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 首先，其实一开始最吸引我的是同人文，因为一个去中心化的 IP 不会有人去指责你的创作，无非是一个比谁声音大的竞赛。因为在正常的一些比如说像是二游的 IP 里面的话，官方对这个人物的设定会非常详尽，所以经常会有人说你的这个设定是 <abbr title="Out Of Character，二次创作中的角色偏离原有的设定">OOC</abbr> 的，影响观感。但是，对于东方的角色，ZUN 给的留白会很足，所以说你把它放在任何的设定里面，去进行你的思想实验，给一些原作里根本不会出现的假设，也不会有人觉得你是在故意哗众取宠。你去拉 CP 把两个人挂在一块，也不会说有些人会去指责你，说你毁坏了原作的什么什么，因为原作里并没有那么详细的设定。而且在东方的同人创作里特别强调同人精神，就是说你做这些制品是获得官方允许的，所以说你也不会在商业化上有什么顾虑，为什么你做出来卖钱，也没有人会去出警说你的这个作品怎么怎么样，我做起来就会很安心，觉得我并不会被人指责说影响了我跟人互动带来的快乐，也不会有类似于官方突然改设定了然后导致我的产品不好卖了这样的情况。我可以说去中心化能带来一种安全感吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 去中心化这个可以理解为，官方会对同人的干预会比较少，而且它的留白也会比较多，大概是这个意思吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 而且人物丰富也是其中一点，就是你至少有人可以写。东方的人物特别多，多到你每天选一个来创作一个新的东西，你都不会觉得厌倦，这也是其中一点吧，你不仅可以去了解他，更重要的是你每一个人都可以对他进行创作，做他的制品，差不多是这个感觉。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是说东方的官方对同人是非常鼓励、非常支持的对吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 是这样。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 像国内的一些 IP，可能会说同人是侵犯了他们的权益，然后可能东方不会有这样的事情，对吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 东方会有专门的规定，现在 B 站上就有上海爱丽丝幻乐团的<a href="https://www.bilibili.com/read/cv6364137">东方同人创作规约</a>，里面基本上就是把所有的同人权利都交给同人作者。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 它就是一个对同人非常开放的 IP，它也非常欢迎你们去进行二次的创作。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你刚刚有介绍你作为读者和创作者的一些典型的日常活动，那这些活动在你的日常生活中对你来说是意味着一些什么？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 那算是精神慰藉吧，就觉得做这些事情会觉得自己有存在的意义，没有那么大的压力。相比做和学一些感觉自己用不太上的东西来说，我利用自己的专业知识，我做的东西跟我的专业也有些相关，所以我会觉得做这些东西既能提升我的专业水平，又能给我带来一些收益，还能收获在社群里的声望，何乐而不为，差不多就是这种感觉，越做越高兴。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你在进行同人创作的时候，有没有一些心路历程，或者说一些灵感来源之类的东西？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 心路历程的话也遭受过挫折吧，类似于写同人文的时候会被人说，或者是甚至都不是被人说而是压根就没有人看，这个才是最令人伤心的。写出来的文章，它现在几乎没有反响，几乎没有人会说你写的怎么样，比起别人批评你这里写的不好那里写的不好，显然是没有人看、没有人关心，才是最令人难过的。不过，为了解决被冷落的这个点，那只能是打铁还需自身硬，想一想办法。给自己的一个结论是，你不能抱怨，你不能只在自己受欢迎的时候才感谢大环境，这个环境是只能由你去适应和改变的，只有你自己去踏出那一步，去对运动的社会进行运动的反应，才能产生更多的互动，才能收获，也就是你想达到的那些东西。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 与其说期望于干什么事这个社群都能对你做出积极的反应，不如思考一下为什么不会产生积极的反应，试图去了解社群才能去发现这个社群需要做出什么改变，他们需要什么。我就是从一开始了解这个社群，到后面我试图去改变这个社群，就是我的心路改变了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以你会比较重视的是社群给你的反馈，然后你会觉得不是说自己是在自娱自乐，而是说可以根据一些读者的反馈，或者说流量和热量的一些反馈，你会去做出反应，就是去改变什么之类的。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 明白这个意思。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你觉得就是创作对你来说有什么特别的意义吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我会在创作中加入一些自己的感受，因为不结合现实生活的创作它会比较的虚无。无论是你加入现实的事例也好，或者你把现实的体会利用另一种方式去把它说出来。我会比较喜欢用一些类似于现代的手法去影射现实，你用东方去影射现实，不会有人说你套皮，这种也是东方的优势。纯粹去创作一些 CP 上发糖的文章我是不太喜欢的，确实可以这样做，但是这样做不会让我有类似于收获别人的认同感的那么大的感受。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 总之我不擅长，但是有其他人写的话我还挺乐意去看。但是对于我自己的创作意义而言的话，我是想借此来找到这个社群的共性，就是在这个社群里这些人爱看的作品的主旨是什么，这就代表了这些人真正缺乏的或者想要的东西是什么，这也算是我的一种社会实践。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你觉得以目前的接触来看，东方的整个同人社群，或者说爱好者的社群，它的氛围，或者说它的精神内核是怎么样的？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 精神内核的话，我其实还是会感觉到他们会比较的可能也是社群的一种共性吧，就是他们会有时候会比较排外一些，比如说你在这个群里提到了其他 IP 的东西，他们可能会说不要提这些，会比较反对。但是，有一些 IP 有特别豁免权，就是比如说他们现在在看的<abbr title="指的是 2025 年 1 月开始播出的“颂乐人偶（BanG Dream! Ave Mujica）”，在开播前热度非常高，但是开播后因为剧情质量而得到了大量差评">少女乐队</abbr>，少女乐队番本身在东方群可能会显得比较无关内容一点，但是他们会很爱去讨论，每周四可能都会去说一说这件事儿。还有他们对于日本的官方周边的态度，因为日谷会稍微卖得贵一些，所以就会更倾向于去买<abbr title="典型例子是 Gift 社有官方授权的 Fumo 玩偶和国内社团的仿制品，后者的价格可能只有前者的三分之一甚至更便宜但是也质量相当，实际上也很受欢迎">盗版的制品</abbr>。对于一个同人为重的 IP 来说著作权问题一直是有的，但是“既然官方已经赚够钱了那么盗版就盗版吧，反正就算是买正版也是收两遍税”，他们会有这种态度，这是会被一些同人作者诟病的，因为他们做的同人刊物如果被盗版的话会带来大量的经济损失。也有我曾经遇到过的同人作者跟我提这件事，甚至会有作者害怕自己的那种类似于有声书的作品内容泄露，所以给读者去拆封试阅，都会有这种事情发生。这种群体性的著作权的疏忽也算是一个共性的问题。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 但是他们对于那种比如说拼多多拿那种盗印的柄图去复制的做法也是深恶痛绝的，他们会更倾向于支持同人作者的著作权，而不是官方作者的著作权。就是比如说 ZUN 本人做的一些游戏之类的，你想免费玩的话资源很好找，但是你想找到同人游戏的免费资源那就很难找了，他们会试图去保护这个同人作者的著作权，而不去保护官方作者的著作权，这是一个很有意思的现象，包括一些类似于对于官方团队的成员的不满，这个也是非常明显的。我能经常看到有人去指责官方的某些成员不负责任，比如说 ZUN 本人来中国或者韩国的游玩的过程制造了很多的不愉快，有时也会有这种事情。因为官方本身和同人是互相违背的，但是这个官方又和同人处于一种非常暖昧的关系，所以会有很有意思的一些在其他 IP 上看不到的这种互动出现。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你刚刚有说到，可能在大家对于官方的著作权相比起同人著作权没有在维护上面那么上心，或者说甚至可能会觉得有点无所谓，你个人会觉得这背后会有一些原因吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 因为基本上大家的共识是日本人很有钱，官方已经赚够钱了，比如大家都知道 ZUN 已经在东京的核心地块买了房子，而且家里基本上是财富自由了，就没有类似于再支持他、给他“捐钱”的欲望，他们会更倾向于多把钱留给这些国内的同人作者，他们买同人刊物会很慷慨，但是买官方的基本上就为了收藏，他们可能买完游戏碟从来都不会拆开，反而去玩盗版，包括音乐碟也是去听那种盗版下载好的内容，而不去把碟子拆开，就摆在那里。官方作品能给他们带来那种像赎罪券一样的感觉，但是基本上不会成为他们的购买方向，这和其他的 IP 是有很大不一样的。我认识一个玩<abbr title="“世界计划 彩色舞台 feat. 初音未来（プロジェクトセカイ カラフルステージ！ feat. 初音ミク）”，取 Project Sekai 各音节的首字母 PJSK 得到的俗称">啤酒烧烤</abbr>，就是那个世界计划的一个女生，她会跟我说，她不会倾向于买同人谷，因为同人不保值。但是在东方这边，闲鱼上面挂的官方谷确实会很多，但是同人谷也有很多，他们会甚至会卖一些同人音乐专辑，因为在日本有很多同人音乐社团，他们的专辑甚至炒的比原作还要贵，因为原作可能还会去生产一些，但是同人的社团有一些已经结束活动了，那些专辑就不会再有复制品了，那些同人碟子可能要炒到 500 块 1000 块，那个时候就有人非常显示他们对著作权的<abbr title="有点讽刺的意思">“重视”</abbr>。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1280*720),720px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/7f07431f00d0c0f80749acf127ed97e7/LZaQ.avif" data-src-webp="https://p.sda1.dev/22/b5b31c417e10c58b19fca382b6ea0f69/vj4T.webp" data-src="https://p.sda1.dev/22/3532d7cc3682b000bb1ad5a58f872ba2/5F8z.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRhABAABXRUJQVlA4IAQBAAAQBgCdASogABIAPrVKoEuRyYwGAgA4BaJYgCxHxpX+Q4A7+6qVKXLLMW2oWVtrA2k8JOvh+eNCKwAAzcnpkYVyYEJ5fjJtoTBaXegacszhuJOj8IsywSRroHHslyP74s8++IaNlx3TRpSk4CO4UY0xtZ+o+1JDz2qI5+LXgGG4k4w2ITEUeS9xx8dVuYHDpLwGb6ObOxC5h4lNFMuxLa8MD3mfwztdlhgCAfa4qJS8cH1zfId42JHVyCDmDc2ltYELDN1CyF8gDk6QMdZIuwA9EuP7R/bSAd10OWWOWMlS5DmUERZbfjg0+ZCCeAOk8M/RTnVMiiP4YQyuhKCKEfO/ogAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/3532d7cc3682b000bb1ad5a58f872ba2/5F8z.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>我自己有一张知名东方同人音乐社团<a href="https://www.yuuhei-satellite.jp/yuuhei-satellite">“幽闭星光（幽閉サテライト）”</a>的专辑<a href="https://www.yuuhei-satellite.jp/18444">“紛う星の如く”</a>，小册子上有包括当时的主唱 Marcia 在内的所有社团成员的签名。后来 Marcia 因故退出了社团，某种意义上这份签名也算是绝版了。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以我可以理解为就是因为东方对同人这样的存在是非常开放、非常支持的，所以同人作品也是非常高质量、非常丰富的，然后社群里面的一些人也比较尊重同人作者，为了未来能够看到更多这样的高质内容，才会特别地去维护同人作者的利益对吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 就这样。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那方便问一下，就是你现在在东方同人这一个范畴里面，具体做了一些什么样的成就，或者说已经在运营一些什么样的社群？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我可以把社团群的群号发给你，或者把海报发给你，或者我现在可以给你录一个视频，我现在正在做这个产品的演示视频。我在 B 站上有一个号，我里面发了一些我前期做的产品的演示，这个也可以发给你看一下，现在就可以发，需要吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 不急，你可以访谈之后给我也没有关系。主要就是想知道，比如你现在有组织或者运营一些社群，这些社群是否已经具有了一些商业规模？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 这个的确有，我跟我室友也会打趣开玩笑说我做的东西不赚钱，但是我肯定会保证我的成本全都能拿得回来，我甚至可以去有余力做一些无盈利的产品。比如那个高校的贴吧头像，有的时候会换成东方的，就是画上东方的角色，类似于这种，我会帮他们做一些无盈利的产品，我们中大的我也做了一个，如果有机会的话我甚至可以送你一份。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1080*574),574px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/a29c72375d0d310458409ce6831e8d7a/p3Co.avif" data-src-webp="https://p.sda1.dev/22/5f3a58eee3158129dd7393c340b2ecef/TWLe.webp" data-src="https://p.sda1.dev/22/d8ad4abbeff317af5a2b330827298a7e/4_WF.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRv4AAABXRUJQVlA4IPIAAADQBQCdASogABEAPrVInUmiiWwCADgFolAGRZqrFJJ2A1xbA67WtirJzFXDW1KF3mr6PTMyjyBAAP7tgVdSXhpfO2yf9ziMdMTiuQSUYxfYBYjEHRa7XheShlDC41uud+ThvVkPSW3EW02TpCdpfUstqAi5x1FkX7Rjfw71AmLcHAUcPRWSnxTnBWFAjyzH2g2bpNaCgZJyZVWY/EqwChy/qcNtfv1iQXA7Yd+p76+ktwJUHKrhtNqQ6SKNuLWG2OaLu0UH+YYxd8Jiz4BiPC2OxkY7gALJ/Qph2H4b7xpVCyH+YtIBXB8RrybKyVHeS2OQAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/d8ad4abbeff317af5a2b330827298a7e/4_WF.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>2023 年 11 月发生在各大高校贴吧的“东方校徽异变”。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我会更乐意做这种无盈利的产品，因为这样的话还能帮助到各大高校的东方群，他们一般会有一些群内活动，如果他们做的制品只是一些便宜的那种小铁片之类的东西，我会觉得，既然我有这个能力，我为什么不去帮他们做一些更好玩而且价格也差不多的东西？我就试着去压了一下我自己产品的成本，和大家一起合力，比如说我做的量多，它肯定就更便宜，然后我就试着把成本压到了一块五，然后我就可以以两块钱向一些高校提供那种很好玩的那个 NFC 卡片，这样的话也没有比吧唧贵太多，然后他们群活也可以发发，发起来很好玩。我会试图去帮助那些曾经对我有帮助的人，因为我自己的发展历程也有很多高校的东方社群的负责人来帮忙。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我们中大也有叫 NOT-SYSU 幻想乡的一个群，群里的很多人帮了我很多忙，我就为了感谢他们吧，就是各个高校的东方社群大家联合在一块可以互相帮忙，包括做一些很有意思的小饰品之类的，我帮他们以成本价做定制，我不收他们的定制费，只要他们带着图来，我就可以给他们做好，差不多是这样，我会做一些这样的事情。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/700*990),990px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/4c9b87a942afd839a4568feecf358fc8/Og3e.avif" data-src-webp="https://p.sda1.dev/22/ad449f6727b8b21e9a6aab92f8e5c532/NO8v.webp" data-src="https://p.sda1.dev/22/12fe814abc387c6781c6f8fd9c099ee9/vGYY.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRt4BAABXRUJQVlA4INIBAADQCACdASoXACAAPq1EmkmKSewDADAFYlsAJ0ygyXEWGGA/XL9ZveZ0wDlgPhS/2bh6TQYbWZT42jVTkv9Td3ITiugH87FNa6183dGGnUZ4AP63So9ZxMuTMoIFKtrYz1O781GWPBjSX4no3J9rhTlPmPshknGJ8f29i9cYF+dPZfXLrs4ReQ5/PAln0cOWT1b+miholN5/anEfDtjNOaQkQJu4N2kwQco0sZQzNJkVsnbo4WUSbcmGiE40yERoEu4SG59ky0/BB1kNHQhO2CL60z6+aIgh2B1vjkHBqDhFPYEM3N6PyywD/EzCkqwsLfjX+4l3xUbyOMsK2iyl17qBBhUu60OoxjE0bmcG8QS2QxCwepfXkLVEJj5hSaZI3zGkfAPr78YV0X4vq29CVz5iMmSGtoTtL19ax9KC7Cs9fdaDbR+SIAaKTe7W0SzeQTiv3hLSjwCwBLvLQmHzk2QIJUBkm78vlp2zp5ean+d9QrUNcXLc1tAOcqjSQMI8/RlSqQ9x/7O04JwsftSZ0bYFIxv63RtK5oeb80IU3OQlzG567lssCcpaGHlMttDZVfOpC0jBef/bAZRwaN3jd1spmxiR9Q/1S+yiGBoeH20POAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/12fe814abc387c6781c6f8fd9c099ee9/vGYY.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>有顶天变电站与多个高校的东方社群合作制作的东方风校徽 NFC 卡的宣传海报。</em></p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1024*768),768px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/cdbed93e6ba3ab18707c4df045b65292/XL-y.avif" data-src-webp="https://p.sda1.dev/22/20cfc014d75ff48d3cfb02ad1b709d8e/OCb7.webp" data-src="https://p.sda1.dev/22/ae01a38a4c96ac6a0f9b1d41dda1a490/n4c1.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRmIBAABXRUJQVlA4IFYBAABwBgCdASogABgAPrVInkmoiewCADgFoliALUa43AnNKgA/DaoTWaUkaOYzmVPOoaWlktmTLG1Aos1sSKAA+OR5J/2p3MD8MTH5+nVxChoqmROVmg/fhxjDrRstU0EEaHHcNbcI/2fXvF7nsXp9495DU1Jk6XMjUT81fkosNki/EWU6napIb1/6k4UXpJyP2esod4OGhEPK8ufwmTKZJgrNMPuPSXCJGZvNNXJq5jbm7qffyvWUFGJ3SB3QagbyAE5DYWyapKiTXDpwVzVq6h7xtH7bJJVem93Ng174cCrQmU/H3gYImKsnUWHAJN1Tb8jSh7nBZcHVv9MRELboheGnp4t8u9KbcHExawgIIyQGTaU4gHba0WwzISl3KbC7Zpplbdu3LefOiO5W9RIOTDEPtVHjUdxtHLrp65nIVkApGJ0YVlywAhT4GFHNG80P7lJJFQh4AAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/ae01a38a4c96ac6a0f9b1d41dda1a490/n4c1.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>最后的各种成品。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是你自己这里变成了类似手工作坊这样的一个地方，可以让你更方便去做一些制品，组织一些社群之间的交流，然后去送一些制品，做一些交换制品之类的活动？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那想问一下，在你进入到东方的同人圈子之前，你是不是就已经有类似这样的社群，还是说是你在进入东方同人圈子之后？可能到现在你有非常多的这样的社群，或者说联络人之类的，有产生一个这样的变化吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我的确是进入东方之后才会有这样的转变的，因为我当时是类似于干一行爱一行这种感觉。我既然要做，我就在这个领域一定要做出名堂来，我一定要让人大家都认识我是做什么的。我可能会去考虑改选一个其他的我很喜欢的 IP，但是现在还没有存在这样的让我创作起来很舒服，而且还能给我很多积极的回馈的另一个 IP。我基本上已经是在搞一辈子东方这种感觉了，已经在这样做准备了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 比如说大家的反馈，或者说一些交流，可能会让你更想留在这个 IP。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 是这样。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你接触到同人文化也非常久了，大概有十多年了。在你看来，这十年期间中国的同人文化有没有发生一些变化，有的话主要是哪些方面有发生变化？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 这个变化我觉得是非常明显的，因为我之前就和人探讨过这个问题。我特别提过二游，我为什么不去参加二游的 IP，我就是觉得二游在近些年来在慢慢变得集权化集中化。比如说我就以米哈游为例吧，我并不反感它，但是我会觉得它走的路线和我的想法背道而驰，他们会有官方去努力地扶持一些同人，类似于 <abbr title="MikuMikuDance，一个免费的 3D 动画制作软件，但是现在也可以泛指所有的自制 3D 小动画">MMD</abbr> 也就是角色小剧场或者角色跳舞，包括去画那种手书同人剧情的同人，这种他们是扶持的，但是他们对于那种做立牌吧唧钥匙扣同人书这种制品反倒是不那么上心的，因为对于他们来说这种制品和他们官方的制品是冲突的，是互相争夺这个市场的，但是手书或者原创曲这种东西是可以作为一个广告在整个平台上邀请新的爱好者的，可能某一个小剧场就会让人觉得对某个角色感兴趣，然后去玩他们的游戏，能带来经济上的正向收益。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 比如说十年前。我们拿 2015 年这个时候举例，当时中国国内的同人创作基本上都是做日本 IP 的，因为日本 IP 在国内不会那么商业化，他们做基本上纯粹是爱好，那个时候和这个时候的观点变化是相当明显的。当时的人对于官方剧情的讨论不会带有那么激烈的主观意愿：“我不喜欢这段剧情我就要强迫官方改”，因为国内的二游有一些玩家会觉得自己是消费者，他们会觉得自己有权利督促这个厂商做他们更喜欢的东西，所以才会有这个原神内鬼吧，说米哈游出男角色就是在把男玩家的钱转移支付给了女玩家。我就相当讨厌一个社群内部出现分化的这种现象。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 这种问题并不出在厂商上，就是在于一些二游 IP 的这些人吧，他们对官方的态度转变了，他们把自己从爱好者的方向转移到消费者的方向上了，所以他们甚至还会去攻击那些同人创作者。以前他们对同人创作者的态度就相当于说是，你又不收钱又给我们做饭吃，那你肯定是很好的人，但他们现在就会说，我也给原 IP 消费了，我现在是消费者，所以我可以命令你给我做我爱吃的菜。这样的话，因为每个人的爱好又各有所不一样，所以有一些二创作者就会因此只做官方想让他做的那些“主流”作品。甚至因为有一些这种作者，他不喜欢做“主流”的作品，然后这些二创作者莫名其妙地遭受到攻击，我觉得这种变化确实是非常的不理想的。一开始大家对同人二创是那种态度，我不喜欢我就不去看你做的好不好吃，我大不了换一家。但是现在这种宽容消失了，反而是相当于搂着这一家我喜欢的 IP，然后互相地攻击，比如说我是男玩家，我讨厌乙女游戏，我就去攻击乙女的玩家，反正乙女的玩家都是女玩家，她们又不会影响到我喜欢的游戏的流水，他们会这样去想，然后去互相地攻击。我有个朋友，他有一个很喜欢的二创作者，但是那个二创作者因为被人带节奏恶心到他了就停止创作了，我这个朋友就自己在长吁短叹：这个对我打击太大了，我都不敢参与这个 IP 创作了。我当时就吓到了，这有什么问题，反倒还要自己来承担责任，这简直太可怕了，怎么会发生这种事情。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我作为一个爱好者，创作就是我想做的事情。按理说，我觉得在十多年前这个常识就是不爱看就走，这是同人很常见的一件事。包括我画一些那种 CP 向的作品的时候，比如说我提哪个 CP，然后这个人觉得应该跟另一个人组，那他不看这个作品就是了，甚至他们可以在自己的扩列表上大大方方标明说我不喜欢看哪个 CP 的，你不要加我好友。但是现在反而会出现人多就是正义的这么一种观点，来攻击那些并没有那么多人来看的那种作品。有些创作者其实一开始并不是为了钱或者收益来做东西的，但是他们可能想接点单子，我去小做一下这个 IP 的作品，然后这个时候还会被一些创作者视为通敌叛变。比如说你做了其他的 IP，然后本家的人就会说，你怎么能做这个 IP 的作品，这是在十年前完全不会发生的事情。比如说一个搬运工，他本来搬东方的视频，然后他搬了个舰 C 的视频，搬了个原神的视频，肯定不会有人去攻击搬运工，至少在十年前是这样的，但是现在就不好说了。我曾经有一个喜欢的乐队，他们是唱东方同人曲的，但是他们也有很多人很排外，就出现过这种情况。他们平时的直播大概就二三十个人看，因为在 B 站直播的话他们并不是那么火，但是有一次他们接了一个原神的单子，他们发原神的那个单曲就被骂了几千多楼，简直太可怕了，我就觉得怎么会变成这样子。从国内的二游崛起开始，社群的这么多人的涌入开始，社群的这个混乱化就是不可避免的。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以就是你觉得比较主要的变化就是社群氛围会有改变，就是大家原来是一个爱好者，只会去关注自己喜欢的东西然后去做自己喜欢的东西，然后变成一个消费者，所以他们就会对于同人创作者有要求，可能还会上升到一些吵架或者之类的比较恶劣的一些行为。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1008*756),756px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/bd673ca51fefbae9af77478519e0afd3/3AFc.avif" data-src-webp="https://p.sda1.dev/22/dc5c0182117d7f824bd9ad894c78e97f/Zu-K.webp" data-src="https://p.sda1.dev/22/273dcedb6c72b76e22f063f536898def/geRN.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRooBAABXRUJQVlA4IH4BAABwBgCdASogABgAPrVInkmsiewCADgFolAF80L3+yKAN5tRoG0uReS2cuwQ2HpE5CqwskmRAGnZH6sHllgA/pplGwqNgw089vsiM49b4bJTHw/WveX9E9cmkShKtwpclrNivlMyeK/85USao0qYCTGS644SxDEhb/C3BXlFNeP4jXUbibFkg8WHx3WGQsJkb7nhcZ/pjzEgLiH8fHKttTjJjPeysoBD1QnbXZDS2uDoQHszsxA1Et1TTeHqpZ0qgGKAJ6gFlQBoZaGDT3lg8UCu7bzUf12iX37GlFGvL5/Pz7vjDlAkQKV/mlQa/3Qr6oiHwkE1ImeWX5+HZAD91aPSv4Ak2SOSxetiasP9QWCMLIAPgsejn8r5/BfjAdjyjueDkr93csf/adJu85QMq/8f/ZU6L8YQCVTUw3yEbmXH6B1vrWmZ/sg0BD2auqGV41jbehxEXYy01QThHx7thc6+6OfrD0fgRADM7/0+FJ8BhmPTIjtKM2v9a5sq9R4A"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/273dcedb6c72b76e22f063f536898def/geRN.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>Animate 广州店的各类国产二游官方周边。原神的周边种类和数量都很多，在货架上占了相当大一部分位置。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 刚刚也有说到，有一些游戏厂商，他们会去主动去扶持一些同人作者，或者说同人的一些作品。但是他们会觉得同人制品和官方周边是有竞争的，所以可能对于同人制品的一些贩卖会不太支持，甚至是不太允许。你个人会觉得同人制品和官方周边是有冲突的吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我之前提到过，我的一个喜欢啤酒烧烤的好朋友，他买啤酒烧烤周边都是优先买官谷的，我的确爱这个人物，但是我只会买特别优秀的官谷或者是特别优秀的同人谷，一般的官谷我不会去买，就会有很明显的这种区分度。反而在东方又恰恰相反，不管是我特别喜欢的官谷或者是一个普通的同人谷，我都会买，因为在很多东方众的眼里，官方是非常有钱的，而同人反而是缺钱的，因为搞同人的确就是这种想法。但是在一些盈利的 IP 上面，他们会有一种我觉得非常坏的毛病，比流水，就是我的这个游戏重不重要，就看流水高不高，你看这个月充的钱我们有没有登顶榜一，我们就是尊贵的游戏，有这种区分度，这是非常常见的一种现象。我现在就可以在贴吧搜流水这两个字，肯定会有很多游戏在攀比这个，但是为什么提到流水这一点？就是官方出周边也是同样的道理，他们出周边肯定是因为这个角色受欢迎，但是同人出周边一般是他们更喜欢做这个角色。我甚至跟一个做盈利向同人社团的人非常熟，他卖一套类似于很精品的周边，他是做 <abbr title="“重返未来：1999”，一个国产二游">1999</abbr> 的，他会做一套很精品的 1999 谷子，然后这个卖的<abbr title="当然不是 1999 (^_^;">价格</abbr>……我说这个东西怎么还能卖得出去，这个太贵了，一张图做七八种，然后卖一套大概一百两百，我会觉得这也太贵了，但是真的有人会去买，还卖得很好。我会觉得难道他跟官方没有起冲突吗？然后我还特意去问了一下，他跟官方是类似于有关系的，他们能认识到官方的一些画师，然后开那个 1999 only，这个人是 1999 only 的一个主催，就基本上是个很核心的人物了，我去问他就是 1999 对这个官方制品同人制品的态度，他们会觉得 1999 only 是非常好的，因为 1999 only 能带来更多的用户粘性，用户会觉得我待在这个 IP 里我是有归属感的，我出 cos 我跟别人集邮，这是有归属感的，然后做制品也是有归属感的，就是做制品既然没有到可以和官方分庭抗礼的程度，他们就会允许它存在，而不会类似于像是那种花钱去购买，比如我记得 MMD 是一秒要二三十、三四十，这都是很低的价格了，按秒卖或者按分钟卖的那种 MMD 是不一样的，他们不会去掏钱去支持同人作者做周边，但是他们也不会说我不让你做，基本上没有哪个作者哪个 IP 会做这种自断后路的蠢事。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 其他现有的国内的同人社团，我没有见到哪个能与官方分庭抗礼到影响到官谷的营收了，因为在官方看来，我觉得就是买同人谷的人一定是非常喜欢这个 IP 的，这个和东方差别是很大的。比如说我举个例子，一个人如果去参加 IP 的 only 展，那他肯定对这个 IP 是很有粘性的，在 IP only 展上卖的一些周边本来也不是官谷的一部分。有些寄希望于买官谷来保值的人，他就更不会在同人展上寄希望于我囤一些同人谷能炒到什么高价，但是官谷能炒到高价的那就比比皆是，看咸鱼一个吧唧能炒到好几万，这也太可怕了，有点理财产品一样的感觉，就是官谷会把自己的定位定得就和同人谷不一样。当然这个在东方也有，但是很不明显，就是也有那种特别魔怔的，我会用魔怔来形容，因为溢价实在是太高了，那种人可能在大家认为并不值这个价格的时候拿很高的价钱买谷子，那就只是理财了，就不能说彰显某个人对什么的热爱。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你现在觉得现在同人作品的形式包括哪些？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 要我说的话，可以分为三种，第一种是做出制品的图，然后做成物理介质的。然后你问的是同人制品包括哪几种，也就是媒介，那就多了，它们会依附于各种各样的媒介，价格也会不太一样，比如说有免费发到视频平台上的，也可能有付费发到视频平台上的，然后还有音乐这种形式。东方的同人音乐也是其他 IP 完全比不上的一个点吧，因为它特别多，由此产生的音乐社团也很多，这个是其他 IP 几乎没有的，然后还有其他类型的制品，有一个视频就是专门讲东方的同人作者都有哪几种的，东方还有一个东西是其他 IP 没有的，就是可以做付费的同人游戏，付费和不付费的质量差距是相当之大的，付费的同人游戏它可以做自己相关的周边，质量也是免费的同人游戏所达不到的。所以我之前说的可以跟官方分庭抗礼的同人社团在东方是的确存在的，这样的社团甚至就在国内，我和他们的主推关系也还不错，我好几次出摊都在他们旁边，他们做的同人游戏的销量比官方的原作卖的还好，而且还很出名，叫<a href="https://store.steampowered.com/app/1584090">东方夜雀食堂</a>，你搜一下还是很好搜到的，而且它的销量非常好。东方的同人有相当蓬勃的发展，所以还可以举到相当多的例子。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 音乐的话各种类型的基本上都有，然后视频也是从 MMD 然后到安科这种靠骰子决定剧情内容的，包括展现原作剧情的类似于表演性质的那种 MMD，还有跳舞，还有唱歌，然后还有同人小剧场，还有那种专门做的类似于手书之类的都有。制品之类的就最经典的什么吧唧钥匙扣之类的，那肯定都有很多人在做，画师也很爱画，包括还有一些我自己做的这个 NFC 卡，比较特殊的一种，我可以说现在还没有其他的 IP 有这种制品，因为我自己就只做东方，然后我有信心只有我一个人会量产这种东西，所以我自己做的这个 NFC 卡也是只有东方会有。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 还有比如说画集啊，刊物啊，这个刊物其实是有点踩在法律的这种红线上的，在东方同人圈内有些人说你不把刊物印到大概 300 本以上就不违法，但是这个东西其实是没有什么明文规定的，因为就在几个月前刚出现一件事，东方有个<abbr title="竹屋通贩 Market">做通贩的人</abbr>被查了，说他私藏了大量的同人刊物，但是他印量确实是大得有点夸张了，所以被罚了很多钱，然后又被没收了很多书。但是，你如果做少量印刷不带版号的这种同人刊物的话，我记得最近广州 CP 也有这种事，就是你拿出来就会被收，拿出来就要被罚，这个确实是因为政策问题会有影响，同人刊物就不太细讲了。画集的话要求就松得多，因为我看到过卖那种全年龄向的画集的，他们会翻译一些日本作者的画集。因为东方还有一种很特殊的现象，就是因为日文的画集在国内是不好卖的，所以那些作者会跟汉化组合作，在国内印一些汉化版的四格漫画，那种小薄册子，那种就以画集的形式来卖，好像也不会触犯那种印刷物的红线，也可以给作者和汉化组都带来收益，这个在东方也是很特殊的一种情况。</p><blockquote><p>同人画集、文集、音乐 CD 等一般没有正式书号或刊号，严格意义上属于“非法出版物”（<a href="https://www.shdf.gov.cn/shdf/contents/708/202882.html">《关于认定、查禁非法出版物的若干问题的通知》</a>、<a href="https://www.gov.cn/zhengce/2021-12/08/content_5724640.htm">《出版管理行政处罚实施办法》</a>第六十五条）。但是在个人制作、数量不多、不涉及淫秽色情等违规内容的情况下，实际执行中一般是睁一只眼闭一只眼的态度。</p><p><a href="https://www.spp.gov.cn/spp/xwfbh/wsfbt/202204/t20220429_555906.shtml#2">《公安部关于公安机关管辖的刑事案件立案追诉标准的规定（二）》</a>第七十一条：</p><blockquote><p>违反国家规定，进行非法经营活动，扰乱市场秩序，涉嫌下列情形之一的，应予立案追诉：</p><p>……</p><p>（四）出版、印刷、复制、发行严重危害社会秩序和扰乱市场秩序的非法出版物，具有下列情形之一的：</p><ol><li>个人非法经营数额在五万元以上的……</li><li>个人违法所得数额在二万元以上的……</li><li>个人非法经营报纸五千份或者期刊五千本或者图书二千册或者音像制品、电子出版物五百张（盒）以上的……</li></ol></blockquote></blockquote><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 东方还有一个很有特点的就是游车映写，把东方角色和当地的一些风景名胜放在一起，这个好像我看也上新闻了，新闻上面就说他们会把这个地铁的风景名胜和东方角色相结合约那种很贵的稿子，然后做成画集来卖。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1200*900),900px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/cac5ba0b5cedcc46fd8d44e5f1c49ad9/K5Nq.avif" data-src-webp="https://p.sda1.dev/22/e891ab92fae713e81750d907bb818619/t1bY.webp" data-src="https://p.sda1.dev/22/2b1bce5748e709ec3ec4e7773066f294/Z3yf.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRjIBAABXRUJQVlA4ICYBAABQBgCdASogABgAPrVOnkuklNMUBqhwC0S2AE6ZQZpJP+piFmj3tw9f5ND637Vetwj6qBWkmEN1ubAqMAD+9y3mwMUIr36xhnuD71K5xiyGZt8P8Z07W7Lsx9r5jMduWgbl294N0WDV4XXeNs+y3Y0w0nhAbkdYc/GguXiDSoZF7kPyxUWc+LAZB/87e540T19QNx+m1AAkcg7XcOfjRxdyH3PguelYltN/NUBRndBu0fw/gPc2VaoyTXz5FPYmOSYFEu/3h6o9/6/Dr3hKP4cOnyXLP+enHn6EFZ3Bym+JQ/8m/zXSwuEg1EkfSWgkqRx/U3sqtoai+VzXJoDGYNYGXt7Boj4rKVJIuReguwsXBNabAEn5ogr5xJiWYHOq2BXB65d9AAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/2b1bce5748e709ec3ec4e7773066f294/Z3yf.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>同人社团<a href="https://gskvpi.dreammatrix.cc/">“幻想乡键盘规划院”</a>的系列画集“东方游车映写”，这是以广州地铁为主题的第一卷，我手上也有一本。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 还有专辑，也就是同人专辑。因为同人专辑做出来是需要审核，要获取那种版号的，我曾经在 CPSP 上有非常深刻的印象，我当时到那个明日方舟的一个摊子上，我看到他那个同人 CD 做的非常好看，然后我就说里面刻的是什么歌，然后他跟我说不能刻，这里面什么都没有，这是空碟子，然后我就特别奇怪，怎么是一个空碟子，他说你可以自己刻自己的东西，我当时才反应过来，原来那些同人乐队确实是很厉害的，他们是有把自己的音乐提交审核然后拿到出版这种 CD 的许可的，这个也是很特殊的，因为日本的碟子直接拿过来卖是没问题的。但是，有一些国内的乐队，他们想出碟子，反而到日本去出，然后再拿回来，也是很有意思的，他们会找到那种出版公司去出这个。基本上只有东方的官方才不会管这种同人碟子的出现，因为日本的那种同人乐队，他们做的碟子已经是做了 20 多年了吧，东方的 IP 基本上从零几年就开始有同人音乐出现了，他们的这种系统性很成熟，你把音乐给他们就会找到公司帮你出，然后再拿回来就完全合法了，他们会有这样的一个流程。我最近接受到了一个邀请，想让我用在 PCB 上面焊那种存储颗粒，就是直接手工搓出一个 U 盘，然后里面存这个音乐，这也算是音乐的另一种存储方式，然后作为那种随印刷物的特典。我认识一个叫<a href="https://thfmu.com/">东方医学</a>的社团，你也可以去采访一下，他是做那种医学类出版物的然后还能和东方有关系的这种，我不知道他的进度如何了，总之他那边如果做出出版物来的话，这就算是合法的出版物了。再之后我一时就想不起来什么让我印象深刻的创作类型了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以我现在感觉东方这个 IP 它的同人的氛围，或者说它的整个产业是非常成熟的，而且其实比较可贵的就是官方它并不会去限制这样的发展。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 是这样。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你刚刚有提到很多关于日本那边的同人文化，你会了解日本的同人文化吗？如果说有的话，你觉得日本那边的同人文化和中国的同人文化具体有什么主要的差异吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 日本的交通依附于铁路会比较方便，而在国内的话，比如说出省，因为中国太大了，所以它的展会基本上是非常分区域化的，比如说我在东北出展的时候，和我在广东出展的时候，顾客喜欢的角色甚至都是不一样的，更不用说价位的区别了，当然经济发达地区他们的消费力会更强，这个就不用说了。但是如果是日本的话，我会觉得日本的那些同人创作者他们是更闲的，我会觉得他们有时间去做各种各样的东西，因为在国内的创作者基本上会遇到三道坎，第一个中考，第二个高考，第三个是考研，然后找个班上。而在日本，可能我觉得相对来说他们的生活压力或者说工作压力会小一些。我知道一个画师，不知道他是做什么的，每天在推特上面发四五张图全是认真画的，我就说你是做什么工作的。我会有这种感觉，他们会有更多的时间和精力来做这件事。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 他们也有很多那种类似于文创的作品，但他们的同人文的这种积淀是完全不如国内的，他们的同人志基本上推出来很慢，而且又很不出名，但是在国内只要提到东方基本上就是同人文、音乐和 MMD 视频这三板斧，还有同人游戏，能一口气掏出来一大堆，但日本的话你说我如果想入东方，我应该看什么，那基本上就只会给你推荐 ZUN 的游戏了。日本的同人游戏社团更倾向于做那种小游戏和免费游戏，但是国内会有一些更成熟的产出，甚至组成工作室这种类型的，比如说<a href="https://store.steampowered.com/app/1955830">东方冰之勇者记</a>，他们做了一年多然后做出来，销量很好，然后可以接着做东方同人游戏来养活自己，这种社团在日本是没有的，我觉得是这样。有一些那种画师他会接各种各样的画，他有一个号专门画东方的画，孜孜不倦地画，然后说画画他们基本上是拿来当副业做，而且他们的价格也会更不美好一些，因为在日本的物价会很高。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那非常感谢，就是刚刚讲了那么多。接下来想问一些你跟其他爱好者或者一些读者或者创作者的一些互动，就是你跟其他的一些同人读者和创作者之间一般会有哪些日常的互动？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 最近刚发生一件令我非常高兴的一件事，就是我把我的这个文章拿去参加中大漫协的投稿，社刊刚做出来，等一会儿我可以给你拿我刚拿到的这个刊物。就是我的这个作品上刊了，过了几天，有一个读者特意过来找我，说我很喜欢你写的作品里面的哪个角色，专门过来感谢了我一顿，这个我觉得非常高兴，就是和做同人制品别人夸你做的品质是完全不一样的一种情绪，他会夸你对这个角色的了解，或者说你自己的描写细致，告诉你你写的主题是让他认同的这种，带来的感觉是不一样的。这是我觉得同人文创作，甚至跟其他同人作品创作都不一样的一种体会，你只要做一样，它就会给你带来未知的那种幸福感，给你一种未知的收获，这种未知是最迷人的，我会有这种体会。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1024*768),768px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/0e88aa468843f51598a02351f7e05f8b/EXqu.avif" data-src-webp="https://p.sda1.dev/22/f66204a61af0b3c28e5875cdcc0ea91e/jA2S.webp" data-src="https://p.sda1.dev/22/18086baf33e56e39238f7295f834ca21/hPF9.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRoQBAABXRUJQVlA4IHgBAADwBgCdASogABgAPrVSok0iikoCADgFolAF89mXt+SC7IHypfgXANnnDrmCNZUbd9sNY5hybDgzj5dIZjxEsV6AAP70vLPd5jcqoc030bKcOa8Yx89F/DZfuH2SRGQ6zjMPFT+PsPeciRFBVny2kSuiPWHQx+DI2vf8VzQHjsPO1foQQAXmovUM9Dl7VVA9sL4We4Zrf6ZELFvq76oCusDyrRfPkI0Ya40rVw3B0IdaWPNA29SOZbtn70+vX0lZ/yElkleOrhSTXz3HKFJVPooFrQukv+RN+4Ki8KmtJCpTTW63+pkCEskqel3h4UrczudqV3/zvc/X62xheiTZQXez0W87UXDrDHxNL+4ZkmYTEq6RGQfpbByjF5trTMBtIw/FCicMXDMINP//Bil/D5yn7KUKxAu1mzrYFHwW7CmdjN3Ud0/eEZ7ESHHyBYdGJ5+Qxg1OIftVCO4jCbQiwBPBD2cDUr4zmnQixbhKsOBzJhNVyK8gAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/18086baf33e56e39238f7295f834ca21/hPF9.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>蔼石的东方同人文“158cm life”在中大漫协社刊上发表时使用的封面。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 然后因为我的社团肯定也不能是只靠我一个人去做，我当时和画师去联系，就是做了八个学校的东方的那种校徽，我跟每一个社会的人互动，我会给他们一种就是我很靠谱，我很负责任的感觉，就是我办事你放心，我做什么肯定都不会有什么差错，给自己给其他人那种令人安心的一个创作者的形象，我会觉得对我自己的这个身份很满意。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你在线上会有一些互动吗？线上主要是通过哪些平台和软件去进行互动？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 因为在 B 站东方的推流<abbr title="常被戏称为“奖励你东方应该有的播放量”">不是那么好看</abbr>，所以我们一般用 QQ 群。我基本上会在中大的东方群跟大家聊聊天，发发图片，还有跟画师互动也是基本上是在 QQ 群和 QQ 动态，包括约稿也基本上就是微信和 QQ，我基本上不在小红书和贴吧活动，因为我觉得再运营几个平台太累了，尤其是微博，基本上我更喜欢那种封闭一点的，都有一些熟人社会那种感觉。就是你跟一些很熟的人才更愿意去分享一些你最近的感知，一些三次元的事情比如说你看今天中大发生了什么事，你可能更愿意跟中大东方群、跟那种你更贴切的一些爱好者分享，甚至都不是跟漫协的人去分享，比如说今天我吃了什么之类的什么拍个菜给大家看这种，我会觉得在东方群内分享更安心一些。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那线下的话主要就是像你刚刚说的，去参加展会，还有一些线下刊物，然后有一些企划去进行互动对吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我们五月份准备在南校申请教室来办一个群活，这也算是我们线下的一种互动。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1008*756),756px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/223ccdc4408e870915c782ac617aa2d8/q40c.avif" data-src-webp="https://p.sda1.dev/22/be1a620807a318f213424c0299a5fdf2/Mqrs.webp" data-src="https://p.sda1.dev/22/13f36a112b831c207a07eb5ba22fc2e2/Jiwr.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRogBAABXRUJQVlA4IHwBAACQCACdASogABgAPq1Em0mqlFPYBgBgCsS2AFiPmXViSDnwNMA3lX/gTNZWBiVupGqB7e0C/48wxV1pFKmwSXUxL6OorpGZL4dWnZgRiAD+lsQvy6PssIYw5cWkTyr3uaSPhEIecoZazjCD987K5PquSl79sms9uGR5/yqQBZdwAY8UNVtyL0X2qppKKqgUeHXgnofPY9c8UVGRSEaQ/L6BTav52wKQELyeavm+5xiNBukuEehUdEller17RdGH4QWGsilGGZdrCUIW4FjPdU1BdZ+p6U51wWbrqMjESGyfGUV64RXrWluqaLg+3yzd2Fw9+HZAlf0LU32HBYr7v8ok3/onzDJIHxLF47QFs3DzE3QEf4d95pxfRuceM7DrwMCyBfw0yeNL5gAOnUHs8kCYWvieSHr1OFkCsvlpSr6ji9WLUN+dvb8MNgmL5KwlGwbGMGKMWENj/X1JsKU9ajn8FKabGaiaVjEtPHcgeDjK7JnvfOeebgmfEoggAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/13f36a112b831c207a07eb5ba22fc2e2/Jiwr.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>NOT-SYSU 幻想乡在珠海校区举行的群活，群友们的“Fumo 祭坛”。Fumo（ふもふも）是日本的 <a href="https://www.gift-gift.jp/">Gift 社</a>出品的玩偶系列，最初以东方的角色为主，后来也推出了其他 IP 的玩偶。国内也有一些社团会开团制作仿制的 Fumo，例如图中下方的《魔法少女小圆》的鹿目圆、晓美焰 Fumo 就是群友自己定制的。</em></p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1008*567),567px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/5a6099b2846c0836d882422b09f6deda/aDu9.avif" data-src-webp="https://p.sda1.dev/22/909babe18f614ca5d65b9bd86e3759d3/cU1I.webp" data-src="https://p.sda1.dev/22/32904b3b09e813faf02fdc078f8a5ff8/wyM_.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRmABAABXRUJQVlA4IFQBAACwBgCdASogABIAPrVInkmkimwCADgFoliALUj/74/vK7/6f9GAPkq/Aqfpvz+AFafU9usjMatkFxcRGZcJgAD9v5V2e6JOcWtW6d0sJ1GuiZUBK+f6zN7gnvTkh8xct81FAbz8os69atCIQg06jEBFtSqe/vU5XE1rnqUVi2fsJt9k7iHSrdnddILDTkO6F1/4uFiDU3Ti1Idpsq2J9oBhQIL1e8Z73brTjCnIuy4mJ+Fu6oCHba57vrbdADq5m9RMH8+8r5j7DWI34VMXu/Db5e1d1PmksD8jszWPK6z+NvaIrzcwoOJpM/aAP/45RxxwduPRiFZXAZCGmgD3kvt3ZgrUm3vI5/9gefEv23XSSrJOLv/eaDNvmMk4B/KEGhrhe1/vNtxd3fZB2nY+yFyfz3noMvt0Mk5KS4jOTy4Z7Mgk4UM9XXciP/Lknpb8es+U0kAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/32904b3b09e813faf02fdc078f8a5ff8/wyM_.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>NOT-SYSU 幻想乡在南校区举行的群活，群友们在进行<a href="https://store.steampowered.com/app/2400340">“东方兽王园”</a>的对战。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那在和不是同人读者和作者的群体，也就是外界，比如说家人同龄人，还有一些路人互动的时候，有没有遇到过一些让你印象深刻的事情？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我父亲会说我搞这个比较幼稚，这个很好笑，就是他看到我当时替别人卖同人刊物，他那个同人刊物外面画的人物，就灵梦魔理沙那种类似于游戏主角的画，他会觉得你卖的东西你做的东西怎么这么幼稚？我爸是那种最传统的觉得二次元是幼稚的这种态度，然后我妈会觉得我不懂，但是我大受震撼。我跟我妈说，比如说我去上海展我赚了两千多，然后我妈说你好厉害，你去了南方果然会赚钱，也是比较刻板印象。她会有那种就是我虽然不了解，但是你只要做的事情看起来很靠谱，那就接着做吧。他们甚至还会说，就你搞这个东西，你如果缺钱跟我们说，我的启动资金也是从这里来的。我的合伙人现在还在上高三，这个技术还是他去年高二的时候教给我的，他这个人也很厉害，我跟他说这个钱以后都是我自己出。我做出来的经济损失，比如我画板子的时候难免会出现一些疏漏，导致我这一批产品都不能用了，这种经济损失都是我自己承担的，然后如果说外界的话，包括我室友可能会好奇说你天天做这些东西你觉得累吗？我就跟他们说我做这个东西很开心，然后还有的话我甚至会给我父母把我做的这个中大的 NFC 卡给他们手机上别了一个，我跟他说你以后可以给你们的朋友看，说这是你家孩子做的，我会让他们觉得我做的东西是可以令他们自豪的，我在做有用的东西，即使他们可能并不那么认同，但我还是会传达给他们，说我做这种东西是完全强化我自己的能力的，我乐于其中，我觉得我在做有意义的事情。对其他同龄人的话，可能会说你要不要入坑东方，然后对年纪大一点的人的话，我会说这个东西确实能赚钱，你要不看看我是怎么赚钱的，就是按方抓药吧。因为对于不同的人都是具体情况具体分析的，他们大概会对哪些感兴趣，我就会去提这些一部分。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以面对家人不是特别理解的时候，你会用一种他们能够理解的方式去跟他们解释。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 对，因为这种感悟也算是我跟顾客打交道的时候，不同的顾客他会对我的产品有不同的兴趣点，渐渐地就总结出来了，哪些年龄段的人会更喜欢哪些东西。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那刚刚也有提到一些，就是你对同人文化商业化现象的一些了解。那总体上的来说，你会怎么去看待同人文化的商业化现象？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 东方圈内的商业化争议是特别大的，就像我之前说的那个“印了 300 本就是犯罪，299 本就不是”，同样也有一个争论是“印了 300 本就是商业化，299 本就不是”。还有些人会觉得就是你的产品卖的太贵了，能不能便宜一点，然后你这样是商业化也不够同人精神，这种问题在东方圈内确实是更明显的，因为在消费者看来，你东西卖东西要赚钱是理所应当的。不过对一些吃白饭吃习惯的人，看到你并不是那么好吃的东西卖了一个比正常吃饭还要贵的价，是不是有点奇怪了，他们就会提这样的一些意见。我觉得商业化是不可避免的，这是一种主流文化和非主流文化或者说亚文化相对来说的一些冲突吧，这种冲突是不可避免的，就是说你需要收益，你不可能免费地把产品送给这些爱好者，但是你也不能过于盯着利益不放，你做的制品就是为了赚钱，不是为了你对于这个产品的理解和喜爱，这样会逐渐偏离你的那些收获，因为钱是永远挣不够的，而且在东方这个 IP 挣钱，你为什么不去找更挣钱的那些 IP 去做？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 在我看来，我会逐渐的把重心转向成同人，而不是更商业。当然生活中我也会有一些很想要的东西，因为我把钱都投在做同人上了，有的时候存款就不会那么好看，然后就不会去买那些消费的东西，这时候我会去想我当时怎么没有定个贵一点的价格，多赚点钱，当然这种念头基本上一瞬间也就过去了，我会觉得赚到了那些钱，把这个东西买下来了，给我的这种幸福感和意义也不会有做这些东西那么多，基本上我会觉得是你在做的时候找好自己的这个方向。如果你真的就想商业化，就想赚钱，没有人会阻止你，没有人能拦在你面前说不要这样做，说你再这样做就怎么影响你了，什么什么变化了，不会这样的，基本上就是只要搞之前认清楚你做这个东西到底为了什么，你想赚钱那就赚。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 为什么同人不能是赚钱的？大概是几个月前，有个展会主办方说自己亏钱了，所以禁止摊位搞拼摊，你明白什么意思吗？就比如说两个社团的东西都不多，然后我们摊位只能申请一个，所以我们两个社团一起拼起来，那个主办方就说，我用了多少钱办展，我太有同人精神了，我都亏钱办了，那你也不许赚钱，这个就是有点太魔怔的同人精神了。同人精神不是人亏钱，同人精神是你创作的时候不以赚钱为目的而已，商业化的目的也不是说我就搞商业化，就是让所有人都给我爆米，你们高不高兴随便，不是这样的，而是能不能在同人和商业之间找到一个平衡点，众乐乐，我们卖的东西又好，大家都喜欢，我们又能让这个制作者不那么的利益亏损。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 好多人办类似于 THO 的 only 展，都会带有一种向死而生的想法，我就要亏钱，我办这个展就是要亏几万，跟人吹牛的时候也是我亏了多少钱，所以我就爱这个同人。我觉得这个也太扭曲了，不是以亏钱为美吧，所以说我觉得这个也是需要改变的，虽然现在还是会有很多人说我办了个展，亏了多少钱，所以我很爱这个 IP 这种说法。这个我只能说，那你菜就多练，你办展难道只能亏钱吗？那这个展、这个 IP 早就已经毁灭了，你不能为了反对商业化而故意亏钱，也不能为了商业化而故意不让所有人对你的产品满意，因为同人就像是同人，是别人选择你的原因，而商业化是你存续的原因。我觉得这就是一种矛盾的两面性，你必须得在里面找到你自己的对立统一，你才能办好你的社团，才能做好你的制品。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 所以，你觉得比较理想的这种创作者的状态就是在赚钱和去交流，或者说去分享热爱这两个方向之间去做到一个平衡。然后你觉得不要以亏多少钱这样的数字去作为一个道德上面的制高点绑架其他人，或者说去占领一个制高点这样的行为，你会觉得这样比较扭曲，也不是特别的利于创作者去持续地做一些事情。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 会影响社群的生态。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那接下来想问一下，在你贩卖同人制品还有营销的过程中，有没有遇到过一些挑战或者机遇？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我自己曾经还特别担心我产品卖不出去怎么办，我会引用应该是恩格斯说的一句吧，在商品转化成货币之前的这个惊鸿一跃，不可能是每一次都成功的，你不能指望做什么产品都赚钱，甚至你不能指望做什么产品都回本。遇到困难的话也是，比如说我做每一个制品的芯片，就是 NFC 卡的存储芯片，每一个都是我自己焊的。一开始我的工艺是我拿热风枪去一个个吹，我会觉得这个东西太累了，那个焊锡是有毒的，那个烟会熏得鼻子眼睛都很疼，我当时还买了防毒面具和护目镜，后来我改进了一下工艺，这也算是我克服了一下这个困难吧，就是我买了一个 99 的烤炉，我把我的产品塞到里面恒温加热，然后就解决了这个加热的问题，这也算是我的工艺的一个提升，也可能算是机遇和挑战了。</p><blockquote><p>原话应该是出自<a href="https://www.marxists.org/chinese/marx-engels-2/44/009.htm">马克思《资本论》第一卷第三章 货币或商品流通</a>：“商品价值从商品体跳到金体上，像我在别处说过的，是商品的惊险的跳跃。这个跳跃如果不成功，摔坏的不是商品，但一定是商品占有者。”</p></blockquote>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/960*720),720px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/4ca505e9f45e230fa14ee2a512d952d9/7qCp.avif" data-src-webp="https://p.sda1.dev/22/15a17ddd0aa358bc009371368cce1ad7/otdU.webp" data-src="https://p.sda1.dev/22/320d936b4575a5ab543de358981a9954/fqGo.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRtIAAABXRUJQVlA4IMYAAABwBQCdASogABgAPrVKm0owqaqnsBgMAOAWiWcAthQQtlJuWlh6AG5JEgdigJhr+mUxP3aAAPRGATfsensqFz9V7ddmz/72IAeCSpllshH3J2+FV4+aprotvYeZAi9cDr+Jr15rzLIRJyY0CM8esT+vRYHZsahH1zhwacQB3yu6v7SF9l8mktxhwpmoMhrImbt1qHUS//CMDBSGwLhlFAmvRutcy2oC7J065MqMmreirs/UPtBRw6ZEY2mAdUiNsdR4MqwiAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/320d936b4575a5ab543de358981a9954/fqGo.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>正在用来焊芯片的烤箱，使用方式就和烤曲奇饼一样，但是当然是不能吃的 (^_^; 因为焊锡有毒，在彻底清洁之前还是别用这个烤箱加工食物了吧。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 还有什么机遇挑战，比如有一些展你一开始向人推销的时候你是找不到重点的，你可能会担心我这样跟人介绍我的产品可能会有一些没有表达好，会导致顾客的流失。不过，我自己在搞同人之前就会经常锻炼我自己的表达能力，因为我觉得向别人清楚地表达自己的这种想法是非常重要的，这也可能是我坚持搞这些的原因，就是说你会有意识地在推销中强化自己的这种表达的能力，这算是给我带来的这种进步，就是我非常有勇气跟人表达我的观点，因为你不得不在推销的时候跟各种各样的人去表达你的产品哪里好，他们可能会做出那种你觉得非常恐怖的、好像被讨厌了这样的感觉，但是给你心性的锻炼是非常显著的，你会很快地觉得那就这样吧，不喜欢就算了吧，我自己不强买强卖，我也没逼他，就会有这种心态转变，这也算是我遇到的机遇和挑战。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 接下来想问关于性别的一些问题，就是你觉得性别对于你成为一个同人作者和读者有什么影响吗？或者说你有听说过什么类似的案例吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我觉得这个很明显，比如同人女这个词确实要比同人男更常见一些。我不知道为什么好像在刻板印象里就是女生的画师更多，她们做出摊就更少一点。不过在我的观察上，我确实不能说东方的爱好者性别比例是一比一，我可能说男生要多得多，不过这个 IP 可能就是如此，女性创作者会显得更少，但是反而比较集中，就是我认识到的女生可能不会画画，但是也会出 cos，总之她们倾注的热情是要比男性更多的，也有可能是虽然人少但是质量精的这种感觉。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 好的，就是你本身是作为一个男性的同人读者和作者，你个人会觉得同人女和同人男之间会有区别，前者的热情可能会更高，然后作品质量也会更好。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我觉得这个区别可能并不是这样说的，不是说女性作者更好，而是说我能接触到的男性特别多，反过来我接触到的女性就会在我的记忆里留下了更深刻的印象，两边都有很优秀的人吧，我不能说哪个更好，这样说就有点不太好了。比如说女生画的就是好看，没有这样，我认识的男画师画得也一样好，但是我遇到的女作者里创作者的占比更高。可以这样说，女性爱好者里创作者的占比是要比男性高得多的，或者这样说，就是她们会更愿意在自己的热爱的 IP 内投入更大的精力去创作，我觉得是可以这样说的。如果说例子的话，比如说 cos 也算是一种同人创作吧，女性会更愿意在 cos 上投更多的钱，但是东方有一个我觉得比其他 cos 圈更好的点，就是你出东方的 cos，你即使不化妆，不那么认真，也不会有人去批评你。出 cos 本身就是你乐于去做的，你只要不是拉住别人说我美不美，你想 cos 成你自己喜欢的角色没有人会出警你，但是在其他 IP 就不行，我曾经看到非常典型的有其他 IP 的人会批评这个现象，说什么东方的 coser 都不按规矩办事，这种太皇帝做派了，我觉得这个也抽象，你凭什么限制别人去做什么事情。东方这边和其他 IP 比起来可能男 coser 会更多，因为在东方圈内部对男 coser 化不化妆的这种要求或者说 cos 质量的要求会更低，你自己想披个假发穿个衣服出来可以，你不到处吓人不就没什么问题吗？但是在其他 IP 我可以明显地感受到是有村规的，你穿出来吓人会挨骂。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你刚刚也提到了你的感受的一些区别，那你个人感觉同人女和同人男会还有别的区别吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 同人女和同人男会经常转发一些对方的这种负面消息到动态里，然后我会觉得双方都会有一些问题吧，我觉得我自己看事情还是相对来说比较客观一些，因为我是一个会积极主动地了解相关东西的人，类似于在推销的时候我会理解对方去让对方相信我是对他考虑，我会认为你很适合我的产品，我才会去推销，所以我会试着去理解所有人，他们产生这种想法的原因是很合理的，但是他们产生这种想法的结果我就要另外再想。所以我觉得说同人女同人男有什么差别的话，我能看到很多同人创作者，他们并不是那么的完美，他们是有性格上的缺陷的，处理方式上也会有缺陷，而同人女的缺陷……可能这个我得很小心地说，比如说她们可能会更在意自己受到的关注度。我认识的同人女，她可能会喜欢说我要集赞，我要很多的赞，我要大家的评论，我要有很多大家的互动，可能赚多少钱反而不重要。我也认识一个非常魔怔，想赚钱的同人男。但是我觉得这都是海量个例，我不能说依靠我了解到的这些人，我就说同人女就是这样的、同人男就是这样的，有点太刻板了，我只能说我去介绍一些我看到的吧。我看到的同人女可能会更愿意跟人互动，不过同人男的话可能就不太愿意发动态。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 同人男有两种，一种是技术宅，他们会做出很厉害的东西，但他们不太会愿意跟人说，我认识的那个跟我一起出摊的那位中大的老学长，他就是不苟言笑，不怎么表达他的产品，但他产品做出来非常好，我就很不忍心看他卖得不好。因为他不推销所以他的摊位前面门可罗雀，我就帮他去卖，以后你的东西寄给我帮你免费卖了，我都会这样说。有一些男性爱好者，他们自己的擅长的那些点就是，可能这也比较刻板吧，就是理科类型的产品，这种多半都是由那种同人男做出来的，因为同人女的话，她们可能更倾向于在世俗上面更容易接受她们去画画去唱歌，但男性的话，可能他们去唱歌画画出 cos，在东方这个女性角色为主的一个 IP 里就会显得很奇怪，他们就被迫去做一些比如网页或者说 3D 动作 MMD 视频，而出 cos 就只能跟那些搞笑 cos 坐一桌了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 同人女和同人男在东方的分工是会有一些的，有一些社会分工这种感觉，就是因为世俗或者说圈内的一些观点的影响，男性 coser 就没有女性 coser 那么地专业，那些摄影也会更愿意拍女 coser 一些，拍那些精心装扮的女 coser。确实也有那种很厉害的男性画手出画集，但是我觉得画师基本上两种性别都是存在的。但是比如说我做的这些小玩意，还有包括我的那个学长，他做的也是这种技术相关的东西。就基本上是同人男在做，但是画师还是要找女画师约稿的，所以我觉得东方圈内还没有那种特别大的什么男权女权的节奏，这也是我非常喜欢的一点，因为大家都心里有数，自己到底能干什么，不能干什么，很平等的一种感觉吧。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你刚刚有提到过，你觉得在东方这个 IP 里面，可能男女比例是男性的创作者和读者会比较多，那你觉得就是在整个同人文化当中，它的男女比例是怎么样的？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我自己觉得整个同人文化可能还是男性偏多一点，我会有这种刻板的印象。不过如果实际来看的话，我在网上看到的同人女，她的创作质量确实会更高。就是如果你在 B 站看手书，基本上是女性创作者的比较多，或者是小红书看到的那种手书之类的，可能女性创作者就更多一点，包括唱歌之类的唱见，包括 coser 都是女性创作者更多。但是到了东方，也不只是东方展吧，我去过很多常规展，我都感觉男性更多，可能是没有去过乙女类的摊位导致的，但是男性就是比女性多，不过也可能是我自己的观察有问题。</p><blockquote><p>不过我也去过几次 CPSP，而且基本上最后都有时间可以把所有场馆都逛一遍，我的感觉是女性向的摊位其实比男性向多很多，东方啊 ba 啊爱马仕啊少女乐队这些都在的那个馆可以认为是偏向男性向的，但是其他的馆基本上都是女性向为主了。比较典型的四大国乙、FF14 这些当然不用说，但是例如任天街这样的一般印象中不太能归入女性向的作品专区，女性摊主和顾客都相当不少。</p></blockquote><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你觉得在同人文化里面男性会比较多，你觉得这样的比例是因为什么？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 可能是我自己的问题，我觉得是因为我比较关注这种中性和男性的 IP，我不会关注靠近女性的 IP，所以我不会知道在女性的这个 IP 圈内会有什么很厉害的人。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 在同人文化的内部有哪一些约定俗成的规则或者原则对你来说特别重要？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我想一想，要说东方的话，前面提过我们有一个<a href="https://www.bilibili.com/read/cv6364137">同人创作准则</a>，这个肯定是必须要遵守的。不过说句实话，我根本就不知道这个详细内容是什么，我只知道东方有一个同人创作准则，所以我做东西卖钱基本上没人会管我。还有什么准则，也没有特别多了。还有不能涉及什么宗教或者政治隐喻，我还记得这个。不过我记得最清楚的是不能提自己是原作，就是你不能做一个游戏，然后说自己是什么东方什么什么无敌版，你不能说你自己是什么原作的正版延续，这个确实是对于一些游戏创作者来说他们是需要知道的。包括不能放原作的 ED，就是 ZUN 本人说不想剧透，你可以打这个游戏的攻略，但是你游戏一旦放到结尾，你就要把这个游戏的结局剪掉，因为他不想让第一次游玩的人被剧透，差不多有这种要求。这种都是一些细节的要求，但是没有比如说不允许做什么角色的要求。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/854*480),480px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/f6c86078e21df66bfd2248eb05f9df10/AkZ_.avif" data-src-webp="https://p.sda1.dev/22/e0470989297ccb9e4c00b93bb08a8b59/3BLm.webp" data-src="https://p.sda1.dev/22/2f6cf4e16b7bbd89c78c5313d42861b7/tBXt.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRvAAAABXRUJQVlA4IOQAAAAwBgCdASogABIAPrVKnkmoiGwCADgFolsAJ0yhH93YzgN5BuAOgAAml9hrZfm6HSDdfw6phQhZcVYAAP72k06NA1/x7dU9MfkdsFbWldTwdMiP83BZXK2qICYx49wpeOlXQkhVUeDn1UM4O+0CM2K7YV670OWfTRbrdcmbwLBa0nexEuPywFSAa66Gph/R2+fkgdrF/4U3lt4ebCSESXXsCR1al5POG9tPokmMBY7E5wl2ub6MBfFcw0je4XLxv09q18/HAusFzRBgVPmnaJQmo234lf24ZGD5//QctSV8//oOAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/2f6cf4e16b7bbd89c78c5313d42861b7/tBXt.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em><a href="https://50dnh.blog.fc2.com/">Gore</a> 的同人游戏“东方门殊钱”，可能是为了方便在直播等场景下满足不直接展示 ED 的要求，在 ED 部分增加了一个可以打开和关上的窗帘。官方作品并没有这种设计。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 在你这样的接触到他们文化的这一整段历史当中，有没有一些外部的因素有对你产生过重要的影响，比如说一些社会事件，一些人或者一些政策变化，还有市场等等。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我会特别记住我准备打算入坑东方那一天，因为当时有人跟我推荐说你看幻想万花镜，就是东方的一个同人动画，当时那天我正准备看，我的同学也给我发消息说俄乌战争开始了。我永远记住了那一天，正好是 2022 年的 1 月份吧，我记得 1 月 20 号还是 2 月 20 号，那天俄乌战争正好开始，所以我跟人聊天的时候总会说，我说俄乌战争开始多久了，我就入了东方多久，这个确实是有点奇怪的一个说法吧。再说的话，还有什么会对我创作有影响的话，可能是一些新闻时事事件。就比如说刚才我说过的之前有一个东方的做通贩的网店被查，这也使我会更谨慎地去做，我基本上不打算自己去做同人刊物了，就是因为这件事。可能别人做我还会能帮忙就帮忙，但是我自己就不打算再做这种刊物了，我会有这种想法。</p><blockquote><p>蔼石后来说幻想万花镜其实是自己在 B 站的推荐上刷到的，并不是其他人推荐的。</p><p>提到俄乌战争的话，有必要推荐一下这篇文章：<a href="https://www.bilibili.com/read/cv23523918">我们都曾是东方众 ——记俄乌冲突与两国东方众</a></p><p>“特别军事行动”是 2 月 24 日开始的，战火已经燃烧了三年，到目前为止还没有结束。</p></blockquote><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你有什么个人的因素会影响到你对同人文化的参与吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 个人因素的话，我想到的可能是类似于我是哪个角色厨，这个可能会有吧，不过我自己甚至都没有说特别喜欢的角色，可能是因为我自己还没做出制品来。我做制品基本上都是按照大家都喜欢什么、我会看哪个角色来比较，或者说我想到一个很好的点子，我可以去做这个制品，我才会去做。反倒是关于我自己的喜好我还没有做什么相关的制品出来。我自己的社团还没有做视频，我总会说我自己喜欢的角色我都还没做，然后别人就问我你到底喜欢哪个角色，我说我都喜欢，因为我入东方这么久了，我不可能说我因为单独喜欢一个角色我才会去决定开社团的。我本人的性格也会因为参与到同人制作中而有改变。我会说我因为我每个角色都喜欢，所以我才可以平等地去给大家做各种各样的这些角色的制品，然后我做宣传的时候才能做到平等的对待。我会觉得同人对我的影响大于我对同人的影响。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 刚刚有提到，就是会因为比如说某个角色，他可能比较缺少一些高质量的同人作品，或者说一些同人谷，然后你就会去做，就是说社群里面的一些意见或者一些反馈会影响到你参与同人文化。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 是这样，比如说有些人会跟我反映说，你做这个角色，他会很适合你的产品，我说那好，我下次就做，基本上会有这种影响。包括我自己会想到我的这个灵感会很适合哪个角色，而不会像一开始说的哪个角色火才做什么。这个可能会影响我的市场，但其次这个 IP 它是需要我来帮助它推广的，它不该是让更多人了解哪个角色，它是有它的这个可爱点、闪光点，我会带有这种责任感而去做。不过后来我基本上妥协了，因为总有人问我这个热门角色你怎么没做，我想买这个，然后我突然想到这个既然是众望所归喜欢的人多自有他的道理，那就还是做一些吧，我现在就在做一些。反而就是不那么去费力不讨好地做冷门角色，因为冷门角色对于那些画师来说他们也没那么熟悉，都不太好约稿，我有个画师就卡了几个月的稿，我跟他说那换个热门角色画，他说太好了，都会有这种反应。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 好的了解，你现在整体上觉得社会对于我们作者和读者的接纳度是怎么样的？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 同人制品在出版物上，在这种印刷品上面，现在还不是特别乐观，做印刷品基本上就是又不赚钱，又容易被管。又比如说挂一些同人吧唧、挂一些这种二次元的挂件之类的在包上，可能确实会受到一些奇怪的那种冷眼，但是我不会觉得这种问题特别严重，因为现在二次元的主流化、商业化让二次元的地位上升也是不可争议的事实。虽然我之前说我不喜欢人们因为变成消费者而吵起来，但是变成消费者也是地位的一种提升吧。就是说这些二次元爱好者，他的数量多起来了，他们才会去想拉帮结派。他们本来都是这种受到一些歧视的团体，但是这些团体强大起来之后，集体歧视他们的那种程度反而就变小了。我甚至觉得对于最近的漫展、展会我父母的态度也在变化，说这个东西确实以后是要成为主流的，他们会有这种感觉。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1008*756),756px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/22/3e8f8df7ce4ee65b337379004ce09157/xsSj.avif" data-src-webp="https://p.sda1.dev/22/36d563bcf1f42562a97c8db161287bc3/cnlz.webp" data-src="https://p.sda1.dev/22/9d25d2d2b03bd167455afce2ab3c26d5/hqTK.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRiYBAABXRUJQVlA4IBoBAABQBgCdASogABgAPrVOokumkhUUBVRwC0SygGJ8aDBfknhpe7EDcYzAu1WlgS38l9pvtptfwwfkjD5cAAD+6KOBXKaieHWUgxadt92eSfAczCINoN6kRv6hDULA/q8YCnuE2TQFSIi82ZVPGsFHs59A0jkqkDwC7CK3g3kMmtaQjyb8JsvTOTzVb4hDXuIst+X9cbSPYSJulBGxsErWejQSz62GMc56cuvZvrGfuCd3OWXWvxvG+IPa0gQ5e85JDGf5UMyK3z89Z1BmNcfbnN4eh7uYaSrQkknNeoHS1KaxuN+wwmLP+2e7u5Rx9L5tFFSf6heC939O07uv5ShhHkpREnBHye2DS4bhaxfJX095go0Htv1+CnAAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/22/9d25d2d2b03bd167455afce2ab3c26d5/hqTK.jpg"                                                                                            >                        </noscript>                    </figure>                <p><em>我自己的挂满了东方同人周边的背包：画师<a href="https://www.pixiv.net/users/3322006">“60 枚”</a>的“ゆるっととうほう”系列挂件，社团<a href="https://thwiki.cc/%E5%86%B0%E7%B2%BE%E7%9A%84%E5%86%B0%E5%B1%8B">“冰精的冰屋”</a>的琪露诺挂件，以及以古明地恋为主角的中山大学东方风校徽吧唧。实际上我经常背着更换了不同动漫挂件（官方和同人都有）的包出门。</em></p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那你有了解到一些关于同人的政策或者社会舆论吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 比如说有一种叫音 MAD 的，它是类似于用重复的音频和视频拼接起来的一种做法，它的这个版权问题最近就有一些例子。比如说蔡徐坤的鬼畜被蔡徐坤用律师函告上法庭，但是最近也有一个做这种的作者，他的著作权受到了法律的保护，这算是我知道的，也就是说同人是受到法律保护的。音 MAD 的作者会因为这件事很高兴，因为自己的东西，比如说你用到的音源、你用到的这个画面，不会再受到原 IP 的限制了，你拥有你自己创作的版权这件事是挺重要的。就是最近的判决把这个版权判给了这个音 MAD 的作者，这个确实是对我来说也很惊讶的一件事情。至于其他的同人相关政策的话，我觉得好像最近也没有什么改变，包括这个出版物，就我关注的出版物 CD 方面基本上没有感觉到特别多的变化，反倒是在视频媒介上面我看到了这么一件事情。</p><blockquote><p>指的应该是这个案例：<a href="https://www.bilibili.com/read/cv29532505">这是一份送给所有鬼畜区 up 主的新年礼物</a></p><blockquote><p>……本院认为，我国著作权法所保护的作品是指文学、艺术和科学领域内具有独创性并能以某种有形形式复制的智力成果。原告权利视频的素材虽取自○○的网络直播视频、○○的抖音视频和的○○的音乐作品《○○》等处，但其进行了大量后期制作，在将○○的网络直播视频、○○的抖音视频作为素材进行修图、重组，并将其音频素材进行调音，最终将素材音、视频进行重新安排、组合，形成新的视频。该视频反映了作者独创性构思，形成一定的独创性表达，构成著作权法意义上的视听作品。</p></blockquote></blockquote><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 接下来问一个比较抽象的问题，你刚刚有提到过同人精神这个词，你是怎么理解同人精神的，你会怎么定义同人文化？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我周围有两类人，第一类人特别认这个同人精神，他们恨不得把自己做的东西每句话都加上这句，我是同人精神。但是还有人特别不喜欢同人精神，就是他看到有人在他面前提同人精神，他就要发火了，因为他觉得这个人是在找事，说他商业化。这两类人我都认识。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我对同人精神的理解，我刚才说过，就是类似于把它理解成一种服务于读者的这种态度，不是把它比喻成不要钱，这绝对不是同人精神。以人为本的这种感觉我觉得才是真正的同人精神，就是你不受到创作者的限制，你也不受到读者的限制，可能这样说有点奇怪，总之就是服务于读者不代表要受到读者的限制，这也是一种同人精神。你不能因为说因为 AB 两类客人都爱看你的作品，然后 A 类多你就多去做 A 类的，像我之前说的转移支付的这种感觉一样。既然你作为一个同人创作者来做，你就坚持你自己想表达的那些事情去吧，而不是说因为外界环境给你的，尤其是那种像是钱，包括那种类似于舆论上的干扰，让你影响了你的创作热情。或者说你创造的内容和方向，这一类都由你决定，你在其他人需要什么方向上的资源，比如说别人缺文案缺平面设计的时候，你不以盈利的目的去帮助，这也算是同人精神吧。在东方圈内这句话的火药味相当十足，所以说让我想的话，我能想到相当多的不同的论点，比如说你帮别人做平面设计，你收费，是不是没有同人精神？你给人画画，因为约稿会有很常见的两种说法，一种叫商稿，也不知道另一种叫什么比较好，反正就是商稿的价格会更高一些，那东方同人社团的稿子，你说它是商稿还是同人稿？很奇怪，不过东方圈内一般都按商稿来收钱，只要你拿去卖钱就算商稿。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 你对同人作者或者读者未来的发展状态有什么期望或者担忧吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 期望的话，我会觉得如果能回到那个人人都看到自己不喜欢的就远离的这种状态比较好，我会非常的厌恶会特别愿意去爱管闲事的这种人，我希望能少一些觉得自我意识过剩的这种人。我甚至还觉得有一个说法特别搞笑，有一些人他自己不在游戏里充钱，但是他说自己是潜在消费者，然后拿着这句话去攻击同人作者说，我是潜在消费者，你也要为我服务。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 我准备的问题差不多都问完了，那你还有什么特别想要补充或者介绍的吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 基本上也就这些，这都说了快两个小时了，已经一个半小时了。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 然后非常感谢你今天抽空来给我做访谈，然后想问一下你对这个研究，还有你填写的问卷，还有刚刚访谈的一些问题，有什么意见吗？</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 基本上没有，我觉得这个问卷说得其实还挺好，比较贴切，还能引导说出来这么多。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 那就非常感谢今天的访谈，也非常欢迎你对你说过的内容进行修改和补充。</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我稍后把我们的制品给你发过去一下，就是给你看一下大概什么效果，</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-life.svg);overflow:hidden;color:transparent">★</span> 可以的，然后就不打扰你休息了，拜拜！</p><p><span style="display:inline-block;width:1em;height:1em;background-image:url(https://static.thbwiki.cc/skin/header/header-bomb.svg);overflow:hidden;color:transparent">☆</span> 我存一下视频链接，再见。</p><hr><details><summary>附：用于招募访谈受访者的问卷</summary><p>亲爱的同人读者&#x2F;作者：</p><p>您好！我是来自中山大学社会学专业的学生，本次问卷旨在招募了解和熟悉同人文化的受访者，以完成毕业论文的实证资料收集。</p><p>我的毕业论文题目是：“同人女”的身份认同与文化变迁，因此访谈主要涉及到身份认同和同人文化的话题。虽然题目中指定访谈对象为“同人女”，但本研究也欢迎熟悉和了解同人文化的男性读者&#x2F;作者来分享自己的见解。</p><p>所有资料都只会被用在毕业论文中并对资料进行匿名化处理，我将严厉遵守基本的学术道德伦理，绝不会泄露一切个人信息与隐私。</p><p>感谢您的支持！</p><hr><ol><li>请问您是同人作品的读者还是作者？（单选）<ul><li>读者</li><li>作者</li><li>两者皆是</li></ul></li><li>请问您的性别是？（单选）<ul><li>男</li><li>女</li><li>其他</li></ul></li><li>请问您几岁了？（单选）<ul><li>18 岁以下（不含 18 岁）</li><li>18-23 岁</li><li>24-30 岁</li><li>31-40 岁</li><li>41-50 岁</li><li>50 岁以上（不含 50 岁）</li></ul></li><li>请问您常居住在国内还是国外？（单选）<ul><li>国内</li><li>国外</li></ul></li><li>请问您成为同人作品的读者&#x2F;作者多长时间了？（如果您两者皆是，请按照更长时间的身份来回答）（单选）<ul><li>不到 1 年</li><li>1-3 年</li><li>4-6 年</li><li>7-10 年</li><li>10 年以上（不含 10 年）</li></ul></li><li>请问您主要是哪类同人作品的读者&#x2F;作者？（如果您两者皆是，请选择所有您所涉猎过的种类）（多选）<ul><li>游戏类</li><li>动画类</li><li>漫画类</li><li>小说类</li><li>影视剧&#x2F;电影类</li><li>历史&#x2F;国家类</li><li>其他</li></ul></li><li>您一般在哪些平台上观看&#x2F;上传同人作品？（多选）<ul><li>网易 Lofter</li><li>微博</li><li>小红书</li><li>AO3</li><li>其他海外平台</li><li>其他</li></ul></li><li>您认为自己有多熟悉和了解同人文化？（单选）<ul><li>非常不了解</li><li>比较不了解</li><li>有点不了解</li><li>一般了解</li><li>有点了解</li><li>比较了解</li><li>非常了解</li></ul></li><li>您认为中国的同人文化在近十年来存在变化吗？（单选）<ul><li>完全没有变化</li><li>有变化但影响很小</li><li>有变化但影响有限</li><li>变化很大且影响很大</li></ul></li><li>您认为如今社会对同人文化的接纳度如何？（单选）<ul><li>完全不接纳</li><li>比较不接纳</li><li>一般</li><li>有点接纳</li><li>完全接纳</li></ul></li><li>若招募您为本次研究的受访者，接受大约 30-45 min 以同人文化为主题的访谈，您是否愿意？（单选）<ul><li>完全不愿意</li><li>我不愿意接受语音访谈，但愿意接受其他形式的访谈，例如文字访谈</li><li>我愿意但需要报酬</li><li>我愿意</li><li>其他</li></ul></li><li>若访谈报酬为一张你推的单人 QQ 人（<a href="https://p.sda1.dev/22/90d2ef472787744855cc634c5854bbed/l5BP.webp">例图</a>，不可折现），请问您是否愿意接受访谈？（单选）<ul><li>完全不愿意</li><li>愿意</li></ul></li><li>感谢您愿意成为本研究的候选受访者！请留下您的联系方式，并等待研究者的联系！（不论您将作为受访者接受访谈还是由于受访者饱和而遗憾落选，您都将收到相应的通知）（单选）<ul><li>微信（请输入电话号码或微信号）</li><li>电话联系（请输入电话号码）</li><li>QQ（请输入 QQ 号码）</li><li>小红书（请输入小红书 id）</li><li>微博（请输入微博昵称并确认能被搜索，或留下微博主页链接）</li><li>其他（格式：社交平台 + 号码&#x2F;账号信息）</li></ul></li></ol></details>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;众所周知，我是个车车人。众所周知，东方 Project 经常作为&lt;abbr title=&quot;一般是指月姬、东方 Project、寒蝉鸣泣之时，顺便一提这似乎是从中文圈开始出现的说法&quot;&gt;“三大同人奇迹”&lt;/abbr&gt;之一而被提及。我所在的东方群里有位叫蔼石的群友，组建了自己的同</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>将评论系统从来必力（LiveRe）迁移到 Artalk</title>
    <link href="https://akarin.dev/2025/01/18/migrate-from-livere-to-artalk/"/>
    <id>https://akarin.dev/2025/01/18/migrate-from-livere-to-artalk/</id>
    <published>2025-01-18T15:48:17.000Z</published>
    <updated>2025-01-18T15:48:17.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://livere.com/">来必力（LiveRe）</a> 是一个来自韩国的评论系统，支持使用国内外的一批社交网站账户登录，免去注册过程。</p><p>……嘛，这个介绍当然是复制粘贴的了。不过在五年前甚至更久以前、使用 <a href="https://hexo.io/">Hexo</a> 搭建个人博客相当流行的时候，来必力确实是各种五花八门的评论系统中相当有竞争力的选项之一。同期流行的其他评论系统中，多说和畅言已经寄了、<a href="https://disqus.com/">Disqus</a> 需要翻墙、<a href="https://github.com/gitalk/gitalk">Gitalk</a> 和 <a href="https://github.com/imsun/gitment">Gitment</a> 这种使用 GitHub 的 issue 存储评论内容的系统嘛……毕竟不是每个路人都有 GitHub 账号的，而且 Gitment 也已经弃坑了。</p><p>不过我一开始实际上没有对比这么多，选择使用 Hexo 和来必力都是因为那个时候看到认识的人的博客上在用这个，所以就跟着用了 (´ﾟωﾟ｀)</p><p>一个评论系统当然应该有评论提醒的功能，这样站长才有可能及时地与评论者进行讨论和交流。来必力一开始是有评论的邮件提醒功能的，但是大概是在 2021 年的时候，不知道为什么这个邮件提醒功能就失效了，官方也没有给出任何相关的通知。当我意识到这一点的时候……那个时候正好我在我自己的服务器上自建了一个邮箱，于是我想到了通过定时模拟登录管理后台、爬取最近的评论内容、然后给自己发邮件的方式，曲线补上了这个缺失的邮件提醒功能。</p><details><summary>当时写的邮件提醒脚本</summary><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> email</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">header</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> email</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">mime</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">text</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> email</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">utils</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> orjson</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> requests</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> smtplib</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> time</span></span><span class="line"></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">__import__</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">requests.models</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">Response</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">json </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> lambda</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> self</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> **</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">kwargs</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> orjson</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">loads</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">self</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">content</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">USERNAME </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">...</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">PASSWORD </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">...</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SMTP_HOST </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">...</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SMTP_USER </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">noreply@example.com</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SMTP_PASSWORD </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">...</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">NOTIFY_TARGET </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">dummy@example.com</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">d </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> time</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">strftime</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">%Y-%m-</span><span style="color:#EBCB8B;--shiki-dark:#569CD6">%d</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> time</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">localtime</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">time</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">time</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> -</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 86400</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">print</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Checking comment on</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">s </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> requests</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">Session</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">s</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">hooks</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">response</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">].</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">append</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">lambda</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> *</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">args</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> **</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">kwarg</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">raise_for_status</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">())</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">r </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> s</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">post</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://was.livere.me/login</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    data</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">username</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> USERNAME</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">password</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> PASSWORD</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">code </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">json</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">code</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">r </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> s</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">get</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://livere.com/doLogin</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    params</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">code</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> code</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">username</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> USERNAME</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">code </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">json</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">secretCode</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">r </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> s</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">get</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://livere.com/login_callback</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    params</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">code</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> code</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">r </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> s</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">post</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://livere.com/insight/managereply/period</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    data</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">startDate</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">endDate</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">        '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">sort</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">regdate</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">if</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> resultData </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">json</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">resultData</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]:</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    replyContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">&#x3C;table>&#x3C;thead>&#x3C;tr>&#x3C;th>评论&#x3C;/th>&#x3C;th>页面&#x3C;/th>&#x3C;th>时间&#x3C;/th>&#x3C;/thead>&#x3C;tbody></span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> reply </span><span style="color:#81A1C1;--shiki-dark:#C586C0">in</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> resultData</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">        print</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">reply</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        replyContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">&#x3C;tr>&#x3C;td>&#x3C;strong></span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;3&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">&#x3C;/strong>&#x3C;br></span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;4&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">&#x3C;/td>&#x3C;td>&#x3C;a href="</span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;2&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">" target="_blank"></span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;1&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">&#x3C;/a>&#x3C;/td>&#x3C;td></span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;0&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">&#x3C;/td>&#x3C;/tr></span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">format</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            time</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">strftime</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">%Y-%m-</span><span style="color:#EBCB8B;--shiki-dark:#569CD6">%d</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> %H:%M:%S</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> time</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">strptime</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">reply</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">regdate</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">%Y-%m-</span><span style="color:#EBCB8B;--shiki-dark:#569CD6">%d</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">-%I:%M:%S %p</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)),</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            reply</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">title</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            reply</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">site</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            reply</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">name</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            reply</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">content</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    replyContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">&#x3C;/tbody>&#x3C;/table></span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    with</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> smtplib</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">SMTP_SSL</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SMTP_HOST</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> as</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> smtp</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        smtp</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">login</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SMTP_USER</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> SMTP_PASSWORD</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        message </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> email</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">mime</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">text</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">MIMEText</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">            f</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">'https://akarin.dev/ 在 </span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">d</span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> 收到了 </span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">len</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">resultData</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> 条评论：&#x3C;br></span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#123;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">replyContent</span><span style="color:#EBCB8B;--shiki-dark:#569CD6">&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">html</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">utf-8</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">From</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> email</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">utils</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">formataddr</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">((</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Akarin Server</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> SMTP_USER</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">To</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> NOTIFY_TARGET</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Subject</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> email</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">header</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">Header</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">[Akarin Server] LiveRe 评论提醒</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">utf-8</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">encode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        smtp</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">sendmail</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SMTP_USER</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">NOTIFY_TARGET</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,),</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">as_string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">())</span></span></code></pre></details><p>靠着这个脚本，我算是自己给来必力又续了几年的命。</p><p>但是，最近我再一次意识到了我没能收到任何评论提醒，连自己写的这个提醒脚本都失效了。我检查了半天脚本，管理后台的各种 API 并没有变化，也不知道是哪里出了问题。</p><p>直到我发现了一个非常尴尬的事情：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1009*801),801px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/21/41513427bbbabf0133c7a6f00b3cf4e4/z9zR.webp" data-src="https://p.sda1.dev/21/3e29da8e97484954e9372d16bf0577d1/gkHJ.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRpYAAABXRUJQVlA4IIoAAAAwBACdASogABkAPrFEnUmpIpPb+qwAcAsEs4AAFu/b9iBXgiC/ELEaIAAA/vc1ek5AodyQ99hTXrG3yXmmeJjdrPvAcA/dHEdzy4jX1ONZiAPkYSZaeyJ4W4JhGyXAZiqsIyMDevFOcqp0hQyZhd84pCmtYvBA9n33qC45+3gFS9+OCtG98oAAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/21/3e29da8e97484954e9372d16bf0577d1/gkHJ.png"                                                                                            >                        </noscript>                    </figure>                <p>“已发布的评论 undefined”</p><p>我甚至不能在后台查到已有的评论。F12 检查了一下获取评论的 API，如果选定的日期之间有评论的话，这个 API 就会返回“出错了”。</p><p>来必力当然是有“意见反馈”的，这个按钮指向他们的邮箱。于是我在邮件里尝试报告邮件提醒失效和无法在后台查找评论的问题，发送之后，我收到的回复是这个：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/613*528),528px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/21/b46f70ec89c0cfb9321fd9a51511a931/P3jQ.webp" data-src="https://p.sda1.dev/21/ca05db090c42ba687fda30630488dbf9/liF8.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRpwAAABXRUJQVlA4IJAAAADQBACdASogABwAPrVKnUmkiOwCADgFolpAC7/wHkf3+vSfGXZMTWzdadguFmjTgAD+9z1+4Va6X8mNsf7jRjlYZsqXgZXRsr+O6duX7WdyegpXgCrvASbGPOPmMqeO3ynRoWGWYEELRDwh4pOGnABtnY+b6J12UiiwC6dCKKR7Cu8T2LNgwXu5BJ6Sla6oAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/21/ca05db090c42ba687fda30630488dbf9/liF8.png"                                                                                            >                        </noscript>                    </figure>                <p>啊，这……</p><p>虽然现在评论还可以正常发送和加载，但是后台出这么严重的问题迟迟不修复，连反馈的邮箱都无法使用的话，我觉得这已经和停止运营准备跑路没什么区别了。趁现在还能看到评论内容，必须考虑迁移评论系统的事情了。</p><p>之前在别人的博客上看到有使用 <a href="https://artalk.js.org/">Artalk</a> 评论系统的，使用下来感觉还不错，评论也不会强制要求注册，所以就决定选择它作为替代品了。Artalk 需要自己部署，不过这没什么难度，而且自己部署的话也可以避免跑路这样的事情。</p><p>安装 Artalk 是非常简单的，但是还有一个重要的问题是怎么把之前的评论数据也一起迁移过来。Artalk 提供了一个<a href="https://artransfer.netlify.app/">迁移工具</a>，可以把其他评论系统的数据转换为 Artalk 使用的<a href="https://artalk.js.org/zh/guide/transfer.html#%E6%95%B0%E6%8D%AE%E8%A1%8C%E5%9B%8A">数据格式</a>（官方称为 Artran），然后导入数据库。不过支持转换的评论系统并不包括来必力，实际上来必力就没有提供将评论数据导出的选项，所以只能自己爬取然后转换了。</p><p>首先考虑一下怎么爬取来必力的评论数据。</p><p>设置来必力的时候，需要在网站上加入一段 HTML 代码，以下以我自己的代码为例：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">div</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> id</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">lv-container</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> data-id</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">city</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> data-uid</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">MTAyMC80NDUwOC8yMTAzOQ==</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">script</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">   (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">function</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> s</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">       var</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">getElementsByTagName</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">s</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">       if</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">typeof</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> LivereTower</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ===</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">function</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> return</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#125;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">       j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">createElement</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">s</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">       j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">src</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://cdn-city.livere.com/js/embed.dist.js</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">       j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">async</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> true</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">       e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">parentNode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">insertBefore</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">   &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">document</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">script</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">script</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">div</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span></code></pre><p>这个 <code>uid</code> 是一串 Base64，解码之后是 <code>1020/44508/21039</code>，将这三个数取出来记为 <code>consumerSeq</code>、<code>livereSeq</code>、<code>smartloginSeq</code>。其中 <code>consumerSeq</code> 大概指的是用户类型，<code>1020</code> 对应免费使用的 City 版，<code>livereSeq</code> 和 <code>smartloginSeq</code> 应该是相当于用户 ID 的东西。</p><p>之后爬取评论需要请求两个 API，以我这里的“关于”页面为例。第一个请求是 <code>https://api-zero.livere.com/v1/common/config?refer=akarin.dev/about/&amp;consumerSeq=1020&amp;livereSeq=44508&amp;smartloginSeq=21039</code>，这里的 <code>refer</code> 实际上是网页的 <code>location.host + location.pathname</code>。</p><p>部分后续会用到的响应如下：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">actions</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">            ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">consumer</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">            ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">livere</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">            ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">smartlogin</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">            ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">rep</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">repSeq</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 4989047</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">title</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">存在感聚集（？）的地方|ω•`) | 存在感消失的地方|ω•`)</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">refer</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">akarin.dev/about/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">logo</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">../img/favicon.png</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">regdate</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">2020-02-17T04:11:04.000Z</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">consumerSeq</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1020</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">livereSeq</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 44508</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">parentCommentsCount</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 28</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">totalCount</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 62</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">plugins</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">            ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        ],</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">livereAdData</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">livereAdList</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [],</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">liveContentsData</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> null</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">resultCode</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 200</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">resultMessage</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Okay, livere</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReConfig</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    rep</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        repSeq</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        title</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        refer</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        logo</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        regdate</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        consumerSeq</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        livereSeq</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        parentCommentsCount</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        totalCount</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>这个 <code>results.rep.repSeq</code> 就是相当于当前页面对应的评论列表的一个 ID，如果当前页面没有评论的话就不会有这个字段。</p><p>第二个请求是 <code>https://api-zero.livere.com/v1/comments/list?repSeq=4989047&amp;consumerSeq=1020&amp;livereSeq=44508&amp;limit=9007199254740991</code>，这里可以使用 <code>offset</code> 和 <code>limit</code> 两个参数进行分页，但是 <code>limit</code> 似乎可以设成任意大的一个数。</p><p>部分后续会用到的响应如下：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">parents</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">            &#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">replySeq</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 56377701</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">name</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">NO NICKNAME</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">memberId</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">UID_7A85086412F723A87421D7E3BF72A05B</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">memberIcon</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">memberUrl</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://qq.com/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">memberDomain</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">qq</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">parentSeq</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 56377701</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">directSeq</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">title</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">存在感聚集（？）的地方|ω•`) | 存在感消失的地方|ω•`)</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">site</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://akarin.dev/about/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">email</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">ipAddress</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">61.161.154.184</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">agent</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.71 Safari/537.36 Core/1.94.192.400 QQBrowser/11.5.5250.400</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">image1</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://d47jbcq60tnr6.cloudfront.net/2024123/11313-15jbtaz.unyu.png</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">image2</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://d47jbcq60tnr6.cloudfront.net/2024123/5554-afg4zo.fy24.png</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">image3</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://d47jbcq60tnr6.cloudfront.net/2024123/6389-r3sgl8.v59kl.png</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">regdate</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">2024-12-03T09:21:49.000Z</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">                "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">content</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">博主铁子，我有一个很小众的问题求助：一个年少时的遗憾，以前辜负了一个姑娘，有来往短信若干条备份在百度云，因为年份过于久远（十年前），想回顾再查看时已乱码（如图）。咨询了官方客服也没法解决。当年用的手机是vivo Y11i T_BBK.</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">            &#125;,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">            ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        ],</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">children</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">            ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        ],</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">quotations</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> []</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">resultCode</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 200</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">resultMessage</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Okay, livere</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReComment</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    replySeq</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    name</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    memberId</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#616E88;--shiki-dark:#6A9955"> // 可能是邮箱</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    memberIcon</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    memberUrl</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    memberDomain</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    directSeq</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#616E88;--shiki-dark:#6A9955"> // 父评论ID或0</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    ipAddress</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    regdate</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    content</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    agent</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#616E88;--shiki-dark:#6A9955"> // User-Agent</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    image1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    image2</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    image3</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReCommentList</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    parents</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReComment</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    children</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReComment</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    quotations</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReComment</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>这里的 <code>replySeq</code> 就是评论的 ID，<code>directSeq</code> 则是父评论的 ID（不存在时为 <code>0</code>），<code>image&#123;1,2,3&#125;</code> 是评论附上的图片链接。关于评论者信息，<code>email</code> 字段不知为什么总是 <code>null</code>，如果评论者是使用邮箱注册了来必力账号进行评论的话，<code>memberId</code> 就是注册时使用的邮箱。上面这位评论者是使用 QQ 登录的，由此也可见来必力是真的没有在维护了，这都获取不到用户名了……</p><p>想要爬取所有的评论，就需要获取所有页面的 <code>location.pathname</code> 作为 <code>refer</code>，然后对每个页面都请求上面这两个 API。运行一下 <code>hexo generate</code> 然后复制粘贴终端中 <code>INFO  Generated: ...</code> 的输出大概会更方便一些。</p><p>然后考虑一下怎么转换到 Artran 的<a href="https://artalk.js.org/zh/guide/transfer.html#%E6%95%B0%E6%8D%AE%E8%A1%8C%E5%9B%8A">数据格式</a>，首先写好类型定义：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> Artran</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    id</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    rid</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#616E88;--shiki-dark:#6A9955"> // 在不存在父评论的时候，可以直接设为0</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    content</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    ua</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    ip</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    created_at</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#616E88;--shiki-dark:#6A9955"> // 格式：2021-10-28 20:50:15 +0800</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    updated_at</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    is_collapsed</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> boolean</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    is_pending</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> boolean</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    vote_up</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    vote_down</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    nick</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    email</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    link</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    password</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    badge_name</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    badge_color</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    page_key</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    page_title</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    page_admin_only</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> boolean</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    site_name</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    site_urls</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>根据<a href="https://cyp0633.icu/post/wp-comment-converter/">这里</a>的说法，如果是导入的话 Artran 的部分字段是可以留空的。</p><p>和爬取的来必力的评论数据一个个对应上去，最后就可以得到下面的完整代码：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> Artran</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReConfig</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReComment</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReCommentList</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReResponse</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#x3C;</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">T</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">></span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    results</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> T</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    resultCode</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">    resultMessage</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> string</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> artrans</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> Artran</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> []</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> uid</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">MTAyMC80NDUwOC8yMTAzOQ==</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF">consumerSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> livereSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> smartloginSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> atob</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">uid</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">split</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">map</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> parseInt</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> host</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">akarin.dev</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 2021-10-28 20:50:15 +0800</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> convertArtransDate</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">d</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> Date</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">$&#123;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">getFullYear</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">-</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">$&#123;</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">getMonth</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">().</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">padStart</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">-</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">$&#123;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">getDate</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">().</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">().</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">padStart</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">&#125;</span><span style="color:#ECEFF4;--shiki-dark:#569CD6"> $&#123;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toTimeString</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">().</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">replaceAll</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">GMT</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> ''</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">replace</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D16969">/</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\(</span><span style="color:#EBCB8B;--shiki-dark:#D16969">.</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">+?</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\)</span><span style="color:#81A1C1;--shiki-dark:#DCDCAA">$</span><span style="color:#ECEFF4;--shiki-dark:#D16969">/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">g</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> ''</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">trim</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">&#125;</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// location.host + location.pathname</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> pathname</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> of</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> [</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">/about/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    ...</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> u1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> URL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://api-zero.livere.com/v1/common/config</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">consumerSeq</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> consumerSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">livereSeq</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> livereSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">smartloginSeq</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> smartloginSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">refer</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> host</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> pathname</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> r1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReResponse</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#x3C;</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">LiveReConfig</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">></span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> await</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> fetch</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">u1</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">r</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">json</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // 当前页面没有评论</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    if</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">r1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">rep</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">repSeq</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#81A1C1;--shiki-dark:#C586C0">continue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> u2</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> URL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://api-zero.livere.com/v1/comments/list</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">consumerSeq</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> consumerSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">livereSeq</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> livereSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">repSeq</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">rep</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">repSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    u2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">searchParams</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">limit</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Number</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">MAX_SAFE_INTEGER</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> r2</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">:</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> LiveReResponse</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#x3C;</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">LiveReCommentList</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">></span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> await</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> fetch</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">u2</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">r</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">json</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    artrans</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">push</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">...</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">...</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">r2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">parents</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ...</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">r2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">children</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">map</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        id</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">replySeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        rid</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">directSeq</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        content</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">content</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> [</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">image1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">image2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">image3</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">filter</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">Boolean</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">map</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\n\n</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">![](</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">$&#123;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#ECEFF4;--shiki-dark:#569CD6">&#125;</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">)</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">join</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">''</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        ua</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">agent</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ||</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Mozilla/5.0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        ip</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">ipAddress</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        created_at</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> convertArtransDate</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Date</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">regdate</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        updated_at</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> convertArtransDate</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Date</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">regdate</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        is_collapsed</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> false</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        nick</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">name</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // html - How can I validate an email address in JavaScript? - Stack Overflow</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // https://stackoverflow.com/a/1373724</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        email</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">memberId</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">match</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D16969">/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9!#$%&#x26;'*+/=?^_`&#123;|&#125;~-</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">]</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">+</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">(?:</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\.</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9!#$%&#x26;'*+/=?^_`&#123;|&#125;~-</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">]</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">+</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">)</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">*</span><span style="color:#EBCB8B;--shiki-dark:#D16969">@</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">(?:[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">](?:[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9-</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">]</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">*</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">])</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">?</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\.</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">)</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">+</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">](?:[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9-</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">]</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">*</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">[</span><span style="color:#EBCB8B;--shiki-dark:#D16969">a-z0-9</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">])</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">?</span><span style="color:#ECEFF4;--shiki-dark:#D16969">/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">gi</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">            ?</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">memberId</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">            :</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">dummy@example.com</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        link</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">memberUrl</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        page_key</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> pathname</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">artrans</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">sort</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">a</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> b</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> a</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> -</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> b</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// console.log(artrans);</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF">JSON</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">stringify</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">artrans</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> undefined</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 2</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>导入评论数据时，Artalk 会自动根据 Artran 里的用户信息创建用户，并将评论 ID 调整为自增值。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/119247734">Pixiv ID: 119247734 「🎀」 by 茶白ひな</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://livere.com/&quot;&gt;来必力（LiveRe）&lt;/a&gt; 是一个来自韩国的评论系统，支持使用国内外的一批社交网站账户登录，免去注册过程。&lt;/p&gt;
&lt;p&gt;……嘛，这个介绍当然是复制粘贴的了。不过在五年前甚至更久以前、使用 &lt;a href=&quot;h</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>西方 Project 幡紫龙 C74 版汉化（魔改）记录</title>
    <link href="https://akarin.dev/2024/01/19/banshiryuu-modification/"/>
    <id>https://akarin.dev/2024/01/19/banshiryuu-modification/</id>
    <published>2024-01-19T15:37:09.000Z</published>
    <updated>2024-01-19T15:37:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>西方 Project 是一个弹幕射击类游戏系列，前两作由东京电机大学的学生社团 Amusement Makers 制作，第三作由前 AM 成员组成的“被瞬杀之道？（瞬殺サレ道？）”制作。此系列的三个游戏为秋霜玉、稀翁玉、幡紫龙，是基于在概念上对应 AM 的先辈 ZUN（后来成立了个人社团上海爱丽丝幻乐团）的东方 Project 而制作的作品，而前两作也有 ZUN 的参与制作及东方 Project 的客串出场。</p><p>……嘛，以上的介绍是从 <a href="https://thwiki.cc/%E8%A5%BF%E6%96%B9Project">THBWiki</a> 复制粘贴过来的。总之在最近通关了东方 Project 所有 Windows 整数作的 Normal 难度之后打算试点新东西，再加上之前也有通关秋霜玉 Normal 的经历，于是就找到了幡紫龙。（也许以后还会试试稀翁玉？）</p><p>不过这一作似乎没有汉化？</p><p>在查找角色设定和剧情的相关资料的时候，偶然看到了在国外的车万论坛 Maidens of the Kaleidoscope 上关于西方各作的英文补丁的<a href="https://www.shrinemaiden.org/forum/index.php?topic=19231.0">讨论帖</a>，其中有人提到制作英文版的最大阻碍是对游戏数据包的封包，大概也是这么久以来幡紫龙一直没有汉化版的原因之一，另一个原因也许是太冷门了。</p><p>解包工具早就已经有人写出来了，也就是 NamelessLegacy 的 <a href="https://github.com/nmlgc/pbg6ext">pbg6ext</a>。然后 Clb184 制作了 <a href="https://github.com/Clb184/BSRtk">BSRtk</a>，可以反编译和编译游戏中的二进制脚本，不过仍然没有实现封包功能。</p><p>于是，从“随便试试看”这样的想法开始，我对幡紫龙的主程序动手了…_φ(･ω･&#96; )</p><p>然后顺便就把汉化做出来了，想要下载的话可以去<a href="https://file.akarin.dev/s/n3tN">这里</a>。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1280*960),960px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/15/dc97281928aee94018e330e7d3383837/j_4UmP2a.jpg" data-src-webp="https://p.sda1.dev/15/7b94453677c912bb809f832d6ee7f569/QwcHiDgy.webp" data-src="https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRjIBAABXRUJQVlA4ICYBAABwBwCdASogABgAPrVKoEusq5MYDAQAcAtEtgBOnKBu58MfQBtgNwBvOW8zVjnGc5Dwq7vgcWg1SwDy3hD7enqCVmtRAAD+67CesMDoQtDv2pqPXLNWAUA0LoFIqUOxFsZEIvj+WeqFCd19gicmemjTIbmWhEnDKyvYQMEFKCHCQirCEYLcZWbN15hzbjesI7jgC+JDAXEv4CT7XsQxDCRD4UC1aHmDCZ0+lPVGKx019IfuBj9Yyae8I0Lf/c0f/7hA5MEmOxDF1uFxD9xaBpNwcmf7BkUThQ39SfMRV6o4/Da6eIG+5u2Hm+erJhoxlvNJilovPEGaEulmLQsR4YBylwXE7f1cl4LHntVhWrK3etPOA2QQQ6CBfYKWW3mQZYfljf5IAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg"                                                                                            >                        </noscript>                    </figure>                <p>不过，由于我的日语水平大概只有 N95 级别（笑），所以这个汉化版大部分是复制粘贴了 THBWiki 上现有的翻译，<strong>剩余的文本则通过 DeepL 和 ChatGPT <del>和脑补</del>完成翻译</strong>（可能有人会在意这个），略有改动。可能会有不准确的地方……在这里留言指出的话，我会尝试修正的！</p><blockquote><p>汉化是基于 C74 v3.001 版的主程序进行的（SHA-256：<code>07f2033073f1c890dcd25324dcf81778e88e8e0039a1a1d52e4889c17b9b8091</code>）。幡紫龙还有一个更早的 C67 版，不过关卡设计、游戏系统、界面等都有很大的差别，基本上可以当成两个不同的游戏了。我暂时没有汉化 C67 版的打算。</p><p>顺便一提，使用更新补丁时可能会由于编码问题导致无法找到游戏主程序而出错，这种情况下需要把游戏主程序的文件名改为 <code>敠巼棾.exe</code>（用 Shift-JIS 编码的“幡紫竜.exe”按照 GBK 解码的效果）。</p></blockquote><h1 id="PBG6-数据包格式介绍"><a href="#PBG6-数据包格式介绍" class="headerlink" title="PBG6 数据包格式介绍"></a>PBG6 数据包格式介绍</h1><p>幡紫龙使用的数据包，也就是那些扩展名 <code>.ac6</code> 的文件，暂且根据文件头的 magic number 记作 PBG6。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/743*236),236px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/433a2b4615058b3e3763702709d90f42/SdvSuz1X.webp" data-src="https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRnwAAABXRUJQVlA4IHAAAABQAwCdASogAAoAPrVKnkosiOwCADgFolnF4ACJQCK+NXNXgAD+8NPxuj/FrgJCEtuHeK6pU0W4I8HSs5CZj9mmkdIyQzxSAr4vsgKeas5o2CmvQaiD0suIcxtn6p5QvRHADfxDHBai2wxaqx3R1gAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png"                                                                                            >                        </noscript>                    </figure>                <p>通过阅读 <a href="https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp">pbg6ext 的代码</a>（当然自己从头分析也不难）可知，整个 PBG6 文件一共由三个部分组成：</p><ul><li>文件头（固定 16 bytes）<ul><li><code>uint8_t[4]</code> 数据包格式的 magic number <code>PBG6</code></li><li><code>uint32_t</code> 目录数据在数据包文件中的位置</li><li><code>uint32_t</code> 目录解密后的大小</li><li><code>uint32_t</code> 目录解密后的 CRC32</li></ul></li><li>加密的各个文件数据</li><li>加密的目录数据</li></ul><p>目录数据的开头是一个 <code>uint32_t</code>，用于记录数据包中包含的文件数量，之后是若干段各个文件的信息，每一段由以下数据组成：</p><ul><li><code>uint8_t[]</code> Shift-JIS 编码的以 <code>0x00</code> 结束的文件名，以根目录的斜杠开始，例如：<code>/foo.bar</code></li><li><code>uint32_t</code> 文件解密前的大小</li><li><code>uint32_t</code> 文件解密后的大小</li><li><code>uint32_t</code> 文件数据在数据包文件中的位置</li><li><code>uint32_t</code> 文件解密后的 CRC32</li></ul><p>知道了 PBG6 的格式，就可以自己写一个简单的封包工具了：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> os</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> sys</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> zlib</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">srcPath </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> sys</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">argv</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> if</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> len</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">sys</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">argv</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ></span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> else</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Input ac6 path: </span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">strip</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">ac6Path </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> srcPath </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">.ac6</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">tocContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> b</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">''</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">tocCount </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">with</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> open</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">ac6Path</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">wb</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> as</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">b</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">PBG6</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">b</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">XXXX</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#616E88;--shiki-dark:#6A9955"> # toc pos</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">b</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">XXXX</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#616E88;--shiki-dark:#6A9955"> # toc size</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">b</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">XXXX</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#616E88;--shiki-dark:#6A9955"> # toc crc32</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> root</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> dirs</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> files </span><span style="color:#81A1C1;--shiki-dark:#C586C0">in</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> os</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">walk</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">srcPath</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">):</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> file </span><span style="color:#81A1C1;--shiki-dark:#C586C0">in</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> files</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            srcFile </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> os</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">path</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">join</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">root</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> file</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            ac6File </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> srcFile</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">removeprefix</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">srcPath</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">replace</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\\</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">            print</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">ac6File</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">            with</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> open</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">srcFile</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">rb</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> as</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> g</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">                d </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> g</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">read</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            tocContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> ac6File</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">encode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">shift_jis</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> b</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\x00</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            tocContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> len</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            tocContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> len</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            tocContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">tell</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">().</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            tocContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> zlib</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">crc32</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">d</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            tocCount </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    tocContent </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> tocCount</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> tocContent</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    tocPos </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">tell</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">tocContent</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">seek</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">tocPos</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">len</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">tocContent</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    f</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">write</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">zlib</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">crc32</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">tocContent</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">).</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">to_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">little</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span></span></code></pre><p>……如果不考虑加密的话。</p><p>之前提过，PBG6 是使用了某种加密（或者说是压缩，这里就不区分了）算法来存储目录和文件数据的，而且该算法似乎不是 Deflate 或 LZ 系列之类的任何一种标准算法。</p><p>pbg6ext 之所以能实现解包，那是因为原作者直接<a href="https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp#L128">照抄</a>了从幡紫龙主程序反编译出来的解包部分的汇编代码，所以这工具的变量名也都是各种寄存器名称……</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/839*949),949px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/8e24066b20674d69c48add43108a0cbd/1iYDaRWm.webp" data-src="https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRlYAAABXRUJQVlA4IEoAAACwAgCdASocACAAPrVUo00EZQEAHALRLS1p4AOWAqAA/vRGgI+x7sa98sBcfS3ko5QOK9rFDeS90jtvlP2wx8foEyxnqq648kAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png"                                                                                            >                        </noscript>                    </figure>                <blockquote><p>Actually, I didn’t write it. I just copied the code from Banshiryuu’s assembly, which is made obvious by the variable names in the decrypt function. I have no clue what this is actually doing or if this is some known algorithm.</p><p>Writing a repacker would be the actually interesting part, but this game is bland anyway.</p><p>——pbg6ext 的 <a href="https://github.com/nmlgc/pbg6ext/blob/master/Readme.txt">README</a></p></blockquote><p>如果手上只有这堆汇编代码的话，写出对应的压缩代码当然就是十分困难的事情了。显而易见，无法实现压缩的话也就无法实现封包，把汉化过的脚本和图片资源导入游戏什么的完全没办法啊……</p><blockquote><p>… so we still need a hardcore hacker to have the tools which will allow us to extract and repack the game data. :V</p><p>——Maidens of the Kaleidoscope 上的讨论帖<a href="https://www.shrinemaiden.org/forum/index.php?topic=19231.msg1236359#msg1236359">“SEIHOU Project English Patch Question”</a></p></blockquote><h1 id="对读取数据包的分析和魔改"><a href="#对读取数据包的分析和魔改" class="headerlink" title="对读取数据包的分析和魔改"></a>对读取数据包的分析和魔改</h1><p>翻出 IDA 把主程序拖进去分析。根据 pbg6ext 的那段从汇编转写过来的 C++ 代码，试着搜索对应的汇编代码，在尝试了很多次之后找到了位于 <code>sub_42D8D0</code> 的解密算法：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/974ef00780ce0e69e6d8c516edb07925/FmGj9hnJ.webp" data-src="https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRoQAAABXRUJQVlA4IHgAAACQBACdASogABcAPrVSo00yicoCADgFolnAMZgyj7dt/gHzCjy4EwEwVVBkfYAA/u/6NFQWlOvP70kB5Ve1+fryCSS0fvR2RFPGD1CFWSZ5fK12u/4UBYyzYKos1oDkuVy8n0dr+v9zJHpymmafiW0C4PrerqVgAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png"                                                                                            >                        </noscript>                    </figure>                <p>和 pbg6ext 的代码对比一下还是能辨认出来是同一个东西的，当然因为这是反编译的产物所以看上去糟了很多。</p><p>然后，可以通过动态调试下断点看调用栈，或者用 Sysinternals 的 procmon 检查使用 <code>ReadFile</code> 读取 PBG6 的前 16 bytes（也就是文件头）的地方，从而找到 <code>sub_42D2C0</code> 这个读取 PBG6 的函数：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/9c403551b04393ffd6c6d5e3f860a94a/pcQmvfKQ.webp" data-src="https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRowAAABXRUJQVlA4IIAAAADwBACdASogABcAPrVSok0sicoCADgFolnAMf/Vu2/wD5hSLt4ff/X6kN4vt1GCsgAA/u/6NFQWlOvP8DcRaP2JaDKM6+Og3d6IIEHiAbYkrrk3Syk/g6w3LXJZiBTRQ9r0M1vLmgkuzis6qqVlmkMN7duDKTylpLfW/X9ZrAAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png"                                                                                            >                        </noscript>                    </figure>                <ul><li><code>v9 != 910639696</code> 这个常数就是用小端序表示的 magic number <code>PBG6</code>，即 <code>0x36474250</code>。</li><li><code>v7 = sub_42DC90((int)v6, v5, dwBytes), (v2 = (void *)v7) != 0</code> 调用了解密算法。</li><li><code>v8 = sub_42DB50(v7, dwBytes, 0), v12 == v8</code> 计算解密后数据的 CRC32，并检查和文件中记录的值是否一致。</li></ul><p>其实一开始只知道 PBG6 使用了校验和，但是不知道具体算法，点进 <code>sub_42DB50</code> 也没能认出来，只是用解包后的文件随便试了一下才发现是 CRC32。不过就算不知道，把校验过程直接去掉也是可以的。</p><p>继续查看 <code>sub_42DC90</code>，可以看到这里分配了一块内存区域用于保存解密后的数据（调用的就是 <code>sub_42D8D0</code>，不过不知道怎么被反编译成了函数指针的样子），解密成功则返回这个区域的地址。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/057c9b1676cbb7688988d425cfd69292/c7uzRR1J.webp" data-src="https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRnwAAABXRUJQVlA4IHAAAADQBACdASogABcAPrVQnkuskdEUBqhwC0SzgGVnr/bf4B8woQSqYnYxEa+HazFLAAD+7/o0VBaU67MHkG5qKm+5jpAcIwFy1yXYEEXlRFALqKIgnRkgvfxHFqg0gnCM4/ZOGfC6YTrzzBcTDPuAAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png"                                                                                            >                        </noscript>                    </figure>                <p>暂时先分析到这里。那我是怎么使封包变得可行，从而实现汉化的呢？在给出答案之前，可以试着自己大胆猜想一下。</p><p>可以稍微提示一下……这个汉化是魔改了主程序的，而使封包变得可行的方法在前面的某个地方已经给出线索了。</p><blockquote><p><strong>“……如果不考虑加密的话。”</strong></p></blockquote><p>原来的主程序是从数据包读取加密的数据，解密后再使用。既然我们无法自行实现封包的加密，那把这一层直接去掉不就可以了吗？</p><p>一边是对数据包进行重新封包，保持 PBG6 的格式不变，但是不进行加密的步骤。另一边是修改 <code>sub_42DC90</code> 的代码，把解密操作去掉，改成直接使用数据包中的数据，也就是把这部分改成一个 <code>memcpy</code>。这样就没有什么加密解密的事情了。</p><p><code>sub_42DC90</code> 对应的汇编如下：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1482*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/1434dc2f2ed48b31adb5407faa28e618/_FDeJNoy.webp" data-src="https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRnAAAABXRUJQVlA4IGQAAAAQBACdASogABMAPrVQoEymkZPUBVRwC0SzgGHWCIlX0qfBLxyRPrLVYAD+8g3ysvg9kW6B/SHUcmKNgw7L036XTxlSBzlKbATTlh8w1KSKoxxpy+8L8bsHCz2uubj6iHHo1rAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png"                                                                                            >                        </noscript>                    </figure>                <p>而我的操作就是从 <code>.text:0042DCA8</code> 开始（这部分以上是 <code>if (!v5) return 0;</code>），用汇编的串传送指令（还好当时学的汇编语言没完全还给老师……）实现这个简单的 <code>memcpy</code>，再处理好返回值和栈平衡，剩下的部分用 <code>nop</code> 填充：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">arg_0 = </span><span style="color:#81A1C1;--shiki-dark:#569CD6">dword</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> ptr </span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#616E88;--shiki-dark:#6A9955"> ; 解密前数据的地址</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">arg_4 = </span><span style="color:#81A1C1;--shiki-dark:#569CD6">dword</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> ptr </span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">8</span><span style="color:#616E88;--shiki-dark:#6A9955"> ; 解密前数据的大小</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">dwBytes = </span><span style="color:#81A1C1;--shiki-dark:#569CD6">dword</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> ptr </span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0Ch</span><span style="color:#616E88;--shiki-dark:#6A9955"> ; 解密后数据的大小</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">push</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> ebx</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">mov</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  ebx</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, [</span><span style="color:#81A1C1;--shiki-dark:#569CD6">esp</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">+</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">4</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">+dwBytes]</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">push</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> esi</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">push</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> edi</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">push</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> ebx</span><span style="color:#616E88;--shiki-dark:#6A9955"> ; dwBytes</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">push</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#616E88;--shiki-dark:#6A9955"> ; uFlags</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">mov</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  edi</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, </span><span style="color:#81A1C1;--shiki-dark:#569CD6">ecx</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">call</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> ds</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">:GlobalAlloc</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">mov</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  esi</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, </span><span style="color:#81A1C1;--shiki-dark:#569CD6">eax</span><span style="color:#616E88;--shiki-dark:#6A9955"> ; 此时esi存储的就是v5</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">test</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> esi</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, </span><span style="color:#81A1C1;--shiki-dark:#569CD6">esi</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">jz</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">   short loc_42DCC6 </span><span style="color:#616E88;--shiki-dark:#6A9955">; if (!v5) return 0;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">; 从这里开始覆盖</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">; 从esi向edi复制ecx字节，通过rep movsb调用</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">push</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> esi</span><span style="color:#616E88;--shiki-dark:#6A9955">                   ; 56</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">mov</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  edi</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, </span><span style="color:#81A1C1;--shiki-dark:#569CD6">esi</span><span style="color:#616E88;--shiki-dark:#6A9955">              ; 89 F7</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">mov</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  esi</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, [</span><span style="color:#81A1C1;--shiki-dark:#569CD6">esp</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">+</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">010h</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">+arg_0] </span><span style="color:#616E88;--shiki-dark:#6A9955">; 8B 74 24 14</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">mov</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  ecx</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, [</span><span style="color:#81A1C1;--shiki-dark:#569CD6">esp</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">+</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">010h</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">+arg_4] </span><span style="color:#616E88;--shiki-dark:#6A9955">; 8B 4C 24 18</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">rep</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">  movsb</span><span style="color:#616E88;--shiki-dark:#6A9955">                 ; F3 A4</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">pop</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  esi</span><span style="color:#616E88;--shiki-dark:#6A9955">                   ; 5E</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">mov</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  eax</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">, </span><span style="color:#81A1C1;--shiki-dark:#569CD6">esi</span><span style="color:#616E88;--shiki-dark:#6A9955">              ; 89 F0</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">pop</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  edi</span><span style="color:#616E88;--shiki-dark:#6A9955">                   ; 5F</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">pop</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  esi</span><span style="color:#616E88;--shiki-dark:#6A9955">                   ; 5E</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">pop</span><span style="color:#81A1C1;--shiki-dark:#569CD6">  ebx</span><span style="color:#616E88;--shiki-dark:#6A9955">                   ; 5B</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">retn</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0Ch</span><span style="color:#616E88;--shiki-dark:#6A9955">                   ; C2 0C 00</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">nop</span><span style="color:#616E88;--shiki-dark:#6A9955">                        ; 90</span></span></code></pre><p>如此修改之后，IDA 也能认出它是 <code>memcpy</code> 了：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1285*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/856f5cb1eff39b46dc67a3503794702f/3jvhOwjP.webp" data-src="https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRnIAAABXRUJQVlA4IGYAAACwBACdASogABYAPrVOnkuiktIUBqhwC0SzgGVnr/bf4B8wmRn+4/0VnHnrBnAAAP7v+jRUTVcaRw+UH88rGLgfwtwQZNyPmoVVtWEcnTVliQi7p2KfkV0/R4rJUZeGCGbHApi2AAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png"                                                                                            >                        </noscript>                    </figure>                <p>实际运行测试一下，主程序也能正常读取重新封过的去掉了加密的数据包。这样对于汉化来说最大的阻碍就解决了。</p><h1 id="修改编码和字体"><a href="#修改编码和字体" class="headerlink" title="修改编码和字体"></a>修改编码和字体</h1><p>前面也提过，主程序使用的是 Shift-JIS 编码，汉化的话就需要改成 GBK 编码。创建字体使用的是 <a href="https://learn.microsoft.com/zh-cn/windows/win32/api/wingdi/nf-wingdi-createfonta"><code>CreateFontA</code></a>，其中参数 <code>DWORD iCharSet</code> 就是用来设定编码的。<code>sub_4257B0</code> 调用了这个函数：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1208*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/9773ddbb20ca142eccefe7c5fb992f35/Kx1PkFg2.webp" data-src="https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRoQAAABXRUJQVlA4IHgAAADQBACdASogABgAPrVSok0kiUoCADgFolnAMHs2r/9t/gHzCj5ZhrMIJLHJdJj9AAD+7/o0MrCyWREsF5C6fktBXkLyA8FiiS61mzWcZQ7+lrTOr337r2cMgLDKPD7q8KqSJk8dbTd6Udl19q0tI9fXgGRw3ZgAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png"                                                                                            >                        </noscript>                    </figure>                <p>中间的 <code>0x80 (SHIFTJIS_CHARSET)</code> 需要改成 <code>0x86 (GB2312_CHARSET)</code>。由于还没有修改游戏脚本，所以这个时候进入游戏会看到把 Shift-JIS 编码的文本当成 GBK 编码而出现的乱码。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/640*480),480px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/15/ef74850433873e0573027bee07b1c579/5fLB8hWl.jpg" data-src-webp="https://p.sda1.dev/15/fa3d3827d331b42389c039f95f72dcdd/6p5Tgmx0.webp" data-src="https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRuoAAABXRUJQVlA4IN4AAACQBQCdASogABgAPrVSok0micoCADgFoliALEe3Wk5JNtGaaqAh71THLcsUgypxl2j34bA3AAD+7E1f6pgl0U9xEEAsSVpua2QZublFTD2HsKNHHQklIZu4QZWJATzfp92P0r1MzMolsdjDvolhIrS52SBb1cSxnHL37WSa67Pp7sEFQl9DmdUjrGyDnK/F+4js2M+KSN0NIQ+/XxZe15m/6WIr8BnuCGGZKOX9c9t77fdUPYgGhvwZyDJyiRJ32dSwtRAHxxdG9kltN9dL1ahj4K6dj0Ac2T66LvKsAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg"                                                                                            >                        </noscript>                    </figure>                <p>有些游戏不仅需要改编码，还会进行<a href="https://github.com/Inori/FuckGalEngine/blob/master/_general_tools/%E8%BE%B9%E7%95%8C%E6%A3%80%E6%B5%8B.txt">字符边界检查</a>，保证文本数据的每个字节都在 Shift-JIS 的范围内。不过幡紫龙没有添加边界检查。</p><p>另外，原来的无衬线体在这里变成了宋体，这也是因为修改了编码后就无法找到字体了。在这里下断点可以找到使用的字体名称：</p><ul><li><code>.rdata:0046EF88</code> <code>82 6C 82 72 20 82 6F 96 BE 92 A9</code>（Shift-JIS 编码的“ＭＳ Ｐ明朝”）</li><li><code>.rdata:0046EF94</code> <code>82 6C 82 72 20 82 6F 83 53 83 56 83 62 83 4E</code>（Shift-JIS 编码的“ＭＳ Ｐゴシック”）</li><li><code>.rdata:0046EFA4</code> <code>82 6C 82 72 20 96 BE 92 A9</code>（Shift-JIS 编码的“ＭＳ 明朝”）</li><li><code>.rdata:0046EFB0</code> <code>82 6C 82 72 20 83 53 83 56 83 62 83 4E</code>（Shift-JIS 编码的“ＭＳ ゴシック”）</li></ul><p>分别改成 GBK 编码的“宋体” <code>CB CE CC E5</code> 和“黑体” <code>BA DA CC E5</code>。</p><p>类似地，可以通过搜索调用 <code>CreateWindowExA</code> 的地方和断点调试找到窗口标题的位置：<code>.rdata:0046D464</code> <code>94 A6 8E 87 97 B3 20 81 60 82 CE 82 F1 82 B5 82 E8 82 E3 82 A4 81 60</code> （Shift-JIS 编码的“幡紫竜 〜ばんしりゅう〜”），改成 GBK 编码的“幡紫龙” <code>E1 A6 D7 CF C1 FA</code>。</p><p>之后就是修改脚本、改图嵌字之类的和主程序修改无关的琐碎工作了。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/110299012">Pixiv ID: 110299012 「:p」 by 白河</a></p></blockquote>]]></content>
    
    
    <summary type="html">因为似乎没有人做过就试试看了…_φ(･ω･` )</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>在 Windows 下检测深色模式并监听变化</title>
    <link href="https://akarin.dev/2023/03/29/detect-dark-theme-on-windows/"/>
    <id>https://akarin.dev/2023/03/29/detect-dark-theme-on-windows/</id>
    <published>2023-03-29T13:50:12.000Z</published>
    <updated>2022-03-29T13:50:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近几年很多应用都加入了深色模式，或者叫暗黑模式，英文的写法是 Dark Theme 或 Dark Mode。一般的说法是，深色模式对于 OLED 屏幕可以达到省电的效果，在夜晚等较暗的环境下使用深色模式可以保护视力。保护视力这一点其实还存在争议，有些理论表示人类的视觉本来就偏向于前暗后亮，因此使用深色模式反而会影响阅读效率并且更容易导致疲劳。不过我自己的感受是在夜晚使用深色模式不至于被屏幕上很亮的一大片亮瞎眼睛，从这个体验来说使用深色模式还是有着一定的意义的。</p><p>之前出于自己的需求用 Python 和 Tkinter 给图片放大工具 Real-ESRGAN 做了一个 <a href="https://github.com/TransparentLC/realesrgan-gui">GUI</a>，选择了 <a href="https://github.com/rdbende/Sun-Valley-ttk-theme">Sun-Valley-ttk-theme</a> 这个非常符合 Windows 11 的设计风格的主题，正好发现它同时提供了浅色和深色模式的主题，就打算借用这个在自己做的 GUI 里也加入深色模式的支持了。</p><p>首先需要解决的问题是：如何检测当前是否正在使用深色模式？</p><p>如果用的是 Qt 之类的大而全的 GUI 框架，这种功能说不定都<a href="https://forum.qt.io/topic/130589">已经封装好了</a>，不过 Tkinter 是没有这种功能的。还好，有人写了一个叫 <a href="https://github.com/albertosottile/darkdetect">Darkdetect</a> 的包，可以跨平台（Windows、Linux 和 macOS）检测系统是否启用了深色模式，使用 <code>darkdetect.isDark()</code> 就可以了。</p><p>不过如果只是推荐一个包的话我就不会特地写这个了（笑），那么 Darkdetect 又是怎么实现检测的呢？在 Windows 下，设置里“个性化→颜色→选择模式→选择默认应用模式”就是是否使用深色模式的选项，底层的记录则是注册表里 <code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize</code> 的 <code>DWORD</code> 类型的键 <code>AppsUseLightTheme</code>。从名字就可以看出来，值为 <code>0</code> 表示使用深色模式，值为 <code>1</code> 表示不使用深色模式。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1113*509),509px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/DsUux8mF.webp" data-src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/pWt1NPyu.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRnYAAABXRUJQVlA4IGoAAAAwAwCdASogAA8APrVInkoENgEAHALRLOAACjhGqUPEgWAAAP7qGeZjrDJPm51uQEymCpNL/s4uVDpfRR+GF8l9tagq4XQ3TgwJ/g9R6KP9hlWSWuc3cFMD5xIGAhyr6fmzK3rJebHxXRwA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/pWt1NPyu.png"                                                                                            >                        </noscript>                    </figure>                <p>通过读取注册表就可以实现检测了。Python 自带的 <a href="https://docs.python.org/zh-cn/3/library/winreg.html"><code>winreg</code></a> 模块可以用来读写注册表，其他语言的话也总有读取注册表的办法，实在没有的话直接用 Windows API 也不是不可以（</p><p>以前我写过一个简单的 PowerShell 脚本，功能就是读取和写入 <code>AppsUseLightTheme</code> 来快速切换深色模式，借助计划任务就可以实现每天早上和晚上的定时切换了，后来发现了 <a href="https://github.com/AutoDarkMode/Windows-Auto-Night-Mode">Auto Dark Mode</a> 这个小工具就转而使用它了。</p><p>检测深色模式的问题解决了，现在可以实现在系统使用深色模式的情况下打开那个 GUI 就选择使用深色模式的主题了，不过还有一个问题：在切换深色模式的设置时，GUI 还不能根据跟着自动切换主题。</p><p>Darkdetect（当时）还不支持监听深色模式的设置变化，有人<a href="https://github.com/albertosottile/darkdetect/issues/14">提议添加这个功能</a>，但是对于怎么实现大家也没什么头绪。如果在 Google 上搜索“检测深色模式”的话，搜索结果基本上都是<strong>前端开发</strong>相关的，教你用 CSS 的 <code>@media (prefers-color-scheme: dark)</code> 检测深色模式以及用 JS 的 <code>matchMedia(&#39;(prefers-color-scheme: dark)&#39;).addEventListener(&#39;change&#39;, e =&gt; e.matches)</code> 来监听变化的各种教程；如果搜索“windows detect dark mode change”的话，也基本上只能搜索到怎么“detect”，没什么和“change”有关的东西。</p><p>如果 GUI 用的是 Electron 之类的使用 Webview 的方案自然就可以把前端开发的那一套直接拿来用了，但是不使用浏览器的话要怎么办？总不能每秒轮询一次吧？浏览器已经能实现深色模式的监听了，它是怎么实现的呢？</p><p>Chromium 是开源的浏览器内核，于是我就试着去翻了 Chromium 的源代码，用前面提过的 <code>AppsUseLightTheme</code> 作为关键词搜索，还真的翻到了几个相关的函数：</p><ul><li><code>ui/native_theme/native_theme_win.cc</code> 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:ui/native_theme/native_theme_win.cc;l=1581;drc=8101d6d81854e4f437e0f03f77694a01aaa8df7a">NativeThemeWin::UpdateDarkModeStatus</a>，这个函数是用来检测深色模式的，读取的就是注册表的 <code>AppsUseLightTheme</code>。</li><li><code>ui/native_theme/native_theme_win.cc</code> 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:ui/native_theme/native_theme_win.cc;l=1569;drc=8101d6d81854e4f437e0f03f77694a01aaa8df7a">NativeThemeWin::RegisterThemeRegkeyObserver</a>，就在上一个函数旁边，从名字就可以看出，功能是通过检测注册表的改变来实现对深色模式的监听。</li><li><code>base/win/registry.cc</code> 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:base/win/registry.cc;l=74;drc=8101d6d81854e4f437e0f03f77694a01aaa8df7a">RegKey::Watcher::StartWatching</a>，用来实现“检测注册表的改变”。</li></ul><p>翻了 <code>RegKey::Watcher::StartWatching</code> 的源代码才知道，原来 Windows API 里提供了 <a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regnotifychangekeyvalue"><code>RegNotifyChangeKeyValue</code></a> 这个函数可以在注册表更改时进行通知。如果用它检测 <code>AppsUseLightTheme</code> 的更改，就可以实现深色模式的监听了。</p><p>用 C 写了一个简单的示例：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#5E81AC;font-weight:bold;--shiki-dark:#C586C0;--shiki-dark-font-weight:inherit">#</span><span style="color:#81A1C1;--shiki-dark:#C586C0">pragma</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> comment</span><span style="color:#5E81AC;--shiki-dark:#569CD6">(</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">lib</span><span style="color:#5E81AC;--shiki-dark:#569CD6">, </span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Advapi32.lib</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#5E81AC;--shiki-dark:#569CD6">)</span></span><span class="line"></span><span class="line"><span style="color:#5E81AC;font-weight:bold;--shiki-dark:#C586C0;--shiki-dark-font-weight:inherit">#</span><span style="color:#81A1C1;--shiki-dark:#C586C0">include</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> &#x3C;</span><span style="color:#8FBCBB;--shiki-dark:#CE9178">stdio.h</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">></span></span><span class="line"><span style="color:#5E81AC;font-weight:bold;--shiki-dark:#C586C0;--shiki-dark-font-weight:inherit">#</span><span style="color:#81A1C1;--shiki-dark:#C586C0">include</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> &#x3C;</span><span style="color:#8FBCBB;--shiki-dark:#CE9178">windows.h</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">></span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">int</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> main</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">int</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> argc</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> const</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> char</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> *</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">argv</span><span style="color:#81A1C1;--shiki-dark:#569CD6">[]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    HKEY hKey</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    RegOpenKeyExA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">HKEY_CURRENT_USER</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">SOFTWARE</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\\</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Microsoft</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\\</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Windows</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\\</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">CurrentVersion</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\\</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Themes</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\\</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Personalize</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> KEY_NOTIFY </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">|</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> KEY_READ</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">hKey</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    DWORD dwSize </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> sizeof</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">DWORD</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    DWORD queryValueLast</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    DWORD queryValue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    RegQueryValueExA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">hKey</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">AppsUseLightTheme</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NULL</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NULL</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">LPBYTE</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x26;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">queryValueLast</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">dwSize</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    while</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">TRUE</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">        RegNotifyChangeKeyValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">hKey</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> TRUE</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> REG_NOTIFY_CHANGE_LAST_SET</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NULL</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> FALSE</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">        RegQueryValueExA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">hKey</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">AppsUseLightTheme</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NULL</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NULL</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">LPBYTE</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x26;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">queryValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">dwSize</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">queryValueLast </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> queryValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            queryValueLast </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> queryValue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">            puts</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">queryValue </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Light</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> :</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Dark</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    return</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>在运行到 <code>RegNotifyChangeKeyValue</code> 这里的时候会一直阻塞，直到注册表的值改变为止，然后读取 <code>AppsUseLightTheme</code> 的值检查深色模式的设置是否有变化，如果有则输出当前的主题。这个监听是死循环，实际使用的时候单独开一个线程就可以了。效果如下：</p><video poster="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/UDGCaVKn.jpg" controls preload="metadata">    <source src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/6xRqEH2a.mp4" type="video/mp4; codecs=av01.0.09M.10">    <source src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/gyqOVFFf.mp4" type="video/mp4; codecs=avc1.640033"></video><p>发现这个之后顺便就给 Darkdetect 提交了一个 <a href="https://github.com/albertosottile/darkdetect/pull/20">Pull request</a>，因为原作者希望使用纯 Python 代码，后来使用 <code>ctypes</code> 进行了<a href="https://github.com/albertosottile/darkdetect/blob/64ce54e20be54cc41f85c8c208d35a4137b958d3/darkdetect/_windows_detect.py#L82">改写</a>。</p><p>与此同时还发现了 Linux 下的监听方法，于是也写进了 Pull request，具体做法可以参见<a href="https://github.com/albertosottile/darkdetect/blob/64ce54e20be54cc41f85c8c208d35a4137b958d3/darkdetect/_linux_detect.py#L38">当时提交的代码</a>，这里就不详细介绍了。我没有使用 macOS 的设备，所以当时没有添加 macOS 下的实现，不过这个后来也有人<a href="https://github.com/albertosottile/darkdetect/blob/64ce54e20be54cc41f85c8c208d35a4137b958d3/darkdetect/_mac_detect.py">补充</a>了。</p><p>“很惭愧，做了一点微小的工作，谢谢大家！”</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/96300365">Pixiv ID: 96300365 「温かいコーヒーどうぞ！」 by チノマロン</a></p></blockquote>]]></content>
    
    
    <summary type="html">之前在折腾某个开源项目时想到要记下来的东西，结果一直鸽到网站都长草了才写出来……</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>使用浏览器扩展在运行 Selenium 的 Firefox 浏览器中伪装 navigator.webdriver</title>
    <link href="https://akarin.dev/2022/02/15/disable-geckodriver-detection-with-addon/"/>
    <id>https://akarin.dev/2022/02/15/disable-geckodriver-detection-with-addon/</id>
    <published>2022-02-15T15:23:29.000Z</published>
    <updated>2022-02-15T15:23:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题的背景"><a href="#问题的背景" class="headerlink" title="问题的背景"></a>问题的背景</h1><p>出于某些需求，我最近使用 Python 的 Selenium 模块，配合自动控制 Firefox 浏览器的 Geckodriver，编写和部署了一个自动完成某网站登录界面上的滑动验证码的服务。虽然这些验证码的宣传词上少不了“大数据”、“人工智能”、“高效拦截机器行为”之类的关键词，但是从现在在网上可以轻易搜索到的至少 114514 篇“○○滑动验证码破解”的文章来看，只要解决“寻找验证码缺口”和“拟合轨迹”这两个问题（当然，需要一些简单的图像处理和数学方面的知识），绝大多数的滑动验证码还是不堪一击的。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1270*789),789px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/6632f9cf9d6eacf4ac2b66f7becfe9c0/y8umq8Zl.webp" data-src="https://p.sda1.dev/12/f4d2a22d9c0696bbde4794e998b83c1c/V8mys-b3.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRmQAAABXRUJQVlA4IFgAAAAQBACdASogABQAPq1ImkmKSWwDADAFYlpAABb7TpLTizoRwwmZDMl0AAD+4av0jcwq55fLrnz9JhlYCu9QHAlYzVfKJHVIm/PI2nH7v7W8ag6P30EAAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/f4d2a22d9c0696bbde4794e998b83c1c/V8mys-b3.png"                                                                                            >                        </noscript>                    </figure>                <p>本来想在这里放上我编写的那个服务自动完成验证码的录屏，但是由于那里的验证码背景图可以暴露被我模拟登录的网站的信息，所以还是算了。作为替代，这里就放一张我当时写的几个拟合滑动轨迹的多项式函数图像吧 (*°∀°)&#x3D;3</p><p>那个服务正常运行了大半个月，累计差不多模拟完成了一两百次滑动验证码，但是今天这个服务突然就无法正常使用了，到底是怎么回事呢？</p><h1 id="基本的检测和伪装原理"><a href="#基本的检测和伪装原理" class="headerlink" title="基本的检测和伪装原理"></a>基本的检测和伪装原理</h1><p>根据大量的控制变量法和排除法分析，确定是由于 Selenium 控制的浏览器中存在的 <code>navigator.webdriver</code> 属性被检测到导致无法完成滑动验证码。这是个检查自动操作从而进行反爬的好方法，在正常的浏览器中这个属性的值为 <code>undefined</code>（在较新的浏览器里则为 <code>false</code>），如果浏览器被 Selenium 之类的工具自动控制的话则为 <code>true</code>。为了让服务可以继续运行，就有必要对它进行伪装了。</p><p>首先上一段最简单的代码，在配置好 Selenium 和 Geckodriver 之后就可以调用 Firefox 打开 <a href="https://bot.sannysoft.com/">https://bot.sannysoft.com/</a>，这是一个可以展示浏览器属性，同时标出哪些属性可能会被检查为自动控制的浏览器的网站。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> time</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> selenium </span><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">driver </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">Firefox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">driver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">get</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://bot.sannysoft.com/</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># driver.execute_script('delete navigator.__proto__.webdriver')</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">try</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    while</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> True</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        time</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">sleep</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">except</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> KeyboardInterrupt</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    driver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">quit</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span></code></pre><p>根据 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/webdriver">MDN 上的介绍</a>，<code>navigator.webdriver</code> 是个只读属性，所以不能通过覆盖值的方式来伪装。但是如果你稍微提高了一点姿势水平，就会知道可以通过重写这个属性的 getter 来把它覆盖掉。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">Object</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">defineProperty</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">navigator</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">webdriver</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    get</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> ()</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#81A1C1;--shiki-dark:#569CD6"> undefined</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>虽然确实可以覆盖，但是这个伪装行为本身还是可以被检查出来。只要执行上面的代码添加了 getter，执行 <code>navigator.hasOwnProperty(&#39;webdriver&#39;)</code> 就会返回 true，未执行则不返回。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1281*459),459px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/fa1ab90b8df3cb7ff41d811aa6ba91b2/p3ZGtrin.webp" data-src="https://p.sda1.dev/12/a7ca5b799a686520c9873f951abfaf59/QPt9p1D6.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRloAAABXRUJQVlA4IE4AAADwAgCdASogAAsAPrVInkokiGwCADgFolpAABd8IQgq8AD+9iuBVQGpHmUFOFoPkS59C2btY7d8H9A01eWdV9spql8DzJ9XTZsmEX8kAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/a7ca5b799a686520c9873f951abfaf59/QPt9p1D6.png"                                                                                            >                        </noscript>                    </figure>                <p>所以，另一种更好的做法是直接在原型链上把属性删除掉。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">delete</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> navigator</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">__proto__</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">webdriver</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>只是知道这一点还不够，虽然 Selenium 提供了执行任意 JavaScript 代码的功能，但当你有机会执行的时候整个页面已经加载和执行完了。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1286*755),755px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/697f35aca41f557caa386e7a0042fbad/j7ivAzXi.webp" data-src="https://p.sda1.dev/12/faf095fe068ccd6fd3c629d349d0ca9c/3qmW7XVi.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRowAAABXRUJQVlA4IIAAAADQAwCdASogABMAPrVInUmE9gEAHALRLEAZQAR9rlWOXNOz/nwtTEAA/vYiXXRGOmNvOZ//13m639+jbkwIuzGk4SFIUhgLE+zXA/EoUvX0CGMq3ln1yF00XYKX82yDNlVdSDtzbSN+ummeGQFvb0tZy4sEBBQupnZuvw0tnwAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/faf095fe068ccd6fd3c629d349d0ca9c/3qmW7XVi.png"                                                                                            >                        </noscript>                    </figure>                <p>“Chrome”那一项检查的是 <code>window.chrome</code>，只有使用 Chrome 才会出现，因为现在使用的是 Firefox 所以没有这个属性是正常的。另外如果使用 Selenium 或 Puppeteer 调用 Chrome 的话 User-Agent 里会写上 <code>HeadlessChrome</code> 的字样从而被检查出来，不过把上面的 JS 代码稍微修改一下也可以很容易伪装。对于其他属性的检查结果也可以自行与非自动控制的浏览器对照。</p><p>看到那个“WebDriver: present (failed)”了吗？虽然现在去控制台检查可以发现伪装已经生效了，但是在加载页面的时候还没有执行伪装的 JS 代码，所以 <code>navigator.webdriver</code> 还是被检查出来了（实际的检查代码是 <code>navigator.webdriver || _.has(navigator, &quot;webdriver&quot;)</code>，后者使用 Lodash 等效于使用 <code>hasOwnProperty</code> 检查）。所以现在的问题就变成了如何在页面加载前就运行伪装的 JS 代码，如果无法做到的话，那还是另请高明吧！无论如何，只要把 <code>navigator.webdriver</code> 处理成一个 falsy 的值就可以了。</p><h1 id="已有的伪装方法"><a href="#已有的伪装方法" class="headerlink" title="已有的伪装方法"></a>已有的伪装方法</h1><p>在 Google 上搜索了 1919 篇资料（大雾）后，我总结了几个目前已有的伪装方法，分别对应了上面的两种思路。</p><h2 id="使用浏览器运行参数和配置进行伪装"><a href="#使用浏览器运行参数和配置进行伪装" class="headerlink" title="使用浏览器运行参数和配置进行伪装"></a>使用浏览器运行参数和配置进行伪装</h2><p>在浏览器的启动参数里添加 <code>--disable-blink-features=AutomationControlled</code>，然后在配置的 <code>excludeSwitches</code> 添加 <code>enable-automation</code>，就可以隐藏 <code>navigator.webdriver</code> 了。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> selenium </span><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">options </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">ChromeOptions</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">options</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">add_argument</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">--disable-blink-features=AutomationControlled</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">options</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">add_experimental_option</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">excludeSwitches</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">enable-automation</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">options</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">add_experimental_option</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">useAutomationExtension</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> False</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">driver </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">Chrome</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">options</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">options</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">driver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">get</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://example.com</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span></code></pre><p>这几个参数和配置在网上广泛流传，但是这是 Chrome 限定的方法，因为我不使用 Chrome 所以没有实际测试过。Firefox 是不吃这一套的。</p><p>使用 Firefox 的话，需要把配置里的 <code>dom.webdriver.enabled</code> 设为 <code>false</code>：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> selenium </span><span style="color:#81A1C1;--shiki-dark:#C586C0">import</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">profile </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">FirefoxProfile</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">profile</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">set_preference</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">dom.webdriver.enabled</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> False</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">driver </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> webdriver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">Firefox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">firefox_profile</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">profile</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span></code></pre><p>遗憾的是，从 Firefox 88 开始，这个配置项也被移除了。<code>navigator.webdriver</code> 的值，最终还是要按照 W3C 的基本法，选举法……去产生，所以 Firefox <a href="https://github.com/mozilla/geckodriver/issues/1680">不会加入直接影响这些属性的方法</a>（据说 Chrome 的那几个参数也被移除了）。</p><p>把 Firefox 的版本锁死在 87，并关闭自动更新，虽然可以解决问题，但是我们不能忘记某车务段拒绝将内部信息系统适配最新版本的操作系统而是死守旧版本结果闹出“人人都是高手”笑话的惨痛教训。我个人认为，<strong>在项目的初始阶段就重度依赖被废弃的功能并且为此固守旧版本，这是一种非常简单粗暴不负责任的解决方案</strong>。</p><h2 id="使用-Chrome-DevTools-Protocol-执行-JS-代码"><a href="#使用-Chrome-DevTools-Protocol-执行-JS-代码" class="headerlink" title="使用 Chrome DevTools Protocol 执行 JS 代码"></a>使用 Chrome DevTools Protocol 执行 JS 代码</h2><p>通过 Chrome DevTools Protocol 的命令就可以很容易地添加在打开网页前就会执行的 JS 代码了。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">driver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">execute_cdp_cmd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Page.addScriptToEvaluateOnNewDocument</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">source</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">delete navigator.__proto__.webdriver</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;)</span></span></code></pre><p>但是 Firefox 也不支持这种操作，毕竟这是 Chrome DevTools Protocol 而不是 Firefox DevTools Protocol……</p><p>那为什么不用 Chrome 呢？作为 Firefox 的忠实用户我怎么可能会这么做 ( ‘-‘ )ノ)&#96;-‘ )</p><p>实际上是因为我不想为了调试这个就特地装一个 Chrome。虽然用 Selenium 的人一般都是用 Chrome，Firefox 在这方面似乎有点小众……</p><h2 id="使用油猴脚本执行-JS"><a href="#使用油猴脚本执行-JS" class="headerlink" title="使用油猴脚本执行 JS"></a>使用油猴脚本执行 JS</h2><p>我们日常使用 Firefox、Chrome、Edge 这些现代浏览器的时候，一般都会安装许多实用的油猴脚本（如果你还没听说过油猴脚本的话，有必要进一步提高一下自己上网冲浪的水平）。油猴脚本本质上是一个 JS 文件，在打开特定网页时会自动运行，从而将自定义的功能加入到网页中。</p><p>默认情况下，油猴脚本会在 <code>DOMContentLoaded</code> 后运行，这个时候网页也已经加载完成了。通过在脚本前面的配置中添加 <code>@run-at document-start</code> 就可以使脚本在网页加载前运行，于是可以将上面的伪装用 JS 代码编写成一个简单的油猴脚本（这里还是使用修改 getter 的方法）：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// ==UserScript==</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// @name         Hide navigator.webdriver</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// @match        *://*</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// @run-at       document-start</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// ==/UserScript==</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    Object</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">defineProperty</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">navigator</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">webdriver</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">        get</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> ()</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#81A1C1;--shiki-dark:#569CD6"> undefined</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>如果你日常使用的浏览器有安装运行油猴脚本的扩展的话，可以做一个小实验：添加上面的脚本，把 <code>undefined</code> 改为 <code>true</code>，再打开 <a href="https://bot.sannysoft.com/">https://bot.sannysoft.com/</a>，就可以发现 <code>navigator.webdriver</code> 被成功地“反向”伪装了。</p><p>Selenium 控制的 Firefox 浏览器是可以添加扩展的，我们可以预先下载好 Tampermonkey 或 Violentmonkey 这两个油猴脚本扩展之一的 XPI 文件，然后在启动浏览器时加载。但是，如何使用 Selenium 在扩展中自动添加上面的油猴脚本，我暂时还没有找到什么简单的方法。已知的方法是自己在本地做一份安装了油猴脚本扩展及伪装脚本的 profile，然后在 Selenium 启动浏览器时读取，不过部署的时候如果还要把整个 profile 复制来复制去还是会比较麻烦。</p><h1 id="简单优雅的解决方案：使用浏览器扩展在-Firefox-中完成伪装"><a href="#简单优雅的解决方案：使用浏览器扩展在-Firefox-中完成伪装" class="headerlink" title="简单优雅的解决方案：使用浏览器扩展在 Firefox 中完成伪装"></a>简单优雅的解决方案：使用浏览器扩展在 Firefox 中完成伪装</h1><p>虽然使用油猴脚本的方式比较麻烦，但它还是给我提供了一种思路。既然可以为浏览器添加扩展，我们可以自己编写一个简单的浏览器扩展来实现 <code>navigator.webdriver</code> 的伪装。之所以说这个方法简单优雅，是因为浏览器扩展是一个不会被轻易废弃的功能，而且我们实际上并不需要额外做很多复杂的工作。</p><p>Firefox 的扩展使用 XPI 的扩展名，本质上是一个 ZIP 格式的压缩包，方便起见也可以跳过这一步而是直接让浏览器从文件夹中加载扩展。不过开发 XPI 扩展的中文资料似乎不是很多，我直接简单参考了 MDN 上的<a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions">浏览器扩展入门</a>的<a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">“你的第一个扩展”</a>章节，这里的知识对于快速了解基本概念来说已经足够了。</p><p>我们的浏览器扩展只需要包含记录扩展元数据的 <code>manifest.json</code> 和运行伪装代码的 <code>main.js</code> 而已。对于前者，只需要写上基本的信息就可以了：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">manifest_version</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // 扩展的名称，在这里可以随意填写</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">name</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">webdriver-cleaner</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">version</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">1.0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // 由于我们需要在网页的运行环境下进行修改，因此需要使用内容脚本</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">    "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">content_scripts</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">            // 使脚本在网页加载前运行</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">run_at</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">document_start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">            // 这个脚本会在打开所有网页时执行</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">            // 也可以设定成&#x3C;all_urls></span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">matches</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">*://*/*</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">            // 需要执行的JS文件，如果有多个则会按顺序执行</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">            "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">js</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">main.js</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    ]</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>由于安全性上的考虑，扩展的运行环境和网页的运行环境是隔离的，不能直接互相修改和通信，具体可以参考<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Sharing_objects_with_page_scripts">MDN 上的这篇教程</a>，不过我暂时还没完全看懂……正好有个经常使用的扩展“User-Agent Switcher”实现的是对 <code>navigator.userAgent</code> 的修改，我参考了它的<a href="https://gitlab.com/ntninja/user-agent-switcher/-/blob/master/content/override-navigator-data.js">修改部分的源代码</a>写出了 <code>main.js</code> 的代码。核心部分还是只有那一行，由于环境隔离所以稍有修改：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">delete</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> window</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">navigator</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wrappedJSObject</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">__proto__</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">webdriver</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">navigator.webdriver cleaned:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> window</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">navigator</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wrappedJSObject</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">webdriver</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>在使用浏览器打开页面前，不要忘记加载这个扩展。正式发布的扩展需要进行签名，由于现在略过了这一步，所以扩展只能以临时的方式加载。加载的路径可以是扩展所在的文件夹或打包后的 XPI 文件的绝对路径，为了方便修改我就跳过打包过程了。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">driver</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">install_addon</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">os</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">path</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">realpath</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">webdriver-cleaner</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">),</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> temporary</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#81A1C1;--shiki-dark:#569CD6">True</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span></code></pre>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1286*1006),1006px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/abbcbc9392be5c95fdce1c83881cc1ce/qqW9HvhO.webp" data-src="https://p.sda1.dev/12/f6f54f768ca25c7eb54c9fd2c85fbb8f/hFAqOO0a.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRr4AAABXRUJQVlA4ILIAAADwBQCdASogABkAPrVKnUmmiOwCADgFolAF2QkMT/uQD4SwMZM486SYvUH02OCzgxxzKmmm9fHNAAD+9QT7uuI3aWU5TonDhfOvPoNH8/uIiy29qnuK/oHQ/GL26pLPcw525Bvgy0r2T2nutO5yExc6f81XlU72XWERl8BW0zU+z7k9kKvyDSIkOKdS/w2HvRe0jfQLRMkNGjrt2iH4r6hFCsjnTjtxR3cU0HyLOjp7AAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/f6f54f768ca25c7eb54c9fd2c85fbb8f/hFAqOO0a.png"                                                                                            >                        </noscript>                    </figure>                <p>伪装并没有被发现……好耶！通过测试啦！(〃′▽&#96;)</p><p><del>或许还可以换一个营销号浓度极高的标题：《爬虫必备！只需要一行代码，我再也不用害怕 Selenium Firefox 被发现啦！》</del></p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/96029592">Pixiv ID: 96029592 「リゼシャロ冬のデート」 by stick_jitb</a></p></blockquote>]]></content>
    
    
    <summary type="html">又名：《爬虫必备！只需要一行代码，我再也不用害怕 Selenium Firefox 被发现啦！》（大雾）</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>图片渐进式加载的实现方法（以及低分辨率图像占位符 LQIP 的基本介绍）</title>
    <link href="https://akarin.dev/2021/11/04/progressive-image-loading/"/>
    <id>https://akarin.dev/2021/11/04/progressive-image-loading/</id>
    <published>2021-11-04T14:48:47.000Z</published>
    <updated>2021-11-04T14:48:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>其实这是之前自己写现在使用的这个 Hexo 主题的时候就想记下来的东西，不过一直咕到今天才写 …_φ(･ω･&#96; )</p><p>在我写主题的过程中，为了节省流量而大量地对图片使用了懒加载。而各位应该很容易就可以发现，对于文章的封面图还有个额外的“从模糊变清晰”的加载效果。</p><video poster="https://p.sda1.dev/12/e1bf7ea924102d38b4c7c21c69f0bcac/6KjPgCbt.jpg" controls>    <source src="https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/telIFazl.mp4" type="video/mp4; codecs=av01.0.05M.10">    <source src="https://s3plus.meituan.net/v1/mss_550586ef375b493da4aa79bebdfce4fa/csc-apply-file-web/prod/2021-11-03/8042b498-dca0-4752-bcc4-3b405280fdf1null" type="video/mp4; codecs=avc1.640032"></video><p>这类加载方式一般被称为渐进式加载（Progressive Loading），对于图片来说，也就是在加载的过程中先展示一部分模糊的图片，等加载完成了再展示完整的原始图片。虽然渐进式加载不能从根本上提高图片的加载速度，但是因为用户<strong>看到图片的时间提前了</strong>（虽然还不是完整图片），因此可以给用户一种“看上去加载得比较快”的错觉，而不是对着未加载时图片位置的一片空白干等，可以提升使用体验。</p><h1 id="图片格式中的渐进解码功能"><a href="#图片格式中的渐进解码功能" class="headerlink" title="图片格式中的渐进解码功能"></a>图片格式中的渐进解码功能</h1><p>现在常用的一些图片格式中都加入了渐进式解码的功能，可以在只加载了图片的部分数据的情况下显示出模糊的图像。由于是解码器直接提供支持，因此展示图片时并不需要额外的配置，只需要在保存图片时注意设置“渐进&#x2F;连续（Progressive）”或者“交错（Interlace）”之类的选项就可以了。</p><p>下面就是模拟较慢的网速下加载以相同质量压缩的非渐进式和渐进式 JPEG 图片的效果，非渐进式是像扫描仪一样从上往下逐渐显示，而渐进式就先显示了大致的轮廓，在加载过程中再逐渐变清晰，“扫描”完第二遍时就已经是可以接受的图片质量了。</p><video poster="https://p.sda1.dev/12/e554dec8a70e0b826071005fc5ee720a/waCL5uzU.jpg" controls>    <source src="https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/Qs1GK6PY.mp4" type="video/mp4; codecs=av01.0.05M.10">    <source src="https://s3plus.meituan.net/v1/mss_550586ef375b493da4aa79bebdfce4fa/csc-apply-file-web/prod/2021-11-03/8bb22ec9-43ab-4bc2-8f83-afa8bc6dd809null" type="video/mp4; codecs=avc1.640032"></video><p>如果使用 <a href="https://github.com/mozilla/mozjpeg">mozjpeg</a> 压图的话，默认就已经启用了参数 <code>-progressive</code> 启用渐进式解码，但是默认的解码方式是按顺序解码 Y、U、V 三个通道（即使用 <code>-dc-scan-opt 1</code>），效果是图片会先以黑白形式显示，再逐渐填充错误的颜色，最后变成正常的颜色，这样看上去的效果不太好，因此可以通过使用 <code>-dc-scan-opt 0</code> 改为同时加载三个通道，就可以达到上面的效果。还可以无损地将已有的非渐进式 JPEG 图片（也被称为 Baseline JPEG）转换为渐进式，文件大小稍微会小一点。</p><p>另外两个经典的图片格式 GIF 和 PNG 也支持渐进式解码，但是对这两个格式启用渐进式解码反而会使文件大小增加，实际使用也似乎不是很多。</p><p>那现代图片格式 WebP 和 AVIF 呢？遗憾的是，它们都不支持渐进式解码 ╮(╯_╰)╭</p><p>Google 已经在 WebP 的文档中表示<a href="https://developers.google.com/speed/webp/faq#does_webp_support_progressive_or_interlaced_display">不支持渐进式解码的功能</a>了。而 AVIF 最初也不支持渐进式解码，后来有人在 GitHub 上提出了相关的 <a href="https://github.com/AOMediaCodec/av1-avif/issues/102">Issue</a>，但是似乎是由于对编码格式的修改过于复杂而无法实装，作为替代有人提出了另一个 <a href="https://github.com/AOMediaCodec/libavif/issues/605">Issue</a>，通过在 AVIF 中内置缩略图来实现类似的效果，不过也没有什么进展……所以大约的确也是不行的。</p><h1 id="懒加载和“从模糊变清晰”的加载效果"><a href="#懒加载和“从模糊变清晰”的加载效果" class="headerlink" title="懒加载和“从模糊变清晰”的加载效果"></a>懒加载和“从模糊变清晰”的加载效果</h1><p>在和图片相关的优化中，懒加载其实是更有必要做的优化。毕竟渐进式的图片加载只能做到视觉上的优化，但是懒加载可是实打实地减少了 HTTP 请求数量和流量消耗。一般的懒加载是在未加载的图片的位置上放一个固定的占位图，等需要加载图片的时候再用原图替换掉，类似的还有“省流模式”，只是将加载图片的时机从出现在屏幕上变成了用户手动点击图片。总之，如果把这张占位图改成图片的缩略图之类的话，就是上面提到的“从模糊变清晰”的渐进式加载效果了。</p><p>这个缩略图有哪些要求呢？</p><ul><li>缩略图应该立即显示在页面上，如果进行了额外的加载，那么加载之前图片仍然是一片空白。</li><li>缩略图还应该尽可能地小。</li><li>如果从缩略图直接切换到原图就太生硬了，应该有个渐变的效果，可以通过将缩略图的不透明度逐渐变成 0 来实现，于是这个缩略图应该作为单独的一层覆盖到原图上。</li></ul><p>因此这个缩略图应该以 Data URL 的形式直接嵌入到页面中，并且使用几十像素的尺寸就足够了。下面就是将一个 32x18 的缩略图（大小只有 434 B）覆盖在 1280x720 的原图上的演示，点击下面的按钮可以模拟图片被加载时显示的图片从缩略图平滑过渡到原图的效果：</p><div style="position:relative">    <img id="example-0-blurred" style="position:absolute;width:100%;max-height:none;transition:opacity 1s" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQIAJQAlAAD/2wCEABcXFxcYFxocHBokJiImJDUwLCwwNVA5PTk9OVB5S1hLS1hLeWuBaWJpgWvAl4WFl8DeurC63v/w8P////////8BFxcXFxgXGhwcGiQmIiYkNTAsLDA1UDk9OT05UHlLWEtLWEt5a4FpYmmBa8CXhYWXwN66sLre//Dw///////////AABEIABIAIAMBIQACEQEDEQH/xABrAAADAQAAAAAAAAAAAAAAAAACBAUAEAACAgEEAQUAAAAAAAAAAAABAgMRAAQSITETBRRBcrEBAQEBAQAAAAAAAAAAAAAAAAQCAwERAAEDBAIDAQAAAAAAAAAAAAEAAgMEESExMoEiQUJx/9oADAMBAAIRAxEAPwCvBIXBLU1DvGoZt70XU4Gm0kSN5W9IxML6odXi04YG405+WrLqm+GAoi5ZK0KyXRPGHUEcm5dqspFnOUusqnnNh2lJi0DJ5WBDbrUnEV9QRqQIxA7JxczDLEAwjKyjcGvub4Vx+IzkrWk+z1WCpeXS0+VJ1TFoNEWJJ8bfuBB0fsMfHo/jlkdr/9k">    <img id="example-0-source" style="width:100%;max-height:none;visibility:hidden" data-src="https://p.sda1.dev/12/bece1d43a7d093583129fdc7202ca924/Fhdt09T7.jpg" data-src-webp="https://p.sda1.dev/12/04d499bac3b61e1596f370c51686c18a/d1iL6gt0.webp" data-src-avif="https://p.sda1.dev/12/3a708bab4022d35fa52f12344a6dabfb/m3nkyCIM.jpg"></div><button id="example-0-load">加载图片</button><button id="example-0-unload">恢复初始状态</button><button id="example-0-blur">切换缩略图模糊</button><!--<script>(() => {const getElementById = e => document.getElementById(e);const prefix = 'example-0-';const blurred = getElementById(prefix+'blurred');const source = getElementById(prefix+'source');const load = getElementById(prefix+'load');const unload = getElementById(prefix+'unload');const blur = getElementById(prefix+'blur');load.onclick = () => {    blurred.style.opacity = 0;    source.style.visibility = '';};unload.onclick = () => {    blurred.style.opacity = 1;    source.style.visibility = 'hidden';};blur.onclick = () => (blurred.style.filter = blurred.style.filter ? '' : 'blur(10px)');})()</script>--><script>(()=>{const e=e=>document.getElementById(e),l="example-0-",t=e(l+"blurred"),i=e(l+"source"),c=e(l+"load"),o=e(l+"unload"),s=e(l+"blur");c.onclick=()=>{t.style.opacity=0,i.style.visibility=""},o.onclick=()=>{t.style.opacity=1,i.style.visibility="hidden"},s.onclick=()=>t.style.filter=t.style.filter?"":"blur(10px)"})()</script><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">div</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> style</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">position:relative</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    &#x3C;!-- 缩略图，显示的尺寸和位置都要设定为和原图一致 --></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">img</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">        style</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">position:absolute;width:100%;transition:opacity 1s</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">        src</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">data:image/jpeg;base64,...</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    ></span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    &#x3C;!-- 原图 --></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">img</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">        style</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">width:100%</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">        src</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">https://...</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    ></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">div</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span></code></pre><p>由于浏览器缩放显示图片时默认使用的是双线性插值（除此之外只能通过修改 <code>image-rendering: pixelated</code> 设置为邻近取样，没有更好的缩放算法了），在将缩略图放大数倍时会出现明显的菱形和十字图形，比较难看。在缩略图上通过 <code>filter: blur(10px)</code> 添加模糊一定程度上可以掩盖这个问题，上面的演示中也可以通过自由切换来比较使用与不使用模糊的视觉效果区别。</p><p>但是，使用 CSS 的模糊滤镜又带来了别的问题。在演示中可以注意到，将缩略图模糊时缩略图的边缘也一起被模糊了，导致的后果就是点击“加载图片”时在边缘位置仍然是没有任何过渡地直接显示了图片，非常生硬。</p><p>如何解决呢？我首先找到了<a href="https://css-tricks.com/the-blur-up-technique-for-loading-background-images/">一篇来自 CSS-Tricks 的文章</a>，同样介绍了如何实现“从模糊变清晰”的渐进式加载效果，但是它使用了另一种不同的方法实现缩略图的模糊显示：不在 CSS 的 <code>filter</code> 中使用自带的 <code>blur</code> 模糊滤镜，而是以 SVG 滤镜的形式将模糊和修改透明度结合到一起。这个结合后的 SVG 滤镜是：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">svg</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> xmlns</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">http://www.w3.org/2000/svg</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">filter</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> id</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">$</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">        &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">feGaussianBlur</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> stdDeviation</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">10</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080"> /></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">        &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">feComponentTransfer</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">            &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">feFuncA</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> type</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">discrete</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> tableValues</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">1 1</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080"> /></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">        &#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">feComponentTransfer</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    &#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">filter</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">svg</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span></code></pre><p><code>&lt;feGaussianBlur&gt;</code> 和 CSS 自带的 <code>blur</code> 一样，表示对图片进行指定半径的模糊处理。而 <code>&lt;feComponentTransfer&gt;</code> 则是对图片的每个像素的 RGBA 通道颜色值进行映射（就像 Photoshop 里的“曲线”一样），这里的设定是将 A 通道固定为 1（范围为 0-1），也就是使整个图像变得不透明。</p><p>给这个 SVG 滤镜任意添加一个 ID（可以短到只有一个字符），然后压缩，编码成使用 URL 编码的 Data URL，再像 HTML 中使用 <code>#</code> 指向有某个 ID 的元素一样引用这个滤镜，写入到 CSS 的 <code>filter</code> 中，就可以得到下面的 CSS 代码：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#D7BA7D">filter</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">: url("</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">data</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">:image/</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">svg</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">xml</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">%3Csvg xmlns='http://www</span><span style="color:#ECEFF4;--shiki-dark:#D7BA7D">.</span><span style="color:#8FBCBB;--shiki-dark:#D7BA7D">w3</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">.org/2000/svg'%3E%3Cfilter id='$'%3E%3CfeGaussianBlur stdDeviation='9'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3C/svg%3E#$")</span></span></code></pre><p>这是目前这个主题正在对文章封面图的使用模糊方法。看上去似乎也没什么问题，但是在写这篇的时候我尝试对上面的演示中的缩略图使用，结果在图片边框出现了严重的色彩溢出现象，溢出的部分甚至还超出了图片的显示区域……</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/789*604),604px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/26eaa299c82c974e2119b6b10ef10484/mnHAu5nI.jpg" data-src-webp="https://p.sda1.dev/12/61d1a0b825f4bdae396a19d4fe77150a/fJE3y2jU.webp" data-src="https://p.sda1.dev/12/e5726043a2abe026a37a8f6aac99aaef/ShAtGwVG.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRhABAABXRUJQVlA4IAQBAABwBQCdASogABgAPrVCoEooqTErsBgMAOAWiWoAnSCUtlIIEIOAppJHDoO53LOAEGDApG0AAP73bxhwnfWFi/A/YUN+JL4K+bOb1q9m/Sw11lM1idmFIEQE6N/3ThsYdBIFl8Bq5sGayomS7QJm5VqvlP1qQIWUNAAgacrWWSgTRl1B3Tokimkdupya6QzAkkUABbcE8wOrrqkjal5RW8w5hq7xgArG81TnFL/8zx3/fn/3/DXv9IX5AAJB8Zcx6bAoG1Za1EnusLdUmn/MvERkBbX3SqzXR9iHgtTIbEkNg23wT2UZL7FF2tsnHfRXkiFzJ4DbH2VzuHBbNzSVzgpGto0MAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/e5726043a2abe026a37a8f6aac99aaef/ShAtGwVG.jpg"                                                                                            >                        </noscript>                    </figure>                <p>那为什么 CSS-Tricks 那边的使用以及对这个主题的封面图使用就没有问题呢？因为那两个情况下的图片都是通过 <code>background-image</code> 显示的，但是这里使用的是 <code>&lt;img&gt;</code>，稍微有点区别。至于为什么在 <code>&lt;img&gt;</code> 中使用就会在显示区域之外出现色彩溢出的部分，我也无法解释…… (;-_-)</p><p>后来我又找到了一个 <a href="https://stackoverflow.com/questions/20443283#answer-48095387">Stack Overflow 上的回答</a>，给出了另一个 SVG 模糊滤镜：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">svg</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> xmlns</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">http://www.w3.org/2000/svg</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">filter</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> id</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">$</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">        &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">feGaussianBlur</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> stdDeviation</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">10</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080"> /></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">        &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">feColorMatrix</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> type</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">matrix</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> values</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">1 0 0 0 0, 0 1 0 0 0, 0 0 1 0 0, 0 0 0 9 0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080"> /></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">        &#x3C;</span><span style="color:#81A1C1;--shiki-dark:#569CD6">feComposite</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> in2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">SourceGraphic</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE"> operator</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">in</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#808080"> /></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">    &#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">filter</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#808080">&#x3C;/</span><span style="color:#81A1C1;--shiki-dark:#569CD6">svg</span><span style="color:#81A1C1;--shiki-dark:#808080">></span></span></code></pre><p><code>&lt;feColorMatrix&gt;</code> 是使用变换矩阵处理每个像素的 RGBA 通道颜色值，上面的滤镜中的矩阵相当于将 A 通道的颜色值乘上 9，其他通道不变，对于被模糊（实际上是半透明）的边缘位置来说基本上就和设成 1 差不多了，并且这种实现方法不会在显示区域之外再出现什么奇怪的东西。对应的 CSS 代码：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#D7BA7D">filter</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">: url("</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">data</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">:image/</span><span style="color:#81A1C1;--shiki-dark:#D7BA7D">svg</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">xml</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">%3Csvg xmlns='http://www</span><span style="color:#ECEFF4;--shiki-dark:#D7BA7D">.</span><span style="color:#8FBCBB;--shiki-dark:#D7BA7D">w3</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">.org/2000/svg'%3E%3Cfilter id='$'%3E%3CfeGaussianBlur stdDeviation='10'/%3E%3CfeColorMatrix type='matrix' values='1 0 0 0 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">0 1 0 0 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">0 0 1 0 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">0 0 0 9 0'/%3E%3CfeComposite in2='SourceGraphic' operator='in'/%3E%3C/filter%3E%3C/svg%3E#$");</span></span></code></pre><p>用这个滤镜替代最初的演示中使用的 CSS 自带的模糊滤镜：</p><div style="position:relative">    <img id="example-1-blurred" style="position:absolute;width:100%;max-height:none;transition:opacity 1s;filter:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22$%22%3E%3CfeGaussianBlur stdDeviation=%2210%22/%3E%3CfeColorMatrix type=%22matrix%22 values=%221 0 0 0 0,0 1 0 0 0,0 0 1 0 0,0 0 0 9 0%22/%3E%3CfeComposite in2=%22SourceGraphic%22 operator=%22in%22/%3E%3C/filter%3E%3C/svg%3E#$')" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQIAJQAlAAD/2wCEABcXFxcYFxocHBokJiImJDUwLCwwNVA5PTk9OVB5S1hLS1hLeWuBaWJpgWvAl4WFl8DeurC63v/w8P////////8BFxcXFxgXGhwcGiQmIiYkNTAsLDA1UDk9OT05UHlLWEtLWEt5a4FpYmmBa8CXhYWXwN66sLre//Dw///////////AABEIABIAIAMBIQACEQEDEQH/xABrAAADAQAAAAAAAAAAAAAAAAACBAUAEAACAgEEAQUAAAAAAAAAAAABAgMRAAQSITETBRRBcrEBAQEBAQAAAAAAAAAAAAAAAAQCAwERAAEDBAIDAQAAAAAAAAAAAAEAAgMEESExMoEiQUJx/9oADAMBAAIRAxEAPwCvBIXBLU1DvGoZt70XU4Gm0kSN5W9IxML6odXi04YG405+WrLqm+GAoi5ZK0KyXRPGHUEcm5dqspFnOUusqnnNh2lJi0DJ5WBDbrUnEV9QRqQIxA7JxczDLEAwjKyjcGvub4Vx+IzkrWk+z1WCpeXS0+VJ1TFoNEWJJ8bfuBB0fsMfHo/jlkdr/9k">    <img id="example-1-source" style="width:100%;max-height:none;visibility:hidden" data-src="https://p.sda1.dev/12/bece1d43a7d093583129fdc7202ca924/Fhdt09T7.jpg" data-src-webp="https://p.sda1.dev/12/04d499bac3b61e1596f370c51686c18a/d1iL6gt0.webp" data-src-avif="https://p.sda1.dev/12/3a708bab4022d35fa52f12344a6dabfb/m3nkyCIM.jpg"></div><button id="example-1-load">加载图片</button><button id="example-1-unload">恢复初始状态</button><!--<script>(() => {const getElementById = e => document.getElementById(e);const prefix = 'example-1-';const blurred = getElementById(prefix+'blurred');const source = getElementById(prefix+'source');const load = getElementById(prefix+'load');const unload = getElementById(prefix+'unload');load.onclick = () => {    blurred.style.opacity = 0;    source.style.visibility = '';};unload.onclick = () => {    blurred.style.opacity = 1;    source.style.visibility = 'hidden';};})()</script>--><script>(()=>{const e=e=>document.getElementById(e),l="example-1-",t=e(l+"blurred"),i=e(l+"source"),c=e(l+"load"),o=e(l+"unload");c.onclick=()=>{t.style.opacity=0,i.style.visibility=""},o.onclick=()=>{t.style.opacity=1,i.style.visibility="hidden"}})()</script><p>这样的效果就很完美了！( つ•̀ω•́)つ</p><h1 id="除了小尺寸的-JPEG，还能用什么作为缩略图？"><a href="#除了小尺寸的-JPEG，还能用什么作为缩略图？" class="headerlink" title="除了小尺寸的 JPEG，还能用什么作为缩略图？"></a>除了小尺寸的 JPEG，还能用什么作为缩略图？</h1><p>CSS-Tricks 的文章还提到了 Facebook 技术团队的<a href="https://engineering.fb.com/2015/08/06/android/the-technology-behind-preview-photos/">另一篇文章</a>，介绍他们是如何在自家的 APP 中实现图片渐进式加载，使用的方法仍然是先立即显示模糊的缩略图再展示完整图片，但是他们的目标是<strong>将缩略图的大小压到 200 B 左右</strong>。为此他们使用了相同的质量和 Huffman 表等参数进行压图，这样得到的图片就有了固定的标头，只要传输剩下的部分，在客户端再和固定的标头拼接起来，就可以得到使用的缩略图了。</p><blockquote><p>So the final format became one byte for version number, one byte each for width and height, and finally the approximately 200 byte payload. The server would just send this format as part of the GraphQL response, and then the client could simply append the JPEG body to the predefined JPEG header, patch the width and height, and treat it as a regular JPEG image.</p><p>After the standard JPEG decoding, the client could run the predetermined Gaussian blur and scale it to fit the window size.</p><p>最终的数据格式先是各占 1 B 的版本号和图片的宽度和高度，剩下的部分就是 200 B 左右的负载。服务端只需要从 GraphQL 响应中返回这些数据，客户端简单地将负载拼接到预定义的 JPEG 头部后面，再填上宽度和高度，就可以当成一般的 JPEG 图片使用了。</p><p>在进行 JPEG 图片解码后，客户端就可以对图片添加高斯模糊并把它缩放到需要的大小。</p></blockquote>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1342*413),413px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/95175c3768eef6ed81c6bdbb2de6bbf0/OB1G85E0.jpg" data-src-webp="https://p.sda1.dev/12/87f7ba58cab07ece16be1c6b87fac673/SdxZk5k0.webp" data-src="https://p.sda1.dev/12/078404d8ab2b2cc14f0bf4fc4ddcb2c5/PCPEkNLq.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRpgAAABXRUJQVlA4IIwAAADQAwCdASogAAoAPrVWoUsmiiwCADgFolnAAEfo79/4mrHbDMw2C0AA/vwuITE+/sch5KUqosx8VDMxq4qvg5/V1MgbKKbC94hc3G5g++z4z+pDwuJttG/Zf/EFjw3fm/HSQjtnVuOTfARzkCOrVEyKSbz9e4KGmQa9tYHL1N2B38Tzize1R0WcEKgAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/078404d8ab2b2cc14f0bf4fc4ddcb2c5/PCPEkNLq.jpg"                                                                                            >                        </noscript>                    </figure>                <p>自己实现图片渐进式加载的时候当然不一定要做如此极端的优化，制作缩略图时，用任意一个软件把图片的宽度和高度压到 40px 左右，控制压缩 JPEG 的质量使大小在 2 KB 以内其实就可以了。</p><p>但是用更少的数据来表示缩略图确实是可行的，这里就需要介绍 <a href="https://blurha.sh/">BlurHash</a> 这个工具了。BlurHash 的算法主要是对原图进行了离散余弦变换，提取出最多 10x10&#x3D;100 个系数，以 0-18 的范围（也就是大约 4.25 bit 的精度，不过对于缩略图已经够用了）表示颜色，按照一些紧凑的规则编码成二进制数据，再使用特别选择的字母表进行 Base83 编码，保证在 URL 和 JSON 等地方不需要额外转义就可以直接传输。详细的编码规则可以参见<a href="https://github.com/woltapp/blurhash/blob/master/Algorithm.md">这里</a>。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1896*855),855px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/93188b3f9a2694ff63c0c58246682786/HMRXqvGF.jpg" data-src-webp="https://p.sda1.dev/12/3468ba7ce4c33ec2db79f2eac2daa47a/r057l1uX.webp" data-src="https://p.sda1.dev/12/3c58250178d463ef7b34d40ba3c32b6e/4OGhJAtT.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRsIAAABXRUJQVlA4ILYAAAAwBACdASogAA4APrVKnkomiWwCADgFolmAJ0fwTABvIAEt1MsK+cnmRNAA/vPxLb88w07tm2IsPip6s5Tsn8MSgE/3ajepZ74vVtKy5BBrCmTct+Bw2aaHlq8KgFK8tWUKE+AOvzARSv04W4iIKUl5XgSq3t0pjg4METEvAv3QIJCHeWfSW4BvVGxqZ7h/RMd6nTz0CN8M7heLm033fjAfMcKu7d3mzNnY1lB11rQmAPAHN4AAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/3c58250178d463ef7b34d40ba3c32b6e/4OGhJAtT.jpg"                                                                                            >                        </noscript>                    </figure>                <p>在系数数量为 6x4 的情况下从上面的缩略图得到的 BlurHash 只有 52 B。即使将 10x10 个系数用满，由此得到的最长的 BlurHash 也只有 166 B，这个数据量比 Facebook 的极端优化还要小。</p><p>需要展示缩略图的时候，只要使用解码库就可以直接将 BlurHash 解码成任意尺寸的位图。系数越少得到的图片就越模糊（或者说是平滑？），但是就算是 10x10 也比前面使用的添加了高斯模糊的低分辨率 JPEG 还要模糊。也许有人会因为想要在模糊的缩略图中多展示一些图片细节而仍然选择低分辨率 JPEG，不过这就是个人喜好不同了 (´▽｀)ノ♪</p><blockquote><p>2023-04-30 更新：</p><p>以在前端开发领域目前被广泛使用的、跑得最快的 JS 打包器 esbuild 为代表作的 evanw 最近推出了 <a href="https://evanw.github.io/thumbhash/">ThumbHash</a>，原理和使用方式与 BlurHash 非常类似。根据官网上的对比，在相同数据量的情况下从 ThumbHash 解码的图像比 BlurHash 有更多的细节，颜色也更接近原图。</p><p>ThumbHash 不像 BlurHash 一样允许通过调节系数数量来控制数据量和解码图像的质量，不过如果本来就不想纠结这个的话其实并不算什么缺点。</p></blockquote><p>还有其他的一些实现缩略图的方式，和 BlurHash&#x2F;ThumbHash 不同的是它们不需要通过执行 JS 来解码：</p><ul><li>Golang 编写的 <a href="https://github.com/fogleman/primitive">Primitive</a>，可以用数百个椭圆、矩形、三角形等简单的图形对图片进行拟合（如下图所示），输出可以是一个 SVG 文件</li><li>Typescript 编写的 <a href="https://github.com/axe312ger/sqip">SQIP</a>，和前者差不多，不过支持的模式更多一些</li><li>甚至可以通过<a href="https://leanrada.com/notes/css-only-lqip/">纯 CSS 的方式</a>，借助渐变来实现</li></ul>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/720*450),450px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/beb4a4956ea45b440675fad7bf90e80b/otUfpNyO.jpg" data-src-webp="https://p.sda1.dev/12/f7433d8bc5c33095a2b969d755cb5dec/ObVzo1Qv.webp" data-src="https://p.sda1.dev/12/6c6cd5de13b8cd23dd2985c4d3ac7d36/gocRFLuN.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRrQAAABXRUJQVlA4IKgAAAAQBQCdASogABQAPrVInkmqqCmlsBgMAOAWiUAWI9vgNTXsUwEfXki5AcVtKcxJg0IAAP7xD/XyPeT91br6qVF6E679kVj1Dn/OT2sHHDkheUCfWNlrO4Wht4IlibO1S1QMFGIRSm1VjBEw+vr/3H5ihow7X44pd6jbd+7s+00Xvo5fsJe2CXzAB7Dc4/XOk6lT2CZA2lEzEYM85L1BeVTfXtzkVKgAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/6c6cd5de13b8cd23dd2985c4d3ac7d36/gocRFLuN.jpg"                                                                                            >                        </noscript>                    </figure>                <p>这样的缩略图有一个专有名词：低分辨率图像占位符（Low Quality Image Placeholders, LQIP）。以这个为关键词进行搜索的话，大概还能找到其他的一些实现方法。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/83265679">Pixiv ID: 83265679 「チノちゃんと遊園地デート」 by チノマロン</a></p></blockquote>]]></content>
    
    
    <summary type="html">其实这是之前自己写现在使用的这个主题的时候就想记下来的东西，不过一直咕到今天才写 …_φ(･ω･` )</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>RSA 算法的替代品：X25519/Ed25519 使用记录</title>
    <link href="https://akarin.dev/2021/09/16/a-taste-of-curve25519/"/>
    <id>https://akarin.dev/2021/09/16/a-taste-of-curve25519/</id>
    <published>2021-09-16T11:07:57.000Z</published>
    <updated>2021-09-16T11:07:57.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/89044985">Pixiv ID: 89044985 「赤座あかりちゃん」 by たんたんめん</a></p></blockquote><p>涉及密码学的课我没少上，而每个学期上这种课的时候都一定会把 RSA、MD5、DES、AES……这些经典算法，以及分组密码的<abbr title="一般是 ECB、CBC、CFB 和 OFB">四个经典的工作模式</abbr>之类的东西轮流过一遍，顺便稍微提一下还有一类比 RSA 更好的算法叫椭圆曲线。知道这些理论后，期末考个 80 分以上基本上就不是问题了。</p><p>但是，虽然理论上的东西讲了这么多，将这些理论用到实践的机会实在是少之又少。好不容易在某课程的期末大作业里看到一个“信息的安全传输”：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1433*589),589px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/401fcc79f0e890de900e2ba5e815e0fa/a22K39rz.jpg" data-src-webp="https://p.sda1.dev/12/375a33cefeebbc23a2a21d4fa6141acc/tUl6PBeq.webp" data-src="https://p.sda1.dev/12/c1846d1aee557f3b544775adb34d5d3b/UqV-5yBP.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRoQAAABXRUJQVlA4IHgAAADQAwCdASogAA0APrVOn0omiWwCADgFolAE6I//AeSZ0c9DUN4zMFAA+OXy12jxBhuY4+HV8yNDwre8UElJKhvOOvWADj9gtY1SyUFFx/QwD39me3Zehl3dRjKACTOh8sPi93518kVEyEM0qmA5tOUQ7828vN0qAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/c1846d1aee557f3b544775adb34d5d3b/UqV-5yBP.png"                                                                                            >                        </noscript>                    </figure>                <p>用密码学手段解决文件的安全传输，有点意思。再看看后面的参考用流程图：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/610*612),612px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/386e15434fcec857acedb56043639cd7/xvrdW8Yj.webp" data-src="https://p.sda1.dev/12/9ffd40c9931b657d122fb294d6971afe/8jOvOUlX.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRtIFAABXRUJQVlA4TMUFAAAvH8AHEBXJ0bb9nJ3/GmK7slpWtp0yZSrbtu0c22Of+Y/tmWOfVFlAqvn/f9nCu4doJU5+E5TWCrKObMJZibWStN5DComRJCmSFB2RPXf3zCTtiw5JkuREUv7/bQstFVdJGlhmxpMESJJM27J99Wzbtm3btm3btm1827Zt2+wJALcr+aHTIDDhVu6A0JJO2xSwObQ50p6dMshDUXZhPUK90tEsDEm8E6fSeoYVNjWhhge+HLhOotTWa1POBeRzwZELSQhy9SXn7Oq50rVeEDcCzLW+g11eBGY0h11KkflFJUlsNOmgVKxd1PghVzLKABpvFC1b5gWkGGfmQ2JHzENRtNzMLZCi47kkEHiSSHUxv+y5V+7CKb0+e2lJX8nKl275BE8TwE2pIZs1zV4q9VcVtpepz5AnyHndi85+/8jXhQ8SGEAd33QT3VIFLwUACvIa38DRlTduZTFoTuFL/uRq2TwNAbH1ZxBC9ip2XmWfVmU3unXzCq9cZVwYkICF5QTL/JwqJun9kQ+8dT+A0p83brcMSQlLCmkJqflfWcAXpZJ8Fz5LUWxGzd2d5UsG0F4UVdbpm93ZZbc+647d6pYZVbXfg7cLoHdNnY2JsyVxzmz6sgvnq2pInCRzlarTYFfgTGDMYFNhVjHnuQ9QGoUpzei97Zw27soxpunWmB9+QJ/GOo/Uq473u+R6wU1tkMYzyPKnVCMHdzSIRCKNPoEgqiYyGmMpjfHY7caTmxNrd2HTCjD+yTEHdfkRNj/GakeyVo5Eu1icsZTEzym71z/AlPr5sxngsmTJujw6anubw1uGiRs2y7mWBeSkrGFqvL/l+f8wnZWoKEp1JzBn0GewpXheaEfH119RhFOgam26xA5fjBOeQEIqE9lTZ1mxZk/WcqpNQbVmOLqmKdZ6Aja+Xtyy9ueNu93zJ/t+JKAlAkDBTwHXdFBUfXQmnzzxx833UptSSvkCUrTrcI266HWodYZZjT+K4lrDlZ76eE16o0a0PKpcPFWZafm1oCiO3AC46n0AmVLf4UFXclpVnLamx5Xl8fxxF9cWLjRdSoVeSRRUe5TFiaTNxtQ7k4VLc1hmxqE4ObuqDMjJ7mvJACggXbVkVxudn3+5Dwygm/wPLAlbqdkNpzAKSMvT1vSSPbmqyy5b1GKcM2mXNfpVaXk5JF3magMYHAreumW444vd+CTHtEKX3zud2oCNI+r1KJ7a2CMpQyjCKZBJyUUirQEBYAC1ZmGYzrA2oYYRqJ4hH4qiZWaeW4rWPKoACmiL8XeKYgebz/7bT5F//hzGAx+gy29ocgRiTOJRGgAoAHsSoli+FFivpNVLdxQGih8K45JeO2Q8Om9Kp3xJhEkdNKqwqpDnoYA3mXYe6c6XM/u+/QhyCCsrXbYoLxdV5aKgWpzInRiAWt/BDslLise1plNbYUPuq+oyDnwzeOH0y6Xs4rxdHd95L9KTX3bSsSxpLHv3wLeeC4Fh903r2QIuCVjFBf/o+6oex7BhF826LChxwyn5zqhx99X42dTfd6ygQIX9+6nzpgxVbn2odGu1qPisy1FeAwOovMnnT4V2mFXY03kEpR+eBCEJRbY7KKjHvbamyJNQKCWEyXCN3JtaUdubyW7pJJHiDKA5wIE3niG//l5oZhCyiaQsxJia/IZm1HbG9zNfj+LYv4P50q79Dm5nvXcHA8R/GOT7t+8nMylhQDPAdOvWk1u3GgFmhDfjlYvShvwIHvfsZ5kNRXUcc3vYAJAopQAXEM/ijG0fzPwHDUg1iGFCO0ft3ERxUwvcjQCBhie2/DTF22AEaXn+LEmJ2z5dds4fHyk6bZYHjsPtymL/B2AhwuCX46vOtsuCGYM0z15tnrcG5PqglMO3/MMNuSegYwA1AERtWYqXOyyJH4kWlUxqRtoyNxWDzMe5C9A7ZvbJzmThhtNTkrL6nEmFN0aBlHMS5qlRIP6jy1Dl9owBNAAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/9ffd40c9931b657d122fb294d6971afe/8jOvOUlX.png"                                                                                            >                        </noscript>                    </figure>                <p>嗯……这个流程图用的都是相当经典的教科书式的操作：</p><ul><li>混合加密：使用非对称密码交换会话密钥，然后在后续的数据交换中使用会话密钥和对称密码</li><li>密钥交换：随机生成会话密钥后，用对方的公钥加密再发过去，对方用私钥解密</li><li>数字签名：对数据计算 hash 后用自己的私钥签名，对方用公钥验证</li></ul><p>如果一定要说有什么问题的话，DES 和 MD5 这两个算法已经很陈旧且不安全了，直接用 AES 和 SHA-256 之类的更现代的算法替代也不困难。但是在上面的流程中重度使用的 RSA 算法是否也可以使用更好的替代品呢？</p><p>还真的有，这就是标题里的基于 Curve25519 椭圆曲线的 X25519 密钥交换算法和 Ed25519 签名算法。</p><p>由于我姿势水平有限，所以以下的介绍可能会存在错误什么的，如果指出来的话我会修正的 (´ﾟωﾟ｀)</p><h1 id="教科书式-RSA-的问题"><a href="#教科书式-RSA-的问题" class="headerlink" title="教科书式 RSA 的问题"></a>教科书式 RSA 的问题</h1><p>众所周知，RSA 的安全性来自于“大素数分解”这一数学难题：将两个很大的素数相乘很容易，但是从相乘的积分解出这两个素数非常难，或者说在计算上是不可行的。具体的算法过程和数学证明就不再介绍，可以直接参见<a href="https://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html">这里</a>。</p><p>RSA 是非常经典的非对称密码算法，可以同时用于加密和签名，但是它最大的缺点就出在“大素数”上。如果刚刚提到的素数分解问题被解决，RSA 就没有任何安全性可言了，因此需要不断增大那两个素数的位数（一般也被叫做“密钥长度”），需要增加到什么程度呢？目前 Factordb 上已经有了 <a href="http://factordb.com/index.php?query=1230186684530117755130494958384962720772853569595334792197322452151726400507263657518745202199786469389956474942774063845925192557326303453731548268507917026122142913461670429214311602221240479274737794080665351419597459856902143413">768 位的数被分解的记录</a>，因此 1024 位也已经比较危险了，根据 <a href="https://www.keylength.com/en/4/">NIST 的建议</a> 2048 位的密钥可以用到 2030 年左右。</p><p>一味增加密钥长度带来的突出问题是 RSA 的执行速度被<strong>严重拖慢</strong>了，生成密钥、加密解密和签名的时间都会随着密钥长度的增加而出现指数级的延长。以生成不同长度的密钥对为例，在<a href="https://travistidwell.com/jsencrypt/demo/">这里</a>在线测试所消耗的时间如下：</p><ul><li>512 位：50-100 ms</li><li>1024 位：500-1500 ms</li><li>2048 位：8000-15000 ms</li><li>4096 位：100000 ms 以上</li></ul><p>生成一个安全的密钥要等十几秒，这合理吗？还好我们现在都知道应该使用混合加密了，RSA 在加密过程中只是用于一开始的密钥交换而已，而且只需要在服务端的加密系统初始化时生成一次密钥似乎就够了，慢一些也可以接受……？</p><p>遗憾的是，使用 RSA 的非对称特性进行密钥交换还存在另一个严重问题。假定有攻击者可以监听客户端和服务端双方通信的所有数据，于是他得到了公钥以及用公钥加密后的会话密钥，这些信息当然不足以让攻击者得到会话密钥从而解密后续的所有使用对称加密传输的信息。但是<strong>如果有一天服务端的私钥泄露了</strong>，攻击者就可以得到每次通信所使用的会话密钥，进而<strong>解密出所有先前监听到的通信内容</strong>。</p><p>即使不使用 RSA 而是使用另一个经典的密钥交换算法 Diffie-Hellman，只要<strong>有一方的密钥对固定不变</strong>，也会面临同样的问题。</p><p>解决办法也很简单：那就在密钥交换时让双方使用的密钥对<strong>每次都不一样</strong>好了。这样，即使某次通信时使用的私钥泄露，攻击者也只能解密这次通信的内容，而其他通信仍然是安全的。这种特性在密码学上被称为<strong>前向安全性（Perfect Forward Secrecy）</strong>（上课的时候完全没讲过这个……），顾名思义就是保护先前的通信的保密性不会受到来自未来的暴露的密钥的威胁。</p><p>Diffie-Hellman Ephemeral 就是 Diffie-Hellman 加上“每次交换时需要随机生成密钥对”这一要求后的改进算法，Ephemeral 的意思是“短暂的”。那 RSA 的密钥交换有没有对应的支持前向安全性的改进算法呢？</p><p>可以做，但是考虑上面提到的速度问题就很容易知道这样的改进对 RSA 来说并没有什么实用意义。回到上面的“文件的安全传输”流程图，你能接受<strong>每次传输文件前</strong>都要<strong>等待十几秒</strong>来生成密钥对吗？</p><p>所以和教科书里不同的是，直接使用 RSA 加密进行密钥交换实际上已经过时了。已有的 <a href="https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml">TLS 协议的密码套件</a>中，推荐的组合里 RSA 都只是用于身份验证（也就是签名，即使私钥泄露也不影响保密性），实际的密钥交换都是通过 DHE 或椭圆曲线的 ECDHE（注意多出来的这个 E，它表示的就是 Ephemeral）完成的。</p><p>顺便一提，和教科书里所述同样不同的是，现实中使用的 RSA 加密会对数据使用 <a href="https://zh.wikipedia.org/zh-hans/%E6%9C%80%E4%BC%98%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%A1%AB%E5%85%85">OAEP 方案</a>进行填充。由于填充过程引入了随机数，因此用同样的密钥多次加密相同的明文的结果也是不一样的。</p><h1 id="Curve25519-系列算法简单介绍"><a href="#Curve25519-系列算法简单介绍" class="headerlink" title="Curve25519 系列算法简单介绍"></a>Curve25519 系列算法简单介绍</h1><p>基于椭圆曲线的非对称密码解决了 RSA 密钥长度大，运行时间长的问题，256 位的椭圆曲线密钥可以等效于 3072 位的 RSA 密钥。目前常用的椭圆曲线密码系统是基于 NIST 系列标准的曲线（例如 P-256，又称 secp256r1 和 prime256v1）而设计的 ECDH 密钥交换算法和 ECDSA 签名算法。</p><p>虽然如此，NIST 标准曲线仍然存在一些问题。在设计密码算法时可能需要定义一些常数，这些常数应该以一种比较透明的方式选择，例如：</p><ul><li>MD5 算法中处理单个 512 字节输入消息分组的轮函数中用到了 64 个常数，由 <code>floor(abs(sin(i + 1)) * (2 ** 32))</code> 计算得到。</li><li>SHA1 算法的五个初始值是数字 <code>0</code> 到 <code>F</code> 在大端序下的顺序排列：<code>0x67452301</code>、<code>0xEFCDAB89</code>、<code>0x98BADCFE</code>、<code>0x10325476</code>、<code>0xC3D2E1F0</code>。</li><li>ChaCha20 算法使用字符串 <code>expand 32-byte k</code> 的 ASCII 码填充初始的状态矩阵。</li></ul><p>把 <code>sin</code> 换成 <code>tan</code> 之类的其他数学函数，或者修改那个字符串，对算法的安全性都不会有什么影响。常数的选择方式仅仅是为了证明在选择的过程中并没有什么特别的操作空间，无法用于预留后门之类的用途。用这类方式选择的常数被称为 <a href="https://en.wikipedia.org/wiki/Nothing-up-my-sleeve_number">Nothing-up-my-sleeve number</a>，这个称呼来自于魔术师变魔术前张开袖子以表示自己两手空空的做法。</p><p>有些密码算法的常数选择没有遵循这一规律，从而引起了怀疑和批评，例如 NSA 设计的 DES 算法的 S 盒就没有任何的依据（后来才有研究发现实际上是为了抵御差分密码分析），另一个更严重的例子是 NIST 推荐的伪随机数生成器 Dual_EC_DRBG 也使用了没有选择依据的常数，被斯诺登曝光出存在 NSA 设计的后门。在这些先例下，当 NIST 标准曲线的系数也出现了来历不明的一系列常数时，它的安全性也就值得怀疑了。</p><p>另一个问题是，ECDSA 签名算法中使用了随机数，这使得使用相同的密钥多次对相同的明文签名的结果也会不一样：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">private</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> openssl_pkey_new</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">([</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">private_key_type</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =></span><span style="color:#88C0D0;--shiki-dark:#D4D4D4"> OPENSSL_KEYTYPE_EC</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">curve_name</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =></span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">prime256v1</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">public</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> openssl_pkey_get_details</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">private</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">key</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">message</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">test</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">for</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 3</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">++</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    openssl_sign</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sign</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">private</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4"> OPENSSL_ALGO_SHA256</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    var_dump</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bin2hex</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sign</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">),</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> openssl_verify</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sign</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">public</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4"> OPENSSL_ALGO_SHA256</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// string(144) "3046022100a6fc5cda8b435e777a4a7342e4777930184816af02579c08f7d633f208571951022100ddd6c9647a5a9f2905c355ce9cd11e4b26d6b4e08afd6d853270b5c3958d5447"</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// int(1)</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// string(140) "304402207e25def883eb91e663aa8f09de1f373bf673cb8f989ed2459591e4e716200f5e02206118a1e1efe17fca6632fff3fbb1b605e162bc57023cb99b9bdfe12b19ac95b6"</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// int(1)</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// string(142) "3045022100d2effb78a5375dc1f1c1603121c312d7b56987bcd5f19a92d37ecc49438f4fad02207cf83ea53494f4a1cc77c04ba945c4c593cc306b9b68e4e63eb9fd4ebd9ee0e8"</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// int(1)</span></span></code></pre><p>如果签名时使用的随机数发生器存在缺陷，在两次签名中输出了相同的随机数，就存在使用签名恢复出私钥的可能（参见<a href="https://www.instructables.com/Understanding-how-ECDSA-protects-your-data/#step14">这篇文章</a>的介绍及它的<a href="https://zhuanlan.zhihu.com/p/97953640">译文</a>）。</p><p>由密码学家 Daniel J. Bernstein 在 2006 年独立设计的基于 Curve25519 曲线的 <a href="https://cr.yp.to/ecdh.html">X25519 密钥交换算法</a> 和 <a href="https://ed25519.cr.yp.to/">Ed25519 签名算法</a>正好避开了以上的 NIST 标准曲线存在的问题，安全性同样等效于 3072 位 RSA，还有以下的优点：</p><ul><li>速度快，当然椭圆曲线密码都能做到这个。</li><li>数据量小，公钥和私钥仅 32 字节，签名仅 64 字节，椭圆曲线密码也应该能做到这个。</li><li>算法的设计和参数选择是明确的，作者自己撰写了相关论文作为依据。</li><li>在算法中回避了分支操作，可以防止时序攻击（Timing Attack）。</li><li><strong>任何一个 32 字节的随机值都可以作为私钥</strong>，不需要另外选取或验证。</li><li>Ed25519 是确定性签名算法，不使用随机数，对于相同的私钥和明文可以得到相同的签名。</li></ul><p>Curve25519 系列算法在 2006 年提出，但直到“棱镜门”曝光出 NIST 标准算法可能存在后门之后才开始流行起来。目前 OpenSSH 就已经支持生成 Ed25519 密钥并用于公钥登录：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">ssh-keygen</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> ed25519</span></span></code></pre><p>2018 年推出的最新的 TLS 1.3 标准支持使用 X25519 和使用 NIST 标准曲线的 ECDHE 进行密钥交换（顺便把 RSA 密钥交换砍掉了），但是据我观察，浏览器似乎都首选使用 X25519。另外 Ed25519 也是 TLS 1.3 支持的签名算法之一。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/726*776),776px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/d804cb733ef52145a58c3d6d74eab59e13302.jpg" data-src-webp="https://p.sda1.dev/12/5ffd9fe8df48d6a422513e7d7e7bc4c3/JKo_TA5N.webp" data-src="https://p.sda1.dev/12/99ee4672e70570da15919344940deb94/Ob0cGO38.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRrQAAABXRUJQVlA4IKgAAABQBQCdASoeACAAPrVKoEuko5IYDAQAcAtEsYBOmax+zT/gHnZ0pKa13q9CRlwAlEa6gAAA/vT+Ln91UGTzBLbJc95jVutVS8dfHYdU41Im05kJBpB/2kidI6B6ONUHUkLYVD+ke+FAjOwh2f+/254m6pHrYlYohiVBp6U15GQ66yn/TdDjl8x9pc5AkN6p+IRTtMhdMoq0Z8TScdT6RBvSnqRvR5PAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/99ee4672e70570da15919344940deb94/Ob0cGO38.png"                                                                                            >                        </noscript>                    </figure>                <h1 id="在-libsodium-中使用-Curve25519-系列算法，以-PHP-的-Sodium-扩展为例"><a href="#在-libsodium-中使用-Curve25519-系列算法，以-PHP-的-Sodium-扩展为例" class="headerlink" title="在 libsodium 中使用 Curve25519 系列算法，以 PHP 的 Sodium 扩展为例"></a>在 libsodium 中使用 Curve25519 系列算法，以 PHP 的 Sodium 扩展为例</h1><p>Daniel J. Bernstein 给出了 X25519 和 Ed25519 的 C 语言实现，不过他还将这两个算法和 ChaCha20Poly1305、AES-256-GCM、HMAC-SHA-256 等比较现代的密码算法放在一起，做了个名为 <a href="https://nacl.cr.yp.to/">Networking and Cryptography library</a> 的开源加密库，简称 NaCl，读作 Salt。密码学中有“盐”的概念，食盐的主要成分也是 NaCl，我有点怀疑这个名字是为了玩梗而强行凑出来的……</p><p>NaCl 已经停止更新了，有人在 NaCl 的基础上开了名为 <a href="https://doc.libsodium.org/">libsodium</a> 的分支继续改进，这个分支的名字大概也是为了照应 NaCl 而取的……总之需要在代码里使用 X25519 和 Ed25519 的话，可以使用 libsodium 以及各种编程语言对它的 binding。</p><p>libsodium 的设计尽可能地隐藏了加密算法的实现细节，从它的函数名就可以看出来。例如包含了 X25519 密钥交换和 ChaCha20Poly1305 认证加密的相关函数统一称为 <code>crypto_box_*</code>，使用 BLAKE2b 进行 hash 的相关函数统一称为 <code>crypto_generichash_*</code>，都不涉及到具体的算法名称。</p><p>这里我还是选择 PHP 作为使用例。从 PHP 7.2 开始 Sodium 扩展已经随 PHP 本体一起附带了，在系统里安装了 libsodium 的条件下即可使用。如果是使用 C 语言编写的原版或其它 binding 的话，用到的函数名称应该是差不多的。</p><h2 id="X25519-的使用"><a href="#X25519-的使用" class="headerlink" title="X25519 的使用"></a>X25519 的使用</h2><p>从私钥生成公钥需要用到 <code>sodium_crypto_scalarmult_base</code>，使用自己的私钥和对方的公钥进行密钥交换需要用到 <code>sodium_crypto_scalarmult</code>。前面提过 Curve25519 系列算法可以使用任意的 32 字节作为私钥，所以可以从密码学安全的伪随机数生成器（CSPRNG）自行生成私钥。我这里作为演示就直接使用了 <a href="https://datatracker.ietf.org/doc/html/rfc7748.html#section-6.1">X25519 的标准测试向量</a>：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 实际使用时必须随机生成私钥：</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// $private = random_bytes(32);</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> hex2bin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">77076d0a7318a57d3c16c17251b26645df4c2f87ebc0992ab177fba51db92c2a</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> hex2bin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">5dab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult_base</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult_base</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">assert</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ===</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">var_dump</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bin2hex</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// string(64) "4a5d9d5ba4ce2de1728e3bf480350f25e07e21c947d19e3376f09b3c1e161742"</span></span></code></pre><p>也可以使用 <code>sodium_crypto_box_keypair</code> 直接生成密钥对，得到一个 64 字节的字符串，前半和后半分别是私钥和公钥，可以用 <code>substr</code> 或 <code>sodium_crypto_box_secretkey</code> 和 <code>sodium_crypto_box_publickey</code> 提取。</p><p>虽然前面提过可以使用任意 32 字节作为私钥，实际使用时还会进行 clamp 处理。将整个 32 字节当成是小端序表示的 256 位整数，clamp 等效于将这个数的最低三位设成 <code>000</code>（强制设为 8 的倍数）以及将最高两位设成 <code>01</code>：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">k</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">  &#x26;=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 248</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#616E88;--shiki-dark:#6A9955"> // 0b11111000;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">k</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">31</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 127</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#616E88;--shiki-dark:#6A9955"> // 0b01111111;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">k</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">31</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">  64</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#616E88;--shiki-dark:#6A9955"> // 0b01000000;</span></span></code></pre><p>这两个操作分别是为了避免小子群攻击和保证算法在常数时间内完成以避免时序攻击（稍微详细一些的解释在<a href="https://www.jcraige.com/an-explainer-on-ed25519-clamping">这里</a>）。不过实际使用的时候各种实现会自动进行 clamp，因此不需要手动操作：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 把$privateA[31]从0x2A 0b00101010改成0xAA 0b10101010（最高两位设成10）</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> hex2bin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">77076d0a7318a57d3c16c17251b26645df4c2f87ebc0992ab177fba51db92caa</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 把$privateB[0]从0x5D 0b01011101改成0x5F 0b01011111（最低两位设成111）</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> hex2bin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">5fab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult_base</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult_base</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">assert</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ===</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">var_dump</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bin2hex</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// string(64) "4a5d9d5ba4ce2de1728e3bf480350f25e07e21c947d19e3376f09b3c1e161742"</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 密钥交换结果没有变化</span></span></code></pre><p>X25519 输出了 32 字节的共享密钥，但是 libsodium 不建议将这 32 字节直接作为密钥使用，<a href="https://github.com/jedisct1/libsodium/blob/6d566070b48efd2fa099bbe9822914455150aba9/src/libsodium/include/sodium/crypto_scalarmult.h#L29">推荐的做法</a>是将它与双方的公钥一起进行 hash 处理。根据考证，TLS 中也有类似的做法：密钥交换得到的共享密钥被称为 Pre Master Secret，同样需要与双方的公钥 Client&#x2F;Server Random 一起输入密钥派生函数（TLS 1.2 及以前为 <abbr title="Pseudo Random Function">PRF</abbr>，TLS 1.3 改为 <abbr title="HMAC-based Extract-and-Expand Key Derivation Function">HKDF</abbr>），得到最终使用的会话密钥 Master Secret。</p><p>至于为什么还要进行一次密钥派生，根据 Stack Overflow 上的两个回答（<a href="https://stackoverflow.com/questions/25258799/#answer-25394747">这个</a>和<a href="https://crypto.stackexchange.com/questions/24780/#answer-24783">这个</a>），主要是出于以下的理由：</p><ul><li>可以将密钥交换和生成会话密钥的过程各自独立出来。</li><li>使通信双方都能对会话密钥的生成过程产生影响。</li><li>不同密钥交换算法产生的共享密钥长度可能不一样，也不一定和会话密钥固定要求的长度相同。</li><li>某些密钥交换算法产生的共享密钥存在随机分布不均的情况。</li></ul><p>对于最后一点，实际上 X25519 输出的共享密钥也存在这个问题。如果注意一下共享密钥中各位出现 0 或 1 的次数，就会发现密钥的最后一个字节的最高位固定为 0，其他位出现 0 和 1 的次数则基本相同：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">bits</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> [</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">for</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1024</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">++</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> random_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">32</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> random_bytes</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">32</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult_base</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult_base</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_scalarmult</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">privateB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">publicA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    assert</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ===</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">byte</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> ord</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">31</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 8</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">++</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">bits</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">][(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">int</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">bool</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">byte</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;&#x3C;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">++;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">var_dump</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">bits</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// array(8) &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [0] => array(2) &#123; [0] => int(493) [1] => int(531) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [1] => array(2) &#123; [0] => int(527) [1] => int(497) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [2] => array(2) &#123; [0] => int(496) [1] => int(528) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [3] => array(2) &#123; [0] => int(547) [1] => int(477) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [4] => array(2) &#123; [0] => int(520) [1] => int(504) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [5] => array(2) &#123; [0] => int(531) [1] => int(493) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [6] => array(2) &#123; [0] => int(498) [1] => int(526) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//   [7] => array(2) &#123; [0] => int(1024) [1] => int(0) &#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// &#125;</span></span></code></pre><p>因此进行密钥派生是有必要的。</p><h2 id="Ed25519-的使用"><a href="#Ed25519-的使用" class="headerlink" title="Ed25519 的使用"></a>Ed25519 的使用</h2><p>Ed25519 签名的相关函数统一称为 <code>sodium_crypto_sign_*</code>，主要用到以下函数：</p><ul><li>直接生成密钥对：<code>sodium_crypto_sign_keypair</code></li><li>从私钥生成密钥对：<code>sodium_crypto_sign_seed_keypair</code></li><li>从密钥对中提取私钥和公钥：<code>sodium_crypto_sign_secretkey</code>、<code>sodium_crypto_sign_publickey</code></li><li>签名：<code>sodium_crypto_sign_detached</code></li><li>验证：<code>sodium_crypto_sign_verify_detached</code></li></ul><p>同样使用 <a href="https://datatracker.ietf.org/doc/html/rfc8032#section-7.1">Ed25519 的标准测试向量</a>作为演示：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">private</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_sign_seed_keypair</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    hex2bin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">833fe62409237b9d62ec77587520911e9a759cec1d19755b7da901b96dca3d42</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">message</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> hex2bin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">''</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    .</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">ddaf35a193617abacc417349ae204131</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    .</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">12e6fa4e89a97ea20a9eeee64b55d39a</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    .</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">2192992a274fc1a836ba3c23a3feebbd</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    .</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">454d4423643ce80e2a9ac94fa54ca49f</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sign</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_sign_detached</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_sign_secretkey</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">private</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">public</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> sodium_crypto_sign_publickey</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">private</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">assert</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">sodium_crypto_sign_verify_detached</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sign</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">public</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">var_dump</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bin2hex</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">public</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">),</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> bin2hex</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sign</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// string(64) "ec172b93ad5e563bf4932c70e1245034c35467ef2efd4d64ebf819683467e2bf"</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// string(128) "dc2a4459e7369633a52b1bf277839a00201009a3efbf3ecb69bea2186c26b58909351fc9ac90b3ecfdfbc7c66431e0303dca179c138ac17ad9bef1177331a704"</span></span></code></pre><p>这里的密钥对长度为 96 字节，前 64 字节为私钥，后 32 字节为公钥，但是私钥的后 32 字节和公钥是一模一样的……</p><p>Ed25519 的算法中也存在 clamp 处理，但是处理的对象是算法内部对私钥计算 SHA-512 后的值，因此也不需要手动操作，改变私钥的话签名结果一定会改变。</p><p>顺便一提，签名是为了保证消息的完整性。教科书里提到签名的做法一般都是对明文&#x2F;密文计算 hash 然后对 hash 签名，或者是对明文计算 hash 然后将 hash 和明文一起加密，方法很多，但是自己和加密算法组合的话容易出错。作为改进，后来出现了一类称为“认证加密”（Authenticated Encryption with Associated Data）的算法，可以在不另外使用签名的情况下同样保证完整性。认证加密与一般的加密的区别在于：</p><ul><li>加密时，除明文和密钥外，还需要输入“附加的认证信息”（Associated Authenticated Data）。</li><li>加密后，除了密文还会得到一定长度的消息认证码 MAC，需要随密文一起发送出去。</li><li>解密时，需要输入相同的认证信息和加密得到的 MAC 进行验证，如果密文被篡改则会导致验证失败。</li></ul><p>常见的认证加密算法包括 AES-GCM 和 ChaCha20Poly1305 等，如果使用了认证加密算法就不需要另外进行签名了。</p><h1 id="在-OpenSSL-中使用-Curve25519-算法"><a href="#在-OpenSSL-中使用-Curve25519-算法" class="headerlink" title="在 OpenSSL 中使用 Curve25519 算法"></a>在 OpenSSL 中使用 Curve25519 算法</h1><p>作为加密库，libsodium 比较小众，相比之下还是 OpenSSL 有更广泛的使用。除了在各大 Linux 发行版里已有预装，大多数编程语言也内置了相应的 binding，比如 PHP 中同样是随本体一起附带的同名扩展，Node.js 自带的 crypto 模块就是对 OpenSSL 的封装。</p><p>OpenSSL 从 1.1.0 和 1.1.1 开始分别加入了对 X25519 和 Ed25519 的支持，不过 binding 不一定都能跟进，PHP 的 OpenSSL 扩展就仍然没有提供相关的功能（再吐槽一下，它虽然支持 ChaCha20Poly1305 的加密解密，但是并没有被当成一种认证加密算法来使用，也就无法获取和验证 MAC，<a href="https://bugs.php.net/bug.php?id=76935">这个问题从 PHP 7.2 开始提出三年了都还没有解决</a>），Node.js 的 crypto 倒是已经支持了，至于其他语言的 binding 我反而没用过，在另一个常用的语言 Python 那边我用得最多的加密库不是 <a href="https://github.com/pyca/pyopenssl">pyOpenSSL</a> 而是 <a href="https://github.com/Legrandin/pycryptodome">PyCryptodome</a>，后者和 OpenSSL 毫无关系而且也只支持 NIST 标准曲线而不支持 Curve25519……</p><p>总之下面先用 OpenSSL 的 CLI 作为 X25519 的使用例好了。</p><p>对于 X25519 密钥交换，参考 Stack Overflow 上的<a href="https://crypto.stackexchange.com/questions/75547/#answer-75548">这个回答</a>，稍微改一改使用的算法就可以了。首先是生成私钥：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> genpkey</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -algorithm</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x25519</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -outform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> genpkey</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -algorithm</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x25519</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -outform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.der</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.der</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 f8 fe 42 87 cc 79 8a 8b b9 1b fc 71 16 fc 75 32</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040 e3 4f 63 06 07 e4 fc 46 75 1d 1e d8 63 96 7e 48</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000060</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 00 f9 28 97 40 10 c9 9d c0 56 76 b9 bf ae a3 a2</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040 3c 67 8d 8e 13 10 15 5e 36 c4 ba ed 28 16 83 58</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000060</span></span></code></pre><p>嗯？X25519 的公私钥都是 32 字节的，怎么这里输出了 48 字节的东西？</p><p>因为那 32 字节是原始的密钥，而 OpenSSL 使用的是实际应用中封装了包括但不限于算法名称、数学参数、版本号、序列号、有效期等等信息的 X.509 或 PKCS 标准的证书格式，这些内容在证书里又按照 ASN.1 标准被序列化。直接保存序列化后得到的二进制数据的证书格式叫做 DER，考虑到使用二进制数据时可能存在不便，因此还有另一种等效的 PEM 格式，这种格式以字符串 <code>-----BEGIN/END ...-----</code> 开头&#x2F;结尾，将二进制数据通过 Base64 编码后存在中间。上面输出的就是 DER 格式的私钥。平时使用 https 上网时，浏览器收到的服务端的证书就是这类格式的。</p><p>那这 48 字节包括了什么信息呢？找个<a href="https://lapo.it/asn1js/">在线的 ASN.1 解析器</a>查看一下：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1895*609),609px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/161fc914e60bd96f3771bdb9890e9572/393h53-2.webp" data-src="https://p.sda1.dev/12/94ba51843ce3e45fe460df6de6dc4385/4IppY4lY.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRkgAAABXRUJQVlA4IDwAAAAwAwCdASogAAoAPrVMn0ooiWwCADgFolpAABbTyql0UUiAAP6xZ8HQ5f/TtCknRlMfzotfGGGXgjBAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/94ba51843ce3e45fe460df6de6dc4385/4IppY4lY.png"                                                                                            >                        </noscript>                    </figure>                <p>这些数据使用的是 <a href="https://datatracker.ietf.org/doc/html/rfc5208#section-5">PKCS#8 格式</a>，添加了 X25519 的算法标识和一些结构信息，不难注意到前 16 字节是固定的，后 32 字节就是私钥本身，因此其实也可以把固定的前 16 字节 <code>30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</code> 抽出来，然后自己从 CSPRNG 里取出 32 字节拼接到一起：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># openssl genpkey -algorithm x25519 -out alice.der -outform der</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># openssl genpkey -algorithm x25519 -out bob.der -outform der</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">echo</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -n</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">MC4CAQAwBQYDK2VuBCIEIA==</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> base64</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -d</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ></span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">echo</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -n</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">MC4CAQAwBQYDK2VuBCIEIA==</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> base64</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -d</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ></span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">dd</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> if=/dev/urandom</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bs=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">32</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> count=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> >></span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">dd</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> if=/dev/urandom</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bs=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">32</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> count=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> >></span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.der</span></span></code></pre><p>然后是从私钥生成公钥：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> pkey</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -pubout</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -in</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.pub</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -inform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -outform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> pkey</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -pubout</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -in</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.pub</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -inform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -outform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.pub</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.pub</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 30 2a 30 05 06 03 2b 65 6e 03 21 00 23 1b c3 9e</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 38 65 a8 e4 b9 1c e9 de 37 7f a2 8b 9f 06 ad 64</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040 83 79 24 86 d3 ca 41 08 26 67 6c 38</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000054</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 30 2a 30 05 06 03 2b 65 6e 03 21 00 1b 39 77 8a</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 f5 cd 2d 61 2f 49 4d 91 94 6c ce ee b1 e5 bc e9</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040 6f 65 03 02 c1 21 c5 76 4f 2c 99 0b</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000054</span></span></code></pre><p>同理，这里的二进制数据使用的是 <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.1.2.7">SPKI 格式</a>，固定的前 12 字节 <code>30 2a 30 05 06 03 2b 65 6e 03 21 00</code> 可以抽出来，和从 libsodium 或是别的方式收到的 32 字节公钥拼起来。</p><p>最后是密钥交换，这次得到的就直接是 32 字节的共享密钥了：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> pkeyutl</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -derive</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alicebob.key</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -inkey</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -peerkey</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.pub</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -keyform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -peerform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> pkeyutl</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -derive</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bobalice.key</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -inkey</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bob.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -peerkey</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alice.pub</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -keyform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -peerform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cmp</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alicebob.key</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bobalice.key</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> alicebob.key</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> bobalice.key</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 01 e0 1d 2b 07 d7 c0 1d e9 28 ef c2 ea b7 f6 a0</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 6b 27 ab fa dc 73 52 f7 58 92 de 2b cd d0 cd 44</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 01 e0 1d 2b 07 d7 c0 1d e9 28 ef c2 ea b7 f6 a0</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 6b 27 ab fa dc 73 52 f7 58 92 de 2b cd d0 cd 44</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040</span></span></code></pre><p>至于在 CLI 中使用 Ed25519 签名……签名和验证的功能<a href="https://github.com/openssl/openssl/issues/11633">并没有加入 CLI</a>，原因是 RSA 和 ECDSA 签名都是先要另外选择一种算法对消息计算 hash 后再使用算法对 hash 签名，但是 Ed25519 不需要这么做，而是直接将消息输入签名算法，在算法内部钦定了使用 SHA-512 计算 hash 然后进行后续操作。由于“输入算法的是消息的 hash 还是本体”这一过程存在不同，因此 OpenSSL 一开始没有将 Ed25519 签名和验证加入 CLI（<a href="https://github.com/openssl/openssl/issues/6988#issuecomment-618297128">在 3.0.0 中加入了</a>，不过这个版本刚发布没多久而且可能存在不兼容的变更，因此我没有自己使用这个版本进行测试），但是源代码还是支持的。</p><blockquote><p><a href="https://github.com/openssl/openssl/blob/bb17971acb0d891b734991091244b90019968c65/doc/man1/pkeyutl.pod#notes">openssl&#x2F;doc&#x2F;man1&#x2F;pkeyutl.pod</a></p><p>The Ed25519 and Ed448 signature algorithms are not supported by this utility. They accept non-hashed input, but this utility can only be used to sign hashed input.</p></blockquote><p>当然生成密钥对还是支持的：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> genpkey</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -algorithm</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> ed25519</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> private.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -outform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> private.der</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 30 2e 02 01 00 30 05 06 03 2b 65 70 04 22 04 20</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 8a da 59 23 d4 7d a0 ed 36 c8 a6 6e 26 26 3a 75</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040 b4 a4 f7 48 91 5a 8e c3 7f 45 71 8b 38 f1 da 8b</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000060</span></span><span class="line"></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">openssl</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> pkey</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -pubout</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -in</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> private.der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -out</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> public.pub</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -inform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -outform</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> der</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cat</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> public.pub</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> |</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> od</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -t</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> x1</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000000 30 2a 30 05 06 03 2b 65 70 03 21 00 e1 42 2a ee</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000020 ec 89 33 41 96 74 fd 6d ec d6 a7 69 94 2b 58 1d</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000040 5e 37 e4 d2 e8 f8 d6 41 79 3d 97 a4</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 0000054</span></span></code></pre><p>仍然可以提取出私钥和公钥的前几个字节和原始的密钥拼接，私钥的前 16 个字节是 <code>30 2e 02 01 00 30 05 06 03 2b 65 70 04 22 04 20</code>，公钥的前 12 个字节是 <code>30 2a 30 05 06 03 2b 65 70 03 21 00</code>，其实只是算法标识不同而已。</p><p>再附加一个在 Node.js 中通过 crypto 模块使用 X25519 和 Ed25519 的例子，使用的还是前面的标准测试向量，因为太长所以这里就折叠了：</p><details><summary>X25519 使用例</summary><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> crypto</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> require</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">crypto</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> x25519PrivateKeyPkcs8Header</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">302e020100300506032b656e04220420</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> x25519PublicKeySpkiHeader</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">302a300506032b656e032100</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// const &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//     privateKey: privateKeyA,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//     publicKey: publicKeyA,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// &#125; = crypto.generateKeyPairSync('x25519');</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// const &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//     privateKey: privateKeyB,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">//     publicKey: publicKeyB,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// &#125; = crypto.generateKeyPairSync('x25519');</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> privateKeyA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">createPrivateKey</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    key</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">concat</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        x25519PrivateKeyPkcs8Header</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">77076d0a7318a57d3c16c17251b26645df4c2f87ebc0992ab177fba51db92c2a</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        )</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    ])</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    format</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">der</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    type</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">pkcs8</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> privateKeyB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">createPrivateKey</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    key</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">concat</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        x25519PrivateKeyPkcs8Header</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">5dab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        )</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    ])</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    format</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">der</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    type</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">pkcs8</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// const publicKeyA = crypto.createPublicKey(&#123; key: privateKeyA &#125;);</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// const publicKeyB = crypto.createPublicKey(&#123; key: privateKeyB &#125;);</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> publicKeyA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">createPublicKey</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    key</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">concat</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        x25519PublicKeySpkiHeader</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">8520f0098930a754748b7ddcb43ef75a0dbf3a0d26381af4eba4a98eaa9b4e6a</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    ])</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    format</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">der</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    type</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">spki</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> publicKeyB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">createPublicKey</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    key</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">concat</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        x25519PublicKeySpkiHeader</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">de9edb7d7b7dc1b4d35b61c2ece435373f8343c85b78674dadfc7e146f882b4f</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    ])</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    format</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">der</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    type</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">spki</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> sharedA</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">diffieHellman</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    privateKey</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> privateKeyA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    publicKey</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> publicKeyB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> sharedB</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">diffieHellman</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    privateKey</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> privateKeyB</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    publicKey</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> publicKeyA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">equals</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedB</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sharedA</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// true</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 4a5d9d5ba4ce2de1728e3bf480350f25e07e21c947d19e3376f09b3c1e161742</span></span></code></pre></details><details><summary>Ed25519 使用例</summary><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> crypto</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> require</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">crypto</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> ed25519PrivateKeyPkcs8Header</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">302e020100300506032b657004220420</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> ed25519PublicKeySpkiHeader</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">302a300506032b6570032100</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// const &#123; privateKey, publicKey &#125; = crypto.generateKeyPairSync('ed25519');</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> privateKey</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">createPrivateKey</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    key</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">concat</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        ed25519PrivateKeyPkcs8Header</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">833fe62409237b9d62ec77587520911e9a759cec1d19755b7da901b96dca3d42</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        )</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    ])</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    format</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">der</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    type</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">pkcs8</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// const publicKey = crypto.createPublicKey(&#123; key: privateKey &#125;);</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> publicKey</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">createPublicKey</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    key</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">concat</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        ed25519PublicKeySpkiHeader</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">ec172b93ad5e563bf4932c70e1245034c35467ef2efd4d64ebf819683467e2bf</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">            '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    ])</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    format</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">der</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">    type</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">spki</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> message</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">from</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">ddaf35a193617abacc417349ae20413112e6fa4e89a97ea20a9eeee64b55d39a</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">2192992a274fc1a836ba3c23a3feebbd454d4423643ce80e2a9ac94fa54ca49f</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> sign</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">sign</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> privateKey</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sign</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">toString</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hex</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">crypto</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">verify</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> message</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> publicKey</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sign</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// dc2a4459e7369633a52b1bf277839a00201009a3efbf3ecb69bea2186c26b58909351fc9ac90b3ecfdfbc7c66431e0303dca179c138ac17ad9bef1177331a704</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// true</span></span></code></pre></details><hr><p>最后再记录一下我把“信息的安全传输”这个大作业的流程修改成了什么样子，首先是密钥交换阶段：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/861*501),501px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://p.sda1.dev/23/9774986d06ea9965e71a69444001f371/zkmH.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRqIDAABXRUJQVlA4TJYDAAAvH4AEEMcmubZt1Yrmxt2hS/5jEARd4nB3q3qy04Ac2bZqZa1z38fdI2JIFmTHkFQgj+9674Ze27arY+4X5ExtWlCcXlSgAH5m34d3N9wAgBQpM6fzj7u7kz3fBpF7AbRATE7qELlTgUfu7u7OuUyABAKIhYmCABDOhZfvL2prJLBaaxBLk7hhNjEXUVAEkzwuWZaRjSRIxLZyR73CwEbNkGYGztmwDJyJNrhpq+3oymx+X+kTAsE3lGbfaM6khIFCkoQAyE0oRSwpi7qreUthhFINpiSywRJMCUqENEhfpbigSMaTqKkhc4oIJbIZAB8NMRAAQQR0zcopXsh9pmTGcFqFRlZaYKGBNPcE/xfNHFYD4NsQq8wk/LmGzEBPW0yTZH2KTOdOjmtDV515cZ35L+hL7CqWR09XkDy8tv5l145p9drwn211yN682T3hyef569b5BZ9+HeHx3735+I9d3qQujtWZpmmrjH/pf8kJs4JhJzBVSR2OhR7/b6PcavVmP73N+7ufCFZr0MXTs3M21ZsGgLsIlvSzNNGC9o+twWHwgsdxyJwiZxpgPP71/vU1+Ntp4AitcQe6ciLelGcHUboIc9du36owRKnPIUhetNl32DF/f9fOjyP+edraj5M2vw+Kn2PFYYqQWMibYPQa3hGFHHEPFoqMAxoYwoBPlOEJUUSEkUmn/qlVMRGc13XYxdm2SS/yptMFd3m2G1phKthpR6EAljKHD9rx3IoLbh7n/fn7sfLffi9Dom3bxt7Ytm3btm3btpOaqRmnto3UjVV3PU/0PUJE/yeAHR/sATiwH6H39h7uO0r3vkP9QnUNDwx2cmTPwJC4QIsvN97A99cb7xFSBObern+AhXfrH3cmNjE6emV69MEkNa5ObmDu4GwL46Njj7bi8sj5e3fPjFzCPDUtGVrKU1z4f/LE2WtbiUzduD5TrampgrSOpg00ahppgG6TnoS6voEadJy7cPG0cUysN6350WWiKOTGlYqQF5dv2RAf7w5cvX3nobSiojLUmlgB1qr1oKQoi4ypqQxw6tjx+2yuS89MhOacjHCkAkN82yorSrSAqVs3Z7aQ1jG0gUZNQw0kA0KC2qv8/bTh398/v39tYZ6QHQrySVnB7Pzb7OyTLWrsHe3A3MHRdhc7lCks9gS5giIPocyiIn3AIizCS6i1z8tfYfXTyhehnj7/+QKWnv14JRSL83PA4/m5HQE"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/23/9774986d06ea9965e71a69444001f371/zkmH.svg"                                                                                            >                        </noscript>                    </figure>                <ol><li>客户端和服务端预先生成 Ed25519 密钥对。</li><li>客户端和服务端建立连接，服务端发送自己的 Ed25519 公钥，客户端可以选择是否信任。<ul><li>由于没有 CA，所以客户端只能自己确认收到的服务端公钥是否正确了。</li><li>这个参考的是 SSH 登录的流程，第一次登录时也会显示出服务端的公钥，如果客户端不信任或是收到的公钥和之前信任的不同则会终止连接。</li></ul></li><li>客户端发送自己的 Ed25519 公钥，服务端可以无条件信任或根据一个白名单决定是否信任。</li><li>双方各自生成 X25519 密钥对，然后互相交换公钥和时间戳以及对这两项的组合生成的签名。<ul><li>添加时间戳是为了防止重放攻击，其实还应该再加一个 nonce。</li></ul></li><li>确认签名无误后，双方使用密钥派生算法产生会话密钥和认证加密的认证信息，创建 ChaCha20Poly1305 加密&#x2F;解密上下文。</li></ol><p>然后是传输文件阶段：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/401*501),501px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://p.sda1.dev/23/f0c856974ea4981cb84533bda7cf8b71/rAuY.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRmAEAABXRUJQVlA4TFMEAAAvGcAHEG8nOZIkR468amZ2wQEdoL8Z++MLLWB4cU7vhnWpAaG2bdXK2le+40SgAp3oSRJ3d7jvnA1Hsm3Vytrn3fcVd8k1sumTMwqN3B2ubDi2rR17zvt+X2zbdpc2dSpzKhkC67RurT6D+G3b/v+8AeqABBLUAQEEaAYC6EAADXSVbQGFk92Flq52LYdbs9E429i43SlNTg8NftTLrV/tc6wK1A73qgDp7IjqcaQWRocVeYgQFAqUyB0yBKmVVA/apQVZhxW0QkIRQEElLS3uqicEHUFHEIJAJCIRvYJeQRIkIiUGOjqJ9vb9Pbv+/8yKZbGHR/49Y5Tq+Jlv3T6sCn6Nm3afP1k/y0dXP+MniGE5y8/DNd8351QWmqmGUWytIF0yLfkPk4KaCrvhcqF/0BXgKTvRoKWSJIis2UjjTak6g1/hP8KaCU2JXIvm1EtlIBV+i2X7K/nNXxr+7xfzqW6LUYAgBATZxHYvWFXvvi9yvmUdjo5c3mVqU52ukdzzf+4xFC6rlvbIMuydv2ksigroYXVH6aqNFhV4G81ZtIyiREiNC63JKLEGgvy/umlFnlPY3GpSTMVkLHLBb1xUqLJGqa5d4VlNdfR9699vNjd/YaUd/H39tI3x7+kO/2efnu4a1hfddGy3vvCdvuN0pFHE9fHOjjx41ldy2kyjj6ocDbeRYtqoV/Kiz8wqUUCXVlghFNQiUZoWKBIUG4RAFZS2oDpGDhUx17RwMIcQpGCokIIAQhCC3Q5bF/uwSNPbBikIwfj2c3bz0Z9/vr7/uT6znk0nNzWZCmiqtvqNGYYyMBTApgIqQUJLo1fT8hoLSxQnUHDp8uTl3SBh27bzT/jbsm3btu36Zy8by7Ztt4w5e9nbMufM50v8fr83fILrieg/A7eNFHn5GPoK+ZcyYVifgYHjbJNH9BsUONJkuKdzJ88Q29ieXbt06zvFYHT/Hp5eQ23jB/T2dB880bgpaNQkcRYdE2ScFakMFLXlqVIZKpgUr1a3npax5a1Wo6FWNclfVstpIVvusqpa0iQ0JCxryEkBOH0KogwyLkgFFtteP4mN0zd+bhnmTJ+pM+ZnsuD3S3314lkmCwIcdeMKVd0swMUbN9/eihbAcgjeChyynb9yOeLsBaFNzo5tc2YXln/h89dV3oLXmUf68MEd/ywta9bS2q2FJSkfkj/t8bfg3OO4WO5ZmZvXr6faQji4nh3sFeDSdeCakKsgkMN29ITTgfXAJjGURVNVdaEFHFedpokmS5OTUlgmwJHUpOSUbybBW7cfc17o8JatsN9k44pdOw1fWDXaR/KVAgoIc+MT4t/Ps4B3MU+fx9xNk7ZZ08ZNGrUS1n0H1gpw9b6q3hZKV1PVEkJoiIYb/n62yCihQ3tVbSemH8e+NexmpbiK2Ybvs2Z//PV3tv38AavNfNOJu6QHk8KVqUQxV5orUt6c5jp13Wmu3uCPadY/pPk/FAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/23/f0c856974ea4981cb84533bda7cf8b71/rAuY.svg"                                                                                            >                        </noscript>                    </figure>                <ol><li>客户端发送文件名、文件大小等元数据，服务端进行检验并创建文件。</li><li>客户端分块读取文件，加密后发送，服务端解密并写入文件。</li><li>客户端发送完文件后发送 MAC，服务端验证。如果验证失败则删除文件并提示。</li></ol><p>流程图是当时写实验报告时做的 ε-(•́ω•̀๑)</p><p>其实如果都是在桌面端使用的话应该使用 AES-GCM 的……因为桌面端都有 AES 指令集。比较加密速度的话，同样是 256 位密钥的对称加密，使用指令集的 AES 最快，其次是 ChaCha20Poly1305，不使用指令集的 AES 最慢。</p>]]></content>
    
    
    <summary type="html">以及一些在学校里学的密码学课程不会讲到的东西</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Hashids 算法和实现原理介绍</title>
    <link href="https://akarin.dev/2021/02/26/hashids-description/"/>
    <id>https://akarin.dev/2021/02/26/hashids-description/</id>
    <published>2021-02-26T08:22:56.000Z</published>
    <updated>2021-02-26T08:22:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>Hashids 是一个小巧的开源库，几乎所有的编程语言都有相应的实现，可以将一个或多个非负整数编码成看上去比较随机的短字符串。按照<a href="https://hashids.org/">官网</a>上的例子，<code>347</code> 可以编码成 <code>yr8</code>，<code>[27, 986]</code> 可以编码成 <code>3kTMd</code>，编码结果会根据初始化时的设置而不同，但只要<strong>保持设置相同</strong>就可以将编码后的字符串<strong>解码恢复成原来的数值</strong>。</p><p>这类算法一般可以用在数据库的自增 ID 上，如果需要把它写在 URL 或者 API 请求之类的地方展示出来但又不想轻易地被爬虫爬一遍的话……</p><p>例如以前屑站使用 AV 号对视频进行编号，实际上也是一个自增 ID，于是写个请求 <code>http://acg.tv/av&#123;i&#125;</code> 的爬虫，然后将 <code>i</code> 的值设为 0、1、2……如此一直爬下去，就可以获取到屑站所有视频的数据。后来屑站实装了 BV 号，av170001 变成了 BV17x411W7Kc，一时看不出规律，写爬虫就不怎么方便了。这个 BV 号就是对 AV 号使用 Hashids 类算法编码的结果。</p><p><em>不过 BV 号实装后没多久就有人翻出了 <a href="https://www.zhihu.com/question/381784377/answer/1099438784">AV 号和 BV 号互转的算法</a>，并且 AV 号仍然可以照常使用，所以折腾出 BV 号这东西的意义嘛……另外 av99999999 之后的视频的 AV 号就<strong>不再自增</strong>而是<strong>随机生成</strong>了，真正起到反爬虫作用的其实是这个才对。</em></p><p>又比如你写了一个论坛，帖子的 ID 一般就是自增的。直接将自增 ID 展示出来的话，所有人都可以很容易地算出这个论坛每天发了多少帖子，由此继续分析用户活跃程度之类的……就像下面这样，注意写着 No. 的地方：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1637*758),758px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/aa3f214a61541fc3f703bc57bf524b8f99487.jpg" data-src-webp="https://p.sda1.dev/12/d96e21c28417a0952f5a4537eacc3bce/Q6bE2pMp.webp" data-src="https://p.sda1.dev/12/9100ab9c46b45700cc9159334ec85ce4/ut-Q4J-V.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRoQAAABXRUJQVlA4IHgAAAAQAwCdASogAA8APrVMoUquhgEAHALRKAJ0ygApGrEkxAAA/v5C9pVYGLU+n33VBMYKyGd3MF3+sXmVxSreHOO7yUraBoJHvIdbZ82Szri7C4bO5wECW3oDGKCuXJv9OmGROYXVVbOgs6Bsf1rplvrb91fAsHZAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/9100ab9c46b45700cc9159334ec85ce4/ut-Q4J-V.png"                                                                                            >                        </noscript>                    </figure>                <p><em>A 岛默许了这个统计，而且使用自增 ID 的串号表示回复和引用本身就是 A 岛社区文化的重要一部分，<del>比叔叔把已是屑站象征之一的 AV 号雪藏掉不知道高到哪里去了</del>。当然对这个串号使用爬虫（又称“爬岛”）还是不允许的。</em></p><p>Hashids 可以自定义编码时用到的字符表（默认是大小写字母数字，但是使用任意 Unicode 字符例如汉字和 emoji 也是可以的），还可以设置编码后字符串的最小长度（默认不设置，设置后编码得到的字符串长度小于此值则会用一定方式填充），另外还有叫 salt 的设定，设置不同的 salt 也会影响编码结果（就像加盐的 hash 算法那样？！）。可以在<a href="https://jsbin.com/kebobahude/edit?html,js,console">这里</a>随意尝试～</p><h1 id="Hashids-真的属于-hash-算法吗？"><a href="#Hashids-真的属于-hash-算法吗？" class="headerlink" title="Hashids 真的属于 hash 算法吗？"></a>Hashids 真的属于 hash 算法吗？</h1><p>虽然 Hashids 的名字里面就写着 hash，而且设置里也用上了 salt 这种确实和 hash 算法有关的词，但是它真的是一个 hash 算法吗……找出 hash 算法的定义来对比一下：</p><ul><li>给定原始数据，很容易可以计算出对应的 hash 值。显然成立。</li><li>即使原始数据出现很小的差异，对应的 hash 值也会有巨大的变化，尽量不要产生碰撞。在上面的“随意尝试”里就可以看出确实会产生巨大变化（虽然某些地方的变化并不大……），而且按照 Hashids 的原理（稍后说明）冲突是完全不可能产生的。</li><li>给定 hash 值，反过来计算原始数据是很难的。嗯？Hashids 编码得到的字符串是可以恢复的啊？</li></ul><p>最后一条定义说明了 Hashids 实际上并不是一个严格意义上的 hash 算法。虽然各种真正的 hash 算法（例如 <a href="https://zh.wikipedia.org/wiki/Bcrypt">bcrypt</a> 或者各种 <a href="https://zh.wikipedia.org/wiki/%E5%AF%86%E9%92%A5%E6%95%A3%E5%88%97%E6%B6%88%E6%81%AF%E8%AE%A4%E8%AF%81%E7%A0%81">HMAC</a>）都有 salt 的设定，但是就算知道了 salt 也很难恢复出原始数据，而 Hashids 的这个 salt 嘛……完全相反，所以它起到的更像是加密算法中密钥的作用。</p><p>实际上 Hashids 是使用进制转换的方式对数值进行编码的，将一般的数转换为十进制是固定使用数字 <code>0-9</code>，十六进制是数字 <code>0-9a-f</code>，而 Hashids 要转换到几进制和设置的字符表的长度有关，<strong>对每个数的每一位使用的“数字”是根据输入数值和设置的 salt 按照一些规则打乱字符表得到的</strong>，所以 Hashids 更像是一种多表代换密码，就像维吉尼亚密码那样，虽然每个字符都使用简单的凯撒密码加密，但是 offset 不同，于是攻击难度稍微提高了。</p><p>就算是在这里把 Hashids 当成加密算法，它的强度也不算太高，绝对不是密码学上安全的算法，所以**严禁将 Hashids 用于加密机密数据，更不要真的像使用 hash 算法一样把它用于保存密码。**按照<a href="https://carnage.github.io/2015/08/cryptanalysis-of-hashids">这里</a>的分析，在使用选择明文攻击、字符表等设置使用默认值但不知道 salt 的情况下，通过解一组方程分析 salt 的前三个字符有大概 200 种可能，这个数量已经大大低于暴力破解需要尝试的次数了。</p><p>为什么设计这个算法的人选用了 hash 和 salt 之类的名词？按照<a href="https://hashids.org/#why-hashids">官网上的说明</a>，因为对一般人来说，它看起来像 hash，走路像 hash，叫声像 hash，那么它就是……⊂彡☆))д&#96;)</p><blockquote><p>Why “hashids”?</p><p>Originally the project <strong>referred to generated ids as hashes, and obviously the name hashids has the word hash in it</strong>. Technically, these generated ids cannot be called hashes since a cryptographic hash has one-way mapping (cannot be decrypted).</p><p>However, when people search for a solution, like a “youtube hash” or “bitly short id”, they usually <strong>don’t really care of the technical details</strong>. So hashids stuck as a term — an algorithm to obfuscate numbers.</p></blockquote>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/664*493),493px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/d634d60ebe06feb4793ba06f3c7e91076047.jpg" data-src-webp="https://p.sda1.dev/12/c7f2390a9afd1ddc0c3231deed88a5f9/XSpAU-lx.jpg" data-src="https://p.sda1.dev/12/2ba066d73298f9705dbaeb08ca4bcc89/mRAQGV5H.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRjgBAABXRUJQVlA4ICwBAADwBQCdASogABgAPp0+mEmsCW36ACwE4lqALEegzoskAp/CNT1379ruhfZHYBv/WkDfyCBvEYwzIAD++W0dUkR32hQUFVcdcSKtFn13MuIxS7Pb2HaTLCjiDV7fiqJdlFnD6caoJlRHMNw6GwMgFxg33UryKT8Kva64JoiqniuvFH0GdNus7TrbnKh0SPsth8R/m9JBsNpOoaAEg7W2TxvdHXSUNJPLa3B3TfQqD9fMFrSBnY4PsQiTPw7z84mf0+CxXntnpqGuuFIU0w5adXzz7noFToeVzpP+P65UZU5hhPTeD90eP9ynb8bre7oH/qx4Qamy9du4sZZEZIzpGeO4zL3sTHRc7pcVUXJ5jXpwi59A8Plnhm/R8uqxfwgUhNlyQSkn1jB0CGIAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/2ba066d73298f9705dbaeb08ca4bcc89/mRAQGV5H.jpg"                                                                                            >                        </noscript>                    </figure>                <hr><p>从这里开始就是介绍 Hashids 的比较详细的实现细节了。在此之前我 Google 了一下介绍 Hashids 的文章，基本上都是简单介绍一下它的主要用途是混淆自增 ID，然后就是一大堆复制粘贴的用法示例了，偶尔有几篇提到了“进制转换”不过也并不是很详细……所以接下来我会参考 <a href="https://github.com/niieani/hashids.js/blob/master/lib/hashids.ts">TypeScript&#x2F;JavaScript 版实现的源码</a>详细介绍一下编码和解码的原理（其它语言的实现应该也是类似的）。</p><p>如果只是想要简单了解 Hashids 原理的话，可以直接阅读<a href="https://hashids.org/#how-does-it-work">官网上的介绍</a>，简略介绍了进制转换等各种涉及到的步骤。想要了解更多细节的话就继续往下翻吧～</p><hr><h1 id="算法的初始化"><a href="#算法的初始化" class="headerlink" title="算法的初始化"></a>算法的初始化</h1><p>所有的编码和解码都是使用同一个 Hashids 对象的实例，在创建这个实例时进行算法的初始化，一般情况下需要输入以下参数：</p><ul><li>salt：一个可以包含任意字符的字符串，对之后打乱字符表的结果有影响。默认是留空。</li><li>minLength：最小长度，编码得到的字符串长度小于此值则会用一定方式填充。默认是留空。</li><li>alphabet：初始字符表，不能有重复字符，编码结果只可能含有这里的字符，即使字符相同顺序不同也会改变结果，长度至少为 16。默认是 <code>a-zA-Z1234567890</code> 一共 62 个字符。</li><li>seps：编码中用于分隔各个数值的字符（稍后说明 x2），必须是 alphabet 的子集，但是不要求字符不重复，顺序也会影响结果。默认是 <code>cfhistuCFHISTU</code>，原作者的想法是使用这些字母做分隔符可以<a href="https://hashids.org/#cursing">避免编码结果中出现粗鄙之语</a>。</li></ul><p><em>实际上 JS 版实现会<a href="https://github.com/niieani/hashids.js/blob/f8a2d2f6bbd4ecbe0ec1b0a2aa04a6cbc7048098/lib/hashids.ts#L50">自动处理</a>字符表去重、“不能重复”和“子集”之类的要求。</em></p><p>初始化以后就可以进行编码了。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> hashids</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Hashids</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // salt</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">@salt!</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // minLength</span></span><span class="line"><span style="color:#B48EAD;--shiki-dark:#B5CEA8">    24</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // alphabet: use default</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    undefined</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // seps</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">SEPS</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">hashids</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">encode</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">114514</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1919810</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 893</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 931</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// tY8p8oMWMb76xOS3Jh4uvs2x</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">hashids</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">decode</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">tY8p8oMWMb76xOS3Jh4uvs2x</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// [114514, 1919810, 893, 931]</span></span></code></pre><p>编码后的字符串，看上去是一堆没什么规律的字母数字，实际上可以分成几个部分。例如上面得到的字符串 <span style="color:#e77">tY8</span><span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span><span style="color:#e77">s2x</span> 就可以分为用不同颜色表示的以下部分：</p><ul><li><span style="color:#9c6">单个数值编码后的值</span></li><li><span style="color:#273">seperator，也就是不同数值之间的分隔符</span></li><li><span style="color:#f80">lottery，用于在编码过程中打乱字符表</span></li><li><span style="color:#63b">guard，用于分隔编码部分和填充部分</span></li><li><span style="color:#e77">编码后字符串左右两边的填充</span></li></ul><p>前三个是实际的编码部分，后两个用于填充，只有设置了最小长度的情况下才有可能出现在编码结果中。</p><p>Hashids 算法中经常需要打乱字符串中的字符，使用的都是下面这个<a href="https://github.com/niieani/hashids.js/blob/f8a2d2f6bbd4ecbe0ec1b0a2aa04a6cbc7048098/lib/hashids.ts#L302">稍有修改的 Fisher–Yates Shuffle 洗牌算法</a>，除了要打乱的字符串（拆成了包含所有字符的数组）这里还有另一个参数也叫 salt（留空则直接原样返回不打乱），只要字符串和 salt 相同就可以保证打乱结果相同……所以这个 salt 起的明明是随机数生成器中种子的作用吧！(╯‵□′)╯︵┻━┻ <strong>为了不与一开始输入的 salt 混淆，之后就用 seed 表示打乱时的这个 salt 参数好了。</strong></p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">function</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> shuffle</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">alphabetChars</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> saltChars</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    if</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">saltChars</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ===</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        return</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> alphabetChars</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> integer</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> transformed</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> alphabetChars</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">slice</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> v</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> p</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> transformed</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> -</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ></span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">--</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // 在原始的Fisher-Yates Shuffled里，j是0-i范围的一个随机数</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        v</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> %=</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> saltChars</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        p</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +=</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> integer</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> saltChars</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">v</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">codePointAt</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">        const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">integer</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> v</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> p</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">%</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        v</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">++;</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        [</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">transformed</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> transformed</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> [</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">transformed</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> transformed</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    return</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> transformed</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>在上面的例子里，一开始的时候输入了 <code>SEPS</code> 四个字符作为 seps，先从输入的字符表中去掉这几个字符（没有了 E、P、S 这三个大写字母，此时还剩下 <code>62 - 3 = 59</code> 个字符），然后以 salt 作为 seed 将 seps 打乱一次，打乱结果为 <code>SSEP</code>。但是上面的编码结果中还出现了这些字符之外的 seperator（b 和 h），这是因为 Hashids 要求 seps 的字符数量必须不少于字符表长度的 1&#x2F;3.5（向上取整），所以这里需要 <code>Math.ceil(59 / 3.5) = 17</code> 个字符作为 seps，不足的 13 个字符从字符表的前几个字符中取出来，接到 seps 后面补充数量。</p><p>补充之后，最后的 seps 字符列表就是 <code>SSEPabcdefghijklm</code>（后面的 <code>a-m</code> 是从字符表中取出的），字符表是 <code>nopqrstuvwxyzABCDFGHIJKLMNOQRTUVWXYZ1234567890</code>（前面的 <code>a-m</code> 被取走了，还有 <code>59 - 13 - 46</code> 个字符）。</p><p>如果设置了编码后字符串的最小长度的话，编码后可能会需要进行填充。Hashids 通过在实际的编码部分左右各放置一个 guard 字符的方式将编码部分和填充部分分开。guards 也是从字符表中取出的，并不能手动设置，字符数量是字符表长度的 1&#x2F;12（向上取整）。在这里就需要取出 <code>Math.ceil(46 / 12) = 4</code> 个字符。</p><p>先以 salt 作为 seed 将当前的字符表打乱一次，字符表变成了 <code>vpnz0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code>，然后取出字符表的前 4 个字符 <code>vpnz</code> 作为 guards，字符表中剩下 <code>0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code> 一共 42 个字符，这些字符会出现在编码结果的除 seperator 和 guard 以外的所有部分中。</p><p>最后用一个流程图来概括以上的初始化过程：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/960*300),300px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://p.sda1.dev/23/014eb31c5f2f41ff5b6503162045e490/4mBp.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRpABAABXRUJQVlA4TIQBAAAvH0ACEMfiOpJspZq9ON9kQUrkX+XyXM+m4Ta2baU6B5dQc0qA1igYKvgaIXc7iCRJkWrgNaCyl00imBlmWmHbtg3T+f+/GWE0iEIk8B0gabbx00RzFAMQi8JsSQKK6A3t//zE+QQCY8IpgQQSk1eG/FvfBJgtmbAxRVAh7b/kS9l4e/LziJ/xuflSjnhr1ykZJEiJIYGMlBssReuy2nTLAEbdmXoMzWQkWCZl0JUMCLEAqPuQNSK5onXNbK7Hyud/Es9PXF+mOf5en63Hay3u8v3vGHl+D459Lu6PYZupnPpyqC9G4LC2bTO6cfInHNu2bdvqvxZ3ENH/CaCpP8qarHko/FFZn7bkL2R/tCghv88f/pUCgHgT94cPrVxm+KaWzbPoFDJDkMNlp4TiqZgfztHI/mY66jNwjkZ2KKuNRLzzVNIH12jkANOsjoHJqMfgJbFuFkoofXv60S7kBugWihUb6qUy+0o5X5fEG4xGwng9a7jxsW6YTQrFB+Z4L+BLUeUA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/23/014eb31c5f2f41ff5b6503162045e490/4mBp.svg"                                                                                            >                        </noscript>                    </figure>                <h1 id="对输入的数进行编码"><a href="#对输入的数进行编码" class="headerlink" title="对输入的数进行编码"></a>对输入的数进行编码</h1><p>初始化以后就可以将输入的整数编码了，编码期间使用的字符表 alphabet 是从初始化后的 Hashids 对象里复制的，虽然会涉及多次打乱字符表的操作但是并不会改变原对象的字符表，解码的时候也是一样的。</p><p>可能是为了添加更多的随机性，Hashids 算法在编码过程中设置了一个称为 lottery 的字符。对于每个输入的第 a 个数 b（a 是从 0 开始计数的），计算 <code>b % (100 + a)</code> 的和（记为 numbersIdInt，后面还会用到），则 <code>alphabet[numbersIdInt % alphabet.length]</code> 就是 lottery 字符。</p><p>在上面的例子中，初始化以后的 alphabet 是 <code>0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code>，对 <code>[114514, 1919810, 893, 931]</code> 编码得到的 lottery 是 8 也就是 <code>alphabet[13]</code>，是根据以下过程算出的：</p><ul><li><code>114514 % 100 = 14</code></li><li><code>1919810 % 101 = 2</code></li><li><code>893 % 102 = 77</code></li><li><code>931 % 103 = 4</code></li><li><code>numbersIdInt = 14 + 2 + 77 + 4 = 97</code></li><li><code>lotteryIndex = 97 % 42 = 13</code></li></ul><p>然后就是对每个数编码了。前面提过 Hashids 的编码原理是进制转换，现在 alphabet 有 42 个字符，相当于将各个数转换为 42 进制。Hashids 又有多表代换的特征，表现在编码每个数之前 alphabet 都会使用 <code>lottery + salt + alphabet</code> 作为 seed 被打乱一次（取代之前的 alphabet），于是每个数在进制转换时使用的“数字”都是不一样的。</p><p>如果编码的不是最后一个数，编码后还要添加一个 seperator，计算方法是：对于第 a 个数 b，编码后的第一个字符的 Unicode 码点是 c，则需要添加的 seperator 是 <code>seps[a % (b + c) % seps.length]</code>。</p><p>例如，上面的例子中编码的过程：</p><ul><li>使用 seed <code>8@salt!0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code> 打乱字符表得到 <code>8ouNLs4OK5V9wA613QqG7XMYZ0JRTFy2BCHItUWxrD</code></li><li>进制转换的结果是 <code>114514 = 1 * 42 ** 3 + 22 * 42 ** 2 + 38 * 42 ** 1 + 22 * 40 ** 0</code></li><li>转换后的各位数 <code>1 22 38 22</code> 在字符表中对应的字符分别是 oMWM</li><li><code>&quot;o&quot; = String.fromCodePoint(111)</code>，所以添加 seperator：<code>seps[114514 % (0 + 111) % 17] = seps[73 % 17] = seps[5]</code> 也就是 b</li><li>使用 seed <code>8@salt!8ouNLs4OK5V9wA613QqG7XMYZ0JRTFy2BCHItUWxrD</code> 打乱字符表得到 <code>DWsUJ81NVrXqAxtYZ9wuIBG547K2RML3OQTCFH6o0y</code></li><li>进制转换的结果是 <code>1919810 = 25 * 42 ** 3 + 38 * 42 ** 2 + 13 * 42 ** 1 + 32 * 42 ** 0</code></li><li>转换后的各位数 <code>25 38 13 32</code> 在字符表中对应的字符分别是 76xO</li><li><code>&quot;7&quot; = String.fromCodePoint(55)</code>，所以添加 seperator：<code>seps[1919810 % (1 + 55) % 17] = seps[18 % 17] = seps[1]</code> 也就是 S</li><li>……</li></ul><p>最后可以得到未填充的编码部分 <span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span>。</p><h1 id="编码结果的填充"><a href="#编码结果的填充" class="headerlink" title="编码结果的填充"></a>编码结果的填充</h1><p>如果设置了最小长度，而刚刚得到的编码结果长度又不足，那么就需要进行填充了。Hashids 使用放在编码部分左右两边各一个的 guard 字符将编码和填充部分分开，这两个字符均使用 <code>guards[(numbersIdInt + x) % guards.length]</code> 求出，对于左边&#x2F;右边的 guard，x 分别是编码部分第 0&#x2F;1 个字符的 Unicode 码点。先添加左边的 guard，如果已经满足最小长度则不再添加右边的 guard。在上面的例子中：</p><ul><li>guards 是 vpnz</li><li>编码部分长度 16，前两个字符的 Unicode 码点：<code>&quot;8&quot; = String.fromCodePoint(56)</code> 和 <code>&quot;o&quot; = String.fromCodePoint(111)</code></li><li>设置了最小长度为 24，编码结果的长度不足，因此在左边添加 <code>guards[(97 + 56) % 4] = guards[1]</code> 也就是 p</li><li>长度仍然不足，因此在右边添加 <code>guards[(97 + 111) % 4] = guards[0]</code> 也就是 v</li></ul><p>如果添加 guard 之后长度还是不足呢？接下来就会在编码结果的左右两边填充数遍完整的字符表了。</p><ul><li>以 alphabet 自己作为 seed 打乱 alphabet（同样是取代之前的 alphabet）</li><li>将 alphabet 一分为二，前 <code>Math.floor(alphabet.length / 2)</code> 个字符添加到编码结果右边，剩下的字符添加到编码结果左边</li><li>循环到编码结果的长度超过最小长度为止</li><li>取编码结果 result 的从第 <code>Math.floor((result.length - minLength) / 2)</code> 个字符开始的 minLength 个字符作为最后的编码结果</li></ul><p>在上面的例子中，添加了 guard 的编码结果是 <span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span>，打乱一次 alphabet 的结果是 s2xC0oRZAQuLqyK6GwXUHNTB7rV4IOD51MF9WJ3tY8，添加到编码结果的左右两边得到 <span style="color:#e77">NTB7rV4IOD51MF9WJ3tY8</span><span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span><span style="color:#e77">s2xC0oRZAQuLqyK6GwXUH</span>，长度为 60，于是截取从第 <code>Math.floor((60 - 24) / 2) = 18</code> 个字符开始的 24 个字符，得到最后的编码结果 <span style="color:#e77">tY8</span><span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span><span style="color:#e77">s2x</span>。</p><h1 id="解码和校验"><a href="#解码和校验" class="headerlink" title="解码和校验"></a>解码和校验</h1><p>对 Hashids 的解码实际上是把字符串中表示每个数的字符串恢复回原来的数，因为 seps 和 guards 是固定的，lottery 又固定是 guard 之间的未填充的编码部分的第一个字符，所以很容易就可以把每个数的字符串从编码后的字符串里拆出来。按照同样的顺序，每解码一个数之前，先使用 <code>lottery + salt + alphabet</code> 打乱一次字符表，对照字符表得出这个数在 x 进制下的表示，再转换到十进制就可以完成解码了。</p><p>既然这样，那剩下的 seperator 和 guard 还有填充部分随便乱写，也是可以解码出结果的哦？</p><p>当然不能出这种问题啦！所以 Hashids 的<a href="https://github.com/niieani/hashids.js/blob/f8a2d2f6bbd4ecbe0ec1b0a2aa04a6cbc7048098/lib/hashids.ts#L275">处理方法</a>是……<strong>把解码出的数重新编码一遍，如果和输入的字符串不同则按照解码结果无效处理，什么也不返回</strong>。</p><p>看来这些部分还起到了校验码的作用呢。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/43737030">Pixiv ID: 43737030 「Cafe de Lapin」 by Koi</a></p></blockquote>]]></content>
    
    
    <summary type="html">虽然名字里写着 hash，实际上更像是一种多表代替的古典密码算法。</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>成语接龙的求解算法</title>
    <link href="https://akarin.dev/2021/01/28/idioms-solitaire/"/>
    <id>https://akarin.dev/2021/01/28/idioms-solitaire/</id>
    <published>2021-01-28T13:49:38.000Z</published>
    <updated>2021-01-28T13:49:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>以前在某个 V 字头的技术论坛看过一个帖子，某君写了一个网页作为给女朋友的一百天礼物……当然写网页来表白&#x2F;记录恋爱经历这种操作在 V 字头论坛已经被吐槽过不知道多少次了，不过这位某君的想法还是有点创意的——网页内容如下：</p><blockquote><p>为了宣布“○○可爱”为一个合法成语，所以：请输入一个四字成语<br>我将自动为你接龙到“○○可爱”</p></blockquote><p><em>或许你能找到那个帖子也说不定？</em></p><p>○○是某君的女朋友的昵称，总之这狗粮把我噎得……(&#x3D;’_’&#x3D;)</p><p>虽然现在我还没有女朋友啦……不过为了将来自己有女朋友的时候和一百天的时候做好准备<del>实际上还是因为最近实在是太闲了</del>，还是可以对它进行一些分析的～去掉狗粮的部分，它就变成了一个比较有意思的问题：给定起始和结束的成语，如何计算出<strong>这两个成语之间的一条接龙</strong>？</p><p>已经有不少提供在线成语接龙的网站了（比如<a href="http://chengyujielong.00cha.net/">这个</a>），不过这些网站基本上都是允许用户设定一个起始成语，然后生成<strong>指定长度的接龙</strong>。只要不断地搜索“以○开头的成语”，就可以想接多少就接多少，总是能一直接下去的嘛！但是如果还要钦定结束的成语，那问题就变得不一样了。</p><h1 id="问题的分析"><a href="#问题的分析" class="headerlink" title="问题的分析"></a>问题的分析</h1><p>成语接龙只考虑成语的第一个字和最后一个字的读音，这样的话每个成语实际上就是一条<strong>有向边</strong>，而所有的成语就组成了一张巨大的<strong>有向图</strong>。那相当于图的顶点的是什么呢？当然就是不同的读音啦！</p><p><em>这里设定成语接龙的规则是允许使用同音字。当然，即使要求必须使用相同的字，思路也是类似的。<del>证明过程留作习题</del></em></p><p>给定起始和结束的成语，实际上我们在意的也只是<strong>起始成语的最后一个字</strong>和<strong>结束成语的第一个字</strong>的读音。以两个读音作为起点和终点，我们就成功地把成语接龙问题变成了一个**“在图中求最短路径”**的问题。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/482*602),602px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://p.sda1.dev/23/505a545ee4593fdafa382278ed39ad68/7FGq.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRhgDAABXRUJQVlA4TAsDAAAvGcAHEBcGK5Ik1Vb1nL0o4H5dAde/L3oMC2UDciRJiqTIHobnKnA6nEInOzNjT1cl5EiSFEmRDcu7Cpz+2t1vGbqCQSNJikrDnqKzf2LomT+0P3ABM5gwBCAMAUQoWFogDCwBCAukAcIQBIEwtEAaWqFYJrsJIooIUURRKsZkSr21cS+iABdwAB/wAPvH5zVrAaEVZCxBWuQyovw7tDYN6QDUKKIAokoD1ChOfMJYsFb7Wfmz/uJJZykzFo9Y5adJvS3TmLHsvHOOk/kzjT/tY281/b2V33zY7xh3e/+vH3+fTf8sw2+9fFQHhrKP7stvNZcUMJYS4i4Kpi+mgmRi1pKI3SkQMpRZvtrYtQ0bXY3dNgKiRpW7Nb99Pnwk0XT1X796noxWfj9fPOL69Od+ebQqiGjesynHENB/NMsP45fo/1U4iIiwKhQIGQ2J0JS6CBmx9RGBAoQoUjCz/N7JFAkNLSQNVaxBNgHpUAsCVBGkw+V863bxz7OLKNrX0aE/SBdtbiBR27azkZ6xkpT/eNZjaz2etW171rZt2xis1bX31P4vf3MIEf2fgPIYz6vKMCydNxfTCqNFnz7O98h3pufy4nRvMv9d+PE/PujMaIsqNYBohQdGlY17IByFZUOKRGLvsUaZMOf+vdnkT2qCJe+XlroF0mDZo8erxiil1PgPlyJ/pfb6bGDBm3cL0UddjFwtkmZkxAPM+oOeG1f0sxgpXqEHEzXbAYVLJnr+kEQoaAoBql5KDQjtUxNh+tA4bYaUjZjcJxFKHLS+gmVLZBVCCAFt1/o9UuO2rf1y47S9G3ZTUXb04asb8HtSsr3mxeu1zoApwxl09+WDgxVlp588uzNMKaVGL+/sWan0Y187v5ysKKPj2hbEfefP7UfceH0dFWWQl20LxuMQwAom/iowU24QHDwRJk8wOGxAUtDa/u37TrcGE3DOdj9dYSfUCZix+e3nHVavaQ1ecOIIYOX46bi1OhpX5/jzK12nvKH/zcjtmR5xaNMBKipjXZtHjKxtbm2piXWtBgA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/23/505a545ee4593fdafa382278ed39ad68/7FGq.svg"                                                                                            >                        </noscript>                    </figure>                <p>不过，要注意的是成语组成的图<strong>并不是有向无环图</strong>，有很多类似于“传宗接代 -&gt; 代代相传”这种多条边组成一个环的情况（上面的示意图中也存在环），甚至还有“为所欲为”、“国将不国”这种一条边组成一个环的情况，在查找最短路径时需要避免出现这种环。</p><p>另外图中也存在一些只有入度没有出度的顶点，比如<del>大家见了就想打的</del>“一个顶俩”的 liǎ 就是完全接不下去的……等等这个好像不算成语吧？那还有“不置可否”、“东拼西凑”、“不尴不尬”……如果以这些作为起始成语的话，那就无解了 (•́ω•̀ ٥)</p><p>图的最短路径算法有很多，比如经典的 Dijkstra 和 Floyd 算法。不过这里的“图的最短路径问题”实际上是简化版的，每一条边之间并没有 cost 的区别，所以只要让路径经过尽可能少的边就可以了，于是我就选择了使用广度优先搜索来获取路径。</p><p>后面的代码都是使用 PHP 实现的，不过使用其他语言的话做法也是一样的啦……毕竟是比较简单的算法，也不需要用到别的第三方工具库 |•ω•&#96;)</p><h1 id="预处理数据"><a href="#预处理数据" class="headerlink" title="预处理数据"></a>预处理数据</h1><p>要折腾成语接龙，首先当然需要收集一个成语数据库。自己爬取的话还是太麻烦了啊……好在这种东西很容易找到现成的，我选择了 GitHub 上的 <a href="https://github.com/pwxcoo/chinese-xinhua">pwxcoo&#x2F;chinese-xinhua</a> 这个仓库，提供的数据是将三万多个成语的信息保存进一个数组的 JSON 文件：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#123;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">derivation</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">语出《法华经·法师功德品》下至阿鼻地狱。”</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">example</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">但也有少数意志薄弱的……逐步上当，终至堕入～。★《上饶集中营·炼狱杂记》</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">explanation</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">阿鼻梵语的译音，意译为无间”，即痛苦无有间断之意。常用来比喻黑暗的社会和严酷的牢狱。又比喻无法摆脱的极其痛苦的境地。</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">ā bí dì yù</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">word</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">阿鼻地狱</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">        "</span><span style="color:#8FBCBB;--shiki-dark:#9CDCFE">abbreviation</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">abdy</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#F44747">    ...</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span></span></code></pre><p>每个成语的拼音都是使用空格分割的，所以很容易取出第一个字和最后一个字的拼音。不过我没有在后续的代码中直接使用这些拼音而是将它们用整数替代了（有点像是在使用枚举），和比较字符串相比，比较整数应该是更快的吧？</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 数据来自：</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// https://github.com/pwxcoo/chinese-xinhua/blob/master/data/idiom.json</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idioms</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> json_decode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">file_get_contents</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idiom.json</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">),</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> true</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyins</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> []</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">foreach</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idioms</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> as</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> &#x26;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> str_replace</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">([</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">　'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">，</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">?</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyin</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> explode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">count</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> -</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!</span><span style="color:#81A1C1;--shiki-dark:#DCDCAA">isset</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyins</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]))</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyins</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> count</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyins</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!</span><span style="color:#81A1C1;--shiki-dark:#DCDCAA">isset</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyins</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]))</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyins</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiom</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> count</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">pinyins</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // 后续使用$pinyins[$idiom['start']]和$pinyins[$idiom['end']]来保存首尾两字的读音</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>为了简化代码和方便查找，这里就使用 SQLite 数据库来保存所有成语的信息：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">CREATE</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> TABLE</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> `</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">idioms</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">` (</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> INTEGER</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> PRIMARY KEY</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">word</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> TEXT</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NOT NULL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">pinyin</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> TEXT</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NOT NULL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">explanation</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> TEXT</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NOT NULL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">derivation</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> TEXT</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NOT NULL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">example</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> TEXT</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NOT NULL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> INTEGER</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NOT NULL</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> INTEGER</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> NOT NULL</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">);</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">CREATE</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> UNIQUE INDEX</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> `</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">idx_idioms_id</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">` </span><span style="color:#81A1C1;--shiki-dark:#569CD6">ON</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idioms</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">);</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">CREATE</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> INDEX</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> `</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">idx_idioms_word</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">` </span><span style="color:#81A1C1;--shiki-dark:#569CD6">ON</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idioms</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">word</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">);</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">CREATE</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> INDEX</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> `</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">idx_idioms_start</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">` </span><span style="color:#81A1C1;--shiki-dark:#569CD6">ON</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idioms</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span></code></pre><p>实际上只要保存自增 ID、成语本体和首尾两字读音就可以了，以及给经常用于查找的某几列添加索引。不过似乎写入得太慢了啊……一直到 PHP 默认的三十秒执行时间限制用完了也只写入了一两百个成语，按照三万多个成语的数据量来看不知道要写到什么时候。</p><p>这实际上和 SQLite 的运行原理有关。毕竟是不需要运行后台服务的使用单文件的数据库，修改数据实际上是写入文件，但是操作系统为了减少 IO 次数一般会先将读写的文件内容保存在缓存中，每隔一段时间再统一写入硬盘（在 Linux 下这个机制称为 <a href="https://man.linuxde.net/sync">sync</a>）。为了保证对数据的每次修改都会确实地写入硬盘，SQLite 默认是<strong>每执行一个事务就等待一次 sync 操作</strong>，然后才会继续执行下一个，于是大部分时间就消耗在等待 sync 之中了，这个效率 efficiency 啊……要提速的话可以执行 <code>PRAGMA synchronous = OFF</code>（默认值是 <code>FULL</code>）禁止 SQLite 等待 sync，副作用是系统崩溃或意外断电时数据库会损坏。由于在使用预处理创建成语数据库之后也只是用于查找，并不需要修改数据，所以这么设定是没问题的。</p><p>另外 SQLite 默认会在执行事务时创建一个 <code>db-journal</code> 文件用于事务的回滚，不过每次插入成语数据时都要写入这东西也够麻烦的……而且确实也不需要回滚，所以使用 <code>PRAGMA journal_mode = MEMORY</code> 把它放到内存里。如此操作之后，所有成语的数据就可以在两秒之内写入数据库啦！( ︠ु ௰︡ू)</p><h1 id="构建遍历树和使用广度优先搜索"><a href="#构建遍历树和使用广度优先搜索" class="headerlink" title="构建遍历树和使用广度优先搜索"></a>构建遍历树和使用广度优先搜索</h1><p>对数据进行预处理之后，就需要考虑如何找到最短路径了。之前提过我选择使用广度优先搜索算法求解，在求解过程中需要从成语的图中产生一个遍历树。以“身经百战 -&gt; 栈山航海 -&gt; 海外奇谈 -&gt; 谈笑风生”这条接龙为例，对应的遍历树如图所示：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1282*522),522px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://p.sda1.dev/23/cabe8e44fd765e5dcdadf94b554decfc/FKsO.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRlABAABXRUJQVlA4TEMBAAAvHwADEGfiNJIkR6pT7OH779yzx1pNusGojSRHNXf8gd37kOQ8XQwaSZLSK+AO/LtABQrQgIN/d1tR20iOv8th+VMsV4P+4AUT3OAGN7jBD1aao+pQpb8URVE7GVX4/41iSx3j6rqcKOr3p1N9pE0K9b0vt3F4nBfq9yfqvB+mf/O9/v27TJvpj07TSYq0kJRQBigkZZl3CYFfQIohlRAICoBQA+qQSCj5IKAAMZJt09Y849xn27bNb+Sf0ME/P4OI/k+A1/XPfg/6QpHnF1DKi/cLWp8J8P6CLF5Ptmwa1etsFkC7Jb7uQKeZ+zr4PGSy9Ach5PUcWXxckHNve5+HVJrx1FHY9HkAur0QNBp8vgDVirOdArVyYjVS6R83ZGc5QU7Ohn+xaRQO8/MNhMPi92kFOB+RxXVnEHCbR2LxqNs8CAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/23/cabe8e44fd765e5dcdadf94b554decfc/FKsO.svg"                                                                                            >                        </noscript>                    </figure>                <ul><li>遍历树中的每个节点表示一个成语和它的尾字读音</li><li>产生子节点，也就是根据当前节点的尾字读音，查找以这个读音开头的成语</li><li>如果某个节点的尾字读音和给定的结束成语的首字读音相同，说明成功地找到了一个解，遍历结束</li></ul><p>这里使用一个类来表示遍历树的节点，在搜索的时候都是使用数据库中的 ID 来表示成语，并不需要考虑成语的其他信息：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">class</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> IdiomSearchNode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    public</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ?</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">IdiomSearchNode</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">parent</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    public</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> int</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    public</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> int</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">end</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    public</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> SQLite3</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">db</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    public</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> function</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> __construct</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">?</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">IdiomSearchNode</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">parent</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> int</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> SQLite3</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">db</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">        $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">parent</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">parent</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">        $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">        $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">db</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">db</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // 获取当前节点的成语的尾字读音</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">db</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">prepare</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#569CD6">SELECT</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> FROM</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idioms</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> WHERE</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> :</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> LIMIT</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bindValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">:0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> SQLITE3_INTEGER</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">row</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">execute</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">fetchArray</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">MYSQLI_ASSOC</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">row</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> throw</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> Exception</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Invalid idiom</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">        $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">end</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">row</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    /** </span><span style="color:#81A1C1;--shiki-dark:#569CD6">@return</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> IdiomSearchNode</span><span style="color:#81A1C1;--shiki-dark:#569CD6">[]</span><span style="color:#616E88;--shiki-dark:#6A9955"> */</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    public</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> function</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> getChildren</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">array</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> &#x26;</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">set</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // 查找以尾字读音开头的成语</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">db</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">prepare</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#569CD6">SELECT</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> FROM</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idioms</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> WHERE</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> :</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bindValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">:0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">end</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> SQLITE3_INTEGER</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">execute</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">execute</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">result</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> []</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        while</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">row</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">execute</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">fetchArray</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SQLITE3_ASSOC</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">            // $set的作用稍后会提及</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">            if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#DCDCAA">isset</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">set</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">row</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]))</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> continue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">            $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">set</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">row</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> true</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">            $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">result</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> IdiomSearchNode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">$this</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">row</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> $this</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">db</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        return</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">result</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>广度优先搜索一般都是使用队列的方式实现的。以上面的遍历树示意图为例，在求解时遍历和产生子节点的顺序如下：</p><ul><li>初始化队列，加入根节点“身经百战”</li><li>取出“身经百战”，找到以 zhàn 开始的成语“战火纷飞”、“栈山航海”、“战战兢兢”……依次加入队列</li><li>取出“战火纷飞”，找到以 feī 开始的成语“飞蛾扑火”，加入队列</li><li>取出“栈山航海”，找到以 hǎi 开始的成语“海市蜃楼”、“海外奇谈”……依次加入队列</li><li>此时可以注意到，“海外奇谈”已经可以接上给定的结束成语“谈笑风生”了，所以结束遍历</li><li>从“海外奇谈”开始往上回溯父节点“栈山航海”和“身经百战”，再把结束成语“谈笑风生”加上，由此就可以构造出“身经百战 -&gt; 栈山航海 -&gt; 海外奇谈 -&gt; 谈笑风生”这个解</li></ul><p>前面也提过，在图中查找最短路径时，要避免路径产生环而出现死循环，所以需要将已经遍历过的成语保存到一个集合中，在将成语加入队列前要检查这个成语之前是否已经遍历过（集合中是否已有该成语）。PHP 中并没有集合的数据结构啊……不过，根据以下的一些事实：</p><ul><li>PHP 的数组的底层实现，实际上就是插入和查找的时间复杂度为常数阶的哈希表（参见<a href="https://stackoverflow.com/questions/3134296#answer-3134315">这里</a>）</li><li>使用 <code>isset($arr[$item])</code> 比 <code>in_array($item, $arr)</code> 和 <code>array_key_exists($item, $arr)</code> 更快（参见<a href="https://stackoverflow.com/questions/8409249#answer-21759158">这里</a>）</li></ul><p>因为这里只需要考虑整型的成语 ID，因此完全可以使用一个数组来模拟实现集合，向集合中加入元素就是将数组中成语 ID 的 key 对应的值设为任意 <code>null</code> 之外的值，使用 <code>isset</code> 判断集合中是否存在某元素。</p><p>使用广度优先搜索来搜索路径的完整代码如下：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomDb</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> SQLite3</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idioms.db</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 保存成语ID的集合</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">set</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> []</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 搜索时使用的队列</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">queue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> SplQueue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 在数据库中查找给定的起始和结束的成语</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomDb</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">prepare</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#569CD6">SELECT</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> *</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> FROM</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">idioms</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> WHERE</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> `</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">word</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">`</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> :</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bindValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">:0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">_POST</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> SQLITE3_TEXT</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomStart</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">execute</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">fetchArray</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SQLITE3_ASSOC</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bindValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">:0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">_POST</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> SQLITE3_TEXT</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">execute</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">fetchArray</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">SQLITE3_ASSOC</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomStart</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ||</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> !</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> throw</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> Exception</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Invalid idiom</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 从起始成语开始创建第一个要遍历的节点</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">queue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">enqueue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">new</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> IdiomSearchNode</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">null</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomStart</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">],</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomDb</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">set</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomStart</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> true</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">set</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> true</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 循环从队列中取出和加入节点进行广度优先遍历，一直遍历到找到解或无解为止</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> null</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">while</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">queue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">isEmpty</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;&#x26;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> !</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    /** </span><span style="color:#81A1C1;--shiki-dark:#569CD6">@var</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> IdiomSearchNode</span><span style="color:#616E88;--shiki-dark:#6A9955"> */</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">node</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">queue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">dequeue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">children</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">node</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">getChildren</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">set</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // 打乱子节点的顺序，稍后说明作用</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    shuffle</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">children</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    foreach</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">children</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> as</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">child</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // 如果有可以接上结束成语的子节点就结束遍历，否则加入队列</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">child</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">end</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ===</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">            $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">child</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">            break</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">queue</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">enqueue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">child</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>有些成语之间最短的接龙是不唯一的，但是按照以上流程只会得到固定的一个解。如果将算法随机化，也就是在遍历节点时将它产生的子节点随机打乱顺序再加入队列，每次运行算法就有可能得到不同的解了。</p><p>还是使用上面的从“身经百战”接到“谈笑风生”作为例子，除了“身经百战 -&gt; 栈山航海 -&gt; 海外奇谈 -&gt; 谈笑风生”之外，还有“身经百战 -&gt; 战战兢兢 -&gt; 经验之谈 -&gt; 谈笑风生”的解法。按照默认顺序会先遍历到“栈山航海”，然后发现子节点中的“海外奇谈”可以接到结束成语，由此得到第一个解。但是打乱的话就有可能先遍历到“战战兢兢”，从而得到第二个解。</p><p>搜索结束后就可以通过回溯的方式来构造解，在构造解的时候还可以一并读取成语的其它信息：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">result</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> []</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">if</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">solve</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">bool</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#DCDCAA">    unset</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">id</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#DCDCAA">    unset</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#DCDCAA">    unset</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    array_unshift</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">result</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomEnd</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">    $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">idiomDb</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">prepare</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span></span><span class="line"><span style="color:#A3BE8C;--shiki-dark:#CE9178">        SELECT</span></span><span class="line"><span style="color:#A3BE8C;--shiki-dark:#CE9178">            `word`, `pinyin`, `explanation`,</span></span><span class="line"><span style="color:#A3BE8C;--shiki-dark:#CE9178">            `derivation`, `example`</span></span><span class="line"><span style="color:#A3BE8C;--shiki-dark:#CE9178">        FROM `idioms`</span></span><span class="line"><span style="color:#A3BE8C;--shiki-dark:#CE9178">        WHERE `id` = :0</span></span><span class="line"><span style="color:#A3BE8C;--shiki-dark:#CE9178">        LIMIT 1</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#CE9178">    '</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    while</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">bindValue</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">:0</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">id</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">        array_unshift</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE">$</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">result</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">statement</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">execute</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">fetchArray</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#88C0D0;--shiki-dark:#D4D4D4">SQLITE3_ASSOC</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#9CDCFE">        $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#9CDCFE"> $</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">found</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">-></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">parent</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><h1 id="成品和一些结论"><a href="#成品和一些结论" class="headerlink" title="成品和一些结论"></a>成品和一些结论</h1>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/3806*2367),2367px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/5801c33e5842a77ceb26ab5dd657ebf060658.jpg" data-src-webp="https://p.sda1.dev/12/ed11aa23f37385c63c7e0599d14fcd1b/PF3IWLDw.webp" data-src="https://p.sda1.dev/12/50a479f8ac1a5dd89fab8c94ef9ca946/kAQ0RZ44.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRmQAAABXRUJQVlA4IFgAAADQAwCdASogABQAPrVMnkm0iOwCADgFollAABb6QCIqDjm96AIthgAA/vAb+Y1GRiBF6UDjui6S5DMNe7O0QX0vXdgrzkGSA4NfI79XgAB3qQUv73rIMkgA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/50a479f8ac1a5dd89fab8c94ef9ca946/kAQ0RZ44.png"                                                                                            >                        </noscript>                    </figure>                <p>你可以前往 <a href="https://i.akarin.dev/idioms-solitaire/">https://i.akarin.dev/idioms-solitaire/</a> 亲自体验一下～(*′ ▽‘)</p><p>除了支持输入起始和结束的成语进行接龙，也可以直接输入起始和结束的拼音。比如你可以来一条可以接到 yí 的接龙，这样就可以在和别人玩接龙的时候把对方的任意成语都接到“一个顶俩”<del>然后被对方真人快打</del>。也可以像 V 字头论坛的某君一样接到“○○可爱”上，嗯……用这个发狗粮是没关系的。</p><p>当然直接输入“一个顶俩”是不行的，因为它并没有被收录到我使用的成语数据库中。</p><p>随机取两个成语进行接龙的话，得到的最短接龙长度（包括起始和结束的成语）都在 3 到 5 之间。在平均情况下，每次运行这个算法时一般只需要遍历一二十个甚至个位数的节点，内存占用不超过 800 KB，运行时间不超过 10 ms。我测试时碰到的最坏情况是从“方寸已乱”接到“操觚染翰”，接龙长度为 5，求解时需要遍历的节点数从 25 到 550 个不等（由于将算法随机化了，所以每次运行时遍历的节点数会有区别），在遍历节点最多的最坏情况下内存占用 3 MB，运行时间 200 ms，可以说这个算法运行起来还是相当快的。</p><p>有没有办法再快一点呢？因为求解的过程中“查找以○开头的成语”这个操作执行得非常频繁，完全可以不使用 SQL 语句来查找，而是预先准备好一张记录了每个拼音对应的以该拼音开头的所有成语 ID 的表，在产生子节点的时候直接查表就可以了。根据我自己的测试，使用查表法可以使平均情况下的运行时间再降低一个数量级，但是这个表本身会占用 5 MB 的内存，典型的空间换时间 (′゜ω。‵)</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/66567478">Pixiv ID: 66567478 「HAPPYNEWYEAR　2018」 by チノマロン</a></p><p>不过因为现在已经是 2021 年了，我就自己把图上的“HappyNewYear 2018”去掉了。</p></blockquote><hr><p>更新一个使用 JavaScript 的实现，你可以将<a href="https://pastebin.com/9JkTvdTY">这里</a>的代码粘贴到浏览器的控制台，然后随意尝试～</p><ul><li>直接使用 jsDelivr 的 CDN 从上面提到的 GitHub 仓库在线加载成语数据，大约需要消耗流量 3.5 MB</li><li>未对拼音创建枚举，因此使用的是直接比较字符串是否相等</li><li>未打乱子节点，因此得到的接龙是固定的</li><li>执行时会在控制台中输出遍历的节点数和运行时间，不过没有统计内存占用情况</li></ul>]]></content>
    
    
    <summary type="html">这也是个可以使用数据结构和算法的知识来解决的问题…_φ(･ω･` )</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>使用 C 语言和 Emscripten 编写自己的 WebAssembly 模块</title>
    <link href="https://akarin.dev/2020/10/10/build-webassembly-module-with-c/"/>
    <id>https://akarin.dev/2020/10/10/build-webassembly-module-with-c/</id>
    <published>2020-10-10T03:24:34.000Z</published>
    <updated>2020-10-10T03:24:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>和 JavaScript 一样，WebAssembly 也是一种可以在浏览器中运行的编程语言，不过它的性质更相当于汇编语言。wasm 文件由二进制的<a href="https://pengowray.github.io/wasm-ops/">字节码</a>组成（也可以转换为类似于汇编语言的文本格式查看），可以<strong>从 C&#x2F;C++、Rust 等编译执行的编程语言生成</strong>。当然，WebAssembly 也是跨平台的，编译出来的 wasm 文件在不同平台的浏览器中都可以运行。</p><p>WebAssembly 最大的特性就是和解释执行的 JS 相比的<strong>超高性能</strong>，甚至还可以将用其它语言编写的项目通过编译到 wasm 的方式<strong>移植到浏览器中运行</strong>（例如<a href="http://www.dnbwg.com/emularity.html?machine=touhou-fumaroku">这个</a>使用 wasm 版的 DOSBox 运行的《东方封魔录》，运行起来也十分流畅）。不过我开这篇并不是为了去编译那些大型项目的……由于几乎每个接受过计算机相关教育的人都学习过 C 语言，自己用 C 写一个简单的 wasm 模块来提升前端代码的性能，是门槛并不高而且也很有意思的一件事情。</p><h1 id="从运行一个简单的模块开始"><a href="#从运行一个简单的模块开始" class="headerlink" title="从运行一个简单的模块开始"></a>从运行一个简单的模块开始</h1><p>要将 C&#x2F;C++ 代码编译到 wasm 模块，我们需要准备好 <a href="https://emscripten.org/docs/getting_started/downloads.html">Emscripten</a> 环境。</p><blockquote><p>即使是 Windows 用户，也可以在 WSL 里面直接安装。</p></blockquote><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">git</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> clone</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> https://github.com/emscripten-core/emsdk.git</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">cd</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> emsdk</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">git</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> pull</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">./emsdk</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> install</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> latest</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">./emsdk</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> activate</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> latest</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 以后每次打开shell都要执行下面这行</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"># 如果不想每次都手动操作的话可以写到.bashrc里面</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">source</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> ./emsdk_env.sh</span></span></code></pre><p>WebAssembly 的运行环境本身只能执行计算任务，加载 wasm 模块时还需要导入一个包含 JS 函数、内存区等属性的对象，wasm 和浏览器的交互只能通过调用这些 JS 函数完成，内存区则是和运行环境外面的 JS 代码共享，可以用来交换数据。Emscripten 的功能不仅是编译 C&#x2F;C++ 代码生成 wasm，它还可以生成一大堆 JS 的“胶水代码”用来连接浏览器和 WebAssembly 运行环境，实现 C&#x2F;C++ 的那些标准库，对内存分配、输入输出等进行处理。</p><p><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/C_to_wasm#%E7%94%9F%E6%88%90_HTML_%E5%92%8C_JavaScript">MDN 上的教程</a>就给出了一个从 Hello world 编译出 wasm 文件和对应的胶水代码、HTML 文件的例子。不过这胶水代码比 wasm 文件本身还大了不少……如果模块比较简单的话还是不太好的。好在 Emscripten 支持通过编译选项 <code>-s SIDE_MODULE=1</code> 使编译出来的 wasm 文件<a href="https://github.com/emscripten-core/emscripten/wiki/WebAssembly-Standalone#create-a-dynamic-library">作为一个单独的动态库</a>，这样就不需要那一堆胶水代码了，不过与 JS 部分的交互也需要自己完成。各种用到的标准库函数，需要自己在 C&#x2F;C++ 里实现（<code>memset</code>、<code>memcpy</code> 和 <code>strlen</code> 之类的比较简单的可以直接抄 <a href="https://github.com/emscripten-core/emscripten/tree/main/system/lib/libc">Emscripten 的实现</a>），或者在 JS 里通过操作内存区实现后导入 wasm 模块。</p><p>根据 <a href="https://github.com/emscripten-core/emscripten/blob/aa66f92b790c8d319d1599d44657a6305bf74a8a/src/settings.js#L953">Emscripten 的说明</a>，<code>SIDE_MODULE</code> 可以设为 1 和 2，区别在于前者会导出 C&#x2F;C++ 代码里所有的函数，后者会把没有用到的代码删减掉，这时就需要自己 <code>#include &lt;emscripten/emscripten.h&gt;</code> 然后手动在需要导出的函数前面加上 <code>EMSCRIPTEN_KEEPALIVE</code>。</p><p>从一个简单的计算两数相乘的模块开始。因为这只是一个函数库，所以 main 函数是不需要的，而且就算写了也不会在加载的时候自动执行。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">EMSCRIPTEN_KEEPALIVE</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">int</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> multiply</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">int</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> a</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> int</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> b</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    return</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> a </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">*</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> b</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>编译，<code>-O3</code> 代表使用最高速度的编译优化：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">emcc</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> multiply.c</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -O3</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -s</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> SIDE_MODULE=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">1</span><span style="color:#A3BE8C;--shiki-dark:#569CD6"> -o</span><span style="color:#A3BE8C;--shiki-dark:#CE9178"> multiply.wasm</span></span></code></pre><p>也可以使用 <code>-Oz</code> 表示使编译出来的文件大小更小的编译优化，当然运行起来就会慢很多。</p><p>在 HTML 中使用以下的 JS 代码加载（目前 <code>importObject</code> 还可以省略不写）：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmModule</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> await</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> fetch</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">multiply.wasm</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">response</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> response</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">arrayBuffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">compile</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">module</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Instance</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">module</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> importObject</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming"><code>WebAssembly.instantiateStreaming</code></a> 加载更简洁，但是需要提供正确的 MIME 类型 <code>application/wasm</code>。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmModule</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> await</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">instantiateStreaming</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    fetch</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">multiply.wasm</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    importObject</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>另外，上面的两种写法都是异步加载模块的，这是因为如果是同步加载大型模块的话会出现较长时间的阻塞（Chrome 甚至自己规定了同步加载的模块不能超过 4 KB）。如果模块较小，加载时间可以忽略不计，而且也需要在同步执行的代码中使用模块的话，可以将模块的二进制数据以 <code>Uint8Array</code> 的格式（不过更建议从 Base64 字符串转换过来，代码更简短）写进 JS 代码，然后用下面的写法加载：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">// 以后创建wasmModule时可以复用m，不需要重新加载</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> m</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Module</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">...</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmModule</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Instance</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">m</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> importObject</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>加载完成后，就可以通过 <code>wasmModule.exports</code> 找到模块导出的函数了。WebAssembly 也是强类型的（32&#x2F;64 位整数&#x2F;浮点数），所以在这个例子中如果使用了小数会自动进行类型转换，并不能得到正确的结果，另外也需要注意溢出的问题。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/542*494),494px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/9b5bf6e63f452a429a4ca1d247d8d9bb/1mHZIpqJ.webp" data-src="https://p.sda1.dev/12/303c73def7aac416cee55273e75b302e/cc5lAleQ.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRsIAAABXRUJQVlA4ILYAAAAwBQCdASogAB0APrVQoUwIpQFVHALRLGAXZCRHnbb/AQP/OHDCZsGS3m+OhZU7XHSZAAD++AgCLVfX6fzmwT0tQRodlqDQtPEhhAPxYf66wRH63n9A2PVVx6grmEoIpcTWqG2No7QrxXGm+VDNjCEtfV7A99KbP4PHP96RdkneB7SSaZZqHwOlOe9BHZnR3id+E8lbO8TvfIr2188Clpmv6sb9L1CeO91mMFI3FATULfjpIXAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/303c73def7aac416cee55273e75b302e/cc5lAleQ.png"                                                                                            >                        </noscript>                    </figure>                <p>以下是对应的“汇编代码”，<code>$multiply</code> 就是上面的相乘函数了：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">module</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t1</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">param</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">result</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $__wasm_apply_relocs</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    nop</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $multiply</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t1</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">param</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $p0</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">param</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $p1</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">result</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    local</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.get</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $p0</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    local</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.get</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $p1</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    i32</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.mul</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">global</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $__dso_handle</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">i32</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.const</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">__wasm_apply_relocs</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $__wasm_apply_relocs</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">multiply</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $multiply</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">__dso_handle</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">global</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">__post_instantiate</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $__wasm_apply_relocs</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span></code></pre><blockquote><p>使用 VSCode 的扩展 <a href="https://marketplace.visualstudio.com/items?itemName=dtsvet.vscode-wasm">WebAssembly</a> 可以以文本格式显示打开的 wasm 文件，并且可以在两种格式之间相互转换。</p></blockquote><h1 id="使用外部函数、内存和指针"><a href="#使用外部函数、内存和指针" class="headerlink" title="使用外部函数、内存和指针"></a>使用外部函数、内存和指针</h1><p>接下来是做一件每种编程语言的初学者都喜欢做的事：输出一个 Hello world。</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#5E81AC;font-weight:bold;--shiki-dark:#C586C0;--shiki-dark-font-weight:inherit">#</span><span style="color:#81A1C1;--shiki-dark:#C586C0">include</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> &#x3C;</span><span style="color:#8FBCBB;--shiki-dark:#CE9178">stdio.h</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">></span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">void</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> hello_world</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    puts</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Hello world!</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">    puts</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">WebAssembly模块测试</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>编译……等下，既然是编译到 WebAssembly 了，那从哪里找到标准库 <code>stdio.h</code> 和这个 <code>puts</code> 呢？看一下文本格式代码：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">module</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t1</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">param</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">result</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">import</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">env</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">puts</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $env.puts</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t1</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">import</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">env</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">__memory_base</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">global</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $env.__memory_base</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">import</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">env</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">memory</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">memory</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $env.memory</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $__wasm_apply_relocs</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    nop</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $hello_world</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">type</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0"> $t0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">local</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $l0</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    global</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.get</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $env.__memory_base</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    local</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.tee</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $l0</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    call</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $env.puts</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    drop</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    local</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.get</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $l0</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    i32</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.const</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 13</span></span><span class="line"><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">    i32</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.add</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    call</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $env.puts</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#D4D4D4">    drop</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">global</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $__dso_handle</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0"> i32</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">i32</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.const</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">__wasm_apply_relocs</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $__wasm_apply_relocs</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hello_world</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $hello_world</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">__dso_handle</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">global</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">export</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> "</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">__post_instantiate</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#4EC9B0">func</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> $__wasm_apply_relocs</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">  (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">data</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $d0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">global</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">.get</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> $env.__memory_base</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Hello world!</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\00</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">WebAssembly</span><span style="color:#EBCB8B;--shiki-dark:#D7BA7D">\e6\a8\a1\e5\9d\97\e6\b5\8b\e8\af\95\00</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">"</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span></code></pre><p><code>puts</code> 是需要自己从 JS 中导入的。在 C 的代码里实际上也可以不写 <code>#include &lt;stdio.h&gt;</code>，直接用 <code>int puts(const char *str);</code> 声明也是没问题的。</p><p>字符串被全部写进了一个数据段（汉字部分和源代码一样使用了 UTF-8 编码）。在加载 wasm 模块的时候需要提供一块内存区域用来从某个偏移位置开始保存这些数据。</p><p>这里就先使用 <code>console.log</code> 代替 <code>puts</code>，并且创建一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory"><code>WebAssembly.Memory</code></a> 作为内存区域，通过一个对象（也就是上面的 <code>importObject</code>）传递给要加载的 wasm 模块：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmMemory</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Memory</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span><span style="color:#88C0D0;--shiki-dark:#9CDCFE"> initial</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmBuffer</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmModule</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> await</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> fetch</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hello-world.wasm</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">response</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> response</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">arrayBuffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">compile</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">module</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Instance</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">module</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        env</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">            puts</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">log</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">            memory</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">            __memory_base</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><blockquote><p><code>WebAssembly.Memory</code> 是一块用于 wasm 模块的内存，以 64 KB 为一“页”作为分配的基本单位，也可以在创建后动态扩容。在 JS 中可以通过 <code>TypedArray</code> 对它进行读写。</p></blockquote><p>加载并执行一下试试看：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/723*329),329px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/90e9e500482c6a0a2c773c749398e991/aWl1K20Z.webp" data-src="https://p.sda1.dev/12/56d66ddea394f573c6fd8e45b062059c/er1Cjn15.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRmAAAABXRUJQVlA4IFQAAAAwAwCdASogAA8APrVInkmmiGwCADgFollAAB61J/24VtxAAP7zkRgC5Xt7YwiQgeiuzIi7ZTWId7EDBlLsM1Hk8m/g3MlEOzKCrSjnhrHEAARgAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/56d66ddea394f573c6fd8e45b062059c/er1Cjn15.png"                                                                                            >                        </noscript>                    </figure>                <p>字符串被写入了内存中从 <code>__memory_base</code> 开始的位置，而和 C 语言一样，调用 <code>puts</code>（实际上是 <code>console.log</code>）的参数是字符串开始的指针（数组下标）。如果自己实现一个 <code>puts</code>，就可以将字符串输出到控制台（或者是页面上某个 DOM 的 innerText）了。</p><blockquote><p>顺便一提，有个叫 <a href="https://github.com/locutusjs/locutus">Locutus</a> 的库尝试使用 JS 实现其他语言的标准库，虽然对于 C 的实现并不多……</p><p>比如要实现 <code>sprintf</code> 或 <code>printf</code>，就可以参考<a href="https://github.com/locutusjs/locutus/blob/master/src/c/stdio/sprintf.js">这里</a>。</p></blockquote><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmMemory</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Memory</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span><span style="color:#88C0D0;--shiki-dark:#9CDCFE"> initial</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmBuffer</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmModule</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> await</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> fetch</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">hello-world.wasm</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">response</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> response</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">arrayBuffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">compile</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">module</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Instance</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">module</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        env</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">            // 将从指针开始到下一个0x00之间的数据用UTF-8解码，然后用console.log输出</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#DCDCAA">            puts</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> ptr</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">log</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">                (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> TextDecoder</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">decode</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">                    wasmBuffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">slice</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">                        ptr</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">                        wasmBuffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">findIndex</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> >=</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> ptr</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;&#x26;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> !</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">e</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">                    )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">                )</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">            )</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">            memory</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">            __memory_base</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/705*749),749px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/a6c97377e4802b4665204cab5c1cf9c3/SLwsimdL.webp" data-src="https://p.sda1.dev/12/d7b12345e092a1e4908e074d5eb065b4/7KUNX1IK.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRnYAAABXRUJQVlA4IGoAAABwBACdASoeACAAPrVEoUmipqMYDAYAcAtEs4AAEtykmX2dcFsgQQIt3pFQAAD++Bt4Sup2N/g6jvkoYK/9ir4nj0L3LKnNq3C1oV+/DAatmgQHlZKMApEFgKfWPxidF4b8ez2FvHJp3UAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/d7b12345e092a1e4908e074d5eb065b4/7KUNX1IK.png"                                                                                            >                        </noscript>                    </figure>                <p>试着将内存中的第一个单元的数据改成 <code>0x41</code>（也就是字母 A），再次调用函数，可以看到输出的内容也发生了相应的变化。当然，实际使用的时候，如果需要向内存中写入数据，就要根据 <code>__memory_base</code> 和代码中数据段的大小自己预留好内存空间，避免覆盖了 wasm 模块内部使用的数据。</p><p>如果代码中需要用到局部变量，根据常识可以知道这些变量是存储在栈里的，编译出的 wasm 也会要求引入 <code>__stack_pointer</code> 用来设置栈指针：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#C8C8C8">    env</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#C8C8C8">        __stack_pointer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">:</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Global</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">            &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">                mutable</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> true</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">                value</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">i32</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">            &#125;,</span></span><span class="line"><span style="color:#B48EAD;--shiki-dark:#B5CEA8">            0x1000</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        )</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><p>和真实的 CPU 一样，栈指针也是向低地址延伸的，于是我们就得到了这样的一个简单的进程地址空间模型：<code>| 只读数据 | &lt;- 栈 | 堆 -&gt; |</code>，这已经开始有点涉及到操作系统的知识了……</p><p>既然提到堆了，能不能用 <code>malloc</code> 和 <code>free</code> 在堆上动态分配内存呢？然而，即使不考虑性能，一个完整的内存分配器非常复杂，在这种编译为 <code>SIDE_MODULE</code> 的简单模块的情况下是无法使用的，这里不再深入介绍。<a href="https://surma.dev/things/c-to-webassembly/">这篇文章</a>的“Building an allocator”部分提出了一种简单的替代方法：分配的内存地址只是从堆的起始地址开始不断累加已分配的内存大小，至于 <code>free</code>？直接空着。</p><h1 id="一个使用-WebAssembly-将性能提高到-30x-的例子"><a href="#一个使用-WebAssembly-将性能提高到-30x-的例子" class="headerlink" title="一个使用 WebAssembly 将性能提高到 30x 的例子"></a>一个使用 WebAssembly 将性能提高到 30x 的例子</h1><p>接下来就用一个实际的例子，来展示 WebAssembly 和 JS 相比在计算密集型任务上的超高性能。我分别用 WebAssembly 和 JS 试着实现了一遍 <a href="https://zh.wikipedia.org/wiki/RC4">RC4 加解密算法</a>。为什么用了 RC4 作为例子？</p><ul><li>加密和解密涉及到大量的计算操作</li><li>RC4 的算法简短，且加密和解密是同一套算法，易于实现</li><li>RC4 是流密码，对明文和密钥的长度<abbr title="明文长度不限，密钥长度 40-2048 位">要求不多</abbr>，也不需要像分组密码一样处理不同的工作模式，易于使用</li><li>有一定的实用性（虽然现在 RC4 的安全性已经比较有限了……）</li></ul><p>以下是来自 Wikipedia 的伪代码：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span>for i from 0 to 255</span></span><span class="line"><span>    S[i] := i</span></span><span class="line"><span>endfor</span></span><span class="line"><span>j := 0</span></span><span class="line"><span>for( i=0 ; i&#x3C;256 ; i++)</span></span><span class="line"><span>    j := (j + S[i] + key[i mod keylength]) % 256</span></span><span class="line"><span>    swap values of S[i] and S[j]</span></span><span class="line"><span>endfor</span></span><span class="line"><span>i := 0</span></span><span class="line"><span>j := 0</span></span><span class="line"><span>while GeneratingOutput:</span></span><span class="line"><span>    i := (i + 1) mod 256</span></span><span class="line"><span>    j := (j + S[i]) mod 256</span></span><span class="line"><span>    swap values of S[i] and S[j]</span></span><span class="line"><span>    k := inputByte ^ S[(S[i] + S[j]) % 256]</span></span><span class="line"><span>    output K</span></span><span class="line"><span>endwhile</span></span></code></pre><p>照着伪代码，用 JS 实现一遍（经检验，实现完全正确，检验过程略）：</p><p><details><summary>使用 JS 的实现</summary><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">/**</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> * </span><span style="color:#ECEFF4;--shiki-dark:#569CD6">@</span><span style="color:#8FBCBB;--shiki-dark:#569CD6">param</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0"> &#123;</span><span style="color:#616E88;--shiki-dark:#4EC9B0">Uint8Array</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0">&#125;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> * </span><span style="color:#ECEFF4;--shiki-dark:#569CD6">@</span><span style="color:#8FBCBB;--shiki-dark:#569CD6">param</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0"> &#123;</span><span style="color:#616E88;--shiki-dark:#4EC9B0">Uint8Array</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0">&#125;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> * </span><span style="color:#ECEFF4;--shiki-dark:#569CD6">@</span><span style="color:#8FBCBB;--shiki-dark:#569CD6">returns</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0"> &#123;</span><span style="color:#616E88;--shiki-dark:#4EC9B0">Uint8Array</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0">&#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> */</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> jsRc4</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> keyLength</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> inputLength</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> sbox</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">256</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 256</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ++</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 256</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ++</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> %</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> keyLength</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]) </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x26;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0xFF</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        [</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> [</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> output</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">inputLength</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> k</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> k</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> inputLength</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ++</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">k</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x26;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0xFF</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]) </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x26;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0xFF</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        [</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> [</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        output</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">k</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">k</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">^</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">i</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]) </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x26;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0xFF</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    return</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> output</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre></details></p><p>然后移植到 C 语言 <del>一看就是一个模子刻出来的</del>：</p><p><details><summary>使用 C 语言的实现，以及相关的 JS 胶水代码</summary><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">static</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> char</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">256</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">void</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> rc4</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> char</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> *</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> char</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> *</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> int</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> keyLength</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> int</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> inputLength</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> short</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> char</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> j </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> char</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> temp</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 256</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ++</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 256</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ++</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // j = (j + sbox[i] + key[i % keyLength]) &#x26; 0xFF;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        j </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">%</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> keyLength</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        temp </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> temp</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">    i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> j </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">unsigned</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> int</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> k </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> k </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">&#x3C;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> inputLength</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ++</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">k</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;</span><span style="color:#81A1C1;--shiki-dark:#B5CEA8"> 0x</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">FF</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">        // j = (j + sbox[i]) &#x26; 0xFF;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        j </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">        temp </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">=</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> temp</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">        input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">k</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ^=</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[(</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">i</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE"> sbox</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">j</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">])</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x26;</span><span style="color:#81A1C1;--shiki-dark:#B5CEA8"> 0x</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">FF</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmMemory</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Memory</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span><span style="color:#88C0D0;--shiki-dark:#9CDCFE"> initial</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmInstance</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#C586C0"> await</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> fetch</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">rc4.wasm</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">response</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> response</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">arrayBuffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">())</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">compile</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    .</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">then</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">module</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">Instance</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#8FBCBB;--shiki-dark:#4EC9B0">module</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        env</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">            memory</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">            __memory_base</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">        &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">/**</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> * </span><span style="color:#ECEFF4;--shiki-dark:#569CD6">@</span><span style="color:#8FBCBB;--shiki-dark:#569CD6">param</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0"> &#123;</span><span style="color:#616E88;--shiki-dark:#4EC9B0">Uint8Array</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0">&#125;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> * </span><span style="color:#ECEFF4;--shiki-dark:#569CD6">@</span><span style="color:#8FBCBB;--shiki-dark:#569CD6">param</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0"> &#123;</span><span style="color:#616E88;--shiki-dark:#4EC9B0">Uint8Array</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0">&#125;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> * </span><span style="color:#ECEFF4;--shiki-dark:#569CD6">@</span><span style="color:#8FBCBB;--shiki-dark:#569CD6">returns</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0"> &#123;</span><span style="color:#616E88;--shiki-dark:#4EC9B0">Uint8Array</span><span style="color:#ECEFF4;--shiki-dark:#4EC9B0">&#125;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955"> */</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> wasmRc4</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // 内存的分布：前256字节保留给S盒，然后是x字节的密钥和x字节的输入</span></span><span class="line"><span style="color:#616E88;--shiki-dark:#6A9955">    // 如果内存不足则进行扩容</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> sboxOffset</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 256</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> memoryRequired</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sboxOffset</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    if</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">memoryRequired</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> ></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">byteLength</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">        wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">grow</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">Math</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">ceil</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">((</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">memoryRequired</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> -</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">byteLength</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">/</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 65536</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmBuffer</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmMemory</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">buffer</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    wasmBuffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sboxOffset</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    wasmBuffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">set</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sboxOffset</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    wasmInstance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">exports</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">rc4</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sboxOffset</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sboxOffset</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    return</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmBuffer</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">slice</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">sboxOffset</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> sboxOffset</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> +</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> input</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span></code></pre></details></p><p>测试则是使用 <del>1KB 的随机密钥</del>，分别使用两种实现来加密 4KB、8KB……128MB 的同一份随机数据，并比较执行时间。</p><p><em>测完才意识到其实并不需要这么长的密钥……<strong>超过前 256 字节的部分是没有意义的</strong>，不过这也不会影响测试结果，所以就不重新测啦！</em></p><p><details><summary>测试代码</summary><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> results</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> []</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> inputLength</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 2048</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 16</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> i</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">++</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    inputLength</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;&#x3C;=</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> rc4Key</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">1024</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">map</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Math</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">random</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">() </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">*</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 256</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> rc4Input</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">inputLength</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">map</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> Math</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">random</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">() </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">*</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 256</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">mark</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">wasm-start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> wasmEncrypted</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> wasmRc4</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">rc4Key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> rc4Input</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">mark</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">wasm-end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">mark</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">js-start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#569CD6">    const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> jsEncrypted</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> jsRc4</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">rc4Key</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> rc4Input</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">mark</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">js-end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">measure</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">wasm</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">wasm-start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">wasm-end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">measure</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">js</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">js-start</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">js-end</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">    for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">let</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> &#x3C;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> inputLength</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> j</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">++</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#81A1C1;--shiki-dark:#C586C0">if</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmEncrypted</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">!==</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> jsEncrypted</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">j</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]) </span><span style="color:#81A1C1;--shiki-dark:#C586C0">throw</span><span style="color:#ECEFF4;--shiki-dark:#CE9178"> '</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">Not equal</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">push</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        length</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> inputLength</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        wasmTime</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">getEntriesByName</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">wasm</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">duration</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        jsTime</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">getEntriesByName</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#A3BE8C;--shiki-dark:#CE9178">js</span><span style="color:#ECEFF4;--shiki-dark:#CE9178">'</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)[</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">duration</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">clearMarks</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    performance</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">clearMeasures</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">()</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">push</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">reduce</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    (</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">acc</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> cur</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        for</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4"> (</span><span style="color:#81A1C1;--shiki-dark:#569CD6">const</span><span style="color:#D8DEE9;--shiki-dark:#4FC1FF"> key</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> in</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> acc</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">) </span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">acc</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">key</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">] </span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">+=</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> cur</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">[</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">key</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#81A1C1;--shiki-dark:#C586C0">        return</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> acc</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#123;</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        length</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        wasmTime</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#88C0D0;--shiki-dark:#9CDCFE">        jsTime</span><span style="color:#ECEFF4;--shiki-dark:#9CDCFE">:</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">    &#125;</span></span><span class="line"><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">forEach</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">r</span><span style="color:#81A1C1;--shiki-dark:#569CD6"> =></span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4"> &#123;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmSpeed</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> /</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmTime</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">jsSpeed</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9FF;--shiki-dark:#9CDCFE">length</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> /</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">jsTime</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">    r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">ratio</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> =</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">wasmSpeed</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4"> /</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE"> r</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">jsSpeed</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">&#125;</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">console</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">table</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">results</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">)</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre></details></p><p>至于测试结果嘛……首先是在我自己日常用的 Firefox 上测试，性能直接提升了 8x！（最后一行是以上测试结果的总和）</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/533*558),558px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/e5dbc87fb856c56b1c716361c44dd66b/qVU1IkB2.webp" data-src="https://p.sda1.dev/12/d5774021459982bf29a49a602a368de7/t23nhwV1.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRuYAAABXRUJQVlA4INoAAAAQBQCdASofACAAPrVSok0sikoCADgFolpAAgdWLSNw8dchw91XnIm3mxPwe8OZ+GgAAP70977IOHCfXtoE2C1JuEnzgFHehNLoGHWXh0aN9Af7Y5I/EXihwI7A02WA+d20XhXFcUObNYM+jf/l2uTVkLbEgIkbcKg+x78m25yB0k235dOkCyENCva1sDizIt2IqptwWo7BkR6lVhDXaAc/YwyXOkk28y3Lj2qz+YPI6A3kZqppXHziDJhR25PVFOoyF9JPGt/MpfllhuMzk64dcRW+6Y+GvKeAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/d5774021459982bf29a49a602a368de7/t23nhwV1.png"                                                                                            >                        </noscript>                    </figure>                <p>然后是 Chrome 上的测试结果。即使是面对使用了性能最强的 V8 引擎的 Chrome，WebAssembly 的性能优势仍然能达到 2x（虽然速度和 Firefox 那边差不多……）</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/727*540),540px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/34ac61597849188263eeccc1b9cfbdbf/K5mwAgo4.webp" data-src="https://p.sda1.dev/12/ad17468aa7c43566663ea46ea18436c1/ZnKKKLOz.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRpYAAABXRUJQVlA4IIoAAAAQBACdASogABgAPrVKnUmEdgEAHALRLSTgN/rABmEKbmMSyLK4foVuAAD+o3rv27tpZJJSeW7cpihnzPb7LL2wZMPi0MkzcoEt6/xJWry9xcDX0ec1yjBEcwCi1JyRArozwAurqKStHo+vwGcADGNGIbciKgEhpLCZJrGf/zEslHOHqaznIyiAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/ad17468aa7c43566663ea46ea18436c1/ZnKKKLOz.png"                                                                                            >                        </noscript>                    </figure>                <p>至于标题上的 30x……是在已经弃坑的旧版 Edge 里面测出来的，不过不论是 WebAssembly 还是 JS 这执行速度都比另外两个差了一大截。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/648*498),498px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/e5194235540816202b54cce3a19b03d2/X5Yl15XJ.webp" data-src="https://p.sda1.dev/12/b6a400aac6c1a2fa0778d8cf88a5f41e/-WLog8bd.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/webp;base64,UklGRrwAAABXRUJQVlA4ILAAAABwBQCdASogABkAPrVOnksmkMoDVDgFolnF5VCSCODCQHxyEESWQYHo9pqQXGf+KNy/19WAAP7gC9f95uCkjHylaHAUMQNDt4RWCQDVUlRjUkBT5adso2xxJu2G2WJMIQv8K5/ddGWCSZdyisqSiiLhAmjBiy37UkkojXNJf/5rw68u//h16nWSi+5ayZxnGtOLPP+VBN/jrxZnwhDwvVDQdA5Vj4SuWA3isNt4OoAAAA"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/b6a400aac6c1a2fa0778d8cf88a5f41e/-WLog8bd.png"                                                                                            >                        </noscript>                    </figure>                <p>（IE 不资辞 WebAssembly，直接爬吧）</p><p>你也可以在<a href="https://jsbin.com/taxocoripu/edit?html,output">这里</a>自己试试看～（wasm 文件已经以 Data URL 的形式嵌入了）</p><p>结论是显而易见的，WebAssembly 的性能比 JS 不知道高到哪里去了。而且如果不写清楚函数名的话，直接对着它的“汇编代码”很难看出是 RC4 算法，所以把一些关键操作放进 wasm 模块或许也是个防止前端代码被逆向的好主意？</p><p>即使不熟悉 C 语言和 Emscripten 的那一套工具，GitHub 上也有 <a href="https://github.com/ballercat/walt">Walt</a> 和 <a href="https://github.com/AssemblyScript/assemblyscript">AssemblyScript</a> 这样的工具可以直接使用 TypeScript 的语法编写 wasm 模块，以后再试试看吧～</p><h1 id="Extra：WebAssembly-的-SIMD-支持"><a href="#Extra：WebAssembly-的-SIMD-支持" class="headerlink" title="Extra：WebAssembly 的 SIMD 支持"></a>Extra：WebAssembly 的 SIMD 支持</h1><p>WebAssembly 的标准里是有 <a href="https://github.com/WebAssembly/simd">SIMD 指令集的提案</a>的，最近各大浏览器以及 Node.js 的 JS 引擎终于<a href="https://github.com/WebAssembly/simd/blob/main/proposals/simd/ImplementationStatus.md">实装了对 SIMD 的支持</a>。理论上来说，使用 SIMD 可以进一步增加 wasm 的执行速度（虽然我做过的简单测试里似乎并不是这样……）</p><p>参考 <a href="https://github.com/GoogleChromeLabs/wasm-feature-detect">GoogleChromeLabs&#x2F;wasm-feature-detect</a>，可以用下面的代码检测对 SIMD 的支持：</p><pre class="shiki shiki-themes nord dark-plus" style="background-color:#2e3440ff;--shiki-dark-bg:#1E1E1E;color:#d8dee9ff;--shiki-dark:#D4D4D4" tabindex="0"><code><span class="line"><span style="color:#D8DEE9;--shiki-dark:#9CDCFE">WebAssembly</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">.</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA">validate</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">(</span><span style="color:#81A1C1;--shiki-dark:#569CD6">new</span><span style="color:#88C0D0;--shiki-dark:#DCDCAA"> Uint8Array</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">([</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8">0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 97</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 115</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 109</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 5</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 96</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 123</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 3</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 2</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 10</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 10</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 1</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 8</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 65</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 0</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 253</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 15</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 253</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 98</span><span style="color:#ECEFF4;--shiki-dark:#D4D4D4">,</span><span style="color:#B48EAD;--shiki-dark:#B5CEA8"> 11</span><span style="color:#D8DEE9FF;--shiki-dark:#D4D4D4">]))</span><span style="color:#81A1C1;--shiki-dark:#D4D4D4">;</span></span></code></pre><p>根据 <a href="https://emscripten.org/docs/porting/simd.html">Emscripten 文档</a>所述，编译时只要添加参数 <code>-msimd128</code> 就可以直接在编译的时候使用 SIMD 优化了。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/82627900">Pixiv ID: 82627900 「After school~」 by 呱子</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;和 JavaScript 一样，WebAssembly 也是一种可以在浏览器中运行的编程语言，不过它的性质更相当于汇编语言。wasm 文件由二进制的&lt;a href=&quot;https://pengowray.github.io/wasm-ops/&quot;&gt;字节码&lt;/a&gt;组成（也可以转换</summary>
      
    
    
    
    
  </entry>
  
</feed>
