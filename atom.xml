<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>存在感消失的地方|ω•`)</title>
  <icon>https://akarin.dev/img/favicon.png</icon>
  
  <link href="https://akarin.dev/atom.xml" rel="self"/>
  
  <link href="https://akarin.dev/"/>
  <updated>2024-01-19T15:37:09.000Z</updated>
  <id>https://akarin.dev/</id>
  
  <author>
    <name>✨小透明・宸✨</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>西方 Project 幡紫龙 C74 版汉化（魔改）记录</title>
    <link href="https://akarin.dev/2024/01/19/banshiryuu-modification/"/>
    <id>https://akarin.dev/2024/01/19/banshiryuu-modification/</id>
    <published>2024-01-19T15:37:09.000Z</published>
    <updated>2024-01-19T15:37:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>西方 Project 是一个弹幕射击类游戏系列，前两作由东京电机大学的学生社团 Amusement Makers 制作，第三作由前 AM 成员组成的“被瞬杀之道？（瞬殺サレ道？）”制作。此系列的三个游戏为秋霜玉、稀翁玉、幡紫龙，是基于在概念上对应 AM 的先辈 ZUN（后来成立了个人社团上海爱丽丝幻乐团）的东方 Project 而制作的作品，而前两作也有 ZUN 的参与制作及东方 Project 的客串出场。</p><p>……嘛，以上的介绍是从 <a href="https://thwiki.cc/%E8%A5%BF%E6%96%B9Project">THBWiki</a> 复制粘贴过来的。总之在最近通关了东方 Project 所有 Windows 整数作的 Normal 难度之后打算试点新东西，再加上之前也有通关秋霜玉 Normal 的经历，于是就找到了幡紫龙。（也许以后还会试试稀翁玉？）</p><p>不过这一作似乎没有汉化？</p><p>在查找角色设定和剧情的相关资料的时候，偶然看到了在国外的车万论坛 Maidens of the Kaleidoscope 上关于西方各作的英文补丁的<a href="https://www.shrinemaiden.org/forum/index.php?topic=19231.0">讨论帖</a>，其中有人提到制作英文版的最大阻碍是对游戏数据包的封包，大概也是这么久以来幡紫龙一直没有汉化版的原因之一，另一个原因也许是太冷门了。</p><p>解包工具早就已经有人写出来了，也就是 NamelessLegacy 的 <a href="https://github.com/nmlgc/pbg6ext">pbg6ext</a>。然后 Clb184 制作了 <a href="https://github.com/Clb184/BSRtk">BSRtk</a>，可以反编译和编译游戏中的二进制脚本，不过仍然没有实现封包功能。</p><p>于是，从“随便试试看”这样的想法开始，我对幡紫龙的主程序动手了…_φ(･ω･&#96; )</p><p>然后顺便就把汉化做出来了，想要下载的话可以去<a href="https://file.akarin.dev/s/n3tN">这里</a>。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1280*960),960px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/15/dc97281928aee94018e330e7d3383837/j_4UmP2a.jpg" data-src-webp="https://p.sda1.dev/15/7b94453677c912bb809f832d6ee7f569/QwcHiDgy.webp" data-src="https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAcCBgEDBf/EACcQAAICAgEDAgcBAAAAAAAAAAECAxEABBIFMVEHYQYTFCEzQaLh/8QAFgEBAQEAAAAAAAAAAAAAAAAABAMF/8QAIBEAAQQCAgMBAAAAAAAAAAAAAQACERIDITFBExQiUf/aAAwDAQACEQMRAD8AucnWNsbejsmaWOCbYREQ0UKEUa492Jy5hj88U0osC2WSgK9sSCepabEvN+hqxqPgpkACFe5us6S+o22Y5poug80hW3I2e38ZZzAwjeyN7B5SH5BlgEAVkAAdJYwlX1itrYk5Vx+/bz4zRMDw4A1Tcrv2yELuVjCp+T9k1WQ2pGjBQxcqN2G/zLfHhDdXqs4My+xYzW36j6fWjcBZTItA9uJvGV0LQ1k+E+tz8CS0JZSR4sGhhhhol7dnlLY+Q4wAaylvFEihCWRlIug6gjMbDw3S+PY4YYoY2l3aOchX/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>不过，由于我的日语水平大概只有 N95 级别（笑），所以这个汉化版大部分是复制粘贴了 THBWiki 上现有的翻译，<strong>剩余的文本则通过 DeepL 和 ChatGPT <del>和脑补</del>完成翻译</strong>（可能有人会在意这个），略有改动。可能会有不准确的地方……在这里留言指出的话，我会尝试修正的！</p><blockquote><p>汉化是基于 C74 v3.001 版的主程序进行的（SHA-256：<code>07f2033073f1c890dcd25324dcf81778e88e8e0039a1a1d52e4889c17b9b8091</code>）。幡紫龙还有一个更早的 C67 版，不过关卡设计、游戏系统、界面等都有很大的差别，基本上可以当成两个不同的游戏了。我暂时没有汉化 C67 版的打算。</p><p>顺便一提，使用更新补丁时可能会由于编码问题导致无法找到游戏主程序而出错，这种情况下需要把游戏主程序的文件名改为 <code>敠巼棾.exe</code>（用 Shift-JIS 编码的“幡紫竜.exe”按照 GBK 解码的效果）。</p></blockquote><h1 id="PBG6-数据包格式介绍"><a href="#PBG6-数据包格式介绍" class="headerlink" title="PBG6 数据包格式介绍"></a>PBG6 数据包格式介绍</h1><p>幡紫龙使用的数据包，也就是那些扩展名 <code>.ac6</code> 的文件，暂且根据文件头的 magic number 记作 PBG6。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/743*236),236px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/433a2b4615058b3e3763702709d90f42/SdvSuz1X.webp" data-src="https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAKACADASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAwIEB//EACMQAAIBAwQBBQAAAAAAAAAAAAECAAMREiEiMUEEMjNDcXP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/xAAYEQEBAQEBAAAAAAAAAAAAAAABAAIRMf/aAAwDAQACEQMRAD8A11GQE6NsbHQRQ/YepYwU+f8AUxR6RHsM6QLPaSNfblUueyYyVs2QK3NwBtPA75ldfdH1B8F3avTyYnYeTD2uF//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>通过阅读 <a href="https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp">pbg6ext 的代码</a>（当然自己从头分析也不难）可知，整个 PBG6 文件一共由三个部分组成：</p><ul><li>文件头（固定 16 bytes）<ul><li><code>uint8_t[4]</code> 数据包格式的 magic number <code>PBG6</code></li><li><code>uint32_t</code> 目录数据在数据包文件中的位置</li><li><code>uint32_t</code> 目录解密后的大小</li><li><code>uint32_t</code> 目录解密后的 CRC32</li></ul></li><li>加密的各个文件数据</li><li>加密的目录数据</li></ul><p>目录数据的开头是一个 <code>uint32_t</code>，用于记录数据包中包含的文件数量，之后是若干段各个文件的信息，每一段由以下数据组成：</p><ul><li><code>uint8_t[]</code> Shift-JIS 编码的以 <code>0x00</code> 结束的文件名，以根目录的斜杠开始，例如：<code>/foo.bar</code></li><li><code>uint32_t</code> 文件解密前的大小</li><li><code>uint32_t</code> 文件解密后的大小</li><li><code>uint32_t</code> 文件数据在数据包文件中的位置</li><li><code>uint32_t</code> 文件解密后的 CRC32</li></ul><p>知道了 PBG6 的格式，就可以自己写一个简单的封包工具了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> sys<span class="token keyword">import</span> zlibsrcPath <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Input ac6 path: '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>ac6Path <span class="token operator">=</span> srcPath <span class="token operator">+</span> <span class="token string">'.ac6'</span>tocContent <span class="token operator">=</span> <span class="token string">b''</span>tocCount <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>ac6Path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'PBG6'</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'XXXX'</span><span class="token punctuation">)</span> <span class="token comment"># toc pos</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'XXXX'</span><span class="token punctuation">)</span> <span class="token comment"># toc size</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'XXXX'</span><span class="token punctuation">)</span> <span class="token comment"># toc crc32</span>    <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>            srcFile <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>            ac6File <span class="token operator">=</span> srcFile<span class="token punctuation">.</span>removeprefix<span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>ac6File<span class="token punctuation">)</span>            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> g<span class="token punctuation">:</span>                d <span class="token operator">=</span> g<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>            tocContent <span class="token operator">+=</span> ac6File<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'shift_jis'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span>            tocContent <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>            tocContent <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>            tocContent <span class="token operator">+=</span> f<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>            tocContent <span class="token operator">+=</span> zlib<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>d<span class="token punctuation">)</span>            tocCount <span class="token operator">+=</span> <span class="token number">1</span>    tocContent <span class="token operator">=</span> tocCount<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token operator">+</span> tocContent    tocPos <span class="token operator">=</span> f<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>tocContent<span class="token punctuation">)</span>    f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>tocPos<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tocContent<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>zlib<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>tocContent<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>……如果不考虑加密的话。</p><p>之前提过，PBG6 是使用了某种加密（或者说是压缩，这里就不区分了）算法来存储目录和文件数据的，而且该算法似乎不是 Deflate 或 LZ 系列之类的任何一种标准算法。</p><p>pbg6ext 之所以能实现解包，那是因为原作者直接<a href="https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp#L128">照抄</a>了从幡紫龙主程序反编译出来的解包部分的汇编代码，所以这工具的变量名也都是各种寄存器名称……</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/839*949),949px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/8e24066b20674d69c48add43108a0cbd/1iYDaRWm.webp" data-src="https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgABwDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIBAwf/xAAjEAACAgEDAwUAAAAAAAAAAAAAAQIRQQMSgRMxQgQiUqGx/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD3SWlGLWVbq0sHTpzfk1wXNKk2r9z/AEuLV0oNcFGr0zzqfQ6D+QBBkktl32k6xkKV+dPgnUlUMVukVpTl22gaAAP/2Q"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <blockquote><p>Actually, I didn’t write it. I just copied the code from Banshiryuu’s assembly, which is made obvious by the variable names in the decrypt function. I have no clue what this is actually doing or if this is some known algorithm.</p><p>Writing a repacker would be the actually interesting part, but this game is bland anyway.</p><p>——pbg6ext 的 <a href="https://github.com/nmlgc/pbg6ext/blob/master/Readme.txt">README</a></p></blockquote><p>如果手上只有这堆汇编代码的话，写出对应的压缩代码当然就是十分困难的事情了。显而易见，无法实现压缩的话也就无法实现封包，把汉化过的脚本和图片资源导入游戏什么的完全没办法啊……</p><blockquote><p>… so we still need a hardcore hacker to have the tools which will allow us to extract and repack the game data. :V</p><p>——Maidens of the Kaleidoscope 上的讨论帖<a href="https://www.shrinemaiden.org/forum/index.php?topic=19231.msg1236359#msg1236359">“SEIHOU Project English Patch Question”</a></p></blockquote><h1 id="对读取数据包的分析和魔改"><a href="#对读取数据包的分析和魔改" class="headerlink" title="对读取数据包的分析和魔改"></a>对读取数据包的分析和魔改</h1><p>翻出 IDA 把主程序拖进去分析。根据 pbg6ext 的那段从汇编转写过来的 C++ 代码，试着搜索对应的汇编代码，在尝试了很多次之后找到了位于 <code>sub_42D8D0</code> 的解密算法：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/974ef00780ce0e69e6d8c516edb07925/FmGj9hnJ.webp" data-src="https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAEDBAIFB//EACgQAAIBBAECBAcAAAAAAAAAAAECAAMEESEScZEUYaHRFSIjMTJRVP/EABYBAQEBAAAAAAAAAAAAAAAAAAIBAP/EABsRAAMAAgMAAAAAAAAAAAAAAAABESGRAjFx/9oADAMBAAIRAxEAPwDs9GwerSar4hwN61r0jo2VbYW6bJ/ePaWrWpRW1wzfNvW5LTBDAfbKjyi7qwBcUmnnbF8PuSMG4Pp7RNZXCqWNxoeQ9pZ49e8G/FukE92M1qVXLBipyRjORM1yzDlzXHQwhLSRE/I/0P2gznifrt2hCYp//9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>和 pbg6ext 的代码对比一下还是能辨认出来是同一个东西的，当然因为这是反编译的产物所以看上去糟了很多。</p><p>然后，可以通过动态调试下断点看调用栈，或者用 Sysinternals 的 procmon 检查使用 <code>ReadFile</code> 读取 PBG6 的前 16 bytes（也就是文件头）的地方，从而找到 <code>sub_42D2C0</code> 这个读取 PBG6 的函数：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/9c403551b04393ffd6c6d5e3f860a94a/pcQmvfKQ.webp" data-src="https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMBBAUH/8QAJRAAAgICAQMDBQAAAAAAAAAAAQIAAxEhBBIUcRNBkSIxVGHR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgEA/8QAGxEBAAICAwAAAAAAAAAAAAAAAAERAjEhUZH/2gAMAwEAAhEDEQA/AOzU8B7aTb3DgYOta8ak1cK8Ehb3Od51/Jb4llK8XDH6t4jKqVsfbYGjo7i3YxjG+fSuz5GMG5vhYNxOSASbGx4WXhSo+7MfJg6KEbHspgqO5Jlpa5IYqckYzkRiMevOXT96hCVKP6z+Q/xIZyVYeux17iEJlf/Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <ul><li><code>v9 != 910639696</code> 这个常数就是用小端序表示的 magic number <code>PBG6</code>，即 <code>0x36474250</code>。</li><li><code>v7 = sub_42DC90((int)v6, v5, dwBytes), (v2 = (void *)v7) != 0</code> 调用了解密算法。</li><li><code>v8 = sub_42DB50(v7, dwBytes, 0), v12 == v8</code> 计算解密后数据的 CRC32，并检查和文件中记录的值是否一致。</li></ul><p>其实一开始只知道 PBG6 使用了校验和，但是不知道具体算法，点进 <code>sub_42DB50</code> 也没能认出来，只是用解包后的文件随便试了一下才发现是 CRC32。不过就算不知道，把校验过程直接去掉也是可以的。</p><p>继续查看 <code>sub_42DC90</code>，可以看到这里分配了一块内存区域用于保存解密后的数据（调用的就是 <code>sub_42D8D0</code>，不过不知道怎么被反编译成了函数指针的样子），解密成功则返回这个区域的地址。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1255*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/057c9b1676cbb7688988d425cfd69292/c7uzRR1J.webp" data-src="https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAQBAwIFB//EACQQAAEEAQIGAwAAAAAAAAAAAAEAAgMRBBIhFDGBkaHRI1TB/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/8QAGhEBAQACAwAAAAAAAAAAAAAAAAECIRGR4f/aAAwDAQACEQMRAD8A7LDhGSIycS4XdN228KY8SRuoDJf1r0n8SeJuGWE042mWMeRTiKHKk3fiZjJvfdIcLLW+UPA/FkcaWjeSOzfSeUHkVPCmsZK8kOLTZFXYVzZXl273tHRCEiRbrP2H9lDnnSfnd2QhYv/Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>暂时先分析到这里。那我是怎么使封包变得可行，从而实现汉化的呢？在给出答案之前，可以试着自己大胆猜想一下。</p><p>可以稍微提示一下……这个汉化是魔改了主程序的，而使封包变得可行的方法在前面的某个地方已经给出线索了。</p><blockquote><p><strong>“……如果不考虑加密的话。”</strong></p></blockquote><p>原来的主程序是从数据包读取加密的数据，解密后再使用。既然我们无法自行实现封包的加密，那把这一层直接去掉不就可以了吗？</p><p>一边是对数据包进行重新封包，保持 PBG6 的格式不变，但是不进行加密的步骤。另一边是修改 <code>sub_42DC90</code> 的代码，把解密操作去掉，改成直接使用数据包中的数据，也就是把这部分改成一个 <code>memcpy</code>。这样就没有什么加密解密的事情了。</p><p><code>sub_42DC90</code> 对应的汇编如下：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1482*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/1434dc2f2ed48b31adb5407faa28e618/_FDeJNoy.webp" data-src="https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAATACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAIDBAEFB//EACMQAAICAQMEAwEAAAAAAAAAAAECAAMhBBGREyIxQRIUYVH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgD/xAAaEQACAgMAAAAAAAAAAAAAAAAAARIhAjFh/9oADAMBAAIRAxEAPwDsq6RDUj9R+/8AfGfUWum0al6VtIVcjJJltCpopAOQc8zFTKuusdz2bDMXdMiKA6e5bihvHJk/0tQE+TWbfhMayypriQ267yw19RQ948SXgq2Mes1aKuwx6k6kr4hCJQ3Uf+jgQNjbHI4EITGP/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>而我的操作就是从 <code>.text:0042DCA8</code> 开始（这部分以上是 <code>if (!v5) return 0;</code>），用汇编的串传送指令（还好当时学的汇编语言没完全还给老师……）实现这个简单的 <code>memcpy</code>，再处理好返回值和栈平衡，剩下的部分用 <code>nop</code> 填充：</p><pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">arg_0 <span class="token operator">=</span> dword ptr <span class="token number">4</span> <span class="token comment">; 解密前数据的地址</span>arg_4 <span class="token operator">=</span> dword ptr <span class="token number">8</span> <span class="token comment">; 解密前数据的大小</span>dwBytes <span class="token operator">=</span> dword ptr <span class="token number">0Ch</span> <span class="token comment">; 解密后数据的大小</span>push <span class="token register variable">ebx</span>mov  <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">+</span>dwBytes<span class="token operator">]</span>push <span class="token register variable">esi</span>push <span class="token register variable">edi</span>push <span class="token register variable">ebx</span> <span class="token comment">; dwBytes</span>push <span class="token number">0</span> <span class="token comment">; uFlags</span>mov  <span class="token register variable">edi</span>, <span class="token register variable">ecx</span>call <span class="token register variable">ds</span>:<span class="token keyword">GlobalAlloc</span>mov  <span class="token register variable">esi</span>, <span class="token register variable">eax</span> <span class="token comment">; 此时esi存储的就是v5</span>test <span class="token register variable">esi</span>, <span class="token register variable">esi</span>jz   short loc_42DCC6 <span class="token comment">; if (!v5) return 0;</span><span class="token comment">; 从这里开始覆盖</span><span class="token comment">; 从esi向edi复制ecx字节，通过rep movsb调用</span>push <span class="token register variable">esi</span>                   <span class="token comment">; 56</span>mov  <span class="token register variable">edi</span>, <span class="token register variable">esi</span>              <span class="token comment">; 89 F7</span>mov  <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">010h</span><span class="token operator">+</span>arg_0<span class="token operator">]</span> <span class="token comment">; 8B 74 24 14</span>mov  <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">010h</span><span class="token operator">+</span>arg_4<span class="token operator">]</span> <span class="token comment">; 8B 4C 24 18</span>rep  movsb                 <span class="token comment">; F3 A4</span>pop  <span class="token register variable">esi</span>                   <span class="token comment">; 5E</span>mov  <span class="token register variable">eax</span>, <span class="token register variable">esi</span>              <span class="token comment">; 89 F0</span>pop  <span class="token register variable">edi</span>                   <span class="token comment">; 5F</span>pop  <span class="token register variable">esi</span>                   <span class="token comment">; 5E</span>pop  <span class="token register variable">ebx</span>                   <span class="token comment">; 5B</span>retn <span class="token number">0Ch</span>                   <span class="token comment">; C2 0C 00</span>nop                        <span class="token comment">; 90</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如此修改之后，IDA 也能认出它是 <code>memcpy</code> 了：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1285*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/856f5cb1eff39b46dc67a3503794702f/3jvhOwjP.webp" data-src="https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAWACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAQDBQECB//EACcQAAEDAwEHBQAAAAAAAAAAAAEAAiEDBBESFBUiIzFxkjJBUmGR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAIB/8QAGxEAAgIDAQAAAAAAAAAAAAAAAAERIQIxkXH/2gAMAwEAAhEDEQA/AOyMtHOph+0PwcxgROIhSUrWpIbcvMz6VPbu5VNhE56Y+wVYLW9qCVild9Ft33JAzcH8AQ6xrtBJuI7BMoUx70oq2aoOsgn3TLHOEGo89ihC0G+sfOp5LBfB46nkhCA//9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>实际运行测试一下，主程序也能正常读取重新封过的去掉了加密的数据包。这样对于汉化来说最大的阻碍就解决了。</p><h1 id="修改编码和字体"><a href="#修改编码和字体" class="headerlink" title="修改编码和字体"></a>修改编码和字体</h1><p>前面也提过，主程序使用的是 Shift-JIS 编码，汉化的话就需要改成 GBK 编码。创建字体使用的是 <a href="https://learn.microsoft.com/zh-cn/windows/win32/api/wingdi/nf-wingdi-createfonta"><code>CreateFontA</code></a>，其中参数 <code>DWORD iCharSet</code> 就是用来设定编码的。<code>sub_4257B0</code> 调用了这个函数：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1208*897),897px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/15/9773ddbb20ca142eccefe7c5fb992f35/Kx1PkFg2.webp" data-src="https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgABAQACAwAAAAAAAAAAAAAAAAQBAgMFB//EACYQAAIBAwIGAgMAAAAAAAAAAAECAAMEEUFxEhMhNFGRFFSxwdL/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/xAAdEQACAQQDAAAAAAAAAAAAAAAAARECEiGRMWGx/9oADAMBAAIRAxEAPwD2KnaM6B/kNg56dOk3p2tdWIFycnyR+hLbbt03aVVKSCgjasVibnHiAqFznZOLC7K9wMeRj84g2N0q5NcYG38ytMDI4h7iC3t7FB1VKoVRUycbGcquzHHHrqp03iJppVza/wBhPUwatbhI5yeoiRH/2Q"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>中间的 <code>0x80 (SHIFTJIS_CHARSET)</code> 需要改成 <code>0x86 (GB2312_CHARSET)</code>。由于还没有修改游戏脚本，所以这个时候进入游戏会看到把 Shift-JIS 编码的文本当成 GBK 编码而出现的乱码。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/640*480),480px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/15/ef74850433873e0573027bee07b1c579/5fLB8hWl.jpg" data-src-webp="https://p.sda1.dev/15/fa3d3827d331b42389c039f95f72dcdd/6p5Tgmx0.webp" data-src="https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMCBAUH/8QAIxAAAgICAgIBBQAAAAAAAAAAAQIDBAARBRIhIiMTMUFRgf/EABgBAAIDAAAAAAAAAAAAAAAAAAACAQME/8QAIBEAAgIBBAMBAAAAAAAAAAAAAQIAAxEEITFhEjNyUv/aAAwDAQACEQMRAD8A51XMH167zAtF29wG2dfzRxcqV3mndYfjMhMfdjvr+BlcsygnQxnyE78DNmnrDISc8yi52UgDxxznG8DDG3TSBCD4IO9axUrusrEOTknWRkKeuMVFWM7Oz9sL0C1jH6i1MS+5HEWrAEbzb4O/xtPlKk9+sLNVGJkj8HeGGPpRmpvqFoBsU9SXM2qF3lLdrj6pgqs+0i/QzFKPJt1U6wwyNT6x9QpUB2PU/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>有些游戏不仅需要改编码，还会进行<a href="https://github.com/Inori/FuckGalEngine/blob/master/_general_tools/%E8%BE%B9%E7%95%8C%E6%A3%80%E6%B5%8B.txt">字符边界检查</a>，保证文本数据的每个字节都在 Shift-JIS 的范围内。不过幡紫龙没有添加边界检查。</p><p>另外，原来的无衬线体在这里变成了宋体，这也是因为修改了编码后就无法找到字体了。在这里下断点可以找到使用的字体名称：</p><ul><li><code>.rdata:0046EF88</code> <code>82 6C 82 72 20 82 6F 96 BE 92 A9</code>（Shift-JIS 编码的“ＭＳ Ｐ明朝”）</li><li><code>.rdata:0046EF94</code> <code>82 6C 82 72 20 82 6F 83 53 83 56 83 62 83 4E</code>（Shift-JIS 编码的“ＭＳ Ｐゴシック”）</li><li><code>.rdata:0046EFA4</code> <code>82 6C 82 72 20 96 BE 92 A9</code>（Shift-JIS 编码的“ＭＳ 明朝”）</li><li><code>.rdata:0046EFB0</code> <code>82 6C 82 72 20 83 53 83 56 83 62 83 4E</code>（Shift-JIS 编码的“ＭＳ ゴシック”）</li></ul><p>分别改成 GBK 编码的“宋体” <code>CB CE CC E5</code> 和“黑体” <code>BA DA CC E5</code>。</p><p>类似地，可以通过搜索调用 <code>CreateWindowExA</code> 的地方和断点调试找到窗口标题的位置：<code>.rdata:0046D464</code> <code>94 A6 8E 87 97 B3 20 81 60 82 CE 82 F1 82 B5 82 E8 82 E3 82 A4 81 60</code> （Shift-JIS 编码的“幡紫竜 〜ばんしりゅう〜”），改成 GBK 编码的“幡紫龙” <code>E1 A6 D7 CF C1 FA</code>。</p><p>之后就是修改脚本、改图嵌字之类的和主程序修改无关的琐碎工作了。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/110299012">Pixiv ID: 110299012 「:p」 by 白河</a></p></blockquote>]]></content>
    
    
    <summary type="html">因为似乎没有人做过就试试看了…_φ(･ω･` )</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>在 Windows 下检测深色模式并监听变化</title>
    <link href="https://akarin.dev/2023/03/29/detect-dark-theme-on-windows/"/>
    <id>https://akarin.dev/2023/03/29/detect-dark-theme-on-windows/</id>
    <published>2023-03-29T13:50:12.000Z</published>
    <updated>2022-03-29T13:50:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近几年很多应用都加入了深色模式，或者叫暗黑模式，英文的写法是 Dark Theme 或 Dark Mode。一般的说法是，深色模式对于 OLED 屏幕可以达到省电的效果，在夜晚等较暗的环境下使用深色模式可以保护视力。保护视力这一点其实还存在争议，有些理论表示人类的视觉本来就偏向于前暗后亮，因此使用深色模式反而会影响阅读效率并且更容易导致疲劳。不过我自己的感受是在夜晚使用深色模式不至于被屏幕上很亮的一大片亮瞎眼睛，从这个体验来说使用深色模式还是有着一定的意义的。</p><p>之前出于自己的需求用 Python 和 Tkinter 给图片放大工具 Real-ESRGAN 做了一个 <a href="https://github.com/TransparentLC/realesrgan-gui">GUI</a>，选择了 <a href="https://github.com/rdbende/Sun-Valley-ttk-theme">Sun-Valley-ttk-theme</a> 这个非常符合 Windows 11 的设计风格的主题，正好发现它同时提供了浅色和深色模式的主题，就打算借用这个在自己做的 GUI 里也加入深色模式的支持了。</p><p>首先需要解决的问题是：如何检测当前是否正在使用深色模式？</p><p>如果用的是 Qt 之类的大而全的 GUI 框架，这种功能说不定都<a href="https://forum.qt.io/topic/130589">已经封装好了</a>，不过 Tkinter 是没有这种功能的。还好，有人写了一个叫 <a href="https://github.com/albertosottile/darkdetect">Darkdetect</a> 的包，可以跨平台（Windows、Linux 和 macOS）检测系统是否启用了深色模式，使用 <code>darkdetect.isDark()</code> 就可以了。</p><p>不过如果只是推荐一个包的话我就不会特地写这个了（笑），那么 Darkdetect 又是怎么实现检测的呢？在 Windows 下，设置里“个性化→颜色→选择模式→选择默认应用模式”就是是否使用深色模式的选项，底层的记录则是注册表里 <code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize</code> 的 <code>DWORD</code> 类型的键 <code>AppsUseLightTheme</code>。从名字就可以看出来，值为 <code>0</code> 表示使用深色模式，值为 <code>1</code> 表示不使用深色模式。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1113*509),509px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/DsUux8mF.webp" data-src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/pWt1NPyu.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAPACADASIAAhEBAxEB/8QAGQAAAQUAAAAAAAAAAAAAAAAACAACAwQH/8QAIhAAAgEEAgIDAQAAAAAAAAAAAQIDAAQFERIxE2EUI1GC/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAYEQADAQEAAAAAAAAAAAAAAAAAAREhMf/aAAwDAQACEQMRAD8Ay28eKRw6W4hUqo0vIjYGj2T3SjhVouWvROuvfdFaMFiFliT4MGm73EpqS4xGNhuRGuLtWTQ2THGpG/4NFvC2LQR/EP004wAJy2aLy5w+KhcquMtT9fLfhTurUOBw8kaucdajY68KUFP/2Q"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/pWt1NPyu.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>通过读取注册表就可以实现检测了。Python 自带的 <a href="https://docs.python.org/zh-cn/3/library/winreg.html"><code>winreg</code></a> 模块可以用来读写注册表，其他语言的话也总有读取注册表的办法，实在没有的话直接用 Windows API 也不是不可以（</p><p>以前我写过一个简单的 PowerShell 脚本，功能就是读取和写入 <code>AppsUseLightTheme</code> 来快速切换深色模式，借助计划任务就可以实现每天早上和晚上的定时切换了，后来发现了 <a href="https://github.com/AutoDarkMode/Windows-Auto-Night-Mode">Auto Dark Mode</a> 这个小工具就转而使用它了。</p><p>检测深色模式的问题解决了，现在可以实现在系统使用深色模式的情况下打开那个 GUI 就选择使用深色模式的主题了，不过还有一个问题：在切换深色模式的设置时，GUI 还不能根据跟着自动切换主题。</p><p>Darkdetect（当时）还不支持监听深色模式的设置变化，有人<a href="https://github.com/albertosottile/darkdetect/issues/14">提议添加这个功能</a>，但是对于怎么实现大家也没什么头绪。如果在 Google 上搜索“检测深色模式”的话，搜索结果基本上都是<strong>前端开发</strong>相关的，教你用 CSS 的 <code>@media (prefers-color-scheme: dark)</code> 检测深色模式以及用 JS 的 <code>matchMedia(&#39;(prefers-color-scheme: dark)&#39;).addEventListener(&#39;change&#39;, e =&gt; e.matches)</code> 来监听变化的各种教程；如果搜索“windows detect dark mode change”的话，也基本上只能搜索到怎么“detect”，没什么和“change”有关的东西。</p><p>如果 GUI 用的是 Electron 之类的使用 Webview 的方案自然就可以把前端开发的那一套直接拿来用了，但是不使用浏览器的话要怎么办？总不能每秒轮询一次吧？浏览器已经能实现深色模式的监听了，它是怎么实现的呢？</p><p>Chromium 是开源的浏览器内核，于是我就试着去翻了 Chromium 的源代码，用前面提过的 <code>AppsUseLightTheme</code> 作为关键词搜索，还真的翻到了几个相关的函数：</p><ul><li><code>ui/native_theme/native_theme_win.cc</code> 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:ui/native_theme/native_theme_win.cc;l=1581;drc=8101d6d81854e4f437e0f03f77694a01aaa8df7a">NativeThemeWin::UpdateDarkModeStatus</a>，这个函数是用来检测深色模式的，读取的就是注册表的 <code>AppsUseLightTheme</code>。</li><li><code>ui/native_theme/native_theme_win.cc</code> 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:ui/native_theme/native_theme_win.cc;l=1569;drc=8101d6d81854e4f437e0f03f77694a01aaa8df7a">NativeThemeWin::RegisterThemeRegkeyObserver</a>，就在上一个函数旁边，从名字就可以看出，功能是通过检测注册表的改变来实现对深色模式的监听。</li><li><code>base/win/registry.cc</code> 的 <a href="https://source.chromium.org/chromium/chromium/src/+/main:base/win/registry.cc;l=74;drc=8101d6d81854e4f437e0f03f77694a01aaa8df7a">RegKey::Watcher::StartWatching</a>，用来实现“检测注册表的改变”。</li></ul><p>翻了 <code>RegKey::Watcher::StartWatching</code> 的源代码才知道，原来 Windows API 里提供了 <a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regnotifychangekeyvalue"><code>RegNotifyChangeKeyValue</code></a> 这个函数可以在注册表更改时进行通知。如果用它检测 <code>AppsUseLightTheme</code> 的更改，就可以实现深色模式的监听了。</p><p>用 C 写了一个简单的示例：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"Advapi32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    HKEY hKey<span class="token punctuation">;</span>    <span class="token function">RegOpenKeyExA</span><span class="token punctuation">(</span>HKEY_CURRENT_USER<span class="token punctuation">,</span> <span class="token string">"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> KEY_NOTIFY <span class="token operator">|</span> KEY_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hKey<span class="token punctuation">)</span><span class="token punctuation">;</span>    DWORD dwSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>    DWORD queryValueLast<span class="token punctuation">;</span>    DWORD queryValue<span class="token punctuation">;</span>    <span class="token function">RegQueryValueExA</span><span class="token punctuation">(</span>hKey<span class="token punctuation">,</span> <span class="token string">"AppsUseLightTheme"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPBYTE<span class="token punctuation">)</span><span class="token operator">&amp;</span>queryValueLast<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">RegNotifyChangeKeyValue</span><span class="token punctuation">(</span>hKey<span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> REG_NOTIFY_CHANGE_LAST_SET<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">RegQueryValueExA</span><span class="token punctuation">(</span>hKey<span class="token punctuation">,</span> <span class="token string">"AppsUseLightTheme"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPBYTE<span class="token punctuation">)</span><span class="token operator">&amp;</span>queryValue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwSize<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>queryValueLast <span class="token operator">!=</span> queryValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            queryValueLast <span class="token operator">=</span> queryValue<span class="token punctuation">;</span>            <span class="token function">puts</span><span class="token punctuation">(</span>queryValue <span class="token operator">?</span> <span class="token string">"Light"</span> <span class="token operator">:</span> <span class="token string">"Dark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在运行到 <code>RegNotifyChangeKeyValue</code> 这里的时候会一直阻塞，直到注册表的值改变为止，然后读取 <code>AppsUseLightTheme</code> 的值检查深色模式的设置是否有变化，如果有则输出当前的主题。这个监听是死循环，实际使用的时候单独开一个线程就可以了。效果如下：</p><video poster="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/UDGCaVKn.jpg" controls preload="metadata">    <source src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/6xRqEH2a.mp4" type="video/mp4; codecs=av01.0.09M.10">    <source src="https://fs-im-kefu.7moor-fs2.com/im/2768a390-5474-11ea-afc9-7b323e3e16c0/gyqOVFFf.mp4" type="video/mp4; codecs=avc1.640033"></video><p>发现这个之后顺便就给 Darkdetect 提交了一个 <a href="https://github.com/albertosottile/darkdetect/pull/20">Pull request</a>，因为原作者希望使用纯 Python 代码，后来使用 <code>ctypes</code> 进行了<a href="https://github.com/albertosottile/darkdetect/blob/64ce54e20be54cc41f85c8c208d35a4137b958d3/darkdetect/_windows_detect.py#L82">改写</a>。</p><p>与此同时还发现了 Linux 下的监听方法，于是也写进了 Pull request，具体做法可以参见<a href="https://github.com/albertosottile/darkdetect/blob/64ce54e20be54cc41f85c8c208d35a4137b958d3/darkdetect/_linux_detect.py#L38">当时提交的代码</a>，这里就不详细介绍了。我没有使用 macOS 的设备，所以当时没有添加 macOS 下的实现，不过这个后来也有人<a href="https://github.com/albertosottile/darkdetect/blob/64ce54e20be54cc41f85c8c208d35a4137b958d3/darkdetect/_mac_detect.py">补充</a>了。</p><p>“很惭愧，做了一点微小的工作，谢谢大家！”</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/96300365">Pixiv ID: 96300365 「温かいコーヒーどうぞ！」 by チノマロン</a></p></blockquote>]]></content>
    
    
    <summary type="html">之前在折腾某个开源项目时想到要记下来的东西，结果一直鸽到网站都长草了才写出来……</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>使用浏览器扩展在运行 Selenium 的 Firefox 浏览器中伪装 navigator.webdriver</title>
    <link href="https://akarin.dev/2022/02/15/disable-geckodriver-detection-with-addon/"/>
    <id>https://akarin.dev/2022/02/15/disable-geckodriver-detection-with-addon/</id>
    <published>2022-02-15T15:23:29.000Z</published>
    <updated>2022-02-15T15:23:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题的背景"><a href="#问题的背景" class="headerlink" title="问题的背景"></a>问题的背景</h1><p>出于某些需求，我最近使用 Python 的 Selenium 模块，配合自动控制 Firefox 浏览器的 Geckodriver，编写和部署了一个自动完成某网站登录界面上的滑动验证码的服务。虽然这些验证码的宣传词上少不了“大数据”、“人工智能”、“高效拦截机器行为”之类的关键词，但是从现在在网上可以轻易搜索到的至少 114514 篇“○○滑动验证码破解”的文章来看，只要解决“寻找验证码缺口”和“拟合轨迹”这两个问题（当然，需要一些简单的图像处理和数学方面的知识），绝大多数的滑动验证码还是不堪一击的。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1270*789),789px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/6632f9cf9d6eacf4ac2b66f7becfe9c0/y8umq8Zl.webp" data-src="https://p.sda1.dev/12/f4d2a22d9c0696bbde4794e998b83c1c/V8mys-b3.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAUACADASIAAhEBAxEB/8QAGgAAAgMBAQAAAAAAAAAAAAAAAAECAwYFB//EACQQAAEDAwQBBQAAAAAAAAAAAAEAAgMFBiEEERJhURNBQ5HC/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhEDEQA/APVW2zbzmMJpGhOB8IVrLXttuxFG0WPf0WrS8R4Conw4jyQEHANsW+7Iougz5hambXofDiKVoh0IQFoAmgcMz3xxk7ZJUJgDIzt35KEIJcR39o2HaEIP/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/f4d2a22d9c0696bbde4794e998b83c1c/V8mys-b3.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>本来想在这里放上我编写的那个服务自动完成验证码的录屏，但是由于那里的验证码背景图可以暴露被我模拟登录的网站的信息，所以还是算了。作为替代，这里就放一张我当时写的几个拟合滑动轨迹的多项式函数图像吧 (*°∀°)&#x3D;3</p><p>那个服务正常运行了大半个月，累计差不多模拟完成了一两百次滑动验证码，但是今天这个服务突然就无法正常使用了，到底是怎么回事呢？</p><h1 id="基本的检测和伪装原理"><a href="#基本的检测和伪装原理" class="headerlink" title="基本的检测和伪装原理"></a>基本的检测和伪装原理</h1><p>根据大量的控制变量法和排除法分析，确定是由于 Selenium 控制的浏览器中存在的 <code>navigator.webdriver</code> 属性被检测到导致无法完成滑动验证码。这是个检查自动操作从而进行反爬的好方法，在正常的浏览器中这个属性的值为 <code>undefined</code>（在较新的浏览器里则为 <code>false</code>），如果浏览器被 Selenium 之类的工具自动控制的话则为 <code>true</code>。为了让服务可以继续运行，就有必要对它进行伪装了。</p><p>首先上一段最简单的代码，在配置好 Selenium 和 Geckodriver 之后就可以调用 Firefox 打开 <a href="https://bot.sannysoft.com/">https://bot.sannysoft.com/</a>，这是一个可以展示浏览器属性，同时标出哪些属性可能会被检查为自动控制的浏览器的网站。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverdriver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Firefox<span class="token punctuation">(</span><span class="token punctuation">)</span>driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://bot.sannysoft.com/'</span><span class="token punctuation">)</span><span class="token comment"># driver.execute_script('delete navigator.__proto__.webdriver')</span><span class="token keyword">try</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>    driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/webdriver">MDN 上的介绍</a>，<code>navigator.webdriver</code> 是个只读属性，所以不能通过覆盖值的方式来伪装。但是如果你稍微提高了一点姿势水平，就会知道可以通过重写这个属性的 getter 来把它覆盖掉。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>navigator<span class="token punctuation">,</span> <span class="token string">'webdriver'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>虽然确实可以覆盖，但是这个伪装行为本身还是可以被检查出来。只要执行上面的代码添加了 getter，执行 <code>navigator.hasOwnProperty(&#39;webdriver&#39;)</code> 就会返回 true，未执行则不返回。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1281*459),459px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/fa1ab90b8df3cb7ff41d811aa6ba91b2/p3ZGtrin.webp" data-src="https://p.sda1.dev/12/a7ca5b799a686520c9873f951abfaf59/QPt9p1D6.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAALACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAECAwQH/8QAHxAAAgIBBAMAAAAAAAAAAAAAAQIAEQQDEjFBEyFy/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQD/xAAVEQEBAAAAAAAAAAAAAAAAAAAAIf/aAAwDAQACEQMRAD8A7kq6amtq3x1NKaeM1bvGK+ZFFAF92ZdGAjj4LVbpfHpgILoYYUKHWugGjhKF/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/a7ca5b799a686520c9873f951abfaf59/QPt9p1D6.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>所以，另一种更好的做法是直接在原型链上把属性删除掉。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">delete</span> navigator<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>webdriver<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>只是知道这一点还不够，虽然 Selenium 提供了执行任意 JavaScript 代码的功能，但当你有机会执行的时候整个页面已经加载和执行完了。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1286*755),755px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/697f35aca41f557caa386e7a0042fbad/j7ivAzXi.webp" data-src="https://p.sda1.dev/12/faf095fe068ccd6fd3c629d349d0ca9c/3qmW7XVi.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAATACADASIAAhEBAxEB/8QAGQAAAwADAAAAAAAAAAAAAAAAAAUGAQIH/8QAIxABAAEDBAICAwAAAAAAAAAAAQIAAxEEBRIhEzEGgSIyM//EABcBAAMBAAAAAAAAAAAAAAAAAAADBAL/xAAeEQACAwACAwEAAAAAAAAAAAABAgADEQQSEyEiMf/aAAwDAQACEQMRAD8A7bA8tszdTIfiOFfqpd3a9ySOnuYH2zWqizC7w4Rgpgz3Us/F9x5KGn7V/lGp+QLyF8Rz92V8VKXL+WwJmZux9s10187xdhchwB/Zp46S1CE05fatIdk0Gr2t1ErtqM+ZEPFAPVPpaibCR4Zns7K3SHFa9z9e9irwi2sqP2X1hE1FxRloopsTDLWHsRBKKKIT/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/faf095fe068ccd6fd3c629d349d0ca9c/3qmW7XVi.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>“Chrome”那一项检查的是 <code>window.chrome</code>，只有使用 Chrome 才会出现，因为现在使用的是 Firefox 所以没有这个属性是正常的。另外如果使用 Selenium 或 Puppeteer 调用 Chrome 的话 User-Agent 里会写上 <code>HeadlessChrome</code> 的字样从而被检查出来，不过把上面的 JS 代码稍微修改一下也可以很容易伪装。对于其他属性的检查结果也可以自行与非自动控制的浏览器对照。</p><p>看到那个“WebDriver: present (failed)”了吗？虽然现在去控制台检查可以发现伪装已经生效了，但是在加载页面的时候还没有执行伪装的 JS 代码，所以 <code>navigator.webdriver</code> 还是被检查出来了（实际的检查代码是 <code>navigator.webdriver || _.has(navigator, &quot;webdriver&quot;)</code>，后者使用 Lodash 等效于使用 <code>hasOwnProperty</code> 检查）。所以现在的问题就变成了如何在页面加载前就运行伪装的 JS 代码，如果无法做到的话，那还是另请高明吧！无论如何，只要把 <code>navigator.webdriver</code> 处理成一个 falsy 的值就可以了。</p><h1 id="已有的伪装方法"><a href="#已有的伪装方法" class="headerlink" title="已有的伪装方法"></a>已有的伪装方法</h1><p>在 Google 上搜索了 1919 篇资料（大雾）后，我总结了几个目前已有的伪装方法，分别对应了上面的两种思路。</p><h2 id="使用浏览器运行参数和配置进行伪装"><a href="#使用浏览器运行参数和配置进行伪装" class="headerlink" title="使用浏览器运行参数和配置进行伪装"></a>使用浏览器运行参数和配置进行伪装</h2><p>在浏览器的启动参数里添加 <code>--disable-blink-features=AutomationControlled</code>，然后在配置的 <code>excludeSwitches</code> 添加 <code>enable-automation</code>，就可以隐藏 <code>navigator.webdriver</code> 了。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriveroptions <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--disable-blink-features=AutomationControlled'</span><span class="token punctuation">)</span>options<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'excludeSwitches'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'enable-automation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>options<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'useAutomationExtension'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>options<span class="token operator">=</span>options<span class="token punctuation">)</span>driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://example.com"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这几个参数和配置在网上广泛流传，但是这是 Chrome 限定的方法，因为我不使用 Chrome 所以没有实际测试过。Firefox 是不吃这一套的。</p><p>使用 Firefox 的话，需要把配置里的 <code>dom.webdriver.enabled</code> 设为 <code>false</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverprofile <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>FirefoxProfile<span class="token punctuation">(</span><span class="token punctuation">)</span>profile<span class="token punctuation">.</span>set_preference<span class="token punctuation">(</span><span class="token string">'dom.webdriver.enabled'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Firefox<span class="token punctuation">(</span>firefox_profile<span class="token operator">=</span>profile<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>遗憾的是，从 Firefox 88 开始，这个配置项也被移除了。<code>navigator.webdriver</code> 的值，最终还是要按照 W3C 的基本法，选举法……去产生，所以 Firefox <a href="https://github.com/mozilla/geckodriver/issues/1680">不会加入直接影响这些属性的方法</a>（据说 Chrome 的那几个参数也被移除了）。</p><p>把 Firefox 的版本锁死在 87，并关闭自动更新，虽然可以解决问题，但是我们不能忘记某车务段拒绝将内部信息系统适配最新版本的操作系统而是死守旧版本结果闹出“人人都是高手”笑话的惨痛教训。我个人认为，<strong>在项目的初始阶段就重度依赖被废弃的功能并且为此固守旧版本，这是一种非常简单粗暴不负责任的解决方案</strong>。</p><h2 id="使用-Chrome-DevTools-Protocol-执行-JS-代码"><a href="#使用-Chrome-DevTools-Protocol-执行-JS-代码" class="headerlink" title="使用 Chrome DevTools Protocol 执行 JS 代码"></a>使用 Chrome DevTools Protocol 执行 JS 代码</h2><p>通过 Chrome DevTools Protocol 的命令就可以很容易地添加在打开网页前就会执行的 JS 代码了。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">driver<span class="token punctuation">.</span>execute_cdp_cmd<span class="token punctuation">(</span><span class="token string">'Page.addScriptToEvaluateOnNewDocument'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token string">'source'</span><span class="token punctuation">:</span> <span class="token string">'delete navigator.__proto__.webdriver'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>但是 Firefox 也不支持这种操作，毕竟这是 Chrome DevTools Protocol 而不是 Firefox DevTools Protocol……</p><p>那为什么不用 Chrome 呢？作为 Firefox 的忠实用户我怎么可能会这么做 ( ‘-‘ )ノ)&#96;-‘ )</p><p>实际上是因为我不想为了调试这个就特地装一个 Chrome。虽然用 Selenium 的人一般都是用 Chrome，Firefox 在这方面似乎有点小众……</p><h2 id="使用油猴脚本执行-JS"><a href="#使用油猴脚本执行-JS" class="headerlink" title="使用油猴脚本执行 JS"></a>使用油猴脚本执行 JS</h2><p>我们日常使用 Firefox、Chrome、Edge 这些现代浏览器的时候，一般都会安装许多实用的油猴脚本（如果你还没听说过油猴脚本的话，有必要进一步提高一下自己上网冲浪的水平）。油猴脚本本质上是一个 JS 文件，在打开特定网页时会自动运行，从而将自定义的功能加入到网页中。</p><p>默认情况下，油猴脚本会在 <code>DOMContentLoaded</code> 后运行，这个时候网页也已经加载完成了。通过在脚本前面的配置中添加 <code>@run-at document-start</code> 就可以使脚本在网页加载前运行，于是可以将上面的伪装用 JS 代码编写成一个简单的油猴脚本（这里还是使用修改 getter 的方法）：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ==UserScript==</span><span class="token comment">// @name         Hide navigator.webdriver</span><span class="token comment">// @match        *://*</span><span class="token comment">// @run-at       document-start</span><span class="token comment">// ==/UserScript==</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>navigator<span class="token punctuation">,</span> <span class="token string">'webdriver'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你日常使用的浏览器有安装运行油猴脚本的扩展的话，可以做一个小实验：添加上面的脚本，把 <code>undefined</code> 改为 <code>true</code>，再打开 <a href="https://bot.sannysoft.com/">https://bot.sannysoft.com/</a>，就可以发现 <code>navigator.webdriver</code> 被成功地“反向”伪装了。</p><p>Selenium 控制的 Firefox 浏览器是可以添加扩展的，我们可以预先下载好 Tampermonkey 或 Violentmonkey 这两个油猴脚本扩展之一的 XPI 文件，然后在启动浏览器时加载。但是，如何使用 Selenium 在扩展中自动添加上面的油猴脚本，我暂时还没有找到什么简单的方法。已知的方法是自己在本地做一份安装了油猴脚本扩展及伪装脚本的 profile，然后在 Selenium 启动浏览器时读取，不过部署的时候如果还要把整个 profile 复制来复制去还是会比较麻烦。</p><h1 id="简单优雅的解决方案：使用浏览器扩展在-Firefox-中完成伪装"><a href="#简单优雅的解决方案：使用浏览器扩展在-Firefox-中完成伪装" class="headerlink" title="简单优雅的解决方案：使用浏览器扩展在 Firefox 中完成伪装"></a>简单优雅的解决方案：使用浏览器扩展在 Firefox 中完成伪装</h1><p>虽然使用油猴脚本的方式比较麻烦，但它还是给我提供了一种思路。既然可以为浏览器添加扩展，我们可以自己编写一个简单的浏览器扩展来实现 <code>navigator.webdriver</code> 的伪装。之所以说这个方法简单优雅，是因为浏览器扩展是一个不会被轻易废弃的功能，而且我们实际上并不需要额外做很多复杂的工作。</p><p>Firefox 的扩展使用 XPI 的扩展名，本质上是一个 ZIP 格式的压缩包，方便起见也可以跳过这一步而是直接让浏览器从文件夹中加载扩展。不过开发 XPI 扩展的中文资料似乎不是很多，我直接简单参考了 MDN 上的<a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions">浏览器扩展入门</a>的<a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">“你的第一个扩展”</a>章节，这里的知识对于快速了解基本概念来说已经足够了。</p><p>我们的浏览器扩展只需要包含记录扩展元数据的 <code>manifest.json</code> 和运行伪装代码的 <code>main.js</code> 而已。对于前者，只需要写上基本的信息就可以了：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"manifest_version"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// 扩展的名称，在这里可以随意填写</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"webdriver-cleaner"</span><span class="token punctuation">,</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span>    <span class="token comment">// 由于我们需要在网页的运行环境下进行修改，因此需要使用内容脚本</span>    <span class="token property">"content_scripts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token comment">// 使脚本在网页加载前运行</span>            <span class="token property">"run_at"</span><span class="token operator">:</span> <span class="token string">"document_start"</span><span class="token punctuation">,</span>            <span class="token comment">// 这个脚本会在打开所有网页时执行</span>            <span class="token comment">// 也可以设定成&lt;all_urls></span>            <span class="token property">"matches"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"*://*/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment">// 需要执行的JS文件，如果有多个则会按顺序执行</span>            <span class="token property">"js"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"main.js"</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于安全性上的考虑，扩展的运行环境和网页的运行环境是隔离的，不能直接互相修改和通信，具体可以参考<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Sharing_objects_with_page_scripts">MDN 上的这篇教程</a>，不过我暂时还没完全看懂……正好有个经常使用的扩展“User-Agent Switcher”实现的是对 <code>navigator.userAgent</code> 的修改，我参考了它的<a href="https://gitlab.com/ntninja/user-agent-switcher/-/blob/master/content/override-navigator-data.js">修改部分的源代码</a>写出了 <code>main.js</code> 的代码。核心部分还是只有那一行，由于环境隔离所以稍有修改：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">delete</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>wrappedJSObject<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>webdriver<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'navigator.webdriver cleaned:'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>wrappedJSObject<span class="token punctuation">.</span>webdriver<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在使用浏览器打开页面前，不要忘记加载这个扩展。正式发布的扩展需要进行签名，由于现在略过了这一步，所以扩展只能以临时的方式加载。加载的路径可以是扩展所在的文件夹或打包后的 XPI 文件的绝对路径，为了方便修改我就跳过打包过程了。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">driver<span class="token punctuation">.</span>install_addon<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span><span class="token string">'webdriver-cleaner'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> temporary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1286*1006),1006px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/abbcbc9392be5c95fdce1c83881cc1ce/qqW9HvhO.webp" data-src="https://p.sda1.dev/12/f6f54f768ca25c7eb54c9fd2c85fbb8f/hFAqOO0a.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAZACADASIAAhEBAxEB/8QAGQAAAwEBAQAAAAAAAAAAAAAAAwQFAQYH/8QAKBAAAgEDAwIFBQAAAAAAAAAAAQIRAAMEEiExBSITFSQycUFRgbHB/8QAFwEBAQEBAAAAAAAAAAAAAAAAAQIAA//EACMRAQACAQMCBwAAAAAAAAAAAAEAAhEDEhORwSExQUJRUnH/2gAMAwEAAhEDEQA/APavUOkSunmQsR8w9IjNw0vd15ikwVCvqH5LU9bYogUIu0TL/wAqL5Plgsy5S7mfatcNe2uFeGtHzzll0Bzm5X9z2J0eIen5hYWje2EmWIps4lpLbkTx9TP7qN02zk4D3S58XWABtpiPiq9zNJRgbcAg8mr0m7Q5AL+oQt4KbsnyZ7yethyeNoAoosMPtTA4radr93oR3sFoO3atBurAfUIEc7U3WHg1iqe56EGyz//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/f6f54f768ca25c7eb54c9fd2c85fbb8f/hFAqOO0a.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>伪装并没有被发现……好耶！通过测试啦！(〃′▽&#96;)</p><p><del>或许还可以换一个营销号浓度极高的标题：《爬虫必备！只需要一行代码，我再也不用害怕 Selenium Firefox 被发现啦！》</del></p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/96029592">Pixiv ID: 96029592 「リゼシャロ冬のデート」 by stick_jitb</a></p></blockquote>]]></content>
    
    
    <summary type="html">又名：《爬虫必备！只需要一行代码，我再也不用害怕 Selenium Firefox 被发现啦！》（大雾）</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>图片渐进式加载的实现方法</title>
    <link href="https://akarin.dev/2021/11/04/progressive-image-loading/"/>
    <id>https://akarin.dev/2021/11/04/progressive-image-loading/</id>
    <published>2021-11-04T14:48:47.000Z</published>
    <updated>2021-11-04T14:48:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>其实这是之前自己写现在使用的这个 Hexo 主题的时候就想记下来的东西，不过一直咕到今天才写 …_φ(･ω･&#96; )</p><p>在我写主题的过程中，为了节省流量而大量地对图片使用了懒加载。而各位应该很容易就可以发现，对于文章的封面图还有个额外的“从模糊变清晰”的加载效果。</p><video poster="https://p.sda1.dev/12/e1bf7ea924102d38b4c7c21c69f0bcac/6KjPgCbt.jpg" controls>    <source src="https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/telIFazl.mp4" type="video/mp4; codecs=av01.0.05M.10">    <source src="https://s3plus.meituan.net/v1/mss_550586ef375b493da4aa79bebdfce4fa/csc-apply-file-web/prod/2021-11-03/8042b498-dca0-4752-bcc4-3b405280fdf1null" type="video/mp4; codecs=avc1.640032"></video><p>这类加载方式一般被称为渐进式加载（Progressive Loading），对于图片来说，也就是在加载的过程中先展示一部分模糊的图片，等加载完成了再展示完整的原始图片。虽然渐进式加载不能从根本上提高图片的加载速度，但是因为用户<strong>看到图片的时间提前了</strong>（虽然还不是完整图片），因此可以给用户一种“看上去加载得比较快”的错觉，而不是对着未加载时图片位置的一片空白干等，可以提升使用体验。</p><h1 id="图片格式中的渐进解码功能"><a href="#图片格式中的渐进解码功能" class="headerlink" title="图片格式中的渐进解码功能"></a>图片格式中的渐进解码功能</h1><p>现在常用的一些图片格式中都加入了渐进式解码的功能，可以在只加载了图片的部分数据的情况下显示出模糊的图像。由于是解码器直接提供支持，因此展示图片时并不需要额外的配置，只需要在保存图片时注意设置“渐进&#x2F;连续（Progressive）”或者“交错（Interlace）”之类的选项就可以了。</p><p>下面就是模拟较慢的网速下加载以相同质量压缩的非渐进式和渐进式 JPEG 图片的效果，非渐进式是像扫描仪一样从上往下逐渐显示，而渐进式就先显示了大致的轮廓，在加载过程中再逐渐变清晰，“扫描”完第二遍时就已经是可以接受的图片质量了。</p><video poster="https://p.sda1.dev/12/e554dec8a70e0b826071005fc5ee720a/waCL5uzU.jpg" controls>    <source src="https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/Qs1GK6PY.mp4" type="video/mp4; codecs=av01.0.05M.10">    <source src="https://s3plus.meituan.net/v1/mss_550586ef375b493da4aa79bebdfce4fa/csc-apply-file-web/prod/2021-11-03/8bb22ec9-43ab-4bc2-8f83-afa8bc6dd809null" type="video/mp4; codecs=avc1.640032"></video><p>如果使用 <a href="https://github.com/mozilla/mozjpeg">mozjpeg</a> 压图的话，默认就已经启用了参数 <code>-progressive</code> 启用渐进式解码，但是默认的解码方式是按顺序解码 Y、U、V 三个通道（即使用 <code>-dc-scan-opt 1</code>），效果是图片会先以黑白形式显示，再逐渐填充错误的颜色，最后变成正常的颜色，这样看上去的效果不太好，因此可以通过使用 <code>-dc-scan-opt 0</code> 改为同时加载三个通道，就可以达到上面的效果。还可以无损地将已有的非渐进式 JPEG 图片（也被称为 Baseline JPEG）转换为渐进式，文件大小稍微会小一点。</p><p>另外两个经典的图片格式 GIF 和 PNG 也支持渐进式解码，但是对这两个格式启用渐进式解码反而会使文件大小增加，实际使用也似乎不是很多。</p><p>那现代图片格式 WebP 和 AVIF 呢？遗憾的是，它们都不支持渐进式解码 ╮(╯_╰)╭</p><p>Google 已经在 WebP 的文档中表示<a href="https://developers.google.com/speed/webp/faq#does_webp_support_progressive_or_interlaced_display">不支持渐进式解码的功能</a>了。而 AVIF 最初也不支持渐进式解码，后来有人在 GitHub 上提出了相关的 <a href="https://github.com/AOMediaCodec/av1-avif/issues/102">Issue</a>，但是似乎是由于对编码格式的修改过于复杂而无法实装，作为替代有人提出了另一个 <a href="https://github.com/AOMediaCodec/libavif/issues/605">Issue</a>，通过在 AVIF 中内置缩略图来实现类似的效果，不过也没有什么进展……所以大约的确也是不行的。</p><h1 id="懒加载和“从模糊变清晰”的加载效果"><a href="#懒加载和“从模糊变清晰”的加载效果" class="headerlink" title="懒加载和“从模糊变清晰”的加载效果"></a>懒加载和“从模糊变清晰”的加载效果</h1><p>在和图片相关的优化中，懒加载其实是更有必要做的优化。毕竟渐进式的图片加载只能做到视觉上的优化，但是懒加载可是实打实地减少了 HTTP 请求数量和流量消耗。一般的懒加载是在未加载的图片的位置上放一个固定的占位图，等需要加载图片的时候再用原图替换掉，类似的还有“省流模式”，只是将加载图片的时机从出现在屏幕上变成了用户手动点击图片。总之，如果把这张占位图改成图片的缩略图之类的话，就是上面提到的“从模糊变清晰”的渐进式加载效果了。</p><p>这个缩略图有哪些要求呢？</p><ul><li>缩略图应该立即显示在页面上，如果进行了额外的加载，那么加载之前图片仍然是一片空白。</li><li>缩略图还应该尽可能地小。</li><li>如果从缩略图直接切换到原图就太生硬了，应该有个渐变的效果，可以通过将缩略图的不透明度逐渐变成 0 来实现，于是这个缩略图应该作为单独的一层覆盖到原图上。</li></ul><p>因此这个缩略图应该以 Data URL 的形式直接嵌入到页面中，并且使用几十像素的尺寸就足够了。下面就是将一个 32x18 的缩略图（大小只有 434 B）覆盖在 1280x720 的原图上的演示，点击下面的按钮可以模拟图片被加载时显示的图片从缩略图平滑过渡到原图的效果：</p><div style="position:relative">    <img id="example-0-blurred" style="position:absolute;width:100%;max-height:none;transition:opacity 1s" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQIAJQAlAAD/2wCEABcXFxcYFxocHBokJiImJDUwLCwwNVA5PTk9OVB5S1hLS1hLeWuBaWJpgWvAl4WFl8DeurC63v/w8P////////8BFxcXFxgXGhwcGiQmIiYkNTAsLDA1UDk9OT05UHlLWEtLWEt5a4FpYmmBa8CXhYWXwN66sLre//Dw///////////AABEIABIAIAMBIQACEQEDEQH/xABrAAADAQAAAAAAAAAAAAAAAAACBAUAEAACAgEEAQUAAAAAAAAAAAABAgMRAAQSITETBRRBcrEBAQEBAQAAAAAAAAAAAAAAAAQCAwERAAEDBAIDAQAAAAAAAAAAAAEAAgMEESExMoEiQUJx/9oADAMBAAIRAxEAPwCvBIXBLU1DvGoZt70XU4Gm0kSN5W9IxML6odXi04YG405+WrLqm+GAoi5ZK0KyXRPGHUEcm5dqspFnOUusqnnNh2lJi0DJ5WBDbrUnEV9QRqQIxA7JxczDLEAwjKyjcGvub4Vx+IzkrWk+z1WCpeXS0+VJ1TFoNEWJJ8bfuBB0fsMfHo/jlkdr/9k">    <img id="example-0-source" style="width:100%;max-height:none;visibility:hidden" data-src="https://p.sda1.dev/12/bece1d43a7d093583129fdc7202ca924/Fhdt09T7.jpg" data-src-webp="https://p.sda1.dev/12/04d499bac3b61e1596f370c51686c18a/d1iL6gt0.webp" data-src-avif="https://p.sda1.dev/12/3a708bab4022d35fa52f12344a6dabfb/m3nkyCIM.jpg"></div><button id="example-0-load">加载图片</button><button id="example-0-unload">恢复初始状态</button><button id="example-0-blur">切换缩略图模糊</button><!--<script>(() => {const getElementById = e => document.getElementById(e);const prefix = 'example-0-';const blurred = getElementById(prefix+'blurred');const source = getElementById(prefix+'source');const load = getElementById(prefix+'load');const unload = getElementById(prefix+'unload');const blur = getElementById(prefix+'blur');load.onclick = () => {    blurred.style.opacity = 0;    source.style.visibility = '';};unload.onclick = () => {    blurred.style.opacity = 1;    source.style.visibility = 'hidden';};blur.onclick = () => (blurred.style.filter = blurred.style.filter ? '' : 'blur(10px)');})()</script>--><script>(()=>{const e=e=>document.getElementById(e),l="example-0-",t=e(l+"blurred"),i=e(l+"source"),c=e(l+"load"),o=e(l+"unload"),s=e(l+"blur");c.onclick=()=>{t.style.opacity=0,i.style.visibility=""},o.onclick=()=>{t.style.opacity=1,i.style.visibility="hidden"},s.onclick=()=>t.style.filter=t.style.filter?"":"blur(10px)"})()</script><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">position</span><span class="token punctuation">:</span>relative</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 缩略图，显示的尺寸和位置都要设定为和原图一致 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>        <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">position</span><span class="token punctuation">:</span>absolute<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">transition</span><span class="token punctuation">:</span>opacity 1s</span><span class="token punctuation">"</span></span></span>        <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:image/jpeg;base64,...<span class="token punctuation">"</span></span>    <span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 原图 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>        <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100%</span><span class="token punctuation">"</span></span></span>        <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://...<span class="token punctuation">"</span></span>    <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于浏览器缩放显示图片时默认使用的是双线性插值（除此之外只能通过修改 <code>image-rendering: pixelated</code> 设置为邻近取样，没有更好的缩放算法了），在将缩略图放大数倍时会出现明显的菱形和十字图形，比较难看。在缩略图上通过 <code>filter: blur(10px)</code> 添加模糊一定程度上可以掩盖这个问题，上面的演示中也可以通过自由切换来比较使用与不使用模糊的视觉效果区别。</p><p>但是，使用 CSS 的模糊滤镜又带来了别的问题。在演示中可以注意到，将缩略图模糊时缩略图的边缘也一起被模糊了，导致的后果就是点击“加载图片”时在边缘位置仍然是没有任何过渡地直接显示了图片，非常生硬。</p><p>如何解决呢？我首先找到了<a href="https://css-tricks.com/the-blur-up-technique-for-loading-background-images/">一篇来自 CSS-Tricks 的文章</a>，同样介绍了如何实现“从模糊变清晰”的渐进式加载效果，但是它使用了另一种不同的方法实现缩略图的模糊显示：不在 CSS 的 <code>filter</code> 中使用自带的 <code>blur</code> 模糊滤镜，而是以 SVG 滤镜的形式将模糊和修改透明度结合到一起。这个结合后的 SVG 滤镜是：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feGaussianBlur</span> <span class="token attr-name">stdDeviation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feComponentTransfer</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feFuncA</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>discrete<span class="token punctuation">"</span></span> <span class="token attr-name">tableValues</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1 1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>feComponentTransfer</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>&lt;feGaussianBlur&gt;</code> 和 CSS 自带的 <code>blur</code> 一样，表示对图片进行指定半径的模糊处理。而 <code>&lt;feComponentTransfer&gt;</code> 则是对图片的每个像素的 RGBA 通道颜色值进行映射（就像 Photoshop 里的“曲线”一样），这里的设定是将 A 通道固定为 1（范围为 0-1），也就是使整个图像变得不透明。</p><p>给这个 SVG 滤镜任意添加一个 ID（可以短到只有一个字符），然后压缩，编码成使用 URL 编码的 Data URL，再像 HTML 中使用 <code>#</code> 指向有某个 ID 的元素一样引用这个滤镜，写入到 CSS 的 <code>filter</code> 中，就可以得到下面的 CSS 代码：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token property">filter</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='$'%3E%3CfeGaussianBlur stdDeviation='9'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3C/svg%3E#$"</span><span class="token punctuation">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这是目前这个主题正在对文章封面图的使用模糊方法。看上去似乎也没什么问题，但是在写这篇的时候我尝试对上面的演示中的缩略图使用，结果在图片边框出现了严重的色彩溢出现象，溢出的部分甚至还超出了图片的显示区域……</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/789*604),604px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/26eaa299c82c974e2119b6b10ef10484/mnHAu5nI.jpg" data-src-webp="https://p.sda1.dev/12/61d1a0b825f4bdae396a19d4fe77150a/fJE3y2jU.webp" data-src="https://p.sda1.dev/12/e5726043a2abe026a37a8f6aac99aaef/ShAtGwVG.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAMBBAIFBv/EACcQAAIBBAECBQUAAAAAAAAAAAECBAADBRESEyIGFCExkRVBUmGh/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgME/8QAHREAAgMAAwEBAAAAAAAAAAAAAQIAAxEEEkEhE//aAAwDAQACEQMRAD8A72dIzbzZRtCCVF51ALPvip0N/ulc8+p2I+Mu7X1DvdGqsFAs2XtveRdPy5pydVLmyo4n71Lid7QGZydG+SN9hR3C5gJAiUv+IG5dSJi17fzvtTMfPznnoy3IeORWvIrFWulirN665UCTpjok1nH4XMhDPuevbP8AafNR6k7o5GefIePc1lgVgPplSTPVJksfTMoSt+4NpBvup03uGVSCDVCRmJYt3XtYbMO4HaggXxv5WiijShpzq7YPDkq1aMSSNJM00/L5V+j0fDWaO7ffqDdHE1OJk5JsjjQ+DzFrcyxye7FuIigONlmoorT+zlSpwjPYBRWrBgCDP//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/e5726043a2abe026a37a8f6aac99aaef/ShAtGwVG.jpg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>那为什么 CSS-Tricks 那边的使用以及对这个主题的封面图使用就没有问题呢？因为那两个情况下的图片都是通过 <code>background-image</code> 显示的，但是这里使用的是 <code>&lt;img&gt;</code>，稍微有点区别。至于为什么在 <code>&lt;img&gt;</code> 中使用就会在显示区域之外出现色彩溢出的部分，我也无法解释…… (;-_-)</p><p>后来我又找到了一个 <a href="https://stackoverflow.com/questions/20443283#answer-48095387">Stack Overflow 上的回答</a>，给出了另一个 SVG 模糊滤镜：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feGaussianBlur</span> <span class="token attr-name">stdDeviation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feColorMatrix</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>matrix<span class="token punctuation">"</span></span> <span class="token attr-name">values</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1 0 0 0 0, 0 1 0 0 0, 0 0 1 0 0, 0 0 0 9 0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feComposite</span> <span class="token attr-name">in2</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SourceGraphic<span class="token punctuation">"</span></span> <span class="token attr-name">operator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>in<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>&lt;feColorMatrix&gt;</code> 是使用变换矩阵处理每个像素的 RGBA 通道颜色值，上面的滤镜中的矩阵相当于将 A 通道的颜色值乘上 9，其他通道不变，对于被模糊（实际上是半透明）的边缘位置来说基本上就和设成 1 差不多了，并且这种实现方法不会在显示区域之外再出现什么奇怪的东西。对应的 CSS 代码：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token property">filter</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='$'%3E%3CfeGaussianBlur stdDeviation='10'/%3E%3CfeColorMatrix type='matrix' values='1 0 0 0 0,0 1 0 0 0,0 0 1 0 0,0 0 0 9 0'/%3E%3CfeComposite in2='SourceGraphic' operator='in'/%3E%3C/filter%3E%3C/svg%3E#$"</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>用这个滤镜替代最初的演示中使用的 CSS 自带的模糊滤镜：</p><div style="position:relative">    <img id="example-1-blurred" style="position:absolute;width:100%;max-height:none;transition:opacity 1s;filter:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22$%22%3E%3CfeGaussianBlur stdDeviation=%2210%22/%3E%3CfeColorMatrix type=%22matrix%22 values=%221 0 0 0 0,0 1 0 0 0,0 0 1 0 0,0 0 0 9 0%22/%3E%3CfeComposite in2=%22SourceGraphic%22 operator=%22in%22/%3E%3C/filter%3E%3C/svg%3E#$')" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQIAJQAlAAD/2wCEABcXFxcYFxocHBokJiImJDUwLCwwNVA5PTk9OVB5S1hLS1hLeWuBaWJpgWvAl4WFl8DeurC63v/w8P////////8BFxcXFxgXGhwcGiQmIiYkNTAsLDA1UDk9OT05UHlLWEtLWEt5a4FpYmmBa8CXhYWXwN66sLre//Dw///////////AABEIABIAIAMBIQACEQEDEQH/xABrAAADAQAAAAAAAAAAAAAAAAACBAUAEAACAgEEAQUAAAAAAAAAAAABAgMRAAQSITETBRRBcrEBAQEBAQAAAAAAAAAAAAAAAAQCAwERAAEDBAIDAQAAAAAAAAAAAAEAAgMEESExMoEiQUJx/9oADAMBAAIRAxEAPwCvBIXBLU1DvGoZt70XU4Gm0kSN5W9IxML6odXi04YG405+WrLqm+GAoi5ZK0KyXRPGHUEcm5dqspFnOUusqnnNh2lJi0DJ5WBDbrUnEV9QRqQIxA7JxczDLEAwjKyjcGvub4Vx+IzkrWk+z1WCpeXS0+VJ1TFoNEWJJ8bfuBB0fsMfHo/jlkdr/9k">    <img id="example-1-source" style="width:100%;max-height:none;visibility:hidden" data-src="https://p.sda1.dev/12/bece1d43a7d093583129fdc7202ca924/Fhdt09T7.jpg" data-src-webp="https://p.sda1.dev/12/04d499bac3b61e1596f370c51686c18a/d1iL6gt0.webp" data-src-avif="https://p.sda1.dev/12/3a708bab4022d35fa52f12344a6dabfb/m3nkyCIM.jpg"></div><button id="example-1-load">加载图片</button><button id="example-1-unload">恢复初始状态</button><!--<script>(() => {const getElementById = e => document.getElementById(e);const prefix = 'example-1-';const blurred = getElementById(prefix+'blurred');const source = getElementById(prefix+'source');const load = getElementById(prefix+'load');const unload = getElementById(prefix+'unload');load.onclick = () => {    blurred.style.opacity = 0;    source.style.visibility = '';};unload.onclick = () => {    blurred.style.opacity = 1;    source.style.visibility = 'hidden';};})()</script>--><script>(()=>{const e=e=>document.getElementById(e),l="example-1-",t=e(l+"blurred"),i=e(l+"source"),c=e(l+"load"),o=e(l+"unload");c.onclick=()=>{t.style.opacity=0,i.style.visibility=""},o.onclick=()=>{t.style.opacity=1,i.style.visibility="hidden"}})()</script><p>这样的效果就很完美了！( つ•̀ω•́)つ</p><h1 id="除了小尺寸的-JPEG，还能用什么作为缩略图？"><a href="#除了小尺寸的-JPEG，还能用什么作为缩略图？" class="headerlink" title="除了小尺寸的 JPEG，还能用什么作为缩略图？"></a>除了小尺寸的 JPEG，还能用什么作为缩略图？</h1><p>CSS-Tricks 的文章还提到了 Facebook 技术团队的<a href="https://engineering.fb.com/2015/08/06/android/the-technology-behind-preview-photos/">另一篇文章</a>，介绍他们是如何在自家的 APP 中实现图片渐进式加载，使用的方法仍然是先立即显示模糊的缩略图再展示完整图片，但是他们的目标是<strong>将缩略图的大小压到 200 B 左右</strong>。为此他们使用了相同的质量和Huffman 表等参数进行压图，这样得到的图片就有了固定的标头，只要传输剩下的部分，在客户端再和固定的标头拼接起来，就可以得到使用的缩略图了。</p><blockquote><p>So the final format became one byte for version number, one byte each for width and height, and finally the approximately 200 byte payload. The server would just send this format as part of the GraphQL response, and then the client could simply append the JPEG body to the predefined JPEG header, patch the width and height, and treat it as a regular JPEG image.</p><p>After the standard JPEG decoding, the client could run the predetermined Gaussian blur and scale it to fit the window size.</p><p>最终的数据格式先是各占 1 B 的版本号和图片的宽度和高度，剩下的部分就是 200 B 左右的负载。服务端只需要从 GraphQL 响应中返回这些数据，客户端简单地将负载拼接到预定义的 JPEG 头部后面，再填上宽度和高度，就可以当成一般的 JPEG 图片使用了。</p><p>在进行 JPEG 图片解码后，客户端就可以对图片添加高斯模糊并把它缩放到需要的大小。</p></blockquote>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1342*413),413px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/95175c3768eef6ed81c6bdbb2de6bbf0/OB1G85E0.jpg" data-src-webp="https://p.sda1.dev/12/87f7ba58cab07ece16be1c6b87fac673/SdxZk5k0.webp" data-src="https://p.sda1.dev/12/078404d8ab2b2cc14f0bf4fc4ddcb2c5/PCPEkNLq.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAKACADASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAQUHBv/EACEQAAICAgIBBQAAAAAAAAAAAAECAwQABRESBhMhI0FR/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAWEQEBAQAAAAAAAAAAAAAAAAABEQD/2gAMAwEAAhEDEQA/AHVrzrY0ppkXUBk9RwvzkkkNlB8U3F/Y6OC/LXRO0swdOSWHDELmjkA7J7feHLVaukDKtzftxai7ZWsGCRoVjDEOW7AEcgZNh5tuDPBAdOwLSohfuzAAtlewCONTyEUH9AxXIb//2Q"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/078404d8ab2b2cc14f0bf4fc4ddcb2c5/PCPEkNLq.jpg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>自己实现图片渐进式加载的时候当然不一定要做如此极端的优化，制作缩略图时，用任意一个软件把图片的宽度和高度压到 40px 左右，控制压缩 JPEG 的质量使大小在 2 KB 以内其实就可以了。</p><p>但是用更少的数据来表示缩略图确实是可行的，这里就需要介绍 <a href="https://blurha.sh/">BlurHash</a> 这个工具了。BlurHash 的算法主要是对原图进行了离散余弦变换，提取出最多 10x10&#x3D;100 个系数，以 0-18 的范围（也就是大约 4.25 bit 的精度，不过对于缩略图已经够用了）表示颜色，按照一些紧凑的规则编码成二进制数据，再使用特别选择的字母表进行 Base83 编码，保证在 URL 和 JSON 等地方不需要额外转义就可以直接传输。详细的编码规则可以参见<a href="https://github.com/woltapp/blurhash/blob/master/Algorithm.md">这里</a>。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1896*855),855px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/93188b3f9a2694ff63c0c58246682786/HMRXqvGF.jpg" data-src-webp="https://p.sda1.dev/12/3468ba7ce4c33ec2db79f2eac2daa47a/r057l1uX.webp" data-src="https://p.sda1.dev/12/3c58250178d463ef7b34d40ba3c32b6e/4OGhJAtT.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAOACADASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAQUEBgf/xAAfEAACAgIDAAMAAAAAAAAAAAABAgMEABEFEjEhIkH/xAAVAQEBAAAAAAAAAAAAAAAAAAACAf/EAB0RAAICAgMBAAAAAAAAAAAAAAECERIAAyEikSP/2gAMAwEAAhEDEQA/ANascxbpVy05aQgAlVUlvdH4GM+NsyWKMM5DlpASRJtG9OtjDf4dLF+GyL1qLr13FG4EbdTv7DR9xgyBho+YU0rqTT9WdghDTI9xM9i3UAE5GsvKIHZV06ka6sW/cS2+WsxdFAkJLAbVCcsaoFGhvWEIASdnC2uzlrECsQCfcoaABUHmc//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/3c58250178d463ef7b34d40ba3c32b6e/4OGhJAtT.jpg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>在系数数量为 6x4 的情况下从上面的缩略图得到的 BlurHash 只有 52 B。即使将 10x10 个系数用满，由此得到的最长的 BlurHash 也只有 166 B，这个数据量比 Facebook 的极端优化还要小。</p><p>需要展示缩略图的时候，只要使用解码库就可以直接将 BlurHash 解码成任意尺寸的位图。系数越少得到的图片就越模糊（或者说是平滑？），但是就算是 10x10 也比前面使用的添加了高斯模糊的低分辨率 JPEG 还要模糊。也许有人会因为想要在模糊的缩略图中多展示一些图片细节而仍然选择低分辨率 JPEG，不过这就是个人喜好不同了 (´▽｀)ノ♪</p><blockquote><p>2023-04-30 更新：</p><p>以在前端开发领域目前被广泛使用的、跑得最快的 JS 打包器 esbuild 为代表作的 evanw 最近推出了 <a href="https://evanw.github.io/thumbhash/">ThumbHash</a>，原理和使用方式与 BlurHash 非常类似。根据官网上的对比，在相同数据量的情况下从 ThumbHash 解码的图像比 BlurHash 有更多的细节，颜色也更接近原图。</p><p>ThumbHash 不像 BlurHash 一样允许通过调节系数数量来控制数据量和解码图像的质量，不过如果本来就不想纠结这个的话其实并不算什么缺点。</p></blockquote><p>在搜索的过程中，我另外还发现了一个名为 <a href="https://github.com/fogleman/primitive">Primitive</a> 的比较有意思的工具，可以用数百个椭圆、矩形、三角形等简单的图形对图片进行拟合，还支持以 SVG 的矢量格式输出。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/720*450),450px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/beb4a4956ea45b440675fad7bf90e80b/otUfpNyO.jpg" data-src-webp="https://p.sda1.dev/12/f7433d8bc5c33095a2b969d755cb5dec/ObVzo1Qv.webp" data-src="https://p.sda1.dev/12/6c6cd5de13b8cd23dd2985c4d3ac7d36/gocRFLuN.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAUACADASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAQGBQH/xAAmEAABBAEDAwQDAAAAAAAAAAABAAIDBDEFERITIYEGIiNCMjNR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQMC/8QAIBEAAgIBAwUAAAAAAAAAAAAAAQIAAwQREzESMnGRkv/aAAwDAQACEQMRAD8Ai5fTVxmYnLLm0Www92FXT9Tt9e00W7D4mRtMT+O3Uccg8sLNt6jOeXynP3Ix43SmZe3dQPcu+Hjji8/Mh36dKDhLGnIDhVpv13QSCSxEJPqOiXb+eQWRLaY4N9zfxG5Ddu/klUTILMRtMPIkWoCjXdUxq5eskfsOFOzWpnZehCDxAk9USc92+Vzm7+oQsTU//9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/6c6cd5de13b8cd23dd2985c4d3ac7d36/gocRFLuN.jpg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>这个工具是用 Go 写的，不过遗憾的是我没有 Go 语言环境，因此就没办法亲自体验了，作者提供的预编译版也只有 macOS 版。这种图片也是可以当缩略图使用的，虽然压到 2 KB 以内大概是做不到了……不过这种画风本身还是挺有趣的 (っ’ω’)っ</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/83265679">Pixiv ID: 83265679 「チノちゃんと遊園地デート」 by チノマロン</a></p></blockquote>]]></content>
    
    
    <summary type="html">其实这是之前自己写现在使用的这个主题的时候就想记下来的东西，不过一直咕到今天才写 …_φ(･ω･` )</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>RSA 算法的替代品：X25519/Ed25519 使用记录</title>
    <link href="https://akarin.dev/2021/09/16/a-taste-of-curve25519/"/>
    <id>https://akarin.dev/2021/09/16/a-taste-of-curve25519/</id>
    <published>2021-09-16T11:07:57.000Z</published>
    <updated>2021-09-16T11:07:57.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/89044985">Pixiv ID: 89044985 「赤座あかりちゃん」 by たんたんめん</a></p></blockquote><p>涉及密码学的课我没少上，而每个学期上这种课的时候都一定会把 RSA、MD5、DES、AES……这些经典算法，以及分组密码的<abbr title="一般是 ECB、CBC、CFB 和 OFB">四个经典的工作模式</abbr>之类的东西轮流过一遍，顺便稍微提一下还有一类比 RSA 更好的算法叫椭圆曲线。知道这些理论后，期末考个 80 分以上基本上就不是问题了。</p><p>但是，虽然理论上的东西讲了这么多，将这些理论用到实践的机会实在是少之又少。好不容易在某课程的期末大作业里看到一个“信息的安全传输”：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1433*589),589px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://p.sda1.dev/12/401fcc79f0e890de900e2ba5e815e0fa/a22K39rz.jpg" data-src-webp="https://p.sda1.dev/12/375a33cefeebbc23a2a21d4fa6141acc/tUl6PBeq.webp" data-src="https://p.sda1.dev/12/c1846d1aee557f3b544775adb34d5d3b/UqV-5yBP.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAANACADASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABgMCBP/EACMQAAICAQMDBQAAAAAAAAAAAAECAxEABAYxBRNRBxUhNJT/xAAVAQEBAAAAAAAAAAAAAAAAAAAAA//EABwRAAAHAQEAAAAAAAAAAAAAAAABAgQUU5EDQ//aAAwDAQACEQMRAD8AfzbM23o2SOWKViBd2vzfmzncmzdnFA5deBzImJddok1siuzAUtcXk4+l6bmS3ayby5uXB+qtEY/CtOAuNibNr7LfoXNL6f7SlNRTyM3gTA4x9l0NklWJPk5aHpmkhn76Ke5ZNk3ziU5uXoRuFScH/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/c1846d1aee557f3b544775adb34d5d3b/UqV-5yBP.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>用密码学手段解决文件的安全传输，有点意思。再看看后面的参考用流程图：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/610*612),612px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/386e15434fcec857acedb56043639cd7/xvrdW8Yj.webp" data-src="https://p.sda1.dev/12/9ffd40c9931b657d122fb294d6971afe/8jOvOUlX.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAMFBMVEVMaXFORjrS0KXHw5yyr4vBvpfV0qfV06ihnX7W06i5tpHFwpvm5LXZ16vDwJlPSz3bhvXRAAAAEHRSTlMAEP44Jltrg0akoMj6zfIqbghHXgAAAAlwSFlzAAAD6AAAA+gBtXtSawAAAZNJREFUeNotkT1IQlEUx8/V57NHFvdiBdkgXAoSHqLYINFg9DJoMuqBUymBRUUYUoItglRCS0QJGs2SLW1lYVC0FWQ0hktDoxg0NDR07333Dufjxz3n/DkHAMDmbzILGh0G6zmXA9w5MkEJtFZMgNaRlaP+aoR7JRuTQE2JyJ5Kilw96RVNyWD7SQCFQIF7DEj2RB6a4D+yuWzAItEFbonf305YYDoP49UqNk1TTAMHpXQ/XuyouYzsESqEPLVa3nN3I4HxYwysFiNKWEpXKdU7bKz2aOkAx0WtjBlAXiyFgAiw9jlKiMhXqjvMHlx+JYVYRM4bdeZn1m/n7WspBqDWQSYr6W5dOz8aHNjoWxwDnp3jCUwFwV4IRFMRrJ2V+iYB7l/5lM12Ag/VS8cjAOUtAHel0mElS2T31ADkJeh3e+8bYxf1aVQHm+5z6c0NPYHt4TFkGMBcVzHvLmC2QiKUIvL38kAw14/kHdhYvkJCFp+tlfU0+MmcV6C+y9tm0yBEwqFVo8jlgsOUx6ZpK5jQAf4BxONbMGs/I5MAAAAASUVORK5CYII"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/9ffd40c9931b657d122fb294d6971afe/8jOvOUlX.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>嗯……这个流程图用的都是相当经典的教科书式的操作：</p><ul><li>混合加密：使用非对称密码交换会话密钥，然后在后续的数据交换中使用会话密钥和对称密码</li><li>密钥交换：随机生成会话密钥后，用对方的公钥加密再发过去，对方用私钥解密</li><li>数字签名：对数据计算 hash 后用自己的私钥签名，对方用公钥验证</li></ul><p>如果一定要说有什么问题的话，DES 和 MD5 这两个算法已经很陈旧且不安全了，直接用 AES 和 SHA-256 之类的更现代的算法替代也不困难。但是在上面的流程中重度使用的 RSA 算法是否也可以使用更好的替代品呢？</p><p>还真的有，这就是标题里的基于 Curve25519 椭圆曲线的 X25519 密钥交换算法和 Ed25519 签名算法。</p><p>由于我姿势水平有限，所以以下的介绍可能会存在错误什么的，如果指出来的话我会修正的 (´ﾟωﾟ｀)</p><h1 id="教科书式-RSA-的问题"><a href="#教科书式-RSA-的问题" class="headerlink" title="教科书式 RSA 的问题"></a>教科书式 RSA 的问题</h1><p>众所周知，RSA 的安全性来自于“大素数分解”这一数学难题：将两个很大的素数相乘很容易，但是从相乘的积分解出这两个素数非常难，或者说在计算上是不可行的。具体的算法过程和数学证明就不再介绍，可以直接参见<a href="https://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html">这里</a>。</p><p>RSA 是非常经典的非对称密码算法，可以同时用于加密和签名，但是它最大的缺点就出在“大素数”上。如果刚刚提到的素数分解问题被解决，RSA 就没有任何安全性可言了，因此需要不断增大那两个素数的位数（一般也被叫做“密钥长度”），需要增加到什么程度呢？目前 Factordb 上已经有了 <a href="http://factordb.com/index.php?query=1230186684530117755130494958384962720772853569595334792197322452151726400507263657518745202199786469389956474942774063845925192557326303453731548268507917026122142913461670429214311602221240479274737794080665351419597459856902143413">768 位的数被分解的记录</a>，因此 1024 位也已经比较危险了，根据 <a href="https://www.keylength.com/en/4/">NIST 的建议</a> 2048 位的密钥可以用到 2030 年左右。</p><p>一味增加密钥长度带来的突出问题是 RSA 的执行速度被<strong>严重拖慢</strong>了，生成密钥、加密解密和签名的时间都会随着密钥长度的增加而出现指数级的延长。以生成不同长度的密钥对为例，在<a href="https://travistidwell.com/jsencrypt/demo/">这里</a>在线测试所消耗的时间如下：</p><ul><li>512 位：50-100 ms</li><li>1024 位：500-1500 ms</li><li>2048 位：8000-15000 ms</li><li>4096 位：100000 ms 以上</li></ul><p>生成一个安全的密钥要等十几秒，这合理吗？还好我们现在都知道应该使用混合加密了，RSA 在加密过程中只是用于一开始的密钥交换而已，而且只需要在服务端的加密系统初始化时生成一次密钥似乎就够了，慢一些也可以接受……？</p><p>遗憾的是，使用 RSA 的非对称特性进行密钥交换还存在另一个严重问题。假定有攻击者可以监听客户端和服务端双方通信的所有数据，于是他得到了公钥以及用公钥加密后的会话密钥，这些信息当然不足以让攻击者得到会话密钥从而解密后续的所有使用对称加密传输的信息。但是<strong>如果有一天服务端的私钥泄露了</strong>，攻击者就可以得到每次通信所使用的会话密钥，进而<strong>解密出所有先前监听到的通信内容</strong>。</p><p>即使不使用 RSA 而是使用另一个经典的密钥交换算法 Diffie-Hellman，只要<strong>有一方的密钥对固定不变</strong>，也会面临同样的问题。</p><p>解决办法也很简单：那就在密钥交换时让双方使用的密钥对<strong>每次都不一样</strong>好了。这样，即使某次通信时使用的私钥泄露，攻击者也只能解密这次通信的内容，而其他通信仍然是安全的。这种特性在密码学上被称为<strong>前向安全性（Perfect Forward Secrecy）</strong>（上课的时候完全没讲过这个……），顾名思义就是保护先前的通信的保密性不会受到来自未来的暴露的密钥的威胁。</p><p>Diffie-Hellman Ephemeral 就是 Diffie-Hellman 加上“每次交换时需要随机生成密钥对”这一要求后的改进算法，Ephemeral 的意思是“短暂的”。那 RSA 的密钥交换有没有对应的支持前向安全性的改进算法呢？</p><p>可以做，但是考虑上面提到的速度问题就很容易知道这样的改进对 RSA 来说并没有什么实用意义。回到上面的“文件的安全传输”流程图，你能接受<strong>每次传输文件前</strong>都要<strong>等待十几秒</strong>来生成密钥对吗？</p><p>所以和教科书里不同的是，直接使用 RSA 加密进行密钥交换实际上已经过时了。已有的 <a href="https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml">TLS 协议的密码套件</a>中，推荐的组合里 RSA 都只是用于身份验证（也就是签名，即使私钥泄露也不影响保密性），实际的密钥交换都是通过 DHE 或椭圆曲线的 ECDHE（注意多出来的这个 E，它表示的就是 Ephemeral）完成的。</p><p>顺便一提，和教科书里所述同样不同的是，现实中使用的 RSA 加密会对数据使用 <a href="https://zh.wikipedia.org/zh-hans/%E6%9C%80%E4%BC%98%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%A1%AB%E5%85%85">OAEP 方案</a>进行填充。由于填充过程引入了随机数，因此用同样的密钥多次加密相同的明文的结果也是不一样的。</p><h1 id="Curve25519-系列算法简单介绍"><a href="#Curve25519-系列算法简单介绍" class="headerlink" title="Curve25519 系列算法简单介绍"></a>Curve25519 系列算法简单介绍</h1><p>基于椭圆曲线的非对称密码解决了 RSA 密钥长度大，运行时间长的问题，256 位的椭圆曲线密钥可以等效于 3072 位的 RSA 密钥。目前常用的椭圆曲线密码系统是基于 NIST 系列标准的曲线（例如 P-256，又称 secp256r1 和 prime256v1）而设计的 ECDH 密钥交换算法和 ECDSA 签名算法。</p><p>虽然如此，NIST 标准曲线仍然存在一些问题。在设计密码算法时可能需要定义一些常数，这些常数应该以一种比较透明的方式选择，例如：</p><ul><li>MD5 算法中处理单个 512 字节输入消息分组的轮函数中用到了 64 个常数，由 <code>floor(abs(sin(i + 1)) * (2 ** 32))</code> 计算得到。</li><li>SHA1 算法的五个初始值是数字 <code>0</code> 到 <code>F</code> 在大端序下的顺序排列：<code>0x67452301</code>、<code>0xEFCDAB89</code>、<code>0x98BADCFE</code>、<code>0x10325476</code>、<code>0xC3D2E1F0</code>。</li><li>ChaCha20 算法使用字符串 <code>expand 32-byte k</code> 的 ASCII 码填充初始的状态矩阵。</li></ul><p>把 <code>sin</code> 换成 <code>tan</code> 之类的其他数学函数，或者修改那个字符串，对算法的安全性都不会有什么影响。常数的选择方式仅仅是为了证明在选择的过程中并没有什么特别的操作空间，无法用于预留后门之类的用途。用这类方式选择的常数被称为 <a href="https://en.wikipedia.org/wiki/Nothing-up-my-sleeve_number">Nothing-up-my-sleeve number</a>，这个称呼来自于魔术师变魔术前张开袖子以表示自己两手空空的做法。</p><p>有些密码算法的常数选择没有遵循这一规律，从而引起了怀疑和批评，例如 NSA 设计的 DES 算法的 S 盒就没有任何的依据（后来才有研究发现实际上是为了抵御差分密码分析），另一个更严重的例子是 NIST 推荐的伪随机数生成器 Dual_EC_DRBG 也使用了没有选择依据的常数，被斯诺登曝光出存在 NSA 设计的后门。在这些先例下，当 NIST 标准曲线的系数也出现了来历不明的一系列常数时，它的安全性也就值得怀疑了。</p><p>另一个问题是，ECDSA 签名算法中使用了随机数，这使得使用相同的密钥多次对相同的明文签名的结果也会不一样：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$private</span> <span class="token operator">=</span> <span class="token function">openssl_pkey_new</span><span class="token punctuation">(</span><span class="token punctuation">[</span>    <span class="token string single-quoted-string">'private_key_type'</span> <span class="token operator">=></span> <span class="token constant">OPENSSL_KEYTYPE_EC</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'curve_name'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'prime256v1'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$public</span> <span class="token operator">=</span> <span class="token function">openssl_pkey_get_details</span><span class="token punctuation">(</span><span class="token variable">$private</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$message</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">openssl_sign</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$sign</span><span class="token punctuation">,</span> <span class="token variable">$private</span><span class="token punctuation">,</span> <span class="token constant">OPENSSL_ALGO_SHA256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">openssl_verify</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$sign</span><span class="token punctuation">,</span> <span class="token variable">$public</span><span class="token punctuation">,</span> <span class="token constant">OPENSSL_ALGO_SHA256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// string(144) "3046022100a6fc5cda8b435e777a4a7342e4777930184816af02579c08f7d633f208571951022100ddd6c9647a5a9f2905c355ce9cd11e4b26d6b4e08afd6d853270b5c3958d5447"</span><span class="token comment">// int(1)</span><span class="token comment">// string(140) "304402207e25def883eb91e663aa8f09de1f373bf673cb8f989ed2459591e4e716200f5e02206118a1e1efe17fca6632fff3fbb1b605e162bc57023cb99b9bdfe12b19ac95b6"</span><span class="token comment">// int(1)</span><span class="token comment">// string(142) "3045022100d2effb78a5375dc1f1c1603121c312d7b56987bcd5f19a92d37ecc49438f4fad02207cf83ea53494f4a1cc77c04ba945c4c593cc306b9b68e4e63eb9fd4ebd9ee0e8"</span><span class="token comment">// int(1)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果签名时使用的随机数发生器存在缺陷，在两次签名中输出了相同的随机数，就存在使用签名恢复出私钥的可能（参见<a href="https://www.instructables.com/Understanding-how-ECDSA-protects-your-data/#step14">这篇文章</a>的介绍及它的<a href="https://zhuanlan.zhihu.com/p/97953640">译文</a>）。</p><p>由密码学家 Daniel J. Bernstein 在 2006 年独立设计的基于 Curve25519 曲线的 <a href="https://cr.yp.to/ecdh.html">X25519 密钥交换算法</a> 和 <a href="https://ed25519.cr.yp.to/">Ed25519 签名算法</a>正好避开了以上的 NIST 标准曲线存在的问题，安全性同样等效于 3072 位 RSA，还有以下的优点：</p><ul><li>速度快，当然椭圆曲线密码都能做到这个。</li><li>数据量小，公钥和私钥仅 32 字节，签名仅 64 字节，椭圆曲线密码也应该能做到这个。</li><li>算法的设计和参数选择是明确的，作者自己撰写了相关论文作为依据。</li><li>在算法中回避了分支操作，可以防止时序攻击（Timing Attack）。</li><li><strong>任何一个 32 字节的随机值都可以作为私钥</strong>，不需要另外选取或验证。</li><li>Ed25519 是确定性签名算法，不使用随机数，对于相同的私钥和明文可以得到相同的签名。</li></ul><p>Curve25519 系列算法在 2006 年提出，但直到“棱镜门”曝光出 NIST 标准算法可能存在后门之后才开始流行起来。目前 OpenSSH 就已经支持生成 Ed25519 密钥并用于公钥登录：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> ed25519<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2018 年推出的最新的 TLS 1.3 标准支持使用 X25519 和使用 NIST 标准曲线的 ECDHE 进行密钥交换（顺便把 RSA 密钥交换砍掉了），但是据我观察，浏览器似乎都首选使用 X25519。另外 Ed25519 也是 TLS 1.3 支持的签名算法之一。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/726*776),776px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/d804cb733ef52145a58c3d6d74eab59e13302.jpg" data-src-webp="https://p.sda1.dev/12/5ffd9fe8df48d6a422513e7d7e7bc4c3/JKo_TA5N.webp" data-src="https://p.sda1.dev/12/99ee4672e70570da15919344940deb94/Ob0cGO38.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgAB4DASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMCB//EACIQAAICAgEDBQAAAAAAAAAAAAECAxEABCESImEjMUFRcf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//EABwRAAICAgMAAAAAAAAAAAAAAAABAhESISIxMv/aAAwDAQACEQMRAD8A7g8cUGwqkWa45Iq8pGmuwHpv2sG4LNRxtI7TWO818B6HjjKxX0giF0+7dh7eDmjSxTCDXLJPvVFI9TXc8JIKbq7rHJxHqQx30LV5pCxHctH9vGRb2haVk9kHXkR4rBa7FErx4FZpdqYkA0o++gm8ntdLTRLCvqc2VAuv01m4xsoyMysV+brjz75brGIQ9SN4xjMxP//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/99ee4672e70570da15919344940deb94/Ob0cGO38.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <h1 id="在-libsodium-中使用-Curve25519-系列算法，以-PHP-的-Sodium-扩展为例"><a href="#在-libsodium-中使用-Curve25519-系列算法，以-PHP-的-Sodium-扩展为例" class="headerlink" title="在 libsodium 中使用 Curve25519 系列算法，以 PHP 的 Sodium 扩展为例"></a>在 libsodium 中使用 Curve25519 系列算法，以 PHP 的 Sodium 扩展为例</h1><p>Daniel J. Bernstein 给出了 X25519 和 Ed25519 的 C 语言实现，不过他还将这两个算法和 ChaCha20Poly1305、AES-256-GCM、HMAC-SHA-256 等比较现代的密码算法放在一起，做了个名为 <a href="https://nacl.cr.yp.to/">Networking and Cryptography library</a> 的开源加密库，简称 NaCl，读作 Salt。密码学中有“盐”的概念，食盐的主要成分也是 NaCl，我有点怀疑这个名字是为了玩梗而强行凑出来的……</p><p>NaCl 已经停止更新了，有人在 NaCl 的基础上开了名为 <a href="https://doc.libsodium.org/">libsodium</a> 的分支继续改进，这个分支的名字大概也是为了照应 NaCl 而取的……总之需要在代码里使用 X25519 和 Ed25519 的话，可以使用 libsodium 以及各种编程语言对它的 binding。</p><p>libsodium 的设计尽可能地隐藏了加密算法的实现细节，从它的函数名就可以看出来。例如包含了 X25519 密钥交换和 ChaCha20Poly1305 认证加密的相关函数统一称为 <code>crypto_box_*</code>，使用 BLAKE2b 进行 hash 的相关函数统一称为 <code>crypto_generichash_*</code>，都不涉及到具体的算法名称。</p><p>这里我还是选择 PHP 作为使用例。从 PHP 7.2 开始 Sodium 扩展已经随 PHP 本体一起附带了，在系统里安装了 libsodium 的条件下即可使用。如果是使用 C 语言编写的原版或其它 binding 的话，用到的函数名称应该是差不多的。</p><h2 id="X25519-的使用"><a href="#X25519-的使用" class="headerlink" title="X25519 的使用"></a>X25519 的使用</h2><p>从私钥生成公钥需要用到 <code>sodium_crypto_scalarmult_base</code>，使用自己的私钥和对方的公钥进行密钥交换需要用到 <code>sodium_crypto_scalarmult</code>。前面提过 Curve25519 系列算法可以使用任意的 32 字节作为私钥，所以可以从密码学安全的伪随机数生成器（CSPRNG）自行生成私钥。我这里作为演示就直接使用了 <a href="https://datatracker.ietf.org/doc/html/rfc7748.html#section-6.1">X25519 的标准测试向量</a>：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 实际使用时必须随机生成私钥：</span><span class="token comment">// $private = random_bytes(32);</span><span class="token variable">$privateA</span> <span class="token operator">=</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'77076d0a7318a57d3c16c17251b26645df4c2f87ebc0992ab177fba51db92c2a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$privateB</span> <span class="token operator">=</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'5dab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$publicA</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult_base</span><span class="token punctuation">(</span><span class="token variable">$privateA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$publicB</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult_base</span><span class="token punctuation">(</span><span class="token variable">$privateB</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$sharedA</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult</span><span class="token punctuation">(</span><span class="token variable">$privateA</span><span class="token punctuation">,</span> <span class="token variable">$publicB</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$sharedB</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult</span><span class="token punctuation">(</span><span class="token variable">$privateB</span><span class="token punctuation">,</span> <span class="token variable">$publicA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$sharedA</span> <span class="token operator">===</span> <span class="token variable">$sharedB</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token variable">$sharedA</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// string(64) "4a5d9d5ba4ce2de1728e3bf480350f25e07e21c947d19e3376f09b3c1e161742"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以使用 <code>sodium_crypto_box_keypair</code> 直接生成密钥对，得到一个 64 字节的字符串，前半和后半分别是私钥和公钥，可以用 <code>substr</code> 或 <code>sodium_crypto_box_secretkey</code> 和 <code>sodium_crypto_box_publickey</code> 提取。</p><p>虽然前面提过可以使用任意 32 字节作为私钥，实际使用时还会进行 clamp 处理。将整个 32 字节当成是小端序表示的 256 位整数，clamp 等效于将这个数的最低三位设成 <code>000</code>（强制设为 8 的倍数）以及将最高两位设成 <code>01</code>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">k<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">&amp;=</span> <span class="token number">248</span><span class="token punctuation">;</span> <span class="token comment">// 0b11111000;</span>k<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">// 0b01111111;</span>k<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">|=</span>  <span class="token number">64</span><span class="token punctuation">;</span> <span class="token comment">// 0b01000000;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这两个操作分别是为了避免小子群攻击和保证算法在常数时间内完成以避免时序攻击（稍微详细一些的解释在<a href="https://www.jcraige.com/an-explainer-on-ed25519-clamping">这里</a>）。不过实际使用的时候各种实现会自动进行 clamp，因此不需要手动操作：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 把$privateA[31]从0x2A 0b00101010改成0xAA 0b10101010（最高两位设成10）</span><span class="token variable">$privateA</span> <span class="token operator">=</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'77076d0a7318a57d3c16c17251b26645df4c2f87ebc0992ab177fba51db92caa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 把$privateB[0]从0x5D 0b01011101改成0x5F 0b01011111（最低两位设成111）</span><span class="token variable">$privateB</span> <span class="token operator">=</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'5fab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$publicA</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult_base</span><span class="token punctuation">(</span><span class="token variable">$privateA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$publicB</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult_base</span><span class="token punctuation">(</span><span class="token variable">$privateB</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$sharedA</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult</span><span class="token punctuation">(</span><span class="token variable">$privateA</span><span class="token punctuation">,</span> <span class="token variable">$publicB</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$sharedB</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult</span><span class="token punctuation">(</span><span class="token variable">$privateB</span><span class="token punctuation">,</span> <span class="token variable">$publicA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$sharedA</span> <span class="token operator">===</span> <span class="token variable">$sharedB</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token variable">$sharedA</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// string(64) "4a5d9d5ba4ce2de1728e3bf480350f25e07e21c947d19e3376f09b3c1e161742"</span><span class="token comment">// 密钥交换结果没有变化</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>X25519 输出了 32 字节的共享密钥，但是 libsodium 不建议将这 32 字节直接作为密钥使用，<a href="https://github.com/jedisct1/libsodium/blob/6d566070b48efd2fa099bbe9822914455150aba9/src/libsodium/include/sodium/crypto_scalarmult.h#L29">推荐的做法</a>是将它与双方的公钥一起进行 hash 处理。根据考证，TLS 中也有类似的做法：密钥交换得到的共享密钥被称为 Pre Master Secret，同样需要与双方的公钥 Client&#x2F;Server Random 一起输入密钥派生函数（TLS 1.2 及以前为 <abbr title="Pseudo Random Function">PRF</abbr>，TLS 1.3 改为 <abbr title="HMAC-based Extract-and-Expand Key Derivation Function">HKDF</abbr>），得到最终使用的会话密钥 Master Secret。</p><p>至于为什么还要进行一次密钥派生，根据 Stack Overflow 上的两个回答（<a href="https://stackoverflow.com/questions/25258799/#answer-25394747">这个</a>和<a href="https://crypto.stackexchange.com/questions/24780/#answer-24783">这个</a>），主要是出于以下的理由：</p><ul><li>可以将密钥交换和生成会话密钥的过程各自独立出来。</li><li>使通信双方都能对会话密钥的生成过程产生影响。</li><li>不同密钥交换算法产生的共享密钥长度可能不一样，也不一定和会话密钥固定要求的长度相同。</li><li>某些密钥交换算法产生的共享密钥存在随机分布不均的情况。</li></ul><p>对于最后一点，实际上 X25519 输出的共享密钥也存在这个问题。如果注意一下共享密钥中各位出现 0 或 1 的次数，就会发现密钥的最后一个字节的最高位固定为 0，其他位出现 0 和 1 的次数则基本相同：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$bits</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$privateA</span> <span class="token operator">=</span> <span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$privateB</span> <span class="token operator">=</span> <span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$publicA</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult_base</span><span class="token punctuation">(</span><span class="token variable">$privateA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$publicB</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult_base</span><span class="token punctuation">(</span><span class="token variable">$privateB</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$sharedA</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult</span><span class="token punctuation">(</span><span class="token variable">$privateA</span><span class="token punctuation">,</span> <span class="token variable">$publicB</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$sharedB</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_scalarmult</span><span class="token punctuation">(</span><span class="token variable">$privateB</span><span class="token punctuation">,</span> <span class="token variable">$publicA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$sharedA</span> <span class="token operator">===</span> <span class="token variable">$sharedB</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$byte</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$sharedA</span><span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$bits</span><span class="token punctuation">[</span><span class="token variable">$j</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$byte</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token variable">$j</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$bits</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// array(8) &#123;</span><span class="token comment">//   [0] => array(2) &#123; [0] => int(493) [1] => int(531) &#125;</span><span class="token comment">//   [1] => array(2) &#123; [0] => int(527) [1] => int(497) &#125;</span><span class="token comment">//   [2] => array(2) &#123; [0] => int(496) [1] => int(528) &#125;</span><span class="token comment">//   [3] => array(2) &#123; [0] => int(547) [1] => int(477) &#125;</span><span class="token comment">//   [4] => array(2) &#123; [0] => int(520) [1] => int(504) &#125;</span><span class="token comment">//   [5] => array(2) &#123; [0] => int(531) [1] => int(493) &#125;</span><span class="token comment">//   [6] => array(2) &#123; [0] => int(498) [1] => int(526) &#125;</span><span class="token comment">//   [7] => array(2) &#123; [0] => int(1024) [1] => int(0) &#125;</span><span class="token comment">// &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因此进行密钥派生是有必要的。</p><h2 id="Ed25519-的使用"><a href="#Ed25519-的使用" class="headerlink" title="Ed25519 的使用"></a>Ed25519 的使用</h2><p>Ed25519 签名的相关函数统一称为 <code>sodium_crypto_sign_*</code>，主要用到以下函数：</p><ul><li>直接生成密钥对：<code>sodium_crypto_sign_keypair</code></li><li>从私钥生成密钥对：<code>sodium_crypto_sign_seed_keypair</code></li><li>从密钥对中提取私钥和公钥：<code>sodium_crypto_sign_secretkey</code>、<code>sodium_crypto_sign_publickey</code></li><li>签名：<code>sodium_crypto_sign_detached</code></li><li>验证：<code>sodium_crypto_sign_verify_detached</code></li></ul><p>同样使用 <a href="https://datatracker.ietf.org/doc/html/rfc8032#section-7.1">Ed25519 的标准测试向量</a>作为演示：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$private</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_sign_seed_keypair</span><span class="token punctuation">(</span>    <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'833fe62409237b9d62ec77587520911e9a759cec1d19755b7da901b96dca3d42'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span>    <span class="token operator">.</span> <span class="token string single-quoted-string">'ddaf35a193617abacc417349ae204131'</span>    <span class="token operator">.</span> <span class="token string single-quoted-string">'12e6fa4e89a97ea20a9eeee64b55d39a'</span>    <span class="token operator">.</span> <span class="token string single-quoted-string">'2192992a274fc1a836ba3c23a3feebbd'</span>    <span class="token operator">.</span> <span class="token string single-quoted-string">'454d4423643ce80e2a9ac94fa54ca49f'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_sign_detached</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token function">sodium_crypto_sign_secretkey</span><span class="token punctuation">(</span><span class="token variable">$private</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$public</span> <span class="token operator">=</span> <span class="token function">sodium_crypto_sign_publickey</span><span class="token punctuation">(</span><span class="token variable">$private</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sodium_crypto_sign_verify_detached</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$public</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token variable">$public</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// string(64) "ec172b93ad5e563bf4932c70e1245034c35467ef2efd4d64ebf819683467e2bf"</span><span class="token comment">// string(128) "dc2a4459e7369633a52b1bf277839a00201009a3efbf3ecb69bea2186c26b58909351fc9ac90b3ecfdfbc7c66431e0303dca179c138ac17ad9bef1177331a704"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里的密钥对长度为 96 字节，前 64 字节为私钥，后 32 字节为公钥，但是私钥的后 32 字节和公钥是一模一样的……</p><p>Ed25519 的算法中也存在 clamp 处理，但是处理的对象是算法内部对私钥计算 SHA-512 后的值，因此也不需要手动操作，改变私钥的话签名结果一定会改变。</p><p>顺便一提，签名是为了保证消息的完整性。教科书里提到签名的做法一般都是对明文&#x2F;密文计算 hash 然后对 hash 签名，或者是对明文计算 hash 然后将 hash 和明文一起加密，方法很多，但是自己和加密算法组合的话容易出错。作为改进，后来出现了一类称为“认证加密”（Authenticated Encryption with Associated Data）的算法，可以在不另外使用签名的情况下同样保证完整性。认证加密与一般的加密的区别在于：</p><ul><li>加密时，除明文和密钥外，还需要输入“附加的认证信息”（Associated Authenticated Data）。</li><li>加密后，除了密文还会得到一定长度的消息认证码 MAC，需要随密文一起发送出去。</li><li>解密时，需要输入相同的认证信息和加密得到的 MAC 进行验证，如果密文被篡改则会导致验证失败。</li></ul><p>常见的认证加密算法包括 AES-GCM 和 ChaCha20Poly1305 等，如果使用了认证加密算法就不需要另外进行签名了。</p><h1 id="在-OpenSSL-中使用-Curve25519-算法"><a href="#在-OpenSSL-中使用-Curve25519-算法" class="headerlink" title="在 OpenSSL 中使用 Curve25519 算法"></a>在 OpenSSL 中使用 Curve25519 算法</h1><p>作为加密库，libsodium 比较小众，相比之下还是 OpenSSL 有更广泛的使用。除了在各大 Linux 发行版里已有预装，大多数编程语言也内置了相应的 binding，比如 PHP 中同样是随本体一起附带的同名扩展，Node.js 自带的 crypto 模块就是对 OpenSSL 的封装。</p><p>OpenSSL 从 1.1.0 和 1.1.1 开始分别加入了对 X25519 和 Ed25519 的支持，不过 binding 不一定都能跟进，PHP 的 OpenSSL 扩展就仍然没有提供相关的功能（再吐槽一下，它虽然支持 ChaCha20Poly1305 的加密解密，但是并没有被当成一种认证加密算法来使用，也就无法获取和验证 MAC，<a href="https://bugs.php.net/bug.php?id=76935">这个问题从 PHP 7.2 开始提出三年了都还没有解决</a>），Node.js 的 crypto 倒是已经支持了，至于其他语言的 binding 我反而没用过，在另一个常用的语言 Python 那边我用得最多的加密库不是 <a href="https://github.com/pyca/pyopenssl">pyOpenSSL</a> 而是 <a href="https://github.com/Legrandin/pycryptodome">PyCryptodome</a>，后者和 OpenSSL 毫无关系而且也只支持 NIST 标准曲线而不支持 Curve25519……</p><p>总之下面先用 OpenSSL 的 CLI 作为 X25519 的使用例好了。</p><p>对于 X25519 密钥交换，参考 Stack Overflow 上的<a href="https://crypto.stackexchange.com/questions/75547/#answer-75548">这个回答</a>，稍微改一改使用的算法就可以了。首先是生成私钥：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl genpkey <span class="token parameter variable">-algorithm</span> x25519 <span class="token parameter variable">-out</span> alice.der <span class="token parameter variable">-outform</span> deropenssl genpkey <span class="token parameter variable">-algorithm</span> x25519 <span class="token parameter variable">-out</span> bob.der <span class="token parameter variable">-outform</span> der<span class="token function">cat</span> alice.der <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token function">cat</span> bob.der <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token comment"># 0000000 30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</span><span class="token comment"># 0000020 f8 fe 42 87 cc 79 8a 8b b9 1b fc 71 16 fc 75 32</span><span class="token comment"># 0000040 e3 4f 63 06 07 e4 fc 46 75 1d 1e d8 63 96 7e 48</span><span class="token comment"># 0000060</span><span class="token comment"># 0000000 30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</span><span class="token comment"># 0000020 00 f9 28 97 40 10 c9 9d c0 56 76 b9 bf ae a3 a2</span><span class="token comment"># 0000040 3c 67 8d 8e 13 10 15 5e 36 c4 ba ed 28 16 83 58</span><span class="token comment"># 0000060</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>嗯？X25519 的公私钥都是 32 字节的，怎么这里输出了 48 字节的东西？</p><p>因为那 32 字节是原始的密钥，而 OpenSSL 使用的是实际应用中封装了包括但不限于算法名称、数学参数、版本号、序列号、有效期等等信息的 X.509 或 PKCS 标准的证书格式，这些内容在证书里又按照 ASN.1 标准被序列化。直接保存序列化后得到的二进制数据的证书格式叫做 DER，考虑到使用二进制数据时可能存在不便，因此还有另一种等效的 PEM 格式，这种格式以字符串 <code>-----BEGIN/END ...-----</code> 开头&#x2F;结尾，将二进制数据通过 Base64 编码后存在中间。上面输出的就是 DER 格式的私钥。平时使用 https 上网时，浏览器收到的服务端的证书就是这类格式的。</p><p>那这 48 字节包括了什么信息呢？找个<a href="https://lapo.it/asn1js/">在线的 ASN.1 解析器</a>查看一下：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1895*609),609px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/161fc914e60bd96f3771bdb9890e9572/393h53-2.webp" data-src="https://p.sda1.dev/12/94ba51843ce3e45fe460df6de6dc4385/4IppY4lY.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAKACADASIAAhEBAxEB/8QAGQAAAQUAAAAAAAAAAAAAAAAABQABAwQH/8QAIBAAAQQCAQUAAAAAAAAAAAAAAQACAxEFIUEUMlFUgf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDTG4CWu+MjjZViLBTAGpoW75cUHhADLoWTtTO4QFzg5/ag+EpnYOdoJ6qHQ8oOkg//2Q"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/94ba51843ce3e45fe460df6de6dc4385/4IppY4lY.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>这些数据使用的是 <a href="https://datatracker.ietf.org/doc/html/rfc5208#section-5">PKCS#8 格式</a>，添加了 X25519 的算法标识和一些结构信息，不难注意到前 16 字节是固定的，后 32 字节就是私钥本身，因此其实也可以把固定的前 16 字节 <code>30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</code> 抽出来，然后自己从 CSPRNG 里取出 32 字节拼接到一起：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># openssl genpkey -algorithm x25519 -out alice.der -outform der</span><span class="token comment"># openssl genpkey -algorithm x25519 -out bob.der -outform der</span><span class="token comment"># 30 2e 02 01 00 30 05 06 03 2b 65 6e 04 22 04 20</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"MC4CAQAwBQYDK2VuBCIEIA=="</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span> <span class="token operator">></span> alice.der<span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"MC4CAQAwBQYDK2VuBCIEIA=="</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span> <span class="token operator">></span> bob.der<span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/urandom <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">32</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">>></span> alice.der<span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/urandom <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">32</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">>></span> bob.der<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后是从私钥生成公钥：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl pkey <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-in</span> alice.der <span class="token parameter variable">-out</span> alice.pub <span class="token parameter variable">-inform</span> der <span class="token parameter variable">-outform</span> deropenssl pkey <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-in</span> bob.der <span class="token parameter variable">-out</span> bob.pub <span class="token parameter variable">-inform</span> der <span class="token parameter variable">-outform</span> der<span class="token function">cat</span> alice.pub <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token function">cat</span> bob.pub <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token comment"># 0000000 30 2a 30 05 06 03 2b 65 6e 03 21 00 23 1b c3 9e</span><span class="token comment"># 0000020 38 65 a8 e4 b9 1c e9 de 37 7f a2 8b 9f 06 ad 64</span><span class="token comment"># 0000040 83 79 24 86 d3 ca 41 08 26 67 6c 38</span><span class="token comment"># 0000054</span><span class="token comment"># 0000000 30 2a 30 05 06 03 2b 65 6e 03 21 00 1b 39 77 8a</span><span class="token comment"># 0000020 f5 cd 2d 61 2f 49 4d 91 94 6c ce ee b1 e5 bc e9</span><span class="token comment"># 0000040 6f 65 03 02 c1 21 c5 76 4f 2c 99 0b</span><span class="token comment"># 0000054</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同理，这里的二进制数据使用的是 <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.1.2.7">SPKI 格式</a>，固定的前 12 字节 <code>30 2a 30 05 06 03 2b 65 6e 03 21 00</code> 可以抽出来，和从 libsodium 或是别的方式收到的 32 字节公钥拼起来。</p><p>最后是密钥交换，这次得到的就直接是 32 字节的共享密钥了：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl pkeyutl <span class="token parameter variable">-derive</span> <span class="token parameter variable">-out</span> alicebob.key <span class="token parameter variable">-inkey</span> alice.der <span class="token parameter variable">-peerkey</span> bob.pub <span class="token parameter variable">-keyform</span> der <span class="token parameter variable">-peerform</span> deropenssl pkeyutl <span class="token parameter variable">-derive</span> <span class="token parameter variable">-out</span> bobalice.key <span class="token parameter variable">-inkey</span> bob.der <span class="token parameter variable">-peerkey</span> alice.pub <span class="token parameter variable">-keyform</span> der <span class="token parameter variable">-peerform</span> der<span class="token function">cmp</span> alicebob.key bobalice.key<span class="token function">cat</span> alicebob.key <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token function">cat</span> bobalice.key <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token comment"># 0000000 01 e0 1d 2b 07 d7 c0 1d e9 28 ef c2 ea b7 f6 a0</span><span class="token comment"># 0000020 6b 27 ab fa dc 73 52 f7 58 92 de 2b cd d0 cd 44</span><span class="token comment"># 0000040</span><span class="token comment"># 0000000 01 e0 1d 2b 07 d7 c0 1d e9 28 ef c2 ea b7 f6 a0</span><span class="token comment"># 0000020 6b 27 ab fa dc 73 52 f7 58 92 de 2b cd d0 cd 44</span><span class="token comment"># 0000040</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至于在 CLI 中使用 Ed25519 签名……签名和验证的功能<a href="https://github.com/openssl/openssl/issues/11633">并没有加入 CLI</a>，原因是 RSA 和 ECDSA 签名都是先要另外选择一种算法对消息计算 hash 后再使用算法对 hash 签名，但是 Ed25519 不需要这么做，而是直接将消息输入签名算法，在算法内部钦定了使用 SHA-512 计算 hash 然后进行后续操作。由于“输入算法的是消息的 hash 还是本体”这一过程存在不同，因此 OpenSSL 一开始没有将 Ed25519 签名和验证加入 CLI（<a href="https://github.com/openssl/openssl/issues/6988#issuecomment-618297128">在 3.0.0 中加入了</a>，不过这个版本刚发布没多久而且可能存在不兼容的变更，因此我没有自己使用这个版本进行测试），但是源代码还是支持的。</p><blockquote><p><a href="https://github.com/openssl/openssl/blob/bb17971acb0d891b734991091244b90019968c65/doc/man1/pkeyutl.pod#notes">openssl&#x2F;doc&#x2F;man1&#x2F;pkeyutl.pod</a></p><p>The Ed25519 and Ed448 signature algorithms are not supported by this utility. They accept non-hashed input, but this utility can only be used to sign hashed input.</p></blockquote><p>当然生成密钥对还是支持的：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl genpkey <span class="token parameter variable">-algorithm</span> ed25519 <span class="token parameter variable">-out</span> private.der <span class="token parameter variable">-outform</span> der<span class="token function">cat</span> private.der <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token comment"># 0000000 30 2e 02 01 00 30 05 06 03 2b 65 70 04 22 04 20</span><span class="token comment"># 0000020 8a da 59 23 d4 7d a0 ed 36 c8 a6 6e 26 26 3a 75</span><span class="token comment"># 0000040 b4 a4 f7 48 91 5a 8e c3 7f 45 71 8b 38 f1 da 8b</span><span class="token comment"># 0000060</span>openssl pkey <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-in</span> private.der <span class="token parameter variable">-out</span> public.pub <span class="token parameter variable">-inform</span> der <span class="token parameter variable">-outform</span> der<span class="token function">cat</span> public.pub <span class="token operator">|</span> od <span class="token parameter variable">-t</span> x1<span class="token comment"># 0000000 30 2a 30 05 06 03 2b 65 70 03 21 00 e1 42 2a ee</span><span class="token comment"># 0000020 ec 89 33 41 96 74 fd 6d ec d6 a7 69 94 2b 58 1d</span><span class="token comment"># 0000040 5e 37 e4 d2 e8 f8 d6 41 79 3d 97 a4</span><span class="token comment"># 0000054</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>仍然可以提取出私钥和公钥的前几个字节和原始的密钥拼接，私钥的前 16 个字节是 <code>30 2e 02 01 00 30 05 06 03 2b 65 70 04 22 04 20</code>，公钥的前 12 个字节是 <code>30 2a 30 05 06 03 2b 65 70 03 21 00</code>，其实只是算法标识不同而已。</p><p>再附加一个在 Node.js 中通过 crypto 模块使用 X25519 和 Ed25519 的例子，使用的还是前面的标准测试向量，因为太长所以这里就折叠了：</p><details><summary>X25519 使用例</summary><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> x25519PrivateKeyPkcs8Header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'302e020100300506032b656e04220420'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> x25519PublicKeySpkiHeader <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'302a300506032b656e032100'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// const &#123;</span><span class="token comment">//     privateKey: privateKeyA,</span><span class="token comment">//     publicKey: publicKeyA,</span><span class="token comment">// &#125; = crypto.generateKeyPairSync('x25519');</span><span class="token comment">// const &#123;</span><span class="token comment">//     privateKey: privateKeyB,</span><span class="token comment">//     publicKey: publicKeyB,</span><span class="token comment">// &#125; = crypto.generateKeyPairSync('x25519');</span><span class="token keyword">const</span> privateKeyA <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>        x25519PrivateKeyPkcs8Header<span class="token punctuation">,</span>        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>            <span class="token string">'77076d0a7318a57d3c16c17251b26645df4c2f87ebc0992ab177fba51db92c2a'</span><span class="token punctuation">,</span>            <span class="token string">'hex'</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span><span class="token punctuation">,</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> privateKeyB <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>        x25519PrivateKeyPkcs8Header<span class="token punctuation">,</span>        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>            <span class="token string">'5dab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb'</span><span class="token punctuation">,</span>            <span class="token string">'hex'</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span><span class="token punctuation">,</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// const publicKeyA = crypto.createPublicKey(&#123; key: privateKeyA &#125;);</span><span class="token comment">// const publicKeyB = crypto.createPublicKey(&#123; key: privateKeyB &#125;);</span><span class="token keyword">const</span> publicKeyA <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>        x25519PublicKeySpkiHeader<span class="token punctuation">,</span>        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>            <span class="token string">'8520f0098930a754748b7ddcb43ef75a0dbf3a0d26381af4eba4a98eaa9b4e6a'</span><span class="token punctuation">,</span>            <span class="token string">'hex'</span>        <span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span><span class="token punctuation">,</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> publicKeyB <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>        x25519PublicKeySpkiHeader<span class="token punctuation">,</span>        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>            <span class="token string">'de9edb7d7b7dc1b4d35b61c2ece435373f8343c85b78674dadfc7e146f882b4f'</span><span class="token punctuation">,</span>            <span class="token string">'hex'</span>        <span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span><span class="token punctuation">,</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> sharedA <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">diffieHellman</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">privateKey</span><span class="token operator">:</span> privateKeyA<span class="token punctuation">,</span>    <span class="token literal-property property">publicKey</span><span class="token operator">:</span> publicKeyB<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> sharedB <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">diffieHellman</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">privateKey</span><span class="token operator">:</span> privateKeyB<span class="token punctuation">,</span>    <span class="token literal-property property">publicKey</span><span class="token operator">:</span> publicKeyA<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sharedA<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sharedB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sharedA<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true</span><span class="token comment">// 4a5d9d5ba4ce2de1728e3bf480350f25e07e21c947d19e3376f09b3c1e161742</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details><details><summary>Ed25519 使用例</summary><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> ed25519PrivateKeyPkcs8Header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'302e020100300506032b657004220420'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> ed25519PublicKeySpkiHeader <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'302a300506032b6570032100'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// const &#123; privateKey, publicKey &#125; = crypto.generateKeyPairSync('ed25519');</span><span class="token keyword">const</span> privateKey <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>        ed25519PrivateKeyPkcs8Header<span class="token punctuation">,</span>        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>            <span class="token string">'833fe62409237b9d62ec77587520911e9a759cec1d19755b7da901b96dca3d42'</span><span class="token punctuation">,</span>            <span class="token string">'hex'</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span><span class="token punctuation">,</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// const publicKey = crypto.createPublicKey(&#123; key: privateKey &#125;);</span><span class="token keyword">const</span> publicKey <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>        ed25519PublicKeySpkiHeader<span class="token punctuation">,</span>        Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>            <span class="token string">'ec172b93ad5e563bf4932c70e1245034c35467ef2efd4d64ebf819683467e2bf'</span><span class="token punctuation">,</span>            <span class="token string">'hex'</span>        <span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span><span class="token punctuation">,</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> message <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>    <span class="token string">'ddaf35a193617abacc417349ae20413112e6fa4e89a97ea20a9eeee64b55d39a'</span> <span class="token operator">+</span>    <span class="token string">'2192992a274fc1a836ba3c23a3feebbd454d4423643ce80e2a9ac94fa54ca49f'</span><span class="token punctuation">,</span>    <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> sign <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sign<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> publicKey<span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// dc2a4459e7369633a52b1bf277839a00201009a3efbf3ecb69bea2186c26b58909351fc9ac90b3ecfdfbc7c66431e0303dca179c138ac17ad9bef1177331a704</span><span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details><hr><p>最后再记录一下我把“信息的安全传输”这个大作业的流程修改成了什么样子，首先是密钥交换阶段：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/861*501),501px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://svgshare.com/i/aEd.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAATBAMAAAADuhLEAAAAMFBMVEVMaXG1mbgaoOEant0boeIrgN4aoOHYAHNqAP9lAPTXAHNqAf7UAHFfqRZgqRZfqRaSxPFHAAAAEHRSTlMAFblQ8SSN4uFNpJhy7mezGyCMDgAAAAlwSFlzAAALEwAACxMBAJqcGAAAALpJREFUeNpjYAADQTCCMoEsxrsXGO9+QBJgeP8AhBCAsXwBECEJMKxaILjqAJQ9e2v0Toa0BMa0BO7dYDN2tM7oZnRRYHVR4OgAq5g5UdiUwdgAiJiNWY0DGBg6Ok2cWF0cgCpYXNhcEhgYIiewBjIAZYwDWEMZQhlAKhgZGMEqmJSYlQxAZgBFwWZABZYXAh0GtgXqjlMLgQTYHcguVUpgVEIWYFRSYFVSQFZx5gAIIfu2AIiQVSBCDAAULC6qwVaOlgAAAABJRU5ErkJggg"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://svgshare.com/i/aEd.svg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <ol><li>客户端和服务端预先生成 Ed25519 密钥对。</li><li>客户端和服务端建立连接，服务端发送自己的 Ed25519 公钥，客户端可以选择是否信任。<ul><li>由于没有 CA，所以客户端只能自己确认收到的服务端公钥是否正确了。</li><li>这个参考的是 SSH 登录的流程，第一次登录时也会显示出服务端的公钥，如果客户端不信任或是收到的公钥和之前信任的不同则会终止连接。</li></ul></li><li>客户端发送自己的 Ed25519 公钥，服务端可以无条件信任或根据一个白名单决定是否信任。</li><li>双方各自生成 X25519 密钥对，然后互相交换公钥和时间戳以及对这两项的组合生成的签名。<ul><li>添加时间戳是为了防止重放攻击，其实还应该再加一个 nonce。</li></ul></li><li>确认签名无误后，双方使用密钥派生算法产生会话密钥和认证加密的认证信息，创建 ChaCha20Poly1305 加密&#x2F;解密上下文。</li></ol><p>然后是传输文件阶段：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/401*501),501px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://svgshare.com/i/aBz.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAgBAMAAAD+hXU2AAAAMFBMVEVMaXEyO1bXAHFIhN8XmduaMEzRAG3QAGpeqBZcAOoUjs1ZohMYnd5kAPsboeJqAP9eral3AAAADnRSTlMAFfRAmEWuffR4YJ3c1bR6/fMAAAAJcEhZcwAACxMAAAsTAQCanBgAAADXSURBVHjaY2AAAgMGGGDcsTsASHRvAPO4Ozo2MLB2dDSAeawgHuOOjo1QpYEwAgjYlZQKGFiVlBJgvAQQTwGiLy2tAEKAgSBIi6AghMPy7p0DA/P//xdhPEdBSSAPLM3s4rKAgXHmzAkMjCCbjI0FGBiMJxswhoYKQPRxAlWygSyG6xMD8ZhXrTI2AOozYC0vDwDxDBgYQQTcBql37w4gbOeC8aA2GENUwm0Hm4JqA8zVF8C2gzwjAPYWxFcCYM0O0BAF8uA2QOTOnIHKMQqAyACSQxAZAABcWVlx1Pfv2gAAAABJRU5ErkJggg"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://svgshare.com/i/aBz.svg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <ol><li>客户端发送文件名、文件大小等元数据，服务端进行检验并创建文件。</li><li>客户端分块读取文件，加密后发送，服务端解密并写入文件。</li><li>客户端发送完文件后发送 MAC，服务端验证。如果验证失败则删除文件并提示。</li></ol><p>流程图是当时写实验报告时做的 ε-(•́ω•̀๑)</p><p>其实如果都是在桌面端使用的话应该使用 AES-GCM 的……因为桌面端都有 AES 指令集。比较加密速度的话，同样是 256 位密钥的对称加密，使用指令集的 AES 最快，其次是 ChaCha20Poly1305，不使用指令集的 AES 最慢。</p>]]></content>
    
    
    <summary type="html">以及一些在学校里学的密码学课程不会讲到的东西</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Hashids 算法和实现原理介绍</title>
    <link href="https://akarin.dev/2021/02/26/hashids-description/"/>
    <id>https://akarin.dev/2021/02/26/hashids-description/</id>
    <published>2021-02-26T08:22:56.000Z</published>
    <updated>2021-02-26T08:22:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>Hashids 是一个小巧的开源库，几乎所有的编程语言都有相应的实现，可以将一个或多个非负整数编码成看上去比较随机的短字符串。按照<a href="https://hashids.org/">官网</a>上的例子，<code>347</code> 可以编码成 <code>yr8</code>，<code>[27, 986]</code> 可以编码成 <code>3kTMd</code>，编码结果会根据初始化时的设置而不同，但只要<strong>保持设置相同</strong>就可以将编码后的字符串<strong>解码恢复成原来的数值</strong>。</p><p>这类算法一般可以用在数据库的自增 ID 上，如果需要把它写在 URL 或者 API 请求之类的地方展示出来但又不想轻易地被爬虫爬一遍的话……</p><p>例如以前屑站使用 AV 号对视频进行编号，实际上也是一个自增 ID，于是写个请求 <code>http://acg.tv/av&#123;i&#125;</code> 的爬虫，然后将 <code>i</code> 的值设为 0、1、2……如此一直爬下去，就可以获取到屑站所有视频的数据。后来屑站实装了 BV 号，av170001 变成了 BV17x411W7Kc，一时看不出规律，写爬虫就不怎么方便了。这个 BV 号就是对 AV 号使用 Hashids 类算法编码的结果。</p><p><em>不过 BV 号实装后没多久就有人翻出了 <a href="https://www.zhihu.com/question/381784377/answer/1099438784">AV 号和 BV 号互转的算法</a>，并且 AV 号仍然可以照常使用，所以折腾出 BV 号这东西的意义嘛……另外 av99999999 之后的视频的 AV 号就<strong>不再自增</strong>而是<strong>随机生成</strong>了，真正起到反爬虫作用的其实是这个才对。</em></p><p>又比如你写了一个论坛，帖子的 ID 一般就是自增的。直接将自增 ID 展示出来的话，所有人都可以很容易地算出这个论坛每天发了多少帖子，由此继续分析用户活跃程度之类的……就像下面这样，注意写着 No. 的地方：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1637*758),758px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/aa3f214a61541fc3f703bc57bf524b8f99487.jpg" data-src-webp="https://p.sda1.dev/12/d96e21c28417a0952f5a4537eacc3bce/Q6bE2pMp.webp" data-src="https://p.sda1.dev/12/9100ab9c46b45700cc9159334ec85ce4/ut-Q4J-V.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAPACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAwQCBQYH/8QAKBAAAQQBAQUJAAAAAAAAAAAAAQACAxEEQRIhMTJhExRDcXKhsdHh/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAP/xAAaEQEAAwEBAQAAAAAAAAAAAAABAAIRAzFh/9oADAMBAAIRAxEAPwDsb8qFk0guMiyN76Q++xVYdDVHxP1I5FmaT1O+SlWg1rwdr5ocaoOsPV3wl+3KiItz2M67e72KO3Jh223OyrrmP2s4QVLHB7Yceca9QoNcFl7AC/J//9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/9100ab9c46b45700cc9159334ec85ce4/ut-Q4J-V.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p><em>A 岛默许了这个统计，而且使用自增 ID 的串号表示回复和引用本身就是 A 岛社区文化的重要一部分，<del>比叔叔把已是屑站象征之一的 AV 号雪藏掉不知道高到哪里去了</del>。当然对这个串号使用爬虫（又称“爬岛”）还是不允许的。</em></p><p>Hashids 可以自定义编码时用到的字符表（默认是大小写字母数字，但是使用任意 Unicode 字符例如汉字和 emoji 也是可以的），还可以设置编码后字符串的最小长度（默认不设置，设置后编码得到的字符串长度小于此值则会用一定方式填充），另外还有叫 salt 的设定，设置不同的 salt 也会影响编码结果（就像加盐的 hash 算法那样？！）。可以在<a href="https://jsbin.com/kebobahude/edit?html,js,console">这里</a>随意尝试～</p><h1 id="Hashids-真的属于-hash-算法吗？"><a href="#Hashids-真的属于-hash-算法吗？" class="headerlink" title="Hashids 真的属于 hash 算法吗？"></a>Hashids 真的属于 hash 算法吗？</h1><p>虽然 Hashids 的名字里面就写着 hash，而且设置里也用上了 salt 这种确实和 hash 算法有关的词，但是它真的是一个 hash 算法吗……找出 hash 算法的定义来对比一下：</p><ul><li>给定原始数据，很容易可以计算出对应的 hash 值。显然成立。</li><li>即使原始数据出现很小的差异，对应的 hash 值也会有巨大的变化，尽量不要产生碰撞。在上面的“随意尝试”里就可以看出确实会产生巨大变化（虽然某些地方的变化并不大……），而且按照 Hashids 的原理（稍后说明）冲突是完全不可能产生的。</li><li>给定 hash 值，反过来计算原始数据是很难的。嗯？Hashids 编码得到的字符串是可以恢复的啊？</li></ul><p>最后一条定义说明了 Hashids 实际上并不是一个严格意义上的 hash 算法。虽然各种真正的 hash 算法（例如 <a href="https://zh.wikipedia.org/wiki/Bcrypt">bcrypt</a> 或者各种 <a href="https://zh.wikipedia.org/wiki/%E5%AF%86%E9%92%A5%E6%95%A3%E5%88%97%E6%B6%88%E6%81%AF%E8%AE%A4%E8%AF%81%E7%A0%81">HMAC</a>）都有 salt 的设定，但是就算知道了 salt 也很难恢复出原始数据，而 Hashids 的这个 salt 嘛……完全相反，所以它起到的更像是加密算法中密钥的作用。</p><p>实际上 Hashids 是使用进制转换的方式对数值进行编码的，将一般的数转换为十进制是固定使用数字 <code>0-9</code>，十六进制是数字 <code>0-9a-f</code>，而 Hashids 要转换到几进制和设置的字符表的长度有关，<strong>对每个数的每一位使用的“数字”是根据输入数值和设置的 salt 按照一些规则打乱字符表得到的</strong>，所以 Hashids 更像是一种多表代换密码，就像维吉尼亚密码那样，虽然每个字符都使用简单的凯撒密码加密，但是 offset 不同，于是攻击难度稍微提高了。</p><p>就算是在这里把 Hashids 当成加密算法，它的强度也不算太高，绝对不是密码学上安全的算法，所以<strong>严禁将 Hashids 用于加密机密数据，更不要真的像使用 hash 算法一样把它用于保存密码。</strong>按照<a href="https://carnage.github.io/2015/08/cryptanalysis-of-hashids">这里</a>的分析，在使用选择明文攻击、字符表等设置使用默认值但不知道 salt 的情况下，通过解一组方程分析 salt 的前三个字符有大概 200 种可能，这个数量已经大大低于暴力破解需要尝试的次数了。</p><p>为什么设计这个算法的人选用了 hash 和 salt 之类的名词？按照<a href="https://hashids.org/#why-hashids">官网上的说明</a>，因为对一般人来说，它看起来像 hash，走路像 hash，叫声像 hash，那么它就是……⊂彡☆))д&#96;)</p><blockquote><p>Why “hashids”?</p><p>Originally the project <strong>referred to generated ids as hashes, and obviously the name hashids has the word hash in it</strong>. Technically, these generated ids cannot be called hashes since a cryptographic hash has one-way mapping (cannot be decrypted).</p><p>However, when people search for a solution, like a “youtube hash” or “bitly short id”, they usually <strong>don’t really care of the technical details</strong>. So hashids stuck as a term — an algorithm to obfuscate numbers.</p></blockquote>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/664*493),493px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/d634d60ebe06feb4793ba06f3c7e91076047.jpg" data-src-webp="https://p.sda1.dev/12/c7f2390a9afd1ddc0c3231deed88a5f9/XSpAU-lx.jpg" data-src="https://p.sda1.dev/12/2ba066d73298f9705dbaeb08ca4bcc89/mRAQGV5H.jpg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAYBBQMEB//EACYQAAICAgEDAwUBAAAAAAAAAAECAxEEBQASIjEjQVEGFTJSgpH/xAAYAQACAwAAAAAAAAAAAAAAAAAEBQECA//EAB0RAAIDAAIDAAAAAAAAAAAAAAECAAMRBCExQVH/2gAMAwEAAhEDEQA/AO7EhQSSAB5J4n7fYbGTMxRr8lI4Im6pSRZkP618cv5gczPbDsiKGNZJj+xckKg/yzzSbGuaOCfWSh+0deNbwsSV9yBXk+fjhFDUIdsBJ+ehMbRawxMEmbeKsDNFjF5fZCwUH+uJSfXm2g2kWNm62BIndVI7romrDcbM/CWHFxZxBJC0lhopCCyn+SRxU22LBPjdUiW0bKyH3BvjCqjivWXVOjvmDPbcrhWMfZcyfC2eYItTlzCaSEFgvp0FrqBA4QbbMkPdpctPSLmwbFNVfjRJ4cOJ4fMmRsHmZsaTSZbJZp+k0aNDlTGBkbPAX7FmwouS4ZyOylU0XseDfDhywdwMDECQVUnSBP/Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/2ba066d73298f9705dbaeb08ca4bcc89/mRAQGV5H.jpg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <hr><p>从这里开始就是介绍 Hashids 的比较详细的实现细节了。在此之前我 Google 了一下介绍 Hashids 的文章，基本上都是简单介绍一下它的主要用途是混淆自增 ID，然后就是一大堆复制粘贴的用法示例了，偶尔有几篇提到了“进制转换”不过也并不是很详细……所以接下来我会参考 <a href="https://github.com/niieani/hashids.js/blob/master/lib/hashids.ts">TypeScript&#x2F;JavaScript 版实现的源码</a>详细介绍一下编码和解码的原理（其它语言的实现应该也是类似的）。</p><p>如果只是想要简单了解 Hashids 原理的话，可以直接阅读<a href="https://hashids.org/#how-does-it-work">官网上的介绍</a>，简略介绍了进制转换等各种涉及到的步骤。想要了解更多细节的话就继续往下翻吧～</p><hr><h1 id="算法的初始化"><a href="#算法的初始化" class="headerlink" title="算法的初始化"></a>算法的初始化</h1><p>所有的编码和解码都是使用同一个 Hashids 对象的实例，在创建这个实例时进行算法的初始化，一般情况下需要输入以下参数：</p><ul><li>salt：一个可以包含任意字符的字符串，对之后打乱字符表的结果有影响。默认是留空。</li><li>minLength：最小长度，编码得到的字符串长度小于此值则会用一定方式填充。默认是留空。</li><li>alphabet：初始字符表，不能有重复字符，编码结果只可能含有这里的字符，即使字符相同顺序不同也会改变结果，长度至少为 16。默认是 <code>a-zA-Z1234567890</code> 一共 62 个字符。</li><li>seps：编码中用于分隔各个数值的字符（稍后说明 x2），必须是 alphabet 的子集，但是不要求字符不重复，顺序也会影响结果。默认是 <code>cfhistuCFHISTU</code>，原作者的想法是使用这些字母做分隔符可以<a href="https://hashids.org/#cursing">避免编码结果中出现粗鄙之语</a>。</li></ul><p><em>实际上 JS 版实现会<a href="https://github.com/niieani/hashids.js/blob/f8a2d2f6bbd4ecbe0ec1b0a2aa04a6cbc7048098/lib/hashids.ts#L50">自动处理</a>字符表去重、“不能重复”和“子集”之类的要求。</em></p><p>初始化以后就可以进行编码了。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> hashids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashids</span><span class="token punctuation">(</span>    <span class="token comment">// salt</span>    <span class="token string">'@salt!'</span><span class="token punctuation">,</span>    <span class="token comment">// minLength</span>    <span class="token number">24</span><span class="token punctuation">,</span>    <span class="token comment">// alphabet: use default</span>    <span class="token keyword">undefined</span><span class="token punctuation">,</span>    <span class="token comment">// seps</span>    <span class="token string">'SEPS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hashids<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token number">114514</span><span class="token punctuation">,</span> <span class="token number">1919810</span><span class="token punctuation">,</span> <span class="token number">893</span><span class="token punctuation">,</span> <span class="token number">931</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// tY8p8oMWMb76xOS3Jh4uvs2x</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hashids<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">'tY8p8oMWMb76xOS3Jh4uvs2x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [114514, 1919810, 893, 931]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编码后的字符串，看上去是一堆没什么规律的字母数字，实际上可以分成几个部分。例如上面得到的字符串 <span style="color:#e77">tY8</span><span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span><span style="color:#e77">s2x</span> 就可以分为用不同颜色表示的以下部分：</p><ul><li><span style="color:#9c6">单个数值编码后的值</span></li><li><span style="color:#273">seperator，也就是不同数值之间的分隔符</span></li><li><span style="color:#f80">lottery，用于在编码过程中打乱字符表</span></li><li><span style="color:#63b">guard，用于分隔编码部分和填充部分</span></li><li><span style="color:#e77">编码后字符串左右两边的填充</span></li></ul><p>前三个是实际的编码部分，后两个用于填充，只有设置了最小长度的情况下才有可能出现在编码结果中。</p><p>Hashids 算法中经常需要打乱字符串中的字符，使用的都是下面这个<a href="https://github.com/niieani/hashids.js/blob/f8a2d2f6bbd4ecbe0ec1b0a2aa04a6cbc7048098/lib/hashids.ts#L302">稍有修改的 Fisher–Yates Shuffle 洗牌算法</a>，除了要打乱的字符串（拆成了包含所有字符的数组）这里还有另一个参数也叫 salt（留空则直接原样返回不打乱），只要字符串和 salt 相同就可以保证打乱结果相同……所以这个 salt 起的明明是随机数生成器中种子的作用吧！(╯‵□′)╯︵┻━┻ <strong>为了不与一开始输入的 salt 混淆，之后就用 seed 表示打乱时的这个 salt 参数好了。</strong></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token parameter">alphabetChars<span class="token punctuation">,</span> saltChars</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>saltChars<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> alphabetChars<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> integer<span class="token punctuation">;</span>    <span class="token keyword">const</span> transformed <span class="token operator">=</span> alphabetChars<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> transformed<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 在原始的Fisher-Yates Shuffled里，j是0-i范围的一个随机数</span>        v <span class="token operator">%=</span> saltChars<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        p <span class="token operator">+=</span> integer <span class="token operator">=</span> saltChars<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> j <span class="token operator">=</span> <span class="token punctuation">(</span>integer <span class="token operator">+</span> v <span class="token operator">+</span> p<span class="token punctuation">)</span> <span class="token operator">%</span> i<span class="token punctuation">;</span>        v<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">[</span>transformed<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> transformed<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>transformed<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> transformed<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> transformed<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的例子里，一开始的时候输入了 <code>SEPS</code> 四个字符作为 seps，先从输入的字符表中去掉这几个字符（没有了 E、P、S 这三个大写字母，此时还剩下 <code>62 - 3 = 59</code> 个字符），然后以 salt 作为 seed 将 seps 打乱一次，打乱结果为 <code>SSEP</code>。但是上面的编码结果中还出现了这些字符之外的 seperator（b 和 h），这是因为 Hashids 要求 seps 的字符数量必须不少于字符表长度的 1&#x2F;3.5（向上取整），所以这里需要 <code>Math.ceil(59 / 3.5) = 17</code> 个字符作为 seps，不足的 13 个字符从字符表的前几个字符中取出来，接到 seps 后面补充数量。</p><p>补充之后，最后的 seps 字符列表就是 <code>SSEPabcdefghijklm</code>（后面的 <code>a-m</code> 是从字符表中取出的），字符表是 <code>nopqrstuvwxyzABCDFGHIJKLMNOQRTUVWXYZ1234567890</code>（前面的 <code>a-m</code> 被取走了，还有 <code>59 - 13 - 46</code> 个字符）。</p><p>如果设置了编码后字符串的最小长度的话，编码后可能会需要进行填充。Hashids 通过在实际的编码部分左右各放置一个 guard 字符的方式将编码部分和填充部分分开。guards 也是从字符表中取出的，并不能手动设置，字符数量是字符表长度的 1&#x2F;12（向上取整）。在这里就需要取出 <code>Math.ceil(46 / 12) = 4</code> 个字符。</p><p>先以 salt 作为 seed 将当前的字符表打乱一次，字符表变成了 <code>vpnz0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code>，然后取出字符表的前 4 个字符 <code>vpnz</code> 作为 guards，字符表中剩下 <code>0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code> 一共 42 个字符，这些字符会出现在编码结果的除 seperator 和 guard 以外的所有部分中。</p><p>最后用一个流程图来概括以上的初始化过程：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/961*301),301px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://svgshare.com/i/aFA.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAKBAMAAAAnY0GXAAAAMFBMVEX////6+ff6+Piy3/QipOPq9/30ttfJ6fjM5LWbyWzbFn5tsCrj8NZpwOrF36rnYqm55rsWAAAAA3RSTlP//vKdYq8wAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbElEQVR42mNQYEACjIJCDAIoAi+b0ARmKjEoCgKFmKDCjAxMDGqrBEycgWxeFwYTd8bZjxjUkgSCTYEC7MYMwaaMHUwMCmkgAZMCoABQy4lDDGrrgVqYXVyBWoACuw9BDGUIFoC7A8VhDAxMAAk5ERteeuB6AAAAAElFTkSuQmCC"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://svgshare.com/i/aFA.svg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <h1 id="对输入的数进行编码"><a href="#对输入的数进行编码" class="headerlink" title="对输入的数进行编码"></a>对输入的数进行编码</h1><p>初始化以后就可以将输入的整数编码了，编码期间使用的字符表 alphabet 是从初始化后的 Hashids 对象里复制的，虽然会涉及多次打乱字符表的操作但是并不会改变原对象的字符表，解码的时候也是一样的。</p><p>可能是为了添加更多的随机性，Hashids 算法在编码过程中设置了一个称为 lottery 的字符。对于每个输入的第 a 个数 b（a 是从 0 开始计数的），计算 <code>b % (100 + a)</code> 的和（记为 numbersIdInt，后面还会用到），则 <code>alphabet[numbersIdInt % alphabet.length]</code> 就是 lottery 字符。</p><p>在上面的例子中，初始化以后的 alphabet 是 <code>0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code>，对 <code>[114514, 1919810, 893, 931]</code> 编码得到的 lottery 是 8 也就是 <code>alphabet[13]</code>，是根据以下过程算出的：</p><ul><li><code>114514 % 100 = 14</code></li><li><code>1919810 % 101 = 2</code></li><li><code>893 % 102 = 77</code></li><li><code>931 % 103 = 4</code></li><li><code>numbersIdInt = 14 + 2 + 77 + 4 = 97</code></li><li><code>lotteryIndex = 97 % 42 = 13</code></li></ul><p>然后就是对每个数编码了。前面提过 Hashids 的编码原理是进制转换，现在 alphabet 有 42 个字符，相当于将各个数转换为 42 进制。Hashids 又有多表代换的特征，表现在编码每个数之前 alphabet 都会使用 <code>lottery + salt + alphabet</code> 作为 seed 被打乱一次（取代之前的 alphabet），于是每个数在进制转换时使用的“数字”都是不一样的。</p><p>如果编码的不是最后一个数，编码后还要添加一个 seperator，计算方法是：对于第 a 个数 b，编码后的第一个字符的 Unicode 码点是 c，则需要添加的 seperator 是 <code>seps[a % (b + c) % seps.length]</code>。</p><p>例如，上面的例子中编码的过程：</p><ul><li>使用 seed <code>8@salt!0xJYw6Q1TLNqH8WGuRB5ZMKOAroCFtD74IU2ysX9V3</code> 打乱字符表得到 <code>8ouNLs4OK5V9wA613QqG7XMYZ0JRTFy2BCHItUWxrD</code></li><li>进制转换的结果是 <code>114514 = 1 * 42 ** 3 + 22 * 42 ** 2 + 38 * 42 ** 1 + 22 * 40 ** 0</code></li><li>转换后的各位数 <code>1 22 38 22</code> 在字符表中对应的字符分别是 oMWM</li><li><code>&quot;o&quot; = String.fromCodePoint(111)</code>，所以添加 seperator：<code>seps[114514 % (0 + 111) % 17] = seps[73 % 17] = seps[5]</code> 也就是 b</li><li>使用 seed <code>8@salt!8ouNLs4OK5V9wA613QqG7XMYZ0JRTFy2BCHItUWxrD</code> 打乱字符表得到 <code>DWsUJ81NVrXqAxtYZ9wuIBG547K2RML3OQTCFH6o0y</code></li><li>进制转换的结果是 <code>1919810 = 25 * 42 ** 3 + 38 * 42 ** 2 + 13 * 42 ** 1 + 32 * 42 ** 0</code></li><li>转换后的各位数 <code>25 38 13 32</code> 在字符表中对应的字符分别是 76xO</li><li><code>&quot;7&quot; = String.fromCodePoint(55)</code>，所以添加 seperator：<code>seps[1919810 % (1 + 55) % 17] = seps[18 % 17] = seps[1]</code> 也就是 S</li><li>……</li></ul><p>最后可以得到未填充的编码部分 <span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span>。</p><h1 id="编码结果的填充"><a href="#编码结果的填充" class="headerlink" title="编码结果的填充"></a>编码结果的填充</h1><p>如果设置了最小长度，而刚刚得到的编码结果长度又不足，那么就需要进行填充了。Hashids 使用放在编码部分左右两边各一个的 guard 字符将编码和填充部分分开，这两个字符均使用 <code>guards[(numbersIdInt + x) % guards.length]</code> 求出，对于左边&#x2F;右边的 guard，x 分别是编码部分第 0&#x2F;1 个字符的 Unicode 码点。先添加左边的 guard，如果已经满足最小长度则不再添加右边的 guard。在上面的例子中：</p><ul><li>guards 是 vpnz</li><li>编码部分长度 16，前两个字符的 Unicode 码点：<code>&quot;8&quot; = String.fromCodePoint(56)</code> 和 <code>&quot;o&quot; = String.fromCodePoint(111)</code></li><li>设置了最小长度为 24，编码结果的长度不足，因此在左边添加 <code>guards[(97 + 56) % 4] = guards[1]</code> 也就是 p</li><li>长度仍然不足，因此在右边添加 <code>guards[(97 + 111) % 4] = guards[0]</code> 也就是 v</li></ul><p>如果添加 guard 之后长度还是不足呢？接下来就会在编码结果的左右两边填充数遍完整的字符表了。</p><ul><li>以 alphabet 自己作为 seed 打乱 alphabet（同样是取代之前的 alphabet）</li><li>将 alphabet 一分为二，前 <code>Math.floor(alphabet.length / 2)</code> 个字符添加到编码结果右边，剩下的字符添加到编码结果左边</li><li>循环到编码结果的长度超过最小长度为止</li><li>取编码结果 result 的从第 <code>Math.floor((result.length - minLength) / 2)</code> 个字符开始的 minLength 个字符作为最后的编码结果</li></ul><p>在上面的例子中，添加了 guard 的编码结果是 <span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span>，打乱一次 alphabet 的结果是 s2xC0oRZAQuLqyK6GwXUHNTB7rV4IOD51MF9WJ3tY8，添加到编码结果的左右两边得到 <span style="color:#e77">NTB7rV4IOD51MF9WJ3tY8</span><span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span><span style="color:#e77">s2xC0oRZAQuLqyK6GwXUH</span>，长度为 60，于是截取从第 <code>Math.floor((60 - 24) / 2) = 18</code> 个字符开始的 24 个字符，得到最后的编码结果 <span style="color:#e77">tY8</span><span style="color:#63b">p</span><span style="color:#f80">8</span><span style="color:#9c6">oMWM</span><span style="color:#273">b</span><span style="color:#9c6">76xO</span><span style="color:#273">S</span><span style="color:#9c6">3J</span><span style="color:#273">h</span><span style="color:#9c6">4u</span><span style="color:#63b">v</span><span style="color:#e77">s2x</span>。</p><h1 id="解码和校验"><a href="#解码和校验" class="headerlink" title="解码和校验"></a>解码和校验</h1><p>对 Hashids 的解码实际上是把字符串中表示每个数的字符串恢复回原来的数，因为 seps 和 guards 是固定的，lottery 又固定是 guard 之间的未填充的编码部分的第一个字符，所以很容易就可以把每个数的字符串从编码后的字符串里拆出来。按照同样的顺序，每解码一个数之前，先使用 <code>lottery + salt + alphabet</code> 打乱一次字符表，对照字符表得出这个数在 x 进制下的表示，再转换到十进制就可以完成解码了。</p><p>既然这样，那剩下的 seperator 和 guard 还有填充部分随便乱写，也是可以解码出结果的哦？</p><p>当然不能出这种问题啦！所以 Hashids 的<a href="https://github.com/niieani/hashids.js/blob/f8a2d2f6bbd4ecbe0ec1b0a2aa04a6cbc7048098/lib/hashids.ts#L275">处理方法</a>是……<strong>把解码出的数重新编码一遍，如果和输入的字符串不同则按照解码结果无效处理，什么也不返回</strong>。</p><p>看来这些部分还起到了校验码的作用呢。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/43737030">Pixiv ID: 43737030 「Cafe de Lapin」 by Koi</a></p></blockquote>]]></content>
    
    
    <summary type="html">虽然名字里写着 hash，实际上更像是一种多表代替的古典密码算法。</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>成语接龙的求解算法</title>
    <link href="https://akarin.dev/2021/01/28/idioms-solitaire/"/>
    <id>https://akarin.dev/2021/01/28/idioms-solitaire/</id>
    <published>2021-01-28T13:49:38.000Z</published>
    <updated>2021-01-28T13:49:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>以前在某个 V 字头的技术论坛看过一个帖子，某君写了一个网页作为给女朋友的一百天礼物……当然写网页来表白&#x2F;记录恋爱经历这种操作在 V 字头论坛已经被吐槽过不知道多少次了，不过这位某君的想法还是有点创意的——网页内容如下：</p><blockquote><p>为了宣布“○○可爱”为一个合法成语，所以：请输入一个四字成语<br>我将自动为你接龙到“○○可爱”</p></blockquote><p><em>或许你能找到那个帖子也说不定？</em></p><p>○○是某君的女朋友的昵称，总之这狗粮把我噎得……(&#x3D;’_’&#x3D;)</p><p>虽然现在我还没有女朋友啦……不过为了将来自己有女朋友的时候和一百天的时候做好准备<del>实际上还是因为最近实在是太闲了</del>，还是可以对它进行一些分析的～去掉狗粮的部分，它就变成了一个比较有意思的问题：给定起始和结束的成语，如何计算出<strong>这两个成语之间的一条接龙</strong>？</p><p>已经有不少提供在线成语接龙的网站了（比如<a href="http://chengyujielong.00cha.net/">这个</a>），不过这些网站基本上都是允许用户设定一个起始成语，然后生成<strong>指定长度的接龙</strong>。只要不断地搜索“以○开头的成语”，就可以想接多少就接多少，总是能一直接下去的嘛！但是如果还要钦定结束的成语，那问题就变得不一样了。</p><h1 id="问题的分析"><a href="#问题的分析" class="headerlink" title="问题的分析"></a>问题的分析</h1><p>成语接龙只考虑成语的第一个字和最后一个字的读音，这样的话每个成语实际上就是一条<strong>有向边</strong>，而所有的成语就组成了一张巨大的<strong>有向图</strong>。那相当于图的顶点的是什么呢？当然就是不同的读音啦！</p><p><em>这里设定成语接龙的规则是允许使用同音字。当然，即使要求必须使用相同的字，思路也是类似的。<del>证明过程留作习题</del></em></p><p>给定起始和结束的成语，实际上我们在意的也只是<strong>起始成语的最后一个字</strong>和<strong>结束成语的第一个字</strong>的读音。以两个读音作为起点和终点，我们就成功地把成语接龙问题变成了一个<strong>“在图中求最短路径”</strong>的问题。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/482*602),602px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://svgshare.com/i/aFi.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAgBAMAAAD+hXU2AAAAMFBMVEX9/v3////////l6ej///+8x8z////3+/UnpOJDr+SEutJouODs8uyhuMKs1+zO3NvBQR0eAAAABnRSTlP9ybv57PuLbZFMAAAACXBIWXMAAAsTAAALEwEAmpwYAAABE0lEQVR42mMQYEAAJgaxNBB4ByaTILy8jmdIvKqZyxG85M+7jxXAeQllQFwA46WDlKWXQXkMaWxAMucYhFeW1/EtLS27G8xLZ8vu2FNebjHDCMyD2He6E+wWoImfgWIJH5KgvDKQUWUgHsh8sACQF5PGnpZsUAYSA8nlfADLMUB4CceBvAKwWiDvVlhacvKq8rS01LVJDKId09IOc3UsSEs72RHEIDuzubz89Mzt5eURMy4xiK1cBlS0OywtLWsWUF96QY4ZOFTSzEC2J9Qcg/DKIH4oA7kTxktj5+24huClcc/cgMTL6rhQjuClXU1LKM+aDeOBgvHmzEsIXlpl5yckXurSJAYVFxcXZ2NjYxMg7QQAkASkrF9/k/sAAAAASUVORK5CYII"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://svgshare.com/i/aFi.svg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>不过，要注意的是成语组成的图<strong>并不是有向无环图</strong>，有很多类似于“传宗接代 -&gt; 代代相传”这种多条边组成一个环的情况（上面的示意图中也存在环），甚至还有“为所欲为”、“国将不国”这种一条边组成一个环的情况，在查找最短路径时需要避免出现这种环。</p><p>另外图中也存在一些只有入度没有出度的顶点，比如<del>大家见了就想打的</del>“一个顶俩”的 liǎ 就是完全接不下去的……等等这个好像不算成语吧？那还有“不置可否”、“东拼西凑”、“不尴不尬”……如果以这些作为起始成语的话，那就无解了 (•́ω•̀ ٥)</p><p>图的最短路径算法有很多，比如经典的 Dijkstra 和 Floyd 算法。不过这里的“图的最短路径问题”实际上是简化版的，每一条边之间并没有 cost 的区别，所以只要让路径经过尽可能少的边就可以了，于是我就选择了使用广度优先搜索来获取路径。</p><p>后面的代码都是使用 PHP 实现的，不过使用其他语言的话做法也是一样的啦……毕竟是比较简单的算法，也不需要用到别的第三方工具库 |•ω•&#96;)</p><h1 id="预处理数据"><a href="#预处理数据" class="headerlink" title="预处理数据"></a>预处理数据</h1><p>要折腾成语接龙，首先当然需要收集一个成语数据库。自己爬取的话还是太麻烦了啊……好在这种东西很容易找到现成的，我选择了 GitHub 上的 <a href="https://github.com/pwxcoo/chinese-xinhua">pwxcoo&#x2F;chinese-xinhua</a> 这个仓库，提供的数据是将三万多个成语的信息保存进一个数组的 JSON 文件：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token property">"derivation"</span><span class="token operator">:</span> <span class="token string">"语出《法华经·法师功德品》下至阿鼻地狱。”"</span><span class="token punctuation">,</span>        <span class="token property">"example"</span><span class="token operator">:</span> <span class="token string">"但也有少数意志薄弱的……逐步上当，终至堕入～。★《上饶集中营·炼狱杂记》"</span><span class="token punctuation">,</span>        <span class="token property">"explanation"</span><span class="token operator">:</span> <span class="token string">"阿鼻梵语的译音，意译为无间”，即痛苦无有间断之意。常用来比喻黑暗的社会和严酷的牢狱。又比喻无法摆脱的极其痛苦的境地。"</span><span class="token punctuation">,</span>        <span class="token property">"pinyin"</span><span class="token operator">:</span> <span class="token string">"ā bí dì yù"</span><span class="token punctuation">,</span>        <span class="token property">"word"</span><span class="token operator">:</span> <span class="token string">"阿鼻地狱"</span><span class="token punctuation">,</span>        <span class="token property">"abbreviation"</span><span class="token operator">:</span> <span class="token string">"abdy"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    ...<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每个成语的拼音都是使用空格分割的，所以很容易取出第一个字和最后一个字的拼音。不过我没有在后续的代码中直接使用这些拼音而是将它们用整数替代了（有点像是在使用枚举），和比较字符串相比，比较整数应该是更快的吧？</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 数据来自：</span><span class="token comment">// https://github.com/pwxcoo/chinese-xinhua/blob/master/data/idiom.json</span><span class="token variable">$idioms</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'idiom.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$pinyins</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$idioms</span> <span class="token keyword">as</span> <span class="token operator">&amp;</span><span class="token variable">$idiom</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pinyin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'　'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'，'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'?'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pinyin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$pinyin</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pinyin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'start'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$pinyin</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'end'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$pinyin</span><span class="token punctuation">[</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$pinyin</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$pinyins</span><span class="token punctuation">[</span><span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token variable">$pinyins</span><span class="token punctuation">[</span><span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$pinyins</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$pinyins</span><span class="token punctuation">[</span><span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token variable">$pinyins</span><span class="token punctuation">[</span><span class="token variable">$idiom</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$pinyins</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 后续使用$pinyins[$idiom['start']]和$pinyins[$idiom['end']]来保存首尾两字的读音</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了简化代码和方便查找，这里就使用 SQLite 数据库来保存所有成语的信息：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>idioms<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INTEGER</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>    <span class="token identifier"><span class="token punctuation">`</span>word<span class="token punctuation">`</span></span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token identifier"><span class="token punctuation">`</span>pinyin<span class="token punctuation">`</span></span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token identifier"><span class="token punctuation">`</span>explanation<span class="token punctuation">`</span></span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token identifier"><span class="token punctuation">`</span>derivation<span class="token punctuation">`</span></span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token identifier"><span class="token punctuation">`</span>example<span class="token punctuation">`</span></span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token identifier"><span class="token punctuation">`</span>start<span class="token punctuation">`</span></span> <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token identifier"><span class="token punctuation">`</span>end<span class="token punctuation">`</span></span> <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_idioms_id<span class="token punctuation">`</span></span> <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>idioms<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_idioms_word<span class="token punctuation">`</span></span> <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>idioms<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>word<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_idioms_start<span class="token punctuation">`</span></span> <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>idioms<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>start<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实际上只要保存自增 ID、成语本体和首尾两字读音就可以了，以及给经常用于查找的某几列添加索引。不过似乎写入得太慢了啊……一直到 PHP 默认的三十秒执行时间限制用完了也只写入了一两百个成语，按照三万多个成语的数据量来看不知道要写到什么时候。</p><p>这实际上和 SQLite 的运行原理有关。毕竟是不需要运行后台服务的使用单文件的数据库，修改数据实际上是写入文件，但是操作系统为了减少 IO 次数一般会先将读写的文件内容保存在缓存中，每隔一段时间再统一写入硬盘（在 Linux 下这个机制称为 <a href="https://man.linuxde.net/sync">sync</a>）。为了保证对数据的每次修改都会确实地写入硬盘，SQLite 默认是<strong>每执行一个事务就等待一次 sync 操作</strong>，然后才会继续执行下一个，于是大部分时间就消耗在等待 sync 之中了，这个效率 efficiency 啊……要提速的话可以执行 <code>PRAGMA synchronous = OFF</code>（默认值是 <code>FULL</code>）禁止 SQLite 等待 sync，副作用是系统崩溃或意外断电时数据库会损坏。由于在使用预处理创建成语数据库之后也只是用于查找，并不需要修改数据，所以这么设定是没问题的。</p><p>另外 SQLite 默认会在执行事务时创建一个 <code>db-journal</code> 文件用于事务的回滚，不过每次插入成语数据时都要写入这东西也够麻烦的……而且确实也不需要回滚，所以使用 <code>PRAGMA journal_mode = MEMORY</code> 把它放到内存里。如此操作之后，所有成语的数据就可以在两秒之内写入数据库啦！( ︠ु ௰︡ू)</p><h1 id="构建遍历树和使用广度优先搜索"><a href="#构建遍历树和使用广度优先搜索" class="headerlink" title="构建遍历树和使用广度优先搜索"></a>构建遍历树和使用广度优先搜索</h1><p>对数据进行预处理之后，就需要考虑如何找到最短路径了。之前提过我选择使用广度优先搜索算法求解，在求解过程中需要从成语的图中产生一个遍历树。以“身经百战 -&gt; 栈山航海 -&gt; 海外奇谈 -&gt; 谈笑风生”这条接龙为例，对应的遍历树如图所示：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/1282*522),522px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src="https://svgshare.com/i/aFj.svg"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANBAMAAAA6ZnEvAAAAMFBMVEX////////+/v7////4+/b///////8mpuT6/f0yq+VpriRzszKx1Y252Znq8uYno9UOXm3xAAAABnRSTlP+9u/z/uMM6DkTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdUlEQVR42mNQYGBwYYBgEGBiUEtL8GNLS//HltY+LS0tjYnBLC2NLS0tvSwNIpAEEkAGMIGsZUAVIFWTgAI5B6AC06AC2TvQtORegBjaBVTltQlqRjpQedc2JAF0WxiAWhhAtsCtzQRq6YQ4TFEQDJSUILQoAF07ScUw0CG0AAAAAElFTkSuQmCC"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://svgshare.com/i/aFj.svg" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <ul><li>遍历树中的每个节点表示一个成语和它的尾字读音</li><li>产生子节点，也就是根据当前节点的尾字读音，查找以这个读音开头的成语</li><li>如果某个节点的尾字读音和给定的结束成语的首字读音相同，说明成功地找到了一个解，遍历结束</li></ul><p>这里使用一个类来表示遍历树的节点，在搜索的时候都是使用数据库中的 ID 来表示成语，并不需要考虑成语的其他信息：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">IdiomSearchNode</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token operator">?</span><span class="token class-name type-declaration">IdiomSearchNode</span> <span class="token variable">$parent</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword type-declaration">int</span> <span class="token variable">$id</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword type-declaration">int</span> <span class="token variable">$end</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name type-declaration">SQLite3</span> <span class="token variable">$db</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token class-name type-declaration">IdiomSearchNode</span> <span class="token variable">$parent</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">SQLite3</span> <span class="token variable">$db</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">parent</span> <span class="token operator">=</span> <span class="token variable">$parent</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">id</span> <span class="token operator">=</span> <span class="token variable">$id</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">db</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token punctuation">;</span>        <span class="token comment">// 获取当前节点的成语的尾字读音</span>        <span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SELECT `end` FROM `idioms` WHERE `id` = :0 LIMIT 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':0'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">id</span><span class="token punctuation">,</span> <span class="token constant">SQLITE3_INTEGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token constant">MYSQLI_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid idiom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">end</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/** @return IdiomSearchNode[] */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getChildren</span><span class="token punctuation">(</span><span class="token keyword type-declaration">array</span> <span class="token operator">&amp;</span><span class="token variable">$set</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 查找以尾字读音开头的成语</span>        <span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SELECT `id` FROM `idioms` WHERE `start` = :0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':0'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">end</span><span class="token punctuation">,</span> <span class="token constant">SQLITE3_INTEGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$execute</span> <span class="token operator">=</span> <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$execute</span><span class="token operator">-></span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token constant">SQLITE3_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// $set的作用稍后会提及</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$set</span><span class="token punctuation">[</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token variable">$set</span><span class="token punctuation">[</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>            <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdiomSearchNode</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">db</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>广度优先搜索一般都是使用队列的方式实现的。以上面的遍历树示意图为例，在求解时遍历和产生子节点的顺序如下：</p><ul><li>初始化队列，加入根节点“身经百战”</li><li>取出“身经百战”，找到以 zhàn 开始的成语“战火纷飞”、“栈山航海”、“战战兢兢”……依次加入队列</li><li>取出“战火纷飞”，找到以 feī 开始的成语“飞蛾扑火”，加入队列</li><li>取出“栈山航海”，找到以 hǎi 开始的成语“海市蜃楼”、“海外奇谈”……依次加入队列</li><li>此时可以注意到，“海外奇谈”已经可以接上给定的结束成语“谈笑风生”了，所以结束遍历</li><li>从“海外奇谈”开始往上回溯父节点“栈山航海”和“身经百战”，再把结束成语“谈笑风生”加上，由此就可以构造出“身经百战 -&gt; 栈山航海 -&gt; 海外奇谈 -&gt; 谈笑风生”这个解</li></ul><p>前面也提过，在图中查找最短路径时，要避免路径产生环而出现死循环，所以需要将已经遍历过的成语保存到一个集合中，在将成语加入队列前要检查这个成语之前是否已经遍历过（集合中是否已有该成语）。PHP 中并没有集合的数据结构啊……不过，根据以下的一些事实：</p><ul><li>PHP 的数组的底层实现，实际上就是插入和查找的时间复杂度为常数阶的哈希表（参见<a href="https://stackoverflow.com/questions/3134296#answer-3134315">这里</a>）</li><li>使用 <code>isset($arr[$item])</code> 比 <code>in_array($item, $arr)</code> 和 <code>array_key_exists($item, $arr)</code> 更快（参见<a href="https://stackoverflow.com/questions/8409249#answer-21759158">这里</a>）</li></ul><p>因为这里只需要考虑整型的成语 ID，因此完全可以使用一个数组来模拟实现集合，向集合中加入元素就是将数组中成语 ID 的 key 对应的值设为任意 <code>null</code> 之外的值，使用 <code>isset</code> 判断集合中是否存在某元素。</p><p>使用广度优先搜索来搜索路径的完整代码如下：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$idiomDb</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLite3</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'idioms.db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 保存成语ID的集合</span><span class="token variable">$set</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 搜索时使用的队列</span><span class="token variable">$queue</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SplQueue</span><span class="token punctuation">;</span><span class="token comment">// 在数据库中查找给定的起始和结束的成语</span><span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$idiomDb</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SELECT * FROM `idioms` WHERE `word` = :0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':0'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">SQLITE3_TEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$idiomStart</span> <span class="token operator">=</span> <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token constant">SQLITE3_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':0'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">SQLITE3_TEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$idiomEnd</span> <span class="token operator">=</span> <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token constant">SQLITE3_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$idiomStart</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$idiomEnd</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid idiom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从起始成语开始创建第一个要遍历的节点</span><span class="token variable">$queue</span><span class="token operator">-></span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdiomSearchNode</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$idiomStart</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$idiomDb</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$set</span><span class="token punctuation">[</span><span class="token variable">$idiomStart</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token variable">$set</span><span class="token punctuation">[</span><span class="token variable">$idiomEnd</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 循环从队列中取出和加入节点进行广度优先遍历，一直遍历到找到解或无解为止</span><span class="token variable">$found</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$queue</span><span class="token operator">-></span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token variable">$found</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** @var IdiomSearchNode */</span>    <span class="token variable">$node</span> <span class="token operator">=</span> <span class="token variable">$queue</span><span class="token operator">-></span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$children</span> <span class="token operator">=</span> <span class="token variable">$node</span><span class="token operator">-></span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token variable">$set</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 打乱子节点的顺序，稍后说明作用</span>    <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token variable">$children</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$children</span> <span class="token keyword">as</span> <span class="token variable">$child</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 如果有可以接上结束成语的子节点就结束遍历，否则加入队列</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$child</span><span class="token operator">-></span><span class="token property">end</span> <span class="token operator">===</span> <span class="token variable">$idiomEnd</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$found</span> <span class="token operator">=</span> <span class="token variable">$child</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$queue</span><span class="token operator">-></span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token variable">$child</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有些成语之间最短的接龙是不唯一的，但是按照以上流程只会得到固定的一个解。如果将算法随机化，也就是在遍历节点时将它产生的子节点随机打乱顺序再加入队列，每次运行算法就有可能得到不同的解了。</p><p>还是使用上面的从“身经百战”接到“谈笑风生”作为例子，除了“身经百战 -&gt; 栈山航海 -&gt; 海外奇谈 -&gt; 谈笑风生”之外，还有“身经百战 -&gt; 战战兢兢 -&gt; 经验之谈 -&gt; 谈笑风生”的解法。按照默认顺序会先遍历到“栈山航海”，然后发现子节点中的“海外奇谈”可以接到结束成语，由此得到第一个解。但是打乱的话就有可能先遍历到“战战兢兢”，从而得到第二个解。</p><p>搜索结束后就可以通过回溯的方式来构造解，在构造解的时候还可以一并读取成语的其它信息：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$solve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span><span class="token variable">$found</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$idiomEnd</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$idiomEnd</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$idiomEnd</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">array_unshift</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token variable">$idiomEnd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$idiomDb</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'        SELECT            `word`, `pinyin`, `explanation`,            `derivation`, `example`        FROM `idioms`        WHERE `id` = :0        LIMIT 1    '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$found</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':0'</span><span class="token punctuation">,</span> <span class="token variable">$found</span><span class="token operator">-></span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">array_unshift</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token variable">$statement</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token constant">SQLITE3_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$found</span> <span class="token operator">=</span> <span class="token variable">$found</span><span class="token operator">-></span><span class="token property">parent</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="成品和一些结论"><a href="#成品和一些结论" class="headerlink" title="成品和一些结论"></a>成品和一些结论</h1>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/3806*2367),2367px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-avif="https://vfile.meituan.net/mmdb/5801c33e5842a77ceb26ab5dd657ebf060658.jpg" data-src-webp="https://p.sda1.dev/12/ed11aa23f37385c63c7e0599d14fcd1b/PF3IWLDw.webp" data-src="https://p.sda1.dev/12/50a479f8ac1a5dd89fab8c94ef9ca946/kAQ0RZ44.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAUACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAUBAgQGB//EACcQAAEDAwEHBQAAAAAAAAAAAAEAAgQDBhEhBRIWMVWTwRQiMlFy/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAED/8QAGxEAAgEFAAAAAAAAAAAAAAAAAAEDAhFDUZH/2gAMAwEAAhEDEQA/AO6cNW/0iJ2mpRKt3Y3qCGQ41NuBoI7HeFsSpXBMl2C4HdHxwtFNKslXS3exDQtrZDX5fEi1RjkY9MeE14at7pEPtNWUwOHN7j+lZHNK8lXRd7BRUYNX5OcfaELMgMHtGpUoQgP/2Q"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/50a479f8ac1a5dd89fab8c94ef9ca946/kAQ0RZ44.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>你可以前往 <a href="https://i.akarin.dev/idioms-solitaire/">https://i.akarin.dev/idioms-solitaire/</a> 亲自体验一下～(*′ ▽‘)</p><p>除了支持输入起始和结束的成语进行接龙，也可以直接输入起始和结束的拼音。比如你可以来一条可以接到 yí 的接龙，这样就可以在和别人玩接龙的时候把对方的任意成语都接到“一个顶俩”<del>然后被对方真人快打</del>。也可以像 V 字头论坛的某君一样接到“○○可爱”上，嗯……用这个发狗粮是没关系的。</p><p>当然直接输入“一个顶俩”是不行的，因为它并没有被收录到我使用的成语数据库中。</p><p>随机取两个成语进行接龙的话，得到的最短接龙长度（包括起始和结束的成语）都在 3 到 5 之间。在平均情况下，每次运行这个算法时一般只需要遍历一二十个甚至个位数的节点，内存占用不超过 800 KB，运行时间不超过 10 ms。我测试时碰到的最坏情况是从“方寸已乱”接到“操觚染翰”，接龙长度为 5，求解时需要遍历的节点数从 25 到 550 个不等（由于将算法随机化了，所以每次运行时遍历的节点数会有区别），在遍历节点最多的最坏情况下内存占用 3 MB，运行时间 200 ms，可以说这个算法运行起来还是相当快的。</p><p>有没有办法再快一点呢？因为求解的过程中“查找以○开头的成语”这个操作执行得非常频繁，完全可以不使用 SQL 语句来查找，而是预先准备好一张记录了每个拼音对应的以该拼音开头的所有成语 ID 的表，在产生子节点的时候直接查表就可以了。根据我自己的测试，使用查表法可以使平均情况下的运行时间再降低一个数量级，但是这个表本身会占用 5 MB 的内存，典型的空间换时间 (′゜ω。‵)</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/66567478">Pixiv ID: 66567478 「HAPPYNEWYEAR　2018」 by チノマロン</a></p><p>不过因为现在已经是 2021 年了，我就自己把图上的“HappyNewYear 2018”去掉了。</p></blockquote><hr><p>更新一个使用 JavaScript 的实现，你可以将<a href="https://pastebin.com/9JkTvdTY">这里</a>的代码粘贴到浏览器的控制台，然后随意尝试～</p><ul><li>直接使用 jsDelivr 的 CDN 从上面提到的 GitHub 仓库在线加载成语数据，大约需要消耗流量 3.5 MB</li><li>未对拼音创建枚举，因此使用的是直接比较字符串是否相等</li><li>未打乱子节点，因此得到的接龙是固定的</li><li>执行时会在控制台中输出遍历的节点数和运行时间，不过没有统计内存占用情况</li></ul>]]></content>
    
    
    <summary type="html">这也是个可以使用数据结构和算法的知识来解决的问题…_φ(･ω･` )</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>使用 C 语言和 Emscripten 编写自己的 WebAssembly 模块</title>
    <link href="https://akarin.dev/2020/10/10/build-webassembly-module-with-c/"/>
    <id>https://akarin.dev/2020/10/10/build-webassembly-module-with-c/</id>
    <published>2020-10-10T03:24:34.000Z</published>
    <updated>2020-10-10T03:24:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>和 JavaScript 一样，WebAssembly 也是一种可以在浏览器中运行的编程语言，不过它的性质更相当于汇编语言。wasm 文件由二进制的<a href="https://pengowray.github.io/wasm-ops/">字节码</a>组成（也可以转换为类似于汇编语言的文本格式查看），可以<strong>从 C&#x2F;C++、Rust 等编译执行的编程语言生成</strong>。当然，WebAssembly 也是跨平台的，编译出来的 wasm 文件在不同平台的浏览器中都可以运行。</p><p>WebAssembly 最大的特性就是和解释执行的 JS 相比的<strong>超高性能</strong>，甚至还可以将用其它语言编写的项目通过编译到 wasm 的方式<strong>移植到浏览器中运行</strong>（例如<a href="http://www.dnbwg.com/emularity.html?machine=touhou-fumaroku">这个</a>使用 wasm 版的 DOSBox 运行的《东方封魔录》，运行起来也十分流畅）。不过我开这篇并不是为了去编译那些大型项目的……由于几乎每个接受过计算机相关教育的人都学习过 C 语言，自己用 C 写一个简单的 wasm 模块来提升前端代码的性能，是门槛并不高而且也很有意思的一件事情。</p><h1 id="从运行一个简单的模块开始"><a href="#从运行一个简单的模块开始" class="headerlink" title="从运行一个简单的模块开始"></a>从运行一个简单的模块开始</h1><p>要将 C&#x2F;C++ 代码编译到 wasm 模块，我们需要准备好 <a href="https://emscripten.org/docs/getting_started/downloads.html">Emscripten</a> 环境。</p><blockquote><p>即使是 Windows 用户，也可以在 WSL 里面直接安装。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/emscripten-core/emsdk.git<span class="token builtin class-name">cd</span> emsdk<span class="token function">git</span> pull./emsdk <span class="token function">install</span> latest./emsdk activate latest<span class="token comment"># 以后每次打开shell都要执行下面这行</span><span class="token comment"># 如果不想每次都手动操作的话可以写到.bashrc里面</span><span class="token builtin class-name">source</span> ./emsdk_env.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>WebAssembly 的运行环境本身只能执行计算任务，加载 wasm 模块时还需要导入一个包含 JS 函数、内存区等属性的对象，wasm 和浏览器的交互只能通过调用这些 JS 函数完成，内存区则是和运行环境外面的 JS 代码共享，可以用来交换数据。Emscripten 的功能不仅是编译 C&#x2F;C++ 代码生成 wasm，它还可以生成一大堆 JS 的“胶水代码”用来连接浏览器和 WebAssembly 运行环境，实现 C&#x2F;C++ 的那些标准库，对内存分配、输入输出等进行处理。</p><p><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/C_to_wasm#%E7%94%9F%E6%88%90_HTML_%E5%92%8C_JavaScript">MDN 上的教程</a>就给出了一个从 Hello world 编译出 wasm 文件和对应的胶水代码、HTML 文件的例子。不过这胶水代码比 wasm 文件本身还大了不少……如果模块比较简单的话还是不太好的。好在 Emscripten 支持通过编译选项 <code>-s SIDE_MODULE=1</code> 使编译出来的 wasm 文件<a href="https://github.com/emscripten-core/emscripten/wiki/WebAssembly-Standalone#create-a-dynamic-library">作为一个单独的动态库</a>，这样就不需要那一堆胶水代码了，不过与 JS 部分的交互也需要自己完成。各种用到的标准库函数，需要自己在 C&#x2F;C++ 里实现（<code>memset</code>、<code>memcpy</code> 和 <code>strlen</code> 之类的比较简单的可以直接抄 <a href="https://github.com/emscripten-core/emscripten/tree/main/system/lib/libc">Emscripten 的实现</a>），或者在 JS 里通过操作内存区实现后导入 wasm 模块。</p><p>根据 <a href="https://github.com/emscripten-core/emscripten/blob/aa66f92b790c8d319d1599d44657a6305bf74a8a/src/settings.js#L953">Emscripten 的说明</a>，<code>SIDE_MODULE</code> 可以设为 1 和 2，区别在于前者会导出 C&#x2F;C++ 代码里所有的函数，后者会把没有用到的代码删减掉，这时就需要自己 <code>#include &lt;emscripten/emscripten.h&gt;</code> 然后手动在需要导出的函数前面加上 <code>EMSCRIPTEN_KEEPALIVE</code>。</p><p>从一个简单的计算两数相乘的模块开始。因为这只是一个函数库，所以 main 函数是不需要的，而且就算写了也不会在加载的时候自动执行。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">EMSCRIPTEN_KEEPALIVE<span class="token keyword">int</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>编译，<code>-O3</code> 代表使用最高速度的编译优化：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">emcc multiply.c <span class="token parameter variable">-O3</span> <span class="token parameter variable">-s</span> <span class="token assign-left variable">SIDE_MODULE</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-o</span> multiply.wasm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也可以使用 <code>-Oz</code> 表示使编译出来的文件大小更小的编译优化，当然运行起来就会慢很多。</p><p>在 HTML 中使用以下的 JS 代码加载（目前 <code>importObject</code> 还可以省略不写）：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'multiply.wasm'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming"><code>WebAssembly.instantiateStreaming</code></a> 加载更简洁，但是需要提供正确的 MIME 类型 <code>application/wasm</code>。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'multiply.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    importObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>另外，上面的两种写法都是异步加载模块的，这是因为如果是同步加载大型模块的话会出现较长时间的阻塞（Chrome 甚至自己规定了同步加载的模块不能超过 4 KB）。如果模块较小，加载时间可以忽略不计，而且也需要在同步执行的代码中使用模块的话，可以将模块的二进制数据以 <code>Uint8Array</code> 的格式（不过更建议从 Base64 字符串转换过来，代码更简短）写进 JS 代码，然后用下面的写法加载：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 以后创建wasmModule时可以复用m，不需要重新加载</span><span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>加载完成后，就可以通过 <code>wasmModule.exports</code> 找到模块导出的函数了。WebAssembly 也是强类型的（32&#x2F;64 位整数&#x2F;浮点数），所以在这个例子中如果使用了小数会自动进行类型转换，并不能得到正确的结果，另外也需要注意溢出的问题。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/542*494),494px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/9b5bf6e63f452a429a4ca1d247d8d9bb/1mHZIpqJ.webp" data-src="https://p.sda1.dev/12/303c73def7aac416cee55273e75b302e/cc5lAleQ.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAdACADASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAABAACAwUH/8QAKhAAAgEDAgQEBwAAAAAAAAAAAQIRAAMhEkEEEzFhFSMkwUJRcoGSodH/xAAXAQADAQAAAAAAAAAAAAAAAAAAAQID/8QAGREBAQEAAwAAAAAAAAAAAAAAAREAAhIx/9oADAMBAAIRAxEAPwD3TixYAARQpk5INZW7TsuhQsz8jAre/eQkw6ySfiA2ih6cZ0ZwcjatDqFWOhpyGZXh/EkZNr7E0rh+Hv2CSVtGe5HtQktK+VEmZhYPvTQqdeWAevSpUvuZVsmMtx1cw5AM50E71rzXAPmn8DRLl1rVwFGYEg5GnYntXQVGZQec+RO38qVHO3US80ibrETEaIq9Tkvn1FzP04/VQCABJPejG//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/303c73def7aac416cee55273e75b302e/cc5lAleQ.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>以下是对应的“汇编代码”，<code>$multiply</code> 就是上面的相乘函数了：</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span><span class="token punctuation">)</span>    <span class="token keyword">nop</span>  <span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$multiply</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p0</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p1</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>    <span class="token keyword">local</span>.get <span class="token variable">$p0</span>    <span class="token keyword">local</span>.get <span class="token variable">$p1</span>    <span class="token keyword">i32<span class="token punctuation">.</span>mul</span>  <span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$__dso_handle</span> <span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__wasm_apply_relocs"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"multiply"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$multiply</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__dso_handle"</span> <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__post_instantiate"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>使用 VSCode 的扩展 <a href="https://marketplace.visualstudio.com/items?itemName=dtsvet.vscode-wasm">WebAssembly</a> 可以以文本格式显示打开的 wasm 文件，并且可以在两种格式之间相互转换。</p></blockquote><h1 id="使用外部函数、内存和指针"><a href="#使用外部函数、内存和指针" class="headerlink" title="使用外部函数、内存和指针"></a>使用外部函数、内存和指针</h1><p>接下来是做一件每种编程语言的初学者都喜欢做的事：输出一个 Hello world。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">void</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"WebAssembly模块测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编译……等下，既然是编译到 WebAssembly 了，那从哪里找到标准库 <code>stdio.h</code> 和这个 <code>puts</code> 呢？看一下文本格式代码：</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"env"</span> <span class="token string">"puts"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$env.puts</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"env"</span> <span class="token string">"__memory_base"</span> <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$env.__memory_base</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"env"</span> <span class="token string">"memory"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token variable">$env.</span><span class="token keyword">memory</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span><span class="token punctuation">)</span>    <span class="token keyword">nop</span>  <span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$hello_world</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span><span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$l0</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>    <span class="token keyword">global</span>.get <span class="token variable">$env.__memory_base</span>    <span class="token keyword">local</span>.tee <span class="token variable">$l0</span>    <span class="token keyword">call</span> <span class="token variable">$env.puts</span>    <span class="token keyword">drop</span>    <span class="token keyword">local</span>.get <span class="token variable">$l0</span>    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span>    <span class="token keyword">i32<span class="token punctuation">.</span>add</span>    <span class="token keyword">call</span> <span class="token variable">$env.puts</span>    <span class="token keyword">drop</span>  <span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$__dso_handle</span> <span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__wasm_apply_relocs"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"hello_world"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$hello_world</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__dso_handle"</span> <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__post_instantiate"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token variable">$d0</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$env.__memory_base</span><span class="token punctuation">)</span> <span class="token string">"Hello world!\00WebAssembly\e6\a8\a1\e5\9d\97\e6\b5\8b\e8\af\95\00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>puts</code> 是需要自己从 JS 中导入的。在 C 的代码里实际上也可以不写 <code>#include &lt;stdio.h&gt;</code>，直接用 <code>int puts(const char *str);</code> 声明也是没问题的。</p><p>字符串被全部写进了一个数据段（汉字部分和源代码一样使用了 UTF-8 编码）。在加载 wasm 模块的时候需要提供一块内存区域用来从某个偏移位置开始保存这些数据。</p><p>这里就先使用 <code>console.log</code> 代替 <code>puts</code>，并且创建一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory"><code>WebAssembly.Memory</code></a> 作为内存区域，通过一个对象（也就是上面的 <code>importObject</code>）传递给要加载的 wasm 模块：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmMemory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> wasmBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'hello-world.wasm'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">puts</span><span class="token operator">:</span> console<span class="token punctuation">.</span>log<span class="token punctuation">,</span>            <span class="token literal-property property">memory</span><span class="token operator">:</span> wasmMemory<span class="token punctuation">,</span>            <span class="token literal-property property">__memory_base</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>WebAssembly.Memory</code> 是一块用于 wasm 模块的内存，以 64 KB 为一“页”作为分配的基本单位，也可以在创建后动态扩容。在 JS 中可以通过 <code>TypedArray</code> 对它进行读写。</p></blockquote><p>加载并执行一下试试看：</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/723*329),329px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/90e9e500482c6a0a2c773c749398e991/aWl1K20Z.webp" data-src="https://p.sda1.dev/12/56d66ddea394f573c6fd8e45b062059c/er1Cjn15.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAPACADASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAwQAAQf/xAAgEAACAQIHAQAAAAAAAAAAAAABAgADEQQSEyExUdFS/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgAB/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQAREiH/2gAMAwEAAhEDEQA/ANzrqlVwKQ62uINsPVYrdIcLTZiMxvboeQmiu3gj7QMs91ZelhipBfjoExwAAWAlaafAkCKOFEFF/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/56d66ddea394f573c6fd8e45b062059c/er1Cjn15.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>字符串被写入了内存中从 <code>__memory_base</code> 开始的位置，而和 C 语言一样，调用 <code>puts</code>（实际上是 <code>console.log</code>）的参数是字符串开始的指针（数组下标）。如果自己实现一个 <code>puts</code>，就可以将字符串输出到控制台（或者是页面上某个 DOM 的 innerText）了。</p><blockquote><p>顺便一提，有个叫 <a href="https://github.com/locutusjs/locutus">Locutus</a> 的库尝试使用 JS 实现其他语言的标准库，虽然对于 C 的实现并不多……</p><p>比如要实现 <code>sprintf</code> 或 <code>printf</code>，就可以参考<a href="https://github.com/locutusjs/locutus/blob/master/src/c/stdio/sprintf.js">这里</a>。</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmMemory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> wasmBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'hello-world.wasm'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 将从指针开始到下一个0x00之间的数据用UTF-8解码，然后用console.log输出</span>            <span class="token function-variable function">puts</span><span class="token operator">:</span> <span class="token parameter">ptr</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>                <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>                    wasmBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>                        ptr<span class="token punctuation">,</span>                        wasmBuffer<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i <span class="token operator">>=</span> ptr <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>e<span class="token punctuation">)</span>                    <span class="token punctuation">)</span>                <span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token literal-property property">memory</span><span class="token operator">:</span> wasmMemory<span class="token punctuation">,</span>            <span class="token literal-property property">__memory_base</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/705*749),749px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/a6c97377e4802b4665204cab5c1cf9c3/SLwsimdL.webp" data-src="https://p.sda1.dev/12/d7b12345e092a1e4908e074d5eb065b4/7KUNX1IK.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgAB4DASIAAhEBAxEB/8QAGQAAAwADAAAAAAAAAAAAAAAAAAMEAgUH/8QAJRAAAgIBAgUFAQAAAAAAAAAAAQIAEQMEIRIxMlGhE0FCYXGR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQACMVH/2gAMAwEAAhEDEQA/AO863TEANjX9HapBk6huv9m1JoExV4MuRTTBvpRXkTedJR1fSRpsJBDFQy+1HaWQCEfM+IcJvrPiYgomfL6u1tXLhBJlCjJsS5qTWQ5ARWrshJlaBqHKu3DUVmzhCEKv/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/d7b12345e092a1e4908e074d5eb065b4/7KUNX1IK.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>试着将内存中的第一个单元的数据改成 <code>0x41</code>（也就是字母 A），再次调用函数，可以看到输出的内容也发生了相应的变化。当然，实际使用的时候，如果需要向内存中写入数据，就要根据 <code>__memory_base</code> 和代码中数据段的大小自己预留好内存空间，避免覆盖了 wasm 模块内部使用的数据。</p><p>如果代码中需要用到局部变量，根据常识可以知道这些变量是存储在栈里的，编译出的 wasm 也会要求引入 <code>__stack_pointer</code> 用来设置栈指针：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>    <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">__stack_pointer</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Global</span><span class="token punctuation">(</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">mutable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'i32'</span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token number">0x1000</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>和真实的 CPU 一样，栈指针也是向低地址延伸的，于是我们就得到了这样的一个简单的进程地址空间模型：<code>| 只读数据 | &lt;- 栈 | 堆 -&gt; |</code>，这已经开始有点涉及到操作系统的知识了……</p><p>既然提到堆了，能不能用 <code>malloc</code> 和 <code>free</code> 在堆上动态分配内存呢？然而，即使不考虑性能，一个完整的内存分配器非常复杂，在这种编译为 <code>SIDE_MODULE</code> 的简单模块的情况下是无法使用的，这里不再深入介绍。<a href="https://surma.dev/things/c-to-webassembly/">这篇文章</a>的“Building an allocator”部分提出了一种简单的替代方法：分配的内存地址只是从堆的起始地址开始不断累加已分配的内存大小，至于 <code>free</code>？直接空着。</p><h1 id="一个使用-WebAssembly-将性能提高到-30x-的例子"><a href="#一个使用-WebAssembly-将性能提高到-30x-的例子" class="headerlink" title="一个使用 WebAssembly 将性能提高到 30x 的例子"></a>一个使用 WebAssembly 将性能提高到 30x 的例子</h1><p>接下来就用一个实际的例子，来展示 WebAssembly 和 JS 相比在计算密集型任务上的超高性能。我分别用 WebAssembly 和 JS 试着实现了一遍 <a href="https://zh.wikipedia.org/wiki/RC4">RC4 加解密算法</a>。为什么用了 RC4 作为例子？</p><ul><li>加密和解密涉及到大量的计算操作</li><li>RC4 的算法简短，且加密和解密是同一套算法，易于实现</li><li>RC4 是流密码，对明文和密钥的长度<abbr title="明文长度不限，密钥长度 40-2048 位">要求不多</abbr>，也不需要像分组密码一样处理不同的工作模式，易于使用</li><li>有一定的实用性（虽然现在 RC4 的安全性已经比较有限了……）</li></ul><p>以下是来自 Wikipedia 的伪代码：</p><pre class="line-numbers language-none"><code class="language-none">for i from 0 to 255    S[i] :&#x3D; iendforj :&#x3D; 0for( i&#x3D;0 ; i&lt;256 ; i++)    j :&#x3D; (j + S[i] + key[i mod keylength]) % 256    swap values of S[i] and S[j]endfori :&#x3D; 0j :&#x3D; 0while GeneratingOutput:    i :&#x3D; (i + 1) mod 256    j :&#x3D; (j + S[i]) mod 256    swap values of S[i] and S[j]    k :&#x3D; inputByte ^ S[(S[i] + S[j]) % 256]    output Kendwhile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>照着伪代码，用 JS 实现一遍（经检验，实现完全正确，检验过程略）：</p><p><details><summary>使用 JS 的实现</summary><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * @param &#123;Uint8Array&#125; key * @param &#123;Uint8Array&#125; input * @returns &#123;Uint8Array&#125; */</span><span class="token keyword">const</span> <span class="token function-variable function">jsRc4</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> input</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> keyLength <span class="token operator">=</span> key<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">const</span> inputLength <span class="token operator">=</span> input<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">const</span> sbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> keyLength<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>        <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>inputLength<span class="token punctuation">)</span><span class="token punctuation">;</span>    i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> inputLength<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>        <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        output<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">^</span> sbox<span class="token punctuation">[</span><span class="token punctuation">(</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> output<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details></p><p>然后移植到 C 语言 <del>一看就是一个模子刻出来的</del>：</p><p><details><summary>使用 C 语言的实现，以及相关的 JS 胶水代码</summary><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sbox<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">rc4</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>input<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> keyLength<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inputLength<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> temp<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// j = (j + sbox[i] + key[i % keyLength]) &amp; 0xFF;</span>        j <span class="token operator">+=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> keyLength<span class="token punctuation">]</span><span class="token punctuation">;</span>        temp <span class="token operator">=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> inputLength<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>        <span class="token comment">// j = (j + sbox[i]) &amp; 0xFF;</span>        j <span class="token operator">+=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        temp <span class="token operator">=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>        input<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">^=</span> sbox<span class="token punctuation">[</span><span class="token punctuation">(</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmMemory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> wasmInstance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'rc4.wasm'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">memory</span><span class="token operator">:</span> wasmMemory<span class="token punctuation">,</span>            <span class="token literal-property property">__memory_base</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/** * @param &#123;Uint8Array&#125; key * @param &#123;Uint8Array&#125; input * @returns &#123;Uint8Array&#125; */</span><span class="token keyword">const</span> <span class="token function-variable function">wasmRc4</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> input</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 内存的分布：前256字节保留给S盒，然后是x字节的密钥和x字节的输入</span>    <span class="token comment">// 如果内存不足则进行扩容</span>    <span class="token keyword">const</span> sboxOffset <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> memoryRequired <span class="token operator">=</span> key<span class="token punctuation">.</span>length <span class="token operator">+</span> input<span class="token punctuation">.</span>length <span class="token operator">+</span> sboxOffset<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryRequired <span class="token operator">></span> wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        wasmMemory<span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>memoryRequired <span class="token operator">-</span> wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">65536</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> wasmBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    wasmBuffer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sboxOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>    wasmBuffer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    wasmInstance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">rc4</span><span class="token punctuation">(</span>sboxOffset<span class="token punctuation">,</span> sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span> sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length <span class="token operator">+</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details></p><p>测试则是使用 <del>1KB 的随机密钥</del>，分别使用两种实现来加密 4KB、8KB……128MB 的同一份随机数据，并比较执行时间。</p><p><em>测完才意识到其实并不需要这么长的密钥……<strong>超过前 256 字节的部分是没有意义的</strong>，不过这也不会影响测试结果，所以就不重新测啦！</em></p><p><details><summary>测试代码</summary><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> inputLength <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    inputLength <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> rc4Key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> rc4Input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>inputLength<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'wasm-start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> wasmEncrypted <span class="token operator">=</span> <span class="token function">wasmRc4</span><span class="token punctuation">(</span>rc4Key<span class="token punctuation">,</span> rc4Input<span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'wasm-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'js-start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> jsEncrypted <span class="token operator">=</span> <span class="token function">jsRc4</span><span class="token punctuation">(</span>rc4Key<span class="token punctuation">,</span> rc4Input<span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'js-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'wasm'</span><span class="token punctuation">,</span> <span class="token string">'wasm-start'</span><span class="token punctuation">,</span> <span class="token string">'wasm-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'js-start'</span><span class="token punctuation">,</span> <span class="token string">'js-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> inputLength<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>wasmEncrypted<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!==</span> jsEncrypted<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">'Not equal'</span><span class="token punctuation">;</span>    results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">length</span><span class="token operator">:</span> inputLength<span class="token punctuation">,</span>        <span class="token literal-property property">wasmTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'wasm'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>duration<span class="token punctuation">,</span>        <span class="token literal-property property">jsTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>duration<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    performance<span class="token punctuation">.</span><span class="token function">clearMeasures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>    <span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> acc<span class="token punctuation">)</span> acc<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> cur<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> acc<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>        <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token literal-property property">wasmTime</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token literal-property property">jsTime</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>results<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    r<span class="token punctuation">.</span>wasmSpeed <span class="token operator">=</span> r<span class="token punctuation">.</span>length <span class="token operator">/</span> r<span class="token punctuation">.</span>wasmTime<span class="token punctuation">;</span>    r<span class="token punctuation">.</span>jsSpeed <span class="token operator">=</span> r<span class="token punctuation">.</span>length <span class="token operator">/</span> r<span class="token punctuation">.</span>jsTime<span class="token punctuation">;</span>    r<span class="token punctuation">.</span>ratio <span class="token operator">=</span> r<span class="token punctuation">.</span>wasmSpeed <span class="token operator">/</span> r<span class="token punctuation">.</span>jsSpeed<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details></p><p>至于测试结果嘛……首先是在我自己日常用的 Firefox 上测试，性能直接提升了 8x！（最后一行是以上测试结果的总和）</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/533*558),558px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/e5dbc87fb856c56b1c716361c44dd66b/qVU1IkB2.webp" data-src="https://p.sda1.dev/12/d5774021459982bf29a49a602a368de7/t23nhwV1.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgAB8DASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAABAUAAgEDB//EACsQAAEDAgUCBAcAAAAAAAAAAAECAxEAEgQTITFBBSIUMkJhIyQzNHGSsf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDtYCouQw4YVbPZvPuqtriXwlVzLkASR2bftWcGSA8nSM5JgJIG9G4qLMTt9IcTyaBYAlLQcOGcsOg1T+OFVZvKccsDCxzJI2ieDUdyh0tsCyQuSLP6BVsAYxRjawAwgjYaa0FMG4M51IWIK0SMyfVAo7GqhT6ZH25MXRsaVJUtLqj3nXTsToQoGmWPK88hIVqwoaAGgVg/JuGQe5Mw77HmmPTIz3NR5B67qASHPCuD4hJWmO1M80f04lLrshXlESAKD//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/d5774021459982bf29a49a602a368de7/t23nhwV1.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>然后是 Chrome 上的测试结果。即使是面对使用了性能最强的 V8 引擎的 Chrome，WebAssembly 的性能优势仍然能达到 2x（虽然速度和 Firefox 那边差不多……）</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/727*540),540px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/34ac61597849188263eeccc1b9cfbdbf/K5mwAgo4.webp" data-src="https://p.sda1.dev/12/ad17468aa7c43566663ea46ea18436c1/ZnKKKLOz.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMBBAcG/8QAJRAAAQQBAwMFAQAAAAAAAAAAAQACAxIEByExBRRBERMjUXPR/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAMAwEAAhEDEQA/AOifprhvjs7Nl5IAJaqk2lnRzEDJlz38VoVqUkg7Y7cSlVrih2SjL2aS9IkdE1mbk782qFI0j6X6gd5Pu+i1bHf8kH2ZE6BwOQAePdKt0V3FlHt8X/qUKFhQhQOgLLw/onwlvdD9ChCD/9k"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/ad17468aa7c43566663ea46ea18436c1/ZnKKKLOz.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>至于标题上的 30x……是在已经弃坑的旧版 Edge 里面测出来的，不过不论是 WebAssembly 还是 JS 这执行速度都比另外两个差了一大截。</p>                    <figure class="akarin-blurred-container">                        <div style="padding-bottom:min(calc(100%/648*498),498px,480px)"></div>                        <img                            class="mdui-img-rounded mdui-hoverable"                            data-src-webp="https://p.sda1.dev/12/e5194235540816202b54cce3a19b03d2/X5Yl15XJ.webp" data-src="https://p.sda1.dev/12/b6a400aac6c1a2fa0778d8cf88a5f41e/-WLog8bd.png"                        >                        <img                            class="mdui-img-rounded mdui-hoverable akarin-blurred"                            src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAZACADASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAABAACBQMH/8QAJBAAAgEDBAICAwAAAAAAAAAAAQIDAAQREiExQRMyQrEFUXH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAAL/xAAZEQEBAQADAAAAAAAAAAAAAAABAgASMVH/2gAMAwEAAhEDEQA/APW4Px1nYxvJDaImvYhTksVPeRSnkjeDLxtzjR1tUlV3ttK+wlbsCjNDOIVGNyx4w2eP1WqqqrlVK+rszMzPGZA8DKWO2cxhLSM6h8mYb1aG1t5JEUWcQ1E76m6qlksizQeQEYJ5pFnlbiEtxl/qhV7ckh0BhSM/ilAHDk1ySWVIQykhgzYOONhW8Kh6ozsyznmmuIWlJJ33pFiSbiLI+T/VNi91/pqRe6Va3//Z"                                                                                >                        <noscript>                            <img                                class="mdui-img-fluid mdui-img-rounded mdui-center mdui-hoverable"                                src="https://p.sda1.dev/12/b6a400aac6c1a2fa0778d8cf88a5f41e/-WLog8bd.png" alt="undefined" title="undefined"                            >                        </noscript>                    </figure>                <p>（IE 不资辞 WebAssembly，直接爬吧）</p><p>你也可以在<a href="https://jsbin.com/taxocoripu/edit?html,output">这里</a>自己试试看～（wasm 文件已经以 Data URL 的形式嵌入了）</p><p>结论是显而易见的，WebAssembly 的性能比 JS 不知道高到哪里去了。而且如果不写清楚函数名的话，直接对着它的“汇编代码”很难看出是 RC4 算法，所以把一些关键操作放进 wasm 模块或许也是个防止前端代码被逆向的好主意？</p><p>即使不熟悉 C 语言和 Emscripten 的那一套工具，GitHub 上也有 <a href="https://github.com/ballercat/walt">Walt</a> 和 <a href="https://github.com/AssemblyScript/assemblyscript">AssemblyScript</a> 这样的工具可以直接使用 TypeScript 的语法编写 wasm 模块，以后再试试看吧～</p><h1 id="Extra：WebAssembly-的-SIMD-支持"><a href="#Extra：WebAssembly-的-SIMD-支持" class="headerlink" title="Extra：WebAssembly 的 SIMD 支持"></a>Extra：WebAssembly 的 SIMD 支持</h1><p>WebAssembly 的标准里是有 <a href="https://github.com/WebAssembly/simd">SIMD 指令集的提案</a>的，最近各大浏览器以及 Node.js 的 JS 引擎终于<a href="https://github.com/WebAssembly/simd/blob/main/proposals/simd/ImplementationStatus.md">实装了对 SIMD 的支持</a>。理论上来说，使用 SIMD 可以进一步增加 wasm 的执行速度（虽然我做过的简单测试里似乎并不是这样……）</p><p>参考 <a href="https://github.com/GoogleChromeLabs/wasm-feature-detect">GoogleChromeLabs&#x2F;wasm-feature-detect</a>，可以用下面的代码检测对 SIMD 的支持：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">WebAssembly<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">109</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">253</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">253</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>根据 <a href="https://emscripten.org/docs/porting/simd.html">Emscripten 文档</a>所述，编译时只要添加参数 <code>-msimd128</code> 就可以直接在编译的时候使用 SIMD 优化了。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/82627900">Pixiv ID: 82627900 「After school~」 by 呱子</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;和 JavaScript 一样，WebAssembly 也是一种可以在浏览器中运行的编程语言，不过它的性质更相当于汇编语言。wasm 文件由二进制的&lt;a href=&quot;https://pengowray.github.io/wasm-ops/&quot;&gt;字节码&lt;/a&gt;组成（也可以转换</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>高校疫情防控笑话合集</title>
    <link href="https://akarin.dev/2020/09/01/jokes-of-controlling-covid-in-university/"/>
    <id>https://akarin.dev/2020/09/01/jokes-of-controlling-covid-in-university/</id>
    <published>2020-09-01T06:42:39.000Z</published>
    <updated>2020-09-01T06:42:39.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>众所周知，苏联政治笑话是宝贵的世界非物质文化遗产。</p></blockquote><p>新学期即将到来，在经过了一个学期的线上教学后，全国的高校学生正按照学校的安排有序地重返校园。遗憾的是，大部分高校均对返校的学生采取了所谓的“封闭式管理”，包括但不限于以下措施：</p><ul><li>禁止学生出入校园</li><li>允许学生出入校园，但需要学生提交纸质“出校申请”并通过繁琐的层层“审批”</li><li>除少数“极特殊情况”外，不允许学生申请出入校园</li></ul><p>“封闭式管理”在学生当中争议极大，不少学生对经典的苏联政治笑话进行二次创作，以批评“封闭式管理”在动机、执行和结果上的不合理之处。其中知乎、微博等平台对这些笑话的传播应该功不可没。</p><p>现将整理到的高校疫情防控笑话列在下面，这些笑话均来自知乎平台“如何看待〇〇大学不允许学生出校门，〇〇却可以随意进出？”等类似问题，但由于大部分答主均选择了匿名回答，这里便不再标示各笑话的出处。未收录或有所删减的笑话根据这几个原则：</p><ul><li>笑点重复，这是最大的一部分，很多笑话都是套用同一个模板，没有必要都列出</li><li>笑点与高校疫情防控无关，只是套上学校和学生的外衣</li><li>特征明显，可以非常容易地看出是哪个学校的学生改编的笑话，这些特征会被删去</li></ul><p>为了达到幽默的效果，笑话中必然存在夸张的成分，因此部分情节可能会偏离实际。</p><hr><h1 id="序曲"><a href="#序曲" class="headerlink" title="序曲"></a>序曲</h1><p>一位辅导员结束了一天的疫情防控工作，回到办公室刷着知乎，突然独自大笑起来。<br>对面办公桌的同事奇怪地问道：“有什么好笑的事吗？”<br>“是啊，”辅导员用手帕擦着笑出来的眼泪：“一个很好笑的笑话……”<br>“哦？说来听听？”<br>“你疯了吗？我刚刚才在班群里对这家伙进行了通报批评！”</p><h1 id="正片"><a href="#正片" class="headerlink" title="正片"></a>正片</h1><p>学生代表大会上，主持人说：下面请认为应该允许学生进出学校的代表坐到会场的左边，认为应该封闭管理学校的代表坐到会场右边。<br>大部分人坐到了左边，少数人坐到右边，只有一个人还坐在中间不动。<br>主持人：那位代表，你到底认为学生能不能进出学校？<br>回答：我认为可以，但是前提是学生需要提交申请由学院通过审批。<br>主持人慌忙说：那请您赶快坐到主席台上来！</p><p>教育部有关人员在央视新闻上表示“开学后学生能否离校由各地各高校决定”后，辅导员当天就通知各班长：“鉴于有关部门给出了相关指示，现在学校决定，开学后学校实行封闭管理。”<br>某班长大惊，哽咽道：“您不知道吗，辅导员老师，学生们被关着很难受的。”<br>辅导员生气地说：“你以为校领导没有考虑过吗？我们已经给你们准备了出校申请表，通过了审批就可以出去！”</p><p>“同学，你对学校的疫情防控措施有什么意见吗？”<br>“我是有意见，但我不同意我的意见。”</p><p>问：什么是最长的笑话？<br>答：学校发布的返校管理细则。<br>问：那什么是最短的笑话？<br>答：“把好校门关。”</p><p>校领导在宣布新学期的疫情防控措施时，台下有人递条子上去。<br>校领导当场宣读了条子的内容：“领导同志，我什么时候可以自由进出校门？”<br>然后问道：“这是谁写的，请站出来！”<br>连问三次，台下一直没有人站出来。<br>于是校领导说：“现在让我来回答你吧，我任何时候都可以。”</p><p>“假设你在食堂里，突然有人坐在你这边并开始唉声叹气，你会怎么做？”<br>“立刻制止他这种反校宣传。”</p><p>在学校的学生代表大会上将研究两个问题：维护学生权益和建设双一流大学。<br>在懒得维护学生权益的情况下，直接研究第二个问题。</p><p>辅导员在宿舍发现了老鼠。<br>他跟同事抱怨这事，后者想了一会说：<br>“你干嘛不立个牌子，在上面写上‘疫情防控’？这样一半的老鼠就不会出去，另一半想出去的也得给你写申请才行。”</p><p>学生说：学校已经不封闭了。<br>有人问：为什么？<br>学生说：我们的校门已经可以进出了！<br>有人又问：有这种事？<br>学生说：你没见我们的学生可以进，教职工可以出！</p><p>问：听说学校严管校门是应了学生的请求？<br>答：原则上是对的。只不过回应的是二月份的请求。</p><p>“谢天谢地，学校终于决定不封校了。”<br>“你不应该谢天谢地，你要谢管这些事情的校领导。”<br>“好的，我以后会注意我的言辞的。可是，万一哪天这些领导下台了，我该去谢谁？”<br>“到时候就该谢天谢地了。”</p><p>“疫情防控常态化以后还需要控制高校的人口流动吗？”<br>“当然不需要，那时所有大学生都已经会自觉遵守‘非必要不出校’的规定了。”</p><p>一个小学生、一个高中生、一个大学生谈论什么是让自己最开心的事。<br>小学生说：放暑假又可以出去玩了，真让人激动。<br>高中生说：你们小学生就知道玩，最开心的事是高考成绩比一模和二模进步不少，可以被 985 或 211 高校录取了。<br>大学生说：最让我开心的是半夜班长来宿舍敲门，开门后：“〇〇，你因为知乎治校要被辅导员约谈了。”<br>……<br>“你弄错了，〇〇在隔壁。”</p><p>校领导在向学生们讲话：<br>“很快我们就能刷校园卡进出校门！”<br>台下传来一个声音：<br>“我们怎么办？”</p><p>校领导的朋友请校领导去他家帮忙解决阳台的漏水问题，校领导推脱道：“谢谢你，但是我对怎么堵漏水一窍不通啊？”<br>“校领导同志，你只要应用一下你在校园落实‘把好校门关’的经验就可以了！你一负责，学生们就全出不来了！”</p><p>问：如果校园实行封闭式管理会怎么样？<br>答：第一周没有什么变化，但是此后校园超市里的东西会逐渐短缺。</p><p>三个学生被辅导员点名批评了，他们开始谈论为什么他们会被批评。<br>“我被批评是因为我每天健康打卡总是早五分钟，他们指控我踩着时间打卡没有一点紧迫感。”第一个说。<br>“我被批评是因为我每天健康打卡总是迟五分钟，他们指控我无视学校的疫情防控措施。”第二个说。<br>“我被批评是因为我每天健康打卡总是准时。”第三个说。<br>“那你怎么还会被批评？”<br>“他们指控我写程序自动打卡。”<br>……<br>“别骗人了，他们怎么可能真的去检查你是不是在用程序打卡？”</p><p>“知乎上那些反对封闭式管理的言论都是别有用心的人在带节奏！”<br>“没错！所以他们都只敢匿名回答！”</p><p>问：人们到底能不能出入学校的校门？<br>答：教职工们说可以，学生们说不可以。我们要辩证地看待这个问题：可以，但不是所有人都可以。</p><p>某学生在朋友圈抱怨：“这个学校的管理真差劲。”结果被一位辅导员看到而被批评。<br>学生辩解说：“我根本没讲是哪个学校的管理，你怎么可以随便批评我呢？”<br>“你少骗人，”辅导员咆哮道，“我在这里工作二十多年了，哪一个学校的管理差劲我不会知道吗？”</p><p>一位领导在学生大会上卖力地演讲，他在拼命地宣传学校对学生多么好。<br>这时小王举起了手：“为什么禁止学生出入学校，教职工却能带孩子随意出入？”<br>第二天，领导又来演讲。<br>小张举手问道：“我对学校没有任何意见，我就是想问问学生名单上怎么没有小王了。”</p><h1 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h1><p>问：你相信随着疫情防控常态化和全面复工复产的推进，校园的疫情防控会被重新认识吗？<br>答：当然。过去学生出一次校门需要交十五份表格，现在只要三份。</p><hr><p>为什么高校的所谓“封闭式管理”会招致大量学生的反对？</p><blockquote><p>四、<strong>低风险等级地区</strong>人员持健康通行码“绿码”，<strong>在测温正常且做好个人防护的前提下可自由有序流动</strong>。如无必要，尽量避免前往中高风险地区。<br>五、各地要<strong>按照依法、科学、精准防控要求</strong>，规范人员健康管理措施。对<strong>在常态化防控措施之外附加其他不合理限制要求</strong>的，要立即予以纠正。对造成恶劣影响的典型案例，坚决依法查处，并通过媒体予以曝光。</p><div style="text-align:right">——国家卫健委<a href="http://www.nhc.gov.cn/xcs/zhengcwj/202006/3494f1bec7ae4e66812b6e251d140ec0.shtml" target="_blank">《关于做好精准健康管理推进人员有序流动的通知》</a></div></blockquote><p>国内的疫情防控已进入常态化阶段。和年初疫情爆发时必须采取的一系列紧急措施不同，“常态化”的意义在于：在不忽略疫情防控的前提下，逐渐<strong>恢复正常的社会生产生活秩序</strong>。例如，“恢复正常教学秩序”就是教育部对各级学校秋季开学疫情防控工作的指示之一。</p><p>目前，大部分地区已将疫情控制在了低风险之内，连续一段时间未出现本土确诊病例，甚至有一批地区已处于确诊患者“清零”状态很长一段时间。这些低风险地区之间的人员流动正在逐渐恢复，旅游风景区有序恢复开放，商业街和食肆陆续开门迎客，即使是由于空气流通相对不畅，被认为有更高的疫情传播风险的电影院，在隔座售票和控制上座率的前提下也已重新复工。幼儿园、小学、初中和高中的学生，也已经恢复了正常的走读，并未存在某所学校以“封闭式管理”的名义强制要求走读学生住校的事情。</p><p>在做好个人防护，不前往中高风险地区的前提下，即使一位大学生离开校园，由此产生的对疫情防控的影响仍然是<strong>可以控制</strong>的。通过查验各地的“健康码”和由通信运营商提供数据的“行程卡”，他的出行轨迹仍然是<strong>可以追溯</strong>的，“精准防控”并不是一句空话。</p><p>但在这样的环境下，某些高校却仍然坚持所谓“封闭式管理”，<strong>把校门外当成雷池，不允许大学生跨越一步，又或是要求出校学生填写大量表格，通过无数审批，横加诸多限制</strong>。暂且不论“封闭式管理”执行过程中可能还会存在的“执行粗暴”、“区别对待”等问题，仅针对其本身而言，对大学生坚持实行所谓的“封闭式管理”，是否合理呢？</p><p><a href="https://www.zhihu.com/question/414092591/answer/1410771245">不言而喻，一目了然。</a></p><blockquote><p>参见：<br><a href="https://m.weibo.cn/status/Jld6f9tGl">人民日报：教育部提醒高校切忌简单化封闭管理</a><br><a href="https://wap.gmdaily.cn/article/469acf3ab14c4470ae04e2013d94998c">光明日报：“封闭管理”是大学生返校的唯一选项吗？</a><br><a href="http://www.eeo.com.cn/2020/0918/413961.shtml">经济观察报：封闭校园，但更需精准防控</a><br><a href="http://www.banyuetan.org/jrt/detail/20200925/1000200033134991600912389085775118_1.html">半月谈：切忌封校“一刀切”！高校管理有力度更要有温度</a><br><a href="https://jiangxi.jxnews.com.cn/system/2020/09/17/019042802.shtml">中国江西网：江西省全面取消校园全封闭管理 允许学生正常外出</a></p></blockquote>]]></content>
    
    
    <summary type="html">坚决反对不合理的所谓“封闭式管理”措施。</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>换上了自己写的新主题！(つ•̀ω•́)つ</title>
    <link href="https://akarin.dev/2020/08/29/migrate-to-new-theme/"/>
    <id>https://akarin.dev/2020/08/29/migrate-to-new-theme/</id>
    <published>2020-08-29T05:33:28.000Z</published>
    <updated>2020-08-29T05:33:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前网站的主题是 <a href="https://github.com/bolnh/hexo-theme-material">hexo-theme-material</a>。这个主题的质量还是很高的，今天仍然有不少用户在它的 <a href="https://github.com/bolnh/hexo-theme-material/issues">Issue</a> 里询问使用问题，但是它的最后一次 Commit 和 Release 停留在了 2018 年 8 月，之后就再也没有任何动静了……主题的文档<a href="https://github.com/bolnh/hexo-theme-material/issues/698">挂了</a>，原作者自己的<a href="https://blog.viosey.com/">博客兼 Demo</a> 也挂了，似乎的确已经是<a href="https://liyin.date/2020/07/25/new-theme-new-start">弃坑</a>了。</p><p>几个月前就有了“换一个主题”的想法，不过又不能抛弃自己喜欢的 Material Design 样式所以就想着自己写一个，然后整个暑假又被某个项目耗光了时间就一直咕咕咕到现在(っ’-‘)╮ 现在我被关在学校里又没什么事干，于是只用了几天时间就自己摸索着把主题给做出来了<del>摸鱼是第一生产力</del>，勉强能看～当然样式还是有不少地方<ruby>借<rt>chāo</rt>鉴<rt>xí</rt></ruby>了原来的主题的，所以看上去和换主题之前好像没有什么区别 (　ε:)</p><p>顺便吐槽一下，Hexo 的文档的评论区里有一堆好几年前的评论吐槽文档质量极差，我看了以后的感觉就是想自己做主题的话只看官方文档很难上手，简单来说就是告诉你：“新建某某文件，在文件里写上一些 HTML 代码，主题就可以使用啦！”至于如何获取各种数据以及类型定义等等，几乎是一字未提，有时候还得用 <code>console.log</code> 自己看。</p><p>GitHub 上有人做了个类似于 Vue CLI 的<a href="https://github.com/tcrowe/generator-hexo-theme">工具</a>，选择模板引擎和文章渲染器之后，就可以自动新建一个主题项目的基本结构，当然我是不想再 <code>npm install -g</code> 往自己的电脑上装一堆东西了，所以直接把它的<a href="https://github.com/tcrowe/generator-hexo-theme/tree/master/app/templates/layout-ejs">页面模板</a>拿下来就开始改了～EJS 模板还是很容易掌握的，只需要记住 <code>&lt;% %&gt;</code> 表示 JS 代码、<code>&lt;%= %&gt;</code> 表示转义输出、<code>&lt;%- %&gt;</code> 表示不转义输出，大部分情况下这三个标签已经够用了。</p><p>因为是自己做给自己用的主题，所以很多地方都很随便啦……这个新主题的一些特性：</p><ul><li>包含我之前魔改主题时添加的所有功能，例如图片懒加载、代码复制、图片放大（使用 <a href="https://github.com/francoischalifour/medium-zoom">medium-zoom</a>）等等。</li><li>图片懒加载支持 WebP 格式自适应（浏览器不支持时会自动回退到传统格式），甚至还可以使用 Firefox 和 Chrome 正在<a href="https://caniuse.com/#feat=avif">逐渐开始支持</a>的 AVIF 格式，比如这一篇的封面图就有个 <a href="https://vfile.meituan.net/mmdb/a6233008620ff984a8330189be974aa150893.jpg">AVIF 格式的版本</a>。</li><li>支持深色模式（<a href="https://github.com/zdhxiong/mdui">MDUI</a> 内置功能）。</li><li>和之前一样继续使用 <a href="https://livere.com/">LiveRe</a> 和<a href="https://busuanzi.ibruce.info/">不蒜子</a>分别提供评论区和访问计数功能。至于其他评论区和计数……因为我没有用过所以就没有适配了。</li><li>不使用 jQuery。但是 LiveRe 仍然会单独加载一个 jQuery，这就不是我能控制的了 ɿ(｡･ɜ･)ɾ</li><li>不支持 Internet Explorer，因为我使用了一些 ES6 以上的语法和特性编写 JS 代码而我又懒得用 Babel 转换再添加一大堆 Polyfill。如果用 IE 访问的话会直接跳转到<a href="https://akarin.dev/upgrade-browser.html">这里</a>。</li></ul><p>主题的源代码我上传到 <a href="https://github.com/TransparentLC/hexo-theme-akarin">GitHub</a> 了，但是除了我自己以外应该不会有第二个人用了吧……|ω•&#96;) 不过 README 和设置文档我也还没写，以后心情好的时候（比如哪天不用被关在学校里了）再补充～（咕咕咕）</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/61882373">Pixiv ID: 61882373 「モカ姉誕生日おめでとうございます。」 by チノマロン</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;之前网站的主题是 &lt;a href=&quot;https://github.com/bolnh/hexo-theme-material&quot;&gt;hexo-theme-material&lt;/a&gt;。这个主题的质量还是很高的，今天仍然有不少用户在它的 &lt;a href=&quot;https://github</summary>
      
    
    
    
    
  </entry>
  
</feed>
