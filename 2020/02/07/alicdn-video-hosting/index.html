<!doctype html><html lang="zh-Hans"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no" name="viewport"><meta content="webkit" name="renderer"><meta content="webkit" name="force-rendering"><meta content="✨小透明・宸✨" name="author"><meta content="" name="keywords"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon shortcut" type="image/ico"><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon"><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="apple-touch-icon"><link href="/atom.xml" rel="alternate" type="application/atom+xml"><title>搞事情：用“图床”传视频，自带免费 CDN 加速（已复活！） | 存在感消失的地方|ω•`)</title><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":"https://akarin.dev","headline":"搞事情：用“图床”传视频，自带免费 CDN 加速（已复活！）","datePublished":"2020-02-07T11:24:46.000Z","dateModified":"2020-02-07T11:24:46.000Z","author":{"@type":"Person","name":"✨小透明・宸✨","image":{"@type":"ImageObject","url":"https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"},"description":"身处寒夜 把握星光✨"},"publisher":{"@type":"Organization","name":"存在感消失的地方|ω•`)","logo":"https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png"},"keywords":"","description":"可能是最快的“视频床”了(〃′▽`)"}</script><script>/MSIE|Trident/.test(navigator.userAgent)&&(location.href="../../../../upgrade-browser.html")</script><script>window.switchDark=t=>{const a={auto:"mdui-theme-layout-auto",enable:"mdui-theme-layout-dark",disable:""};(t=t||localStorage.getItem("dark"))in a||(t="auto");for(const e in a)a[e]&&document.body.classList[e===t?"add":"remove"](a[e]);localStorage.setItem("dark",t)},addEventListener("DOMContentLoaded",()=>switchDark());</script><link href="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/css/mdui.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/combine/npm/aplayer@1/dist/APlayer.min.css,npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css,npm/prism-themes@1/themes/prism-vsc-dark-plus.min.css,gh/TransparentLC/transparentlc.github.io/css/style.min.css" rel="stylesheet"><style>*{--sidebar-image:url(https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/sidebar_header.jpg);--sidebar-image-color:#958981;--banner-image:url(https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/daily_pic.png);--banner-image-color:#f09ea3;--post-thumbnail-color:#f09ea3;--copy-code-btn-color:#fff}</style><meta content="Hexo 6.0.0" name="generator"></head><body class="mdui-drawer-body-left mdui-theme-accent-pink mdui-theme-primary-pink"><button class="mdui-shadow-0 mdui-fab mdui-m-a-2 mdui-text-color-grey-700" mdui-drawer="{target:'#akarin-drawer'}" style="position:fixed;z-index:1"><i class="material-icons mdui-icon">menu</i></button><nav class="mdui-drawer mdui-drawer-full-height mdui-shadow-6" id="akarin-drawer"><div class="akarin-util-bg-cover mdui-p-x-2" id="akarin-drawer-media"><img src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg" class="akarin-hover-spin mdui-img-circle mdui-m-t-4" id="akarin-drawer-avatar"><div class="akarin-util-text-gradient mdui-card-media-covered"><div class="mdui-card-primary"><div class="mdui-typo-subheading">✨小透明・宸✨</div><div class="akarin-util-opacity-half mdui-typo-caption">存在感消失的地方|ω•`)</div></div></div></div><div class="mdui-list" mdui-collapse><div><a href="../../../../" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">home</i> <span class="mdui-list-item-content">主页</span></a></div><div><a href="../../../../about" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">person</i> <span class="mdui-list-item-content">关于</span></a></div><div><a href="../../../../friend" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">link</i> <span class="mdui-list-item-content">友链</span></a></div><div><a href="https://github.com/TransparentLC" target="_blank" rel="noopener" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">code</i> <span class="mdui-list-item-content">GitHub</span></a></div><div><a href="../../../../archives" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">collections_bookmark</i> <span class="mdui-list-item-content">归档</span> <small class="akarin-drawer-badge mdui-color-theme-accent">31</small></a></div><div><a href="../../../../atom.xml" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">rss_feed</i> <span class="mdui-list-item-content">RSS</span></a></div><div class="mdui-divider"></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">brightness_4</i> <span class="mdui-list-item-content">深色模式</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item" data-dark="auto"><span class="mdui-list-item-content">根据系统主题切换</span></div><div class="mdui-ripple mdui-list-item" data-dark="enable"><span class="mdui-list-item-content">启用</span></div><div class="mdui-ripple mdui-list-item" data-dark="disable"><span class="mdui-list-item-content">禁用</span></div></div></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">insert_chart</i> <span class="mdui-list-item-content">访问统计</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_pv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访客数</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_uv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">页面访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_page_pv">Loading</small></div></div></div></div></nav><picture id="akarin-top" title="返回顶部"><source srcset="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.avif" type="image/avif"><source srcset="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.webp" type="image/webp"><img src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.png"></picture><div style="padding-top:20px"></div><div class="mdui-hidden-sm-down" style="padding-top:40px"></div><div class="mdui-hidden-md-down" style="padding-top:40px"></div><main class="mdui-container" style="max-width:1024px"><div class="akarin-util-rounded-5 mdui-card mdui-shadow-4"><div class="mdui-ripple akarin-post-bg akarin-util-bg-cover" data-src="https://ae01.alicdn.com/kf/H50835fe93e1b44bfb6cae5c2a9e04310M.jpg" data-src-avif="https://vfile.meituan.net/mmdb/e2ca03206416d62ceec9afc254e0aa9862880.jpg" data-src-webp="https://ae01.alicdn.com/kf/Hca94f7b6616842df9dfcbe3092988d74s.jpg"><div class="akarin-util-bg-cover akarin-post-bg akarin-blurred-cover" style="background-image:url(data:image/jpeg;base64,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)"></div><div class="akarin-util-text-gradient akarin-post-title"><div class="mdui-card-primary"><div class="mdui-card-primary-title mdui-text-color-white-text">搞事情：用“图床”传视频，自带免费 CDN 加速（已复活！）</div></div></div></div><div class="mdui-valign mdui-card-header"><div><img src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg" class="akarin-hover-spin mdui-card-header-avatar"><div class="mdui-card-header-title">✨小透明・宸✨</div><div class="mdui-card-header-subtitle">2020-02-07 19:24:46</div></div></div><article class="mdui-p-a-3 mdui-card-content mdui-typo"><p>在开头位置先推荐一下 <a href="https://bottle.moe/" target="_blank" rel="noopener">@SomeBottle</a> 发布在自己博客上的教程<a href="https://bottle.moe/post-269.html" target="_blank" rel="noopener">《用图床看视频的体验·改》</a>，非常详细，在这篇教程的基础上补充了包括“iOS 环境下如何播放”在内的很多东西～</p><details><summary>之前的更新</summary><p>目前 alicdn 似乎又取消了文件格式检测，仍然可以像之前一样上传非图片类型的文件，只需要上传时填写文件名的那个字段使用图片的扩展名即可～</p><p>但是<strong>不能上传 TS</strong>，估计是被视频床的事情弄怕了 2333</p><p>当然还是有办法绕过这个限制。HLS 协议支持使用加密，操作方法是将所有的 TS 使用某个密钥和 IV 通过 AES-128-CBC 进行加密，然后将密钥以二进制写入文件中并上传，在 M3U8 中添加字段 <code>#EXT-X-KEY</code> 写上密钥文件的 URL 和 IV。加密以后的文件就不是 TS 了，仍然可以正常上传 | ू•ૅω•́)</p><p>在之前的上传脚本上改一改就可以进行加密了，至于怎么改？请独立完成作业（逃</p><p><a href="https://jsbin.com/nonubudeli/edit?html,output" target="_blank" rel="noopener">这里</a>是演示。代码完全复制自 hls.js 的<a href="https://github.com/video-dev/hls.js#getting-started" target="_blank" rel="noopener">示例</a>，所以在 iOS 上大概也能播放……？</p><hr><p><strong><del>由于添加了文件格式检测，该方法已失效。</del></strong></p><p><del>上传图片仍然是没问题的（不包括 WebP），但是无法再上传新的非图片文件，视频当然也不行了┐(´-｀)┌</del></p><p>另外现在获取文件时<strong>有极低概率出现 429 错误</strong>，如果介意的话建议更换其它图床 (=’_‘=)</p><p>传视频的替代品：<a href="https://catbox.moe/" target="_blank" rel="noopener">Catbox</a>，Onedrive 5TB 配合<a href="https://www.52pojie.cn/thread-1070131-1-1.html" target="_blank" rel="noopener">直链生成工具</a>，或许还有下一个不会检测文件格式的图床……？</p><hr><p>一种理论上可行的方法：</p><p>众所周知，很多文件格式都有文件头和文件尾，解码图片时会直接<strong>无视图片的文件尾之后的数据</strong>。以前在网上经常会流传的“图种”就是利用了这个原理，在图片后面加上压缩包的数据即可在各大论坛上直接发送，压缩软件打开“图种”的时候又会无视压缩包文件头之前的数据，所以不影响正常打开。</p><p>利用这个手段同样可以解决文件格式检测的问题，只要用一个尽可能小的 1x1 的图片放在 TS 切片前面就可以在<strong>任意图床</strong>（只要不进行二压）正常上传了。至于播放……只考虑在网页上播放视频的话，hls.js 也支持<a href="https://github.com/video-dev/hls.js/blob/master/docs/API.md#loader" target="_blank" rel="noopener">对获取切片的 loader 进行重写</a>，因此可以在这里把文件开头的那张图片去掉，应该就可以正常播放视频了～</p><p><del>由于 iOS 本身就支持播放 HLS，而且并不能使用 hls.js，因此无法在获取视频切片这一步上动手脚，所以这个办法<strong>在 iOS 上是无法使用的</strong>……</del></p><p>通过 M3U8 格式的 <code>#EXT-X-BYTERANGE</code> 字段似乎可以绕过？</p><p><del>占坑，写出来以后再更新（咕咕咕）</del></p><p>测试成功(σ′▽‵)′▽‵)σ <a href="https://jsbin.com/qiqugiyeko/edit?html,output" target="_blank" rel="noopener">这里</a>是演示，具体操作方法请翻到<a href="#%E5%9C%A8%E5%BC%80%E5%A7%8B%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E4%B9%8B%E5%90%8E%E2%80%A6%E2%80%A6">最后</a>～</p></details><hr><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/78997162" target="_blank" rel="noopener">Pixiv ID: 78997162 「綾あか」 by うめか</a></p></blockquote><p>先说结论，作为测试翻出了硬盘里的 LL 的四个多小时的 Final Live，自己压制成 720p 和 360p 后上传到“图床”上，播放非常流畅，一点问题都没有～</p><p><a href="https://jsbin.com/catagatuyi/edit?html,output" target="_blank" rel="noopener">这里</a>是演示| ᐕ)୨ 需要自动上传脚本的可以直接翻到最后。</p><h1 id="“非公开”的图床？"><a href="#“非公开”的图床？" class="headerlink" title="“非公开”的图床？"></a>“非公开”的图床？</h1><p>图床这种东西一抓一大把，比如 <a href="https://sm.ms/" target="_blank" rel="noopener">SM.MS</a> 之类的图床本身就是用来提供图片外链服务的。</p><p>那……难道还有用途不是图片外链的图床吗？其实是有的(´ﾟωﾟ｀)</p><p>比如说最知名的图床：<strong>微博图床</strong>，因为使用简单（各种轮子足够多）、速度快（真・全球 CDN 加速）、有保障（在可见的相当一段长的时间内微博几乎不可能关闭）而被广泛使用，虽然也有强制二压图片、给图片加水印的不足之处……不过对于这种免费的“服务”，不能要求太多？</p><p>但是微博显然不是专门做图床的，它只是个社交网站。据说是因为发微博的时候上传图片的接口存在漏洞，已登录用户只要选择了图片就会立刻上传（不论有没有发送微博），而且这个接口只需要已登录用户的 Cookie，上传图片得到的 URL 直接拿去外链也不会有“该图片来自……未经允许不可引用”之类的提示，于是就被拿来当图床使用了(　ε:)</p><p>甚至还出现了一些图床，号称“全球 CDN 加速”、“图片永久储存”、“高速稳定”，实际上后端对接的也是微博图床，这就有点那啥……不过至少也是提供了一个上传工具嘛（摊手</p><img data-src="https://ae01.alicdn.com/kf/H046b02b37060460b978f1b0fc000aad4E.png" data-src-webp="https://ae01.alicdn.com/kf/Hac19464ae2b844e895b754f0a551d4aei.jpg"><p>由此可见，一个图片上传接口只要满足以下几点，就有被拿去<del>薅羊毛</del>作为图床的可能：</p><ol><li>没有添加<strong>防盗链</strong>措施</li><li>上传图片无须复杂的身份验证，甚至允许<strong>匿名上传</strong></li><li>不限制图片的上传次数</li></ol><p>比如<a href="https://blog.cmcncm.cn/2019/03/26/image-hosting/" target="_blank" rel="noopener">这里</a>就列举了一大堆符合以上条件的“非公开”图床（部分已失效），谁能想到一个图片搜索功能都可以拿来做图床的？！</p><h1 id="如果还认为“检查文件格式-检查扩展名”的话……"><a href="#如果还认为“检查文件格式-检查扩展名”的话……" class="headerlink" title="如果还认为“检查文件格式 === 检查扩展名”的话……"></a>如果还认为“检查文件格式 === 检查扩展名”的话……</h1><p>这次<del>要被玩坏的</del>主角就是上面那个连接里提到过的福报厂的图片上传接口，也是本站一直在使用的接口(｡•̀ᴗ-)✧</p><p>先说明一下调用方法，以及总结一下它的属性：</p><p><code>https://kfupload.alibaba.com/mupload</code></p><div class="mdui-shadow-0 mdui-table-fluid"><table class="mdui-table mdui-table-hoverable"><thead><tr><th>POST 参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>file</code></td><td>File</td><td>文件的二进制数据</td></tr><tr><td><code>name</code></td><td>String</td><td>文件名</td></tr><tr><td><code>scene</code></td><td>String</td><td>固定为 <code>aeMessageCenterV2ImageRule</code></td></tr></tbody></table></div><ul><li>支持 JPG、PNG、GIF 格式（？）</li><li>文件大小限制为 5MB</li><li>不会对图片（？）进行二压</li><li>无需身份验证</li><li>没有上传频率限制，大概吧<span style="opacity:.2">（连续上传过数百个文件也没被封 IP 什么的）</span></li><li>没有图片内容审核，大概吧<span style="opacity:.2">（上传过一张“好孩子看不见”的图片，观察了至少半个月也没被删除）</span></li></ul><p>返回数据示例：</p><pre class="line-numbers language-plaintext" data-language="plaintext"><code class="language-plaintext">&#123;
    &quot;fs_url&quot;: &quot;H2db4a9284928493eb92b0676277dc60a3.jpg&quot;,
    &quot;code&quot;: &quot;0&quot;,
    &quot;size&quot;: &quot;42585&quot;,
    &quot;width&quot;: &quot;960&quot;,
    &quot;url&quot;: &quot;https:&#x2F;&#x2F;ae01.alicdn.com&#x2F;kf&#x2F;H2db4a9284928493eb92b0676277dc60a3.jpg&quot;,
    &quot;hash&quot;: &quot;26e29271d884f443e3e2660decd3776b&quot;,
    &quot;height&quot;: &quot;540&quot;
&#125;<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><del>所有的数据居然都是<strong>字符串</strong>类型，这是坠痛苦的</del></p><p>看上去是很正常的图片上传接口，但是实际上它对于文件格式的检测仅仅是根据<strong>扩展名</strong>（也就是 <code>name</code> 字段）。也就是说，只要<strong>随便选择</strong>一个 5MB 以内的文件，然后上传时在 <code>name</code> 字段<strong>写上图片的文件名</strong>（比如 <code>image.jpg</code>），仍然可以正常上传！(๑˙ー˙๑)</p><p>比如 <a href="https://ae01.alicdn.com/kf/Hcb7a3052f6894bfab549f41d324a68dbR.jpg" target="_blank" rel="noopener"><code>https://ae01.alicdn.com/kf/Hcb7a3052f6894bfab549f41d324a68dbR.jpg</code></a> 这个链接，看上去是 JPG 图片，打开后却无法显示。如果下载下来然后将扩展名改成 <code>m4a</code> 的话……实际上是一个音频文件啦～</p><p>利用这个漏洞就可以实现上传<strong>任意类型</strong>的文件了，比如这个接口本来不支持上传 WebP 图片，但是通过改扩展名就可以解决（本站的 WebP 图片也是用这种方式上传的）。不过对于视频文件来说，其文件大小通常都在数十或数百 MB，甚至以 GB 为单位的数量级上，5 MB 的大小限制显然是不够用的（除非是○手、○音上的那些短视频……），那还能怎么办呢……</p><h1 id="视频分片上传基本原理"><a href="#视频分片上传基本原理" class="headerlink" title="视频分片上传基本原理"></a>视频分片上传基本原理</h1><p>压缩包有分卷压缩，视频也可以拆成好几段然后然后组合到一起再播放，具体的实现手段就是 HLS 协议了。</p><blockquote><p>HTTP Live Streaming（缩写是 HLS）是由苹果公司提出基于 HTTP 的流媒体网络传输协议。是苹果公司 QuickTime X 和 iPhone 软件系统的一部分。</p><p>它的工作原理是<strong>把整个流分成一个个小的基于 HTTP 的文件</strong>来下载，每次只下载一些。当媒体流正在播放时，客户端可以选择从许多不同的备用源中以不同的速率下载同样的资源，允许流媒体会话适应不同的数据速率。</p><p>在开始一个流媒体会话时，客户端会下载一个包含元数据的 M3U8 文件，用于寻找可用的媒体流。</p><p><span style="float:right"><a href="https://zh.wikipedia.org/wiki/HTTP_Live_Streaming" target="_blank" rel="noopener">维基百科：HTTP Live Streaming</a></span></p></blockquote><p>播放 HLS 协议的视频流需要一个 M3U8 文件，这个文件按照一定格式存储了每一小段视频的 URL 以及时长。</p><pre class="line-numbers language-plaintext" data-language="plaintext"><code class="language-plaintext">#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:5.000,
http:&#x2F;&#x2F;tp-fad-files.huanxi.com&#x2F;38c6b150aefe7a7150ce64b4f12f0538&#x2F;1581043918&#x2F;vod01&#x2F;20200124&#x2F;7cfe90e6-752b-4cba-87f0-10e2b188b007&#x2F;4944&#x2F;4944_1579831306_3865413_1505.ts
#EXTINF:5.000,
http:&#x2F;&#x2F;tp-fad-files.huanxi.com&#x2F;34be054e87e4a7ad08609adaa42b53a7&#x2F;1581043919&#x2F;vod01&#x2F;20200124&#x2F;7cfe90e6-752b-4cba-87f0-10e2b188b007&#x2F;4944&#x2F;4944_1579831306_3631912_6505.ts

...

#EXTINF:5.000,
http:&#x2F;&#x2F;tp-fad-files.huanxi.com&#x2F;a467e02ed4c84cddcc72b4b8062bf46a&#x2F;1581043919&#x2F;vod01&#x2F;20200124&#x2F;7cfe90e6-752b-4cba-87f0-10e2b188b007&#x2F;4944&#x2F;4944_1579831388_4072629_7596505.ts
#EXTINF:0.880,
http:&#x2F;&#x2F;tp-fad-files.huanxi.com&#x2F;05dfd6187eee5353498aafe175c7747e&#x2F;1581043919&#x2F;vod01&#x2F;20200124&#x2F;7cfe90e6-752b-4cba-87f0-10e2b188b007&#x2F;4944&#x2F;4944_1579831388_7758824_7601505.ts
#EXT-X-ENDLIST<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>除此之外，HLS 协议也支持自适应切换视频流的功能。在 M3U8 里面再写上若干个视频流（也是 M3U8）的 URL，并给每个流标记上码率、分辨率、视频编码等数据（例如：<code>#EXT-X-STREAM-INF:BANDWIDTH=1200000,RESOLUTION=640x360,CODECS=&quot;avc1.42e00a,mp4a.40.2&quot;,NAME=360p</code>），这样客户端就可以根据网速和播放器的支持情况自动切换视频流。</p><p>HLS 使用到的 TS 视频文件，全称 Transport Stream，主要应用于实时传送视频数据，因此需要保证每个单独的 TS 都可以独立播放（相当于一个小的视频文件）。反过来，将若干个 TS 的二进制数据按顺序直接拼接到一起，就可以组成一个较长的视频。服务端源源不断地将视频数据转换为 TS 然后输出，这样就实现了视频直播；如果视频已经以 TS 形式保存在服务器上，也可以通过 HLS 依次获取然后播放，这样实现的就是视频点播。</p><p>只要能将自己手上的视频切割成 TS 然后逐个上传到“图床”，使用 HLS 协议不就能正常播放了吗！(੭ ˙ᗜ˙ )੭</p><h1 id="准备上传"><a href="#准备上传" class="headerlink" title="准备上传"></a>准备上传</h1><p>目前在网页上播放视频的主流格式仍然是 MP4 封装的使用 H.264 + AAC 编码的视频文件，这里也只针对这种格式进行处理。</p><p>使用 FFmpeg 的两行命令就可以实现将视频转换为 TS，再对 TS 进行切割以及生成 M3U8 播放列表的工作：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ffmpeg -i video.mp4 -c copy -vbsf h264_mp4toannexb -absf aac_adtstoasc video.ts
ffmpeg -i video.ts -c copy -f segment -segment_list video.m3u8 %d.ts<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span></span></code></pre><p>因为是对视频直接进行分割，所以这个操作是无损的，不需要重新编码，速度非常快（唯一的限制是硬盘读写速度），对视频的画质也没有影响。执行后会在当前目录下生成一个 <code>video.m3u8</code> 以及一大堆的 <code>0.ts</code>、<code>1.ts</code>……（忽略因为字符编码造成的乱码）</p><img data-src="https://ae01.alicdn.com/kf/Ha6d4f5bc8b8e41889a7bd1caaca284f78.jpg" data-src-webp="https://ae01.alicdn.com/kf/H818b12765a0e476eba1b52621c54cd8fb.jpg"><p>使用 MPC-HC、VLC 等支持 HLS 的播放器打开 M3U8 就可以播放，如果将 TS 全部上传到“图床”然后用得到的 URL 替换掉 M3U8 里面的 <code>0.ts</code>、<code>1.ts</code>……那就相当于上传了整个视频。还记得那个“图床”的限制吗？<strong>文件大小限制不能超过 5 MB</strong>，因此切割出来的 TS 也不应该超过 5 MB，但是切割 TS 的大小并不是可以随意设定的……</p><p>这里就需要提到一些视频格式的基础知识了（逃</p><p>为了提高压缩率，H.264 编码标准将视频的帧分为 I 帧、P 帧、B 帧三类，后两者可以存储前后帧的图像变化，然后参考其他帧“预测”出画面数据；但 I 帧保存的是完整的一帧；部分 I 帧也是 IDR 帧，每一个 IDR 帧之后的帧都<strong>不能参考 IDR 帧之前的内容</strong>。</p><p>在无损的要求下，由于 IDR 帧的特性，视频分割的最小单位是以 IDR 帧（关键帧）进行分割得到的小段，又称 GOP（Group Of Pictures）。每个 GOP 的帧序列以 I 帧开头和结尾，例如 <code>IBBBPBBBPBBBI</code>，不能再继续分割。如果<strong>视频的码率较高且 GOP 过长</strong>的话，就很容易出现某个 GOP 已经超过了 5 MB 的情况。</p><p>简单的解决方法是将这些大小超过 5 MB 的 GOP 切出来的 TS <strong>丢给 FFmpeg 进行二压</strong>，不改变分辨率和帧率的话并不会影响整个视频的播放；但是在问题相当严重的情况下，最好是二压整个视频，降低码率，注意<strong>将 x264 的参数 <code>keyint</code> 改低一些</strong>，保证不会出现过长的 GOP。</p><p>除了超出限制的文件，过小的文件也是需要注意的。上面的截图中的大部分 TS 都只有数百 KB，虽然可以上传，但是文件数量实在太多，加载时需要发送大量 HTTP 请求严重影响性能。可以将相邻的几个大小加起来刚好达到 5 MB 的 TS 的二进制数据按顺序合并起来，不过一开始的几个 TS 例外（只需要合并到 2 MB 就可以了？），否则按下“播放”按钮然后要等上很久才能播放第一个 TS 还是有点难受的……</p><p>上传视频也可以使用 curl 在命令行中完成，得到的响应会直接输出到 stdout。也可以使用其它编程语言的网络请求模块，不过不知道为什么使用 Python 的 <code>requests</code> 模块一直都无法上传……？</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://kfupload.alibaba.com/mupload -X POST -F <span class="token assign-left variable">scene</span><span class="token operator">=</span>aeMessageCenterV2ImageRule -F <span class="token assign-left variable">name</span><span class="token operator">=</span>image.jpg -F <span class="token assign-left variable">file</span><span class="token operator">=</span>@video.ts<span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre><h1 id="自动上传脚本"><a href="#自动上传脚本" class="headerlink" title="自动上传脚本"></a>自动上传脚本</h1><p><video controls poster="https://ae01.alicdn.com/kf/Hc825f57d14f14538a21ad8ac6e21c054k.jpg" preload="metadata" src="https://files.catbox.moe/33jkl0.mp4"></video></p><p><del>看上去是 Windows，实际上是 Kali 的 Windows 界面模式（滑稽</del></p><p><del>但是它真的预装了 PowerShell</del></p><p><del>出门右转 <a href="https://gist.github.com/TransparentLC/54778bfd01b41c97dee1343521a9de9e" target="_blank" rel="noopener">GitHub Gist</a> 查看和下载脚本( ॑꒳ ॑ )</del></p><p><strong>运行脚本需要 PowerShell 运行环境、FFmpeg 和 curl</strong></p><ul><li>输入一个 MP4 封装的 H264 + AAC 编码的视频的路径（如果有需要，请自行对视频进行二压处理）</li><li>在相同目录下生成一个以随机 GUID 命名的临时文件夹，保存视频切割的 TS 并生成 M3U8（<code>video.m3u8</code>）</li><li>如果存在超过 5 MB 的 TS 则给出提示，需要手动进行二压后才能继续上传</li><li>自动合并相邻的 TS，使文件大小接近 5 MB（前三个合并的 TS 为 2 MB）</li><li>将合并后的 TS 全部上传到“图床”，生成写入了“图床”的 URL 的 M3U8（<code>video_online.m3u8</code>）</li><li>临时文件夹内的 TS 和 <code>video.m3u8</code> 可以自行决定是否删除</li><li><span style="opacity:.2">脚本没有任何错误处理，所以如果出现了各种奇怪的事情大概率是视频文件本身的问题……大概吧（小声</span></li></ul><p>将 <code>video_online.m3u8</code> 存放到自己的服务器上（或者也上传到“图床”？！），在网页上使用 <a href="https://github.com/video-dev/hls.js" target="_blank" rel="noopener">hls.js</a> 就可以播放了。</p><p>（实际上最前面的<a href="https://jsbin.com/catagatuyi/edit?html,output" target="_blank" rel="noopener">演示</a>就是这么做的，还用到了自适应切换，如果网速比较快的话播放一段时间就可以发现视频的清晰度从 360p 无缝衔接到了 720p）</p><hr><p>因为 Python 无法实现上传所以还是继续用 PowerShell 写脚本了～正好 PowerShell 6.0 已经支持跨平台了，所以做了一点微小的适配，在 Linux 下也能跑٩( ‘ω’ )و</p><p>当然 Linux 用户别忘了 <code>apt-get install powershell</code>，Windows 自带<del>充话费送的</del> PowerShell 运行环境。</p><p>脚本需要使用 FFmpeg，Windows 用户请出门右转<a href="https://ffmpeg.zeranoe.com/builds/" target="_blank" rel="noopener">这里</a>下载，然后<strong>把 <code>ffmpeg.exe</code> 所在的目录添加到 PATH</strong> 或者<strong>去脚本的三十几行的位置手动修改路径</strong>，Linux 用户请 <code>apt-get install ffmpeg</code>；还需要使用 curl，在 Linux 下应该是标配了，Windows 用户请出门右转<a href="https://curl.haxx.se/download.html#Win64" target="_blank" rel="noopener">这里</a>下载，同样需要添加到 PATH 或者修改脚本里的路径。</p><h1 id="在开始检测文件格式之后……"><a href="#在开始检测文件格式之后……" class="headerlink" title="在开始检测文件格式之后……"></a>在开始检测文件格式之后……</h1><p>目前 alicdn 的这个接口已经添加了图片的文件格式检测，如果上传的文件数据不是图片，即使自己改了 <code>name</code> 字段也会报错。不过借鉴“图种”的原理，把正常的图片数据插入到文件最前面就可以了～</p><p>在 <a href="https://stackoverflow.com/questions/2570633/smallest-filesize-for-transparent-single-pixel-image#answer-15960901" target="_blank" rel="noopener">Stack Overflow</a> 上查了一下，<a href="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAAC">最小的 1x1 像素的 GIF 图片</a>可以做到只有 24 字节。把它加到 M3U8 和 TS 切片的最前面，得到的“图片”是可以上传到 alicdn 的（理论上也支持所有图床），然后读取的时候再截掉前 24 字节就可以了 ∠( ᐛ 」∠)_</p><p>截取的操作在 hls.js 的 loader 上加一个 Hook 即可实现，不过遗憾的是这样的话将视频下载到本地就不能直接播放了……这个 Hook minify 以后只有三百多字节，在 <code>new Hls(...)</code> 之前执行即可～</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">Hls<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> load <span class="token operator">=</span> Hls<span class="token punctuation">.</span>DefaultConfig<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>load<span class="token punctuation">;</span>
    Hls<span class="token punctuation">.</span>DefaultConfig<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function function-variable">load</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> config<span class="token punctuation">,</span> callbacks</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'manifest'</span> <span class="token operator">||</span> context<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'level'</span> <span class="token operator">||</span> context<span class="token punctuation">.</span>responseType <span class="token operator">===</span> <span class="token string">'arraybuffer'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> onSuccess <span class="token operator">=</span> callbacks<span class="token punctuation">.</span>onSuccess<span class="token punctuation">;</span>
            callbacks<span class="token punctuation">.</span><span class="token function function-variable">onSuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                response<span class="token punctuation">.</span>data <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">onSuccess</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">load</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> config<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Hls<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>出门右转 <a href="https://gist.github.com/TransparentLC/72b6ea086b9a28964496c2bc1b721aa4" target="_blank" rel="noopener">GitHub Gist</a> 下载更新后的脚本( ॑꒳ ॑ ) 这个脚本最后会输出一个 <code>video_online.m3u8.gif</code>，自行上传到任意图床即可（同样也可以将脚本中的上传部分自行修改为其它图床）。<a href="https://jsbin.com/qiqugiyeko/edit?html,output" target="_blank" rel="noopener">这里</a>是演示～（可以注意到，M3U8 并没有存在 alicdn 上，不过 TS 切片还是使用 alicdn 上传）</p><blockquote class="mdui-m-b-0 mdui-m-x-0 mdui-p-y-1" style="border-left:4px solid rgba(0,0,0,.36)"><strong>本作品采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</strong><br><strong>本文作者：✨小透明・宸✨</strong><br><strong>本文链接：<a href="https://akarin.dev/2020/02/07/alicdn-video-hosting/">https://akarin.dev/2020/02/07/alicdn-video-hosting/</a></strong></blockquote></article><div class="mdui-p-a-3 mdui-color-white" id="lv-container" data-id="city" data-uid="MTAyMC80NDUwOC8yMTAzOQ=="><script>(()=>{const e=document.createElement("script");e.src="https://cdn-city.livere.com/js/embed.dist.js",e.async=!0,document.body.appendChild(e)})()</script></div></div><div class="mdui-valign mdui-m-t-2"><a href="../../26/crypto-in-js-and-php/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_left</i> </a><span class="mdui-typo-body-1-opacity mdui-text-left mdui-m-l-1" title="在 Javascript 和 PHP 中进行加密和解密">上一篇</span> <span class="mdui-typo-body-1-opacity mdui-text-center" style="flex-grow:1"></span> <span class="mdui-typo-body-1-opacity mdui-text-right mdui-m-r-1" title="使用 PHP 的 Ratchet 框架搭建 WebSocket 服务端">下一篇</span> <a href="../../../01/10/php-websocket-server/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_right</i></a></div></main><footer class="mdui-container mdui-m-y-5 mdui-typo" style="display:flex;max-width:1024px"><div class="mdui-typo-body-1-opacity mdui-text-left">Copyright © 2021 ✨小透明・宸✨<br>Hosted by <a href="https://github.com/TransparentLC/transparentlc.github.io" target="_blank">Github Pages</a></div><div style="flex-grow:1"></div><div class="mdui-typo-body-1-opacity mdui-text-right">Powered by <a href="https://hexo.io" target="_blank">Hexo</a> <span class="mdui-hidden-xs-down">6.0.0</span><br>Theme - <a href="https://github.com/TransparentLC/hexo-theme-akarin" target="_blank">Akarin</a></div></footer><script src="https://cdn.jsdelivr.net/combine/npm/aplayer@1/dist/APlayer.min.js,gh/TransparentLC/transparentlc.github.io/js/mdui.min.js,npm/medium-zoom@1/dist/medium-zoom.min.js,npm/instant.page@5/instantpage.min.js,gh/TransparentLC/transparentlc.github.io/js/script.min.js"></script><script src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/bsz.min.js" async></script><script>/MicroMessenger/.test(navigator.userAgent)&&(()=>{const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/fuck-wechat.min.js",document.body.appendChild(e)})()</script></body></html>