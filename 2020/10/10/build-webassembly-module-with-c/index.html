<!doctype html><html lang="zh-Hans"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no" name="viewport"><meta content="webkit" name="renderer"><meta content="webkit" name="force-rendering"><meta content="✨小透明・宸✨" name="author"><meta content="" name="keywords"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon shortcut" type="image/ico"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="apple-touch-icon"><link href="/atom.xml" rel="alternate" type="application/atom+xml"><title>使用 C 语言和 Emscripten 编写自己的 WebAssembly 模块 | 存在感消失的地方|ω•`)</title><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://akarin.dev/2020/10/10/build-webassembly-module-with-c/"},"headline":"使用 C 语言和 Emscripten 编写自己的 WebAssembly 模块","datePublished":"2020-10-10T03:24:34.000Z","dateModified":"2020-10-10T03:24:34.000Z","author":{"@type":"Person","name":"✨小透明・宸✨","image":{"@type":"ImageObject","url":"https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"},"description":"身处寒夜 把握星光✨"},"publisher":{"@type":"Organization","name":"存在感消失的地方|ω•`)","logo":"https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png"},"keywords":"","description":null}</script><meta content="存在感消失的地方|ω•`)" property="og:site_name"><meta content="使用 C 语言和 Emscripten 编写自己的 WebAssembly 模块" property="og:title"><meta content="" property="og:description"><meta content="article" property="og:type"><meta content="https://akarin.dev/2020/10/10/build-webassembly-module-with-c/" property="og:url"><meta content="https://p.pstatp.com/origin/137350001c495b8b07e5c" property="og:image"><meta content="2020-10-10T03:24:34.000Z" property="article:published_time"><meta content="2020-10-10T03:24:34.000Z" property="article:modified_time"><meta content="✨小透明・宸✨" property="article:author"><script>document.documentMode&&(location.href="../../../../upgrade-browser.html")</script><script>document.addEventListener("WeixinJSBridgeReady",(()=>{const e=document.createElement("script");e.src="https://fastly.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/fuck-wechat.min.js",document.body.appendChild(e)}))</script><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/css/mdui.min.css" rel="stylesheet"><link href="https://gcore.jsdelivr.net/combine/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css,npm/prism-themes@1/themes/prism-vsc-dark-plus.min.css,npm/aplayer@1/dist/APlayer.min.css,gh/TransparentLC/transparentlc.github.io@da8e973/css/style.min.css" rel="stylesheet"><style>*{--sidebar-image:url(https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/sidebar_header.jpg);--sidebar-image-color:#958981;--banner-image:url(https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/daily_pic.png);--banner-image-color:#f09ea3;--post-thumbnail-color:#f09ea3;--copy-code-btn-color:#fff}</style><meta content="Hexo 6.2.0" name="generator"></head><body class="mdui-drawer-body-left mdui-theme-accent-pink mdui-theme-primary-pink"><script>window.switchDark=t=>{const a={auto:"mdui-theme-layout-auto",enable:"mdui-theme-layout-dark",disable:""};(t=t||localStorage.getItem("dark"))in a||(t="auto");for(const e in a)a[e]&&document.body.classList[e===t?"add":"remove"](a[e]);localStorage.setItem("dark",t)},switchDark()</script><button class="mdui-fab mdui-m-a-2 mdui-shadow-0 mdui-text-color-grey-700" mdui-drawer="{target:'#akarin-drawer'}" style="position:fixed;z-index:1"><i class="material-icons mdui-icon">menu</i></button><nav class="mdui-drawer mdui-drawer-full-height mdui-shadow-6" id="akarin-drawer"><div class="akarin-util-bg-cover mdui-p-x-2" id="akarin-drawer-media"><img class="akarin-hover-spin mdui-img-circle mdui-m-t-4" src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg" id="akarin-drawer-avatar"><div class="akarin-util-text-gradient mdui-card-media-covered"><div class="mdui-card-primary"><div class="mdui-typo-subheading">✨小透明・宸✨</div><div class="akarin-util-opacity-half mdui-typo-caption">存在感消失的地方|ω•`)</div></div></div></div><div class="mdui-list" mdui-collapse><div><a href="../../../../" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">home</i> <span class="mdui-list-item-content">主页</span></a></div><div><a href="../../../../about/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">person</i> <span class="mdui-list-item-content">关于</span></a></div><div><a href="../../../../friend/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">link</i> <span class="mdui-list-item-content">友链</span></a></div><div><a href="https://github.com/TransparentLC" target="_blank" rel="noopener" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">code</i> <span class="mdui-list-item-content">GitHub</span></a></div><div><a href="../../../../archives/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">collections_bookmark</i> <span class="mdui-list-item-content">归档</span> <small class="akarin-drawer-badge mdui-color-theme-accent">32</small></a></div><div><a href="../../../../atom.xml" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">rss_feed</i> <span class="mdui-list-item-content">RSS</span></a></div><div class="mdui-divider"></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">brightness_4</i> <span class="mdui-list-item-content">深色模式</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item" data-dark="auto"><span class="mdui-list-item-content">根据系统主题切换</span></div><div class="mdui-ripple mdui-list-item" data-dark="enable"><span class="mdui-list-item-content">启用</span></div><div class="mdui-ripple mdui-list-item" data-dark="disable"><span class="mdui-list-item-content">禁用</span></div></div></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">insert_chart</i> <span class="mdui-list-item-content">访问统计</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_pv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访客数</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_uv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">页面访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_page_pv">Loading</small></div></div></div></div></nav><picture id="akarin-top" title="返回顶部"><source srcset="https://fastly.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.avif" type="image/avif"><source srcset="https://fastly.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.webp" type="image/webp"><img src="https://fastly.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.png"></picture><div style="padding-top:20px"></div><div class="mdui-hidden-sm-down" style="padding-top:40px"></div><div class="mdui-hidden-md-down" style="padding-top:40px"></div><main class="mdui-container" style="max-width:1024px"><div class="akarin-util-rounded-5 mdui-card mdui-shadow-4"><div class="mdui-ripple akarin-post-bg akarin-util-bg-cover" data-src="https://p.pstatp.com/origin/137350001c495b8b07e5c" data-src-avif="https://vfile.meituan.net/mmdb/5afc55a0648ec96adcdd2342cd3cbf4368089.jpg" data-src-webp="https://ae01.alicdn.com/kf/H739031ee3c3e42d7ae41a53412ef3336v.jpg"><div class="akarin-blurred akarin-post-bg akarin-util-bg-cover" style="background-image:url(data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAkAEADASIAAhEBAxEB/8QAGwAAAgMBAQEAAAAAAAAAAAAABAYAAwUHAQL/xAAsEAACAQMDAwMDBAMAAAAAAAABAgMABBEFEiEiMUETFFFCYXEHM3LBgZGh/8QAFwEBAQEBAAAAAAAAAAAAAAAAAwQFAv/EACQRAAIBBAEDBQEAAAAAAAAAAAECAAMREjEhBBNBFCMyUXJC/9oADAMBAAIRAxEAPwA4yPjPqR1oQXl66CISx88KTgmsmLpIxGgAIrRtklMpCyoG+nIwM/8Aa26q+3m4Fl55XUy6QBfAE3YW3uFtDqNqRKSpLfVjI/BzQ8t1elOpowPkZ/qmBvcNbyp0sZIisgU7gCRwRkCly1truZgqKrq/dgQATk4XPliR47VJ6lBi7BTe1sd2j+kLAqMuCflqU2zFrhN4yueogEUwOkIWX2qokihWTcx61b5Bou2gSKGZI4Ss4QriTqwSPtk4rI1S1gVHmltljkWFyM9bYVjjajfagqdU7lWClVPiUU+lpLmuWR+5ml7oSAhAHB7KSCKLe+1LaCdhBHhlzV873+oRG7gtPRbCbCrZ3o5xzjsaxptsU0sMzmCdWAZSSO/n7imp11qWLKgt9i8Kp0xTJbufJ5EWLTVpmuFhmQR9geCTREF7K1+XFwZbdCenGCc/2PGK+Y9Hsb+a4Sx1pHESl+qFkAX+Roy2sLezO6TVIZ1iBfECGZf84K1yxrVQwqVjr4gREahSKlaFyG2TGDUNVt/cPBbzkwNjpGVIDdWCSM87uTRIg9mbaazhD+pkbFkMnpkgkk8+RQMOnaReXMcVneukxQfupw5HBIINGWtlJFc3VsLhTIA6dhyAOcAnxSIvTLSUi2QF2up5gu1dqrDm2hzqF6dPO8/RbPEvkqA2CP5ZNF6teql3AbodIbfGVQg5UAqu4jgFh1GvbCyn00l0QlmHVleK8vd9xcGchwkab3dVyQEIIjUf7b8gVN1Td1yUsVGo3TezbMG8y7K9nuNR1HTokkgRbkemUThmQYJw3jyBStdT6i+ozK2zcJdrMwXJC8V2CwgwvrPbos7oN5Ay3PgnziuUa5p91Hqd1dSwqyhlMrA7T8DFDSJGTZKCLWv4JjuQSqhXKkHK3mI+katdafMPTWN0YFTHKu5TmqFmZJ1Kgcv28c1KlaTf3+ZGu0/U6rDawSabp5KlXDOFdWIZeT2p70yCIc+mhcqMvtG5j8kipUqFye3uUMB3SfOU23YpGCKCYiRmYqAw7EDBqVKkXYlD/EyuOZ0cgY+aQP1Adk9gVON+/dUqU9MDvLAYnDc//9k)"></div><div class="akarin-util-text-gradient akarin-post-title"><div class="mdui-card-primary"><div class="mdui-card-primary-title mdui-text-color-white-text">使用 C 语言和 Emscripten 编写自己的 WebAssembly 模块</div></div></div></div><div class="mdui-valign mdui-card-header"><div><img class="akarin-hover-spin mdui-card-header-avatar" src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"><div class="mdui-card-header-title">✨小透明・宸✨</div><div class="mdui-card-header-subtitle">2020-10-10 11:24:34</div></div></div><article class="mdui-p-a-3 mdui-card-content mdui-typo"><p>和 JavaScript 一样，WebAssembly 也是一种可以在浏览器中运行的编程语言，不过它的性质更相当于汇编语言。wasm 文件由二进制的<a href="https://pengowray.github.io/wasm-ops/" target="_blank" rel="noopener">字节码</a>组成（也可以转换为类似于汇编语言的文本格式查看），可以<strong>从 C/C++、Rust 等编译执行的编程语言生成</strong>。当然，WebAssembly 也是跨平台的，编译出来的 wasm 文件在不同平台的浏览器中都可以运行。</p><p>WebAssembly 最大的特性就是和解释执行的 JS 相比的<strong>超高性能</strong>，甚至还可以将用其它语言编写的项目通过编译到 wasm 的方式<strong>移植到浏览器中运行</strong>（例如<a href="http://www.dnbwg.com/emularity.html?machine=touhou-fumaroku" target="_blank" rel="noopener">这个</a>使用 wasm 版的 DOSBox 运行的《东方封魔录》，运行起来也十分流畅）。不过我开这篇并不是为了去编译那些大型项目的……由于几乎每个接受过计算机相关教育的人都学习过 C 语言，自己用 C 写一个简单的 wasm 模块来提升前端代码的性能，是门槛并不高而且也很有意思的一件事情。</p><h1 id="从运行一个简单的模块开始"><a href="#从运行一个简单的模块开始" class="headerlink" title="从运行一个简单的模块开始"></a>从运行一个简单的模块开始</h1><p>要将 C/C++ 代码编译到 wasm 模块，我们需要准备好 <a href="https://emscripten.org/docs/getting_started/downloads.html" target="_blank" rel="noopener">Emscripten</a> 环境。</p><blockquote><p>即使是 Windows 用户，也可以在 WSL 里面直接安装。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/emscripten-core/emsdk.git
<span class="token class-name builtin">cd</span> emsdk
<span class="token function">git</span> pull
./emsdk <span class="token function">install</span> latest
./emsdk activate latest
<span class="token comment"># 以后每次打开shell都要执行下面这行</span>
<span class="token comment"># 如果不想每次都手动操作的话可以写到.bashrc里面</span>
<span class="token class-name builtin">source</span> ./emsdk_env.sh<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>WebAssembly 的运行环境本身只能执行计算任务，加载 wasm 模块时还需要导入一个包含 JS 函数、内存区等属性的对象，wasm 和浏览器的交互只能通过调用这些 JS 函数完成，内存区则是和运行环境外面的 JS 代码共享，可以用来交换数据。Emscripten 的功能不仅是编译 C/C++ 代码生成 wasm，它还可以生成一大堆 JS 的“胶水代码”用来连接浏览器和 WebAssembly 运行环境，实现 C/C++ 的那些标准库，对内存分配、输入输出等进行处理。</p><p><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/C_to_wasm#%E7%94%9F%E6%88%90_HTML_%E5%92%8C_JavaScript" target="_blank" rel="noopener">MDN 上的教程</a>就给出了一个从 Hello world 编译出 wasm 文件和对应的胶水代码、HTML 文件的例子。不过这胶水代码比 wasm 文件本身还大了不少……如果模块比较简单的话还是不太好的。好在 Emscripten 支持通过编译选项 <code>-s SIDE_MODULE=1</code> 使编译出来的 wasm 文件<a href="https://github.com/emscripten-core/emscripten/wiki/WebAssembly-Standalone#create-a-dynamic-library" target="_blank" rel="noopener">作为一个单独的动态库</a>，这样就不需要那一堆胶水代码了，不过与 JS 部分的交互也需要自己完成。各种用到的标准库函数，需要自己在 C/C++ 里实现（<code>memset</code>、<code>memcpy</code> 和 <code>strlen</code> 之类的比较简单的可以直接抄 <a href="https://github.com/emscripten-core/emscripten/tree/main/system/lib/libc" target="_blank" rel="noopener">Emscripten 的实现</a>），或者在 JS 里通过操作内存区实现后导入 wasm 模块。</p><p>根据 <a href="https://github.com/emscripten-core/emscripten/blob/aa66f92b790c8d319d1599d44657a6305bf74a8a/src/settings.js#L953" target="_blank" rel="noopener">Emscripten 的说明</a>，<code>SIDE_MODULE</code> 可以设为 1 和 2，区别在于前者会导出 C/C++ 代码里所有的函数，后者会把没有用到的代码删减掉，这时就需要自己 <code>#include &lt;emscripten/emscripten.h></code> 然后手动在需要导出的函数前面加上 <code>EMSCRIPTEN_KEEPALIVE</code>。</p><p>从一个简单的计算两数相乘的模块开始。因为这只是一个函数库，所以 main 函数是不需要的，而且就算写了也不会在加载的时候自动执行。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">EMSCRIPTEN_KEEPALIVE
<span class="token keyword">int</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span></span></code></pre><p>编译，<code>-O3</code> 代表使用最高速度的编译优化：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">emcc multiply.c -O3 -s <span class="token variable assign-left">SIDE_MODULE</span><span class="token operator">=</span><span class="token number">1</span> -o multiply.wasm<span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre><p>也可以使用 <code>-Oz</code> 表示使编译出来的文件大小更小的编译优化，当然运行起来就会慢很多。</p><p>在 HTML 中使用以下的 JS 代码加载（目前 <code>importObject</code> 还可以省略不写）：</p><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'multiply.wasm'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span></span></code></pre><p>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming" target="_blank" rel="noopener"><code>WebAssembly.instantiateStreaming</code></a> 加载更简洁，但是需要提供正确的 MIME 类型 <code>application/wasm</code>。</p><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'multiply.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    importObject
<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span></span></code></pre><p>另外，上面的两种写法都是异步加载模块的，这是因为如果是同步加载大型模块的话会出现较长时间的阻塞（Chrome 甚至自己规定了同步加载的模块不能超过 4 KB）。如果模块较小，加载时间可以忽略不计，而且也需要在同步执行的代码中使用模块的话，可以将模块的二进制数据以 <code>Uint8Array</code> 的格式（不过更建议从 Base64 字符串转换过来，代码更简短）写进 JS 代码，然后用下面的写法加载：</p><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token comment">// 以后创建wasmModule时可以复用m，不需要重新加载</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span></span></code></pre><p>加载完成后，就可以通过 <code>wasmModule.exports</code> 找到模块导出的函数了。WebAssembly 也是强类型的（32/64 位整数/浮点数），所以在这个例子中如果使用了小数会自动进行类型转换，并不能得到正确的结果，另外也需要注意溢出的问题。</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/542*494),494px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/Hf475ef5e755d47ad817fc2da532fec99G.png" data-src-webp="https://ae01.alicdn.com/kf/H81425f6758c5414aaf6df7d13663a59eZ.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAdACADASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAABAACAwUH/8QAKhAAAgEDAgQEBwAAAAAAAAAAAQIRAAMhEkEEEzFhFSMkwUJRcoGSodH/xAAXAQADAQAAAAAAAAAAAAAAAAAAAQID/8QAGREBAQEAAwAAAAAAAAAAAAAAAREAAhIx/9oADAMBAAIRAxEAPwD3TixYAARQpk5INZW7TsuhQsz8jAre/eQkw6ySfiA2ih6cZ0ZwcjatDqFWOhpyGZXh/EkZNr7E0rh+Hv2CSVtGe5HtQktK+VEmZhYPvTQqdeWAevSpUvuZVsmMtx1cw5AM50E71rzXAPmn8DRLl1rVwFGYEg5GnYntXQVGZQec+RO38qVHO3US80ibrETEaIq9Tkvn1FzP04/VQCABJPejG//Z"></figure><p>以下是对应的“汇编代码”，<code>$multiply</code> 就是上面的相乘函数了：</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span><span class="token punctuation">)</span>
    <span class="token keyword">nop</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$multiply</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p0</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p1</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span>.get <span class="token variable">$p0</span>
    <span class="token keyword">local</span>.get <span class="token variable">$p1</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>mul</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$__dso_handle</span> <span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__wasm_apply_relocs"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"multiply"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$multiply</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__dso_handle"</span> <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__post_instantiate"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>使用 VSCode 的扩展 <a href="https://marketplace.visualstudio.com/items?itemName=dtsvet.vscode-wasm" target="_blank" rel="noopener">WebAssembly</a> 可以以文本格式显示打开的 wasm 文件，并且可以在两种格式之间相互转换。</p></blockquote><h1 id="使用外部函数、内存和指针"><a href="#使用外部函数、内存和指针" class="headerlink" title="使用外部函数、内存和指针"></a>使用外部函数、内存和指针</h1><p>接下来是做一件每种编程语言的初学者都喜欢做的事：输出一个 Hello world。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"WebAssembly模块测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编译……等下，既然是编译到 WebAssembly 了，那从哪里找到标准库 <code>stdio.h</code> 和这个 <code>puts</code> 呢？看一下文本格式代码：</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm"><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"env"</span> <span class="token string">"puts"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$env.puts</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"env"</span> <span class="token string">"__memory_base"</span> <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$env.__memory_base</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"env"</span> <span class="token string">"memory"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token variable">$env.</span><span class="token keyword">memory</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span><span class="token punctuation">)</span>
    <span class="token keyword">nop</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$hello_world</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$t0</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$l0</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">global</span>.get <span class="token variable">$env.__memory_base</span>
    <span class="token keyword">local</span>.tee <span class="token variable">$l0</span>
    <span class="token keyword">call</span> <span class="token variable">$env.puts</span>
    <span class="token keyword">drop</span>
    <span class="token keyword">local</span>.get <span class="token variable">$l0</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span>
    <span class="token keyword">call</span> <span class="token variable">$env.puts</span>
    <span class="token keyword">drop</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$__dso_handle</span> <span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__wasm_apply_relocs"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"hello_world"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$hello_world</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__dso_handle"</span> <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"__post_instantiate"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$__wasm_apply_relocs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token variable">$d0</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$env.__memory_base</span><span class="token punctuation">)</span> <span class="token string">"Hello world!\00WebAssembly\e6\a8\a1\e5\9d\97\e6\b5\8b\e8\af\95\00"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>puts</code> 是需要自己从 JS 中导入的。在 C 的代码里实际上也可以不写 <code>#include &lt;stdio.h></code>，直接用 <code>int puts(const char *str);</code> 声明也是没问题的。</p><p>字符串被全部写进了一个数据段（汉字部分和源代码一样使用了 UTF-8 编码）。在加载 wasm 模块的时候需要提供一块内存区域用来从某个偏移位置开始保存这些数据。</p><p>这里就先使用 <code>console.log</code> 代替 <code>puts</code>，并且创建一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory" target="_blank" rel="noopener"><code>WebAssembly.Memory</code></a> 作为内存区域，通过一个对象（也就是上面的 <code>importObject</code>）传递给要加载的 wasm 模块：</p><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmMemory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property literal-property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wasmBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'hello-world.wasm'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token property literal-property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property literal-property">puts</span><span class="token operator">:</span> console<span class="token punctuation">.</span>log<span class="token punctuation">,</span>
            <span class="token property literal-property">memory</span><span class="token operator">:</span> wasmMemory<span class="token punctuation">,</span>
            <span class="token property literal-property">__memory_base</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>WebAssembly.Memory</code> 是一块用于 wasm 模块的内存，以 64 KB 为一“页”作为分配的基本单位，也可以在创建后动态扩容。在 JS 中可以通过 <code>TypedArray</code> 对它进行读写。</p></blockquote><p>加载并执行一下试试看：</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/723*329),329px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/Had9484e4759b4fe6b4c7c4a1f3f7d254i.png" data-src-webp="https://ae01.alicdn.com/kf/H6ec662f7bba04b7cb7039848a799c5fcj.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAPACADASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAwQAAQf/xAAgEAACAQIHAQAAAAAAAAAAAAABAgADEQQSEyExUdFS/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgAB/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQAREiH/2gAMAwEAAhEDEQA/ANzrqlVwKQ62uINsPVYrdIcLTZiMxvboeQmiu3gj7QMs91ZelhipBfjoExwAAWAlaafAkCKOFEFF/9k"></figure><p>字符串被写入了内存中从 <code>__memory_base</code> 开始的位置，而和 C 语言一样，调用 <code>puts</code>（实际上是 <code>console.log</code>）的参数是字符串开始的指针（数组下标）。如果自己实现一个 <code>puts</code>，就可以将字符串输出到控制台（或者是页面上某个 DOM 的 innerText）了。</p><blockquote><p>顺便一提，有个叫 <a href="https://github.com/locutusjs/locutus" target="_blank" rel="noopener">Locutus</a> 的库尝试使用 JS 实现其他语言的标准库，虽然对于 C 的实现并不多……</p><p>比如要实现 <code>sprintf</code> 或 <code>printf</code>，就可以参考<a href="https://github.com/locutusjs/locutus/blob/master/src/c/stdio/sprintf.js" target="_blank" rel="noopener">这里</a>。</p></blockquote><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmMemory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property literal-property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wasmBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wasmModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'hello-world.wasm'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token property literal-property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将从指针开始到下一个0x00之间的数据用UTF-8解码，然后用console.log输出</span>
            <span class="token function function-variable">puts</span><span class="token operator">:</span> <span class="token parameter">ptr</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>
                    wasmBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>
                        ptr<span class="token punctuation">,</span>
                        wasmBuffer<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i <span class="token operator">>=</span> ptr <span class="token operator">&&</span> <span class="token operator">!</span>e<span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token property literal-property">memory</span><span class="token operator">:</span> wasmMemory<span class="token punctuation">,</span>
            <span class="token property literal-property">__memory_base</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/705*749),749px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/H75ed678f9ffc414e9b3d8190047ee58bs.png" data-src-webp="https://ae01.alicdn.com/kf/He83f806c53164f3294a93ed93051f1aet.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgAB4DASIAAhEBAxEB/8QAGQAAAwADAAAAAAAAAAAAAAAAAAMEAgUH/8QAJRAAAgIBAgUFAQAAAAAAAAAAAQIAEQMEIRIxMlGhE0FCYXGR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQACMVH/2gAMAwEAAhEDEQA/AO863TEANjX9HapBk6huv9m1JoExV4MuRTTBvpRXkTedJR1fSRpsJBDFQy+1HaWQCEfM+IcJvrPiYgomfL6u1tXLhBJlCjJsS5qTWQ5ARWrshJlaBqHKu3DUVmzhCEKv/9k"></figure><p>试着将内存中的第一个单元的数据改成 <code>0x41</code>（也就是字母 A），再次调用函数，可以看到输出的内容也发生了相应的变化。当然，实际使用的时候，如果需要向内存中写入数据，就要根据 <code>__memory_base</code> 和代码中数据段的大小自己预留好内存空间，避免覆盖了 wasm 模块内部使用的数据。</p><p>如果代码中需要用到局部变量，根据常识可以知道这些变量是存储在栈里的，编译出的 wasm 也会要求引入 <code>__stack_pointer</code> 用来设置栈指针：</p><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    <span class="token property literal-property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property literal-property">__stack_pointer</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Global</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token property literal-property">mutable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token property literal-property">value</span><span class="token operator">:</span> <span class="token string">'i32'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token number">0x1000</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>和真实的 CPU 一样，栈指针也是向低地址延伸的，于是我们就得到了这样的一个简单的进程地址空间模型：<code>| 只读数据 | &lt;- 栈 | 堆 -> |</code>，这已经开始有点涉及到操作系统的知识了……</p><p>既然提到堆了，能不能用 <code>malloc</code> 和 <code>free</code> 在堆上动态分配内存呢？然而，即使不考虑性能，一个完整的内存分配器非常复杂，在这种编译为 <code>SIDE_MODULE</code> 的简单模块的情况下是无法使用的，这里不再深入介绍。<a href="https://surma.dev/things/c-to-webassembly/" target="_blank" rel="noopener">这篇文章</a>的“Building an allocator”部分提出了一种简单的替代方法：分配的内存地址只是从堆的起始地址开始不断累加已分配的内存大小，至于 <code>free</code>？直接空着。</p><h1 id="一个使用-WebAssembly-将性能提高到-30x-的例子"><a href="#一个使用-WebAssembly-将性能提高到-30x-的例子" class="headerlink" title="一个使用 WebAssembly 将性能提高到 30x 的例子"></a>一个使用 WebAssembly 将性能提高到 30x 的例子</h1><p>接下来就用一个实际的例子，来展示 WebAssembly 和 JS 相比在计算密集型任务上的超高性能。我分别用 WebAssembly 和 JS 试着实现了一遍 <a href="https://zh.wikipedia.org/wiki/RC4" target="_blank" rel="noopener">RC4 加解密算法</a>。为什么用了 RC4 作为例子？</p><ul><li>加密和解密涉及到大量的计算操作</li><li>RC4 的算法简短，且加密和解密是同一套算法，易于实现</li><li>RC4 是流密码，对明文和密钥的长度<abbr title="明文长度不限，密钥长度 40-2048 位">要求不多</abbr>，也不需要像分组密码一样处理不同的工作模式，易于使用</li><li>有一定的实用性（虽然现在 RC4 的安全性已经比较有限了……）</li></ul><p>以下是来自 Wikipedia 的伪代码：</p><pre class="line-numbers language-none"><code class="language-none">for i from 0 to 255
    S[i] := i
endfor
j := 0
for( i=0 ; i&lt;256 ; i++)
    j := (j + S[i] + key[i mod keylength]) % 256
    swap values of S[i] and S[j]
endfor
i := 0
j := 0
while GeneratingOutput:
    i := (i + 1) mod 256
    j := (j + S[i]) mod 256
    swap values of S[i] and S[j]
    k := inputByte ^ S[(S[i] + S[j]) % 256]
    output K
endwhile<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>照着伪代码，用 JS 实现一遍（经检验，实现完全正确，检验过程略）：</p><p></p><details><summary>使用 JS 的实现</summary><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * @param {Uint8Array} key
 * @param {Uint8Array} input
 * @returns {Uint8Array}
 */</span>
<span class="token keyword">const</span> <span class="token function function-variable">jsRc4</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> input</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> keyLength <span class="token operator">=</span> key<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> inputLength <span class="token operator">=</span> input<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">const</span> sbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> keyLength<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>inputLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> inputLength<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        output<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">^</span> sbox<span class="token punctuation">[</span><span class="token punctuation">(</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details><p></p><p>然后移植到 C 语言 <del>一看就是一个模子刻出来的</del>：</p><p></p><details><summary>使用 C 语言的实现，以及相关的 JS 胶水代码</summary><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sbox<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">rc4</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>input<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> keyLength<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inputLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> temp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// j = (j + sbox[i] + key[i % keyLength]) & 0xFF;</span>
        j <span class="token operator">+=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> keyLength<span class="token punctuation">]</span><span class="token punctuation">;</span>
        temp <span class="token operator">=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> inputLength<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        <span class="token comment">// j = (j + sbox[i]) & 0xFF;</span>
        j <span class="token operator">+=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        temp <span class="token operator">=</span> sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
        input<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">^=</span> sbox<span class="token punctuation">[</span><span class="token punctuation">(</span>sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> sbox<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> wasmMemory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property literal-property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wasmInstance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'rc4.wasm'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> WebAssembly<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token property literal-property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property literal-property">memory</span><span class="token operator">:</span> wasmMemory<span class="token punctuation">,</span>
            <span class="token property literal-property">__memory_base</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {Uint8Array} key
 * @param {Uint8Array} input
 * @returns {Uint8Array}
 */</span>
<span class="token keyword">const</span> <span class="token function function-variable">wasmRc4</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> input</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 内存的分布：前256字节保留给S盒，然后是x字节的密钥和x字节的输入</span>
    <span class="token comment">// 如果内存不足则进行扩容</span>
    <span class="token keyword">const</span> sboxOffset <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> memoryRequired <span class="token operator">=</span> key<span class="token punctuation">.</span>length <span class="token operator">+</span> input<span class="token punctuation">.</span>length <span class="token operator">+</span> sboxOffset<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryRequired <span class="token operator">></span> wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wasmMemory<span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>memoryRequired <span class="token operator">-</span> wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">65536</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> wasmBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmMemory<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wasmBuffer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sboxOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wasmBuffer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wasmInstance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">rc4</span><span class="token punctuation">(</span>sboxOffset<span class="token punctuation">,</span> sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>wasmBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span> sboxOffset <span class="token operator">+</span> key<span class="token punctuation">.</span>length <span class="token operator">+</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details><p></p><p>测试则是使用 <del>1KB 的随机密钥</del>，分别使用两种实现来加密 4KB、8KB……128MB 的同一份随机数据，并比较执行时间。</p><p><em>测完才意识到其实并不需要这么长的密钥……<strong>超过前 256 字节的部分是没有意义的</strong>，不过这也不会影响测试结果，所以就不重新测啦！</em></p><p></p><details><summary>测试代码</summary><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> inputLength <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inputLength <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rc4Key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rc4Input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>inputLength<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'wasm-start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> wasmEncrypted <span class="token operator">=</span> <span class="token function">wasmRc4</span><span class="token punctuation">(</span>rc4Key<span class="token punctuation">,</span> rc4Input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'wasm-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'js-start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> jsEncrypted <span class="token operator">=</span> <span class="token function">jsRc4</span><span class="token punctuation">(</span>rc4Key<span class="token punctuation">,</span> rc4Input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'js-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'wasm'</span><span class="token punctuation">,</span> <span class="token string">'wasm-start'</span><span class="token punctuation">,</span> <span class="token string">'wasm-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'js-start'</span><span class="token punctuation">,</span> <span class="token string">'js-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> inputLength<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>wasmEncrypted<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!==</span> jsEncrypted<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">'Not equal'</span><span class="token punctuation">;</span>

    results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token property literal-property">length</span><span class="token operator">:</span> inputLength<span class="token punctuation">,</span>
        <span class="token property literal-property">wasmTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'wasm'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>duration<span class="token punctuation">,</span>
        <span class="token property literal-property">jsTime</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>duration<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    performance<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    performance<span class="token punctuation">.</span><span class="token function">clearMeasures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> acc<span class="token punctuation">)</span> acc<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> cur<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> acc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property literal-property">length</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property literal-property">wasmTime</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property literal-property">jsTime</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
results<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    r<span class="token punctuation">.</span>wasmSpeed <span class="token operator">=</span> r<span class="token punctuation">.</span>length <span class="token operator">/</span> r<span class="token punctuation">.</span>wasmTime<span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>jsSpeed <span class="token operator">=</span> r<span class="token punctuation">.</span>length <span class="token operator">/</span> r<span class="token punctuation">.</span>jsTime<span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>ratio <span class="token operator">=</span> r<span class="token punctuation">.</span>wasmSpeed <span class="token operator">/</span> r<span class="token punctuation">.</span>jsSpeed<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details><p></p><p>至于测试结果嘛……首先是在我自己日常用的 Firefox 上测试，性能直接提升了 8x！（最后一行是以上测试结果的总和）</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/533*558),558px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/H3d340f0428e547e2af3a74c41b2a495cj.png" data-src-webp="https://ae01.alicdn.com/kf/H3837f04fbf9f49d6bfb820ff45e36e0aR.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgAB8DASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAABAUAAgEDB//EACsQAAEDAgUCBAcAAAAAAAAAAAECAxEAEgQTITFBBSIUMkJhIyQzNHGSsf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDtYCouQw4YVbPZvPuqtriXwlVzLkASR2bftWcGSA8nSM5JgJIG9G4qLMTt9IcTyaBYAlLQcOGcsOg1T+OFVZvKccsDCxzJI2ieDUdyh0tsCyQuSLP6BVsAYxRjawAwgjYaa0FMG4M51IWIK0SMyfVAo7GqhT6ZH25MXRsaVJUtLqj3nXTsToQoGmWPK88hIVqwoaAGgVg/JuGQe5Mw77HmmPTIz3NR5B67qASHPCuD4hJWmO1M80f04lLrshXlESAKD//Z"></figure><p>然后是 Chrome 上的测试结果。即使是面对使用了性能最强的 V8 引擎的 Chrome，WebAssembly 的性能优势仍然能达到 2x（虽然速度和 Firefox 那边差不多……）</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/727*540),540px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/Hf4bc9d25a9184a0e89e398a40fe71950s.png" data-src-webp="https://ae01.alicdn.com/kf/H2c771e7ff0934e4bb270160637753b07D.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMBBAcG/8QAJRAAAQQBAwMFAQAAAAAAAAAAAQACAxIEByExBRRBERMjUXPR/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAMAwEAAhEDEQA/AOifprhvjs7Nl5IAJaqk2lnRzEDJlz38VoVqUkg7Y7cSlVrih2SjL2aS9IkdE1mbk782qFI0j6X6gd5Pu+i1bHf8kH2ZE6BwOQAePdKt0V3FlHt8X/qUKFhQhQOgLLw/onwlvdD9ChCD/9k"></figure><p>至于标题上的 30x……是在已经弃坑的旧版 Edge 里面测出来的，不过不论是 WebAssembly 还是 JS 这执行速度都比另外两个差了一大截。</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/648*498),498px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/Ha4ad8d104302413383ce3ce0db556e91E.png" data-src-webp="https://ae01.alicdn.com/kf/H5a5e94d374a5477dafe1869bf5e24a35u.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAZACADASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAABAACBQMH/8QAJBAAAgEDBAICAwAAAAAAAAAAAQIDAAQREiExQRMyQrEFUXH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAAL/xAAZEQEBAQADAAAAAAAAAAAAAAABAgASMVH/2gAMAwEAAhEDEQA/APW4Px1nYxvJDaImvYhTksVPeRSnkjeDLxtzjR1tUlV3ttK+wlbsCjNDOIVGNyx4w2eP1WqqqrlVK+rszMzPGZA8DKWO2cxhLSM6h8mYb1aG1t5JEUWcQ1E76m6qlksizQeQEYJ5pFnlbiEtxl/qhV7ckh0BhSM/ilAHDk1ySWVIQykhgzYOONhW8Kh6ozsyznmmuIWlJJ33pFiSbiLI+T/VNi91/pqRe6Va3//Z"></figure><p>（IE 不资辞 WebAssembly，直接爬吧）</p><p>你也可以在<a href="https://jsbin.com/taxocoripu/edit?html,output" target="_blank" rel="noopener">这里</a>自己试试看～（wasm 文件已经以 Data URL 的形式嵌入了）</p><p>结论是显而易见的，WebAssembly 的性能比 JS 不知道高到哪里去了。而且如果不写清楚函数名的话，直接对着它的“汇编代码”很难看出是 RC4 算法，所以把一些关键操作放进 wasm 模块或许也是个防止前端代码被逆向的好主意？</p><p>即使不熟悉 C 语言和 Emscripten 的那一套工具，GitHub 上也有 <a href="https://github.com/ballercat/walt" target="_blank" rel="noopener">Walt</a> 和 <a href="https://github.com/AssemblyScript/assemblyscript" target="_blank" rel="noopener">AssemblyScript</a> 这样的工具可以直接使用 TypeScript 的语法编写 wasm 模块，以后再试试看吧～</p><h1 id="Extra：WebAssembly-的-SIMD-支持"><a href="#Extra：WebAssembly-的-SIMD-支持" class="headerlink" title="Extra：WebAssembly 的 SIMD 支持"></a>Extra：WebAssembly 的 SIMD 支持</h1><p>WebAssembly 的标准里是有 <a href="https://github.com/WebAssembly/simd" target="_blank" rel="noopener">SIMD 指令集的提案</a>的，最近各大浏览器以及 Node.js 的 JS 引擎终于<a href="https://github.com/WebAssembly/simd/blob/main/proposals/simd/ImplementationStatus.md" target="_blank" rel="noopener">实装了对 SIMD 的支持</a>。理论上来说，使用 SIMD 可以进一步增加 wasm 的执行速度（虽然我做过的简单测试里似乎并不是这样……）</p><p>参考 <a href="https://github.com/GoogleChromeLabs/wasm-feature-detect" target="_blank" rel="noopener">GoogleChromeLabs/wasm-feature-detect</a>，可以用下面的代码检测对 SIMD 的支持：</p><pre class="language-javascript line-numbers" data-language="javascript"><code class="language-javascript">WebAssembly<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">109</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">253</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">253</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre><p>根据 <a href="https://emscripten.org/docs/porting/simd.html" target="_blank" rel="noopener">Emscripten 文档</a>所述，编译时只要添加参数 <code>-msimd128</code> 就可以直接在编译的时候使用 SIMD 优化了。</p><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/82627900" target="_blank" rel="noopener">Pixiv ID: 82627900 「After school~」 by 呱子</a></p></blockquote><blockquote class="mdui-m-b-0 mdui-m-x-0 mdui-p-y-1" style="border-left:4px solid rgba(0,0,0,.36)"><strong>本作品采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。</strong><br><strong>本文作者：✨小透明・宸✨</strong><br><strong>本文链接：<a href="https://akarin.dev/2020/10/10/build-webassembly-module-with-c/">https://akarin.dev/2020/10/10/build-webassembly-module-with-c/</a></strong></blockquote></article><div class="mdui-p-a-3 mdui-color-white" id="lv-container" data-id="city" data-uid="MTAyMC80NDUwOC8yMTAzOQ=="><script>(()=>{const e=document.createElement("script");e.src="https://cdn-city.livere.com/js/embed.dist.js",e.async=!0,document.body.appendChild(e)})()</script></div></div><div class="mdui-valign mdui-m-t-2"><a href="../../../../2021/01/28/idioms-solitaire/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_left</i> </a><span class="mdui-typo-body-1-opacity mdui-text-left mdui-m-l-1" title="成语接龙的求解算法">上一篇</span> <span class="mdui-typo-body-1-opacity mdui-text-center" style="flex-grow:1"></span> <span class="mdui-typo-body-1-opacity mdui-text-right mdui-m-r-1" title="高校疫情防控笑话合集">下一篇</span> <a href="../../../09/01/jokes-of-controlling-covid-in-university/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_right</i></a></div></main><footer class="mdui-container mdui-m-y-5 mdui-typo" style="display:flex;max-width:1024px"><div class="mdui-typo-body-1-opacity mdui-text-left">Copyright © 2022 ✨小透明・宸✨<br>Hosted by <a href="https://github.com/TransparentLC/transparentlc.github.io" target="_blank">Github Pages</a></div><div style="flex-grow:1"></div><div class="mdui-typo-body-1-opacity mdui-text-right">Powered by <a href="https://hexo.io" target="_blank">Hexo</a> <span class="mdui-hidden-xs-down">6.2.0</span><br>Theme - <a href="https://github.com/TransparentLC/hexo-theme-akarin" target="_blank">Akarin</a></div></footer><script src="https://gcore.jsdelivr.net/combine/gh/TransparentLC/transparentlc.github.io/js/mdui.min.js,npm/medium-zoom@1/dist/medium-zoom.min.js,npm/instant.page@5/instantpage.min.js,npm/aplayer@1/dist/APlayer.min.js,gh/TransparentLC/transparentlc.github.io@da8e973/js/script.min.js"></script><script src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/bsz.min.js" async></script></body></html>