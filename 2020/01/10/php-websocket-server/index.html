<!doctype html><html lang="zh-Hans"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no" name="viewport"><meta content="webkit" name="renderer"><meta content="webkit" name="force-rendering"><meta content="✨小透明・宸✨" name="author"><meta content="" name="keywords"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon shortcut" type="image/ico"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="icon"><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png" rel="apple-touch-icon"><link href="/atom.xml" rel="alternate" type="application/atom+xml"><title>使用 PHP 的 Ratchet 框架搭建 WebSocket 服务端 | 存在感消失的地方|ω•`)</title><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://akarin.dev/2020/01/10/php-websocket-server/"},"headline":"使用 PHP 的 Ratchet 框架搭建 WebSocket 服务端","datePublished":"2020-01-10T14:27:32.000Z","dateModified":"2020-01-10T14:27:32.000Z","author":{"@type":"Person","name":"✨小透明・宸✨","image":{"@type":"ImageObject","url":"https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"},"description":"身处寒夜 把握星光✨"},"publisher":{"@type":"Organization","name":"存在感消失的地方|ω•`)","logo":"https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/favicon.png"},"keywords":"","description":"不需要使用轮询了！"}</script><meta content="存在感消失的地方|ω•`)" property="og:site_name"><meta content="使用 PHP 的 Ratchet 框架搭建 WebSocket 服务端" property="og:title"><meta content="不需要使用轮询了！" property="og:description"><meta content="article" property="og:type"><meta content="https://akarin.dev/2020/01/10/php-websocket-server/" property="og:url"><meta content="https://ae01.alicdn.com/kf/H7b335f1a00874624b4fe845596bab618O.jpg" property="og:image"><meta content="2020-01-10T14:27:32.000Z" property="article:published_time"><meta content="2020-01-10T14:27:32.000Z" property="article:modified_time"><meta content="✨小透明・宸✨" property="article:author"><script>document.documentMode&&(location.href="../../../../upgrade-browser.html")</script><script>document.addEventListener("WeixinJSBridgeReady",(()=>{const e=document.createElement("script");e.src="https://fastly.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/fuck-wechat.min.js",document.body.appendChild(e)}))</script><link href="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/css/mdui.min.css" rel="stylesheet"><link href="https://gcore.jsdelivr.net/combine/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css,npm/prism-themes@1/themes/prism-vsc-dark-plus.min.css,npm/aplayer@1/dist/APlayer.min.css,gh/TransparentLC/transparentlc.github.io@879beec/css/style.min.css" rel="stylesheet"><style>*{--sidebar-image:url(https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/sidebar_header.jpg);--sidebar-image-color:#958981;--banner-image:url(https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/daily_pic.png);--banner-image-color:#f09ea3;--post-thumbnail-color:#f09ea3;--copy-code-btn-color:#fff}</style><meta content="Hexo 6.3.0" name="generator"></head><body class="mdui-drawer-body-left mdui-theme-accent-pink mdui-theme-primary-pink"><script>window.switchDark=t=>{const a={auto:"mdui-theme-layout-auto",enable:"mdui-theme-layout-dark",disable:""};(t=t||localStorage.getItem("dark"))in a||(t="auto");for(const e in a)a[e]&&document.body.classList[e===t?"add":"remove"](a[e]);localStorage.setItem("dark",t)},switchDark()</script><button class="mdui-fab mdui-m-a-2 mdui-shadow-0 mdui-text-color-grey-700" mdui-drawer="{target:'#akarin-drawer'}" style="position:fixed;z-index:1"><i class="material-icons mdui-icon">menu</i></button><nav class="mdui-drawer mdui-drawer-full-height mdui-shadow-6" id="akarin-drawer"><div class="akarin-util-bg-cover mdui-p-x-2" id="akarin-drawer-media"><img class="akarin-hover-spin mdui-img-circle mdui-m-t-4" src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg" id="akarin-drawer-avatar"><div class="akarin-util-text-gradient mdui-card-media-covered"><div class="mdui-card-primary"><div class="mdui-typo-subheading">✨小透明・宸✨</div><div class="akarin-util-opacity-half mdui-typo-caption">存在感消失的地方|ω•`)</div></div></div></div><div class="mdui-list" mdui-collapse><div><a href="../../../../" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">home</i> <span class="mdui-list-item-content">主页</span></a></div><div><a href="../../../../about/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">person</i> <span class="mdui-list-item-content">关于</span></a></div><div><a href="../../../../friend/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">link</i> <span class="mdui-list-item-content">友链</span></a></div><div><a href="https://github.com/TransparentLC" class="mdui-ripple mdui-list-item" rel="noopener" target="_blank"><i class="material-icons mdui-icon mdui-list-item-icon">code</i> <span class="mdui-list-item-content">GitHub</span></a></div><div><a href="../../../../archives/" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">collections_bookmark</i> <span class="mdui-list-item-content">归档</span> <small class="akarin-drawer-badge mdui-color-theme-accent">33</small></a></div><div><a href="../../../../atom.xml" class="mdui-ripple mdui-list-item"><i class="material-icons mdui-icon mdui-list-item-icon">rss_feed</i> <span class="mdui-list-item-content">RSS</span></a></div><div class="mdui-divider"></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">brightness_4</i> <span class="mdui-list-item-content">深色模式</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item" data-dark="auto"><span class="mdui-list-item-content">根据系统主题切换</span></div><div class="mdui-ripple mdui-list-item" data-dark="enable"><span class="mdui-list-item-content">启用</span></div><div class="mdui-ripple mdui-list-item" data-dark="disable"><span class="mdui-list-item-content">禁用</span></div></div></div><div class="mdui-collapse-item mdui-collapse-item-open"><div class="mdui-ripple mdui-list-item mdui-collapse-item-header"><i class="material-icons mdui-icon mdui-list-item-icon">insert_chart</i> <span class="mdui-list-item-content">访问统计</span> <i class="material-icons mdui-icon mdui-collapse-item-arrow">keyboard_arrow_down</i></div><div class="mdui-list mdui-collapse-item-body"><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_pv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">站点访客数</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_site_uv">Loading</small></div><div class="mdui-ripple mdui-list-item"><span class="mdui-list-item-content">页面访问量</span> <small class="akarin-drawer-badge mdui-color-theme-accent" id="busuanzi_value_page_pv">Loading</small></div></div></div></div></nav><picture id="akarin-top" title="返回顶部"><source srcset="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.avif" type="image/avif"><source srcset="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.webp" type="image/webp"><img src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/top.png"></picture><div style="padding-top:20px"></div><div class="mdui-hidden-sm-down" style="padding-top:40px"></div><div class="mdui-hidden-md-down" style="padding-top:40px"></div><main class="mdui-container" style="max-width:1024px"><div class="akarin-util-rounded-5 mdui-card mdui-shadow-4"><div class="mdui-ripple akarin-post-bg akarin-util-bg-cover" data-src="https://ae01.alicdn.com/kf/H7b335f1a00874624b4fe845596bab618O.jpg" data-src-avif="https://vfile.meituan.net/mmdb/66bf91f10ffefea340d78f85fd7029dc54554.jpg" data-src-webp="https://ae01.alicdn.com/kf/He58779a4fabb461e83dc6a136a0b482dQ.jpg"><div class="akarin-blurred akarin-post-bg akarin-util-bg-cover" style="background-image:url(data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAaAEADASIAAhEBAxEB/8QAGgAAAgMBAQAAAAAAAAAAAAAABQYCAwQHAP/EACcQAAIBAwMDAwUAAAAAAAAAAAECAwAEEQUhMRJBUQYTYRUiMoGx/8QAGQEAAgMBAAAAAAAAAAAAAAAAAQQAAwUC/8QAHhEAAgMBAQADAQAAAAAAAAAAAREAAgMEEgUTUTH/2gAMAwEAAhEDEQA/AFEtUASRtU4RkkVekR/Ed6gJKhmRow2DsKJ2GhSXsMTx3EYLze2V5K9yxorodjBPdKl1AzJhsDOASPNPznTrFUdIokIGFEaYpLt6xiRUA+vLjXLz/YyUmopy+kLQI8Md2fe5V3I6T+hSDNC0bujDDIxVh8iuh3GqrL75EmDHyHblT2NIt1Ot3cSSoQVPBHBAqr4/o21tcXZCb/DLOzDPOtTVAtKDmjOQcVLccqKu3zxXmFakz4bS0VK3wWgLISMb4yavhAMtb9VAGnbDuP7XdgKeQB/TBV2BJM0vaSQWrPCwEgBKHn7gNq5/q/rSdoljit3judw4Y5RT5HmutMiLp8YVQBjgCuG60ifVMdI3bx80lpjlsXegJoYzTS+QVLIWEX0sb+6ZpWEjmRsljv1GnW0tJIYEWQDqC74pq6EW3iCqAOjgChktOeBQBfgi3r1BnRg1FkrX2FXxKpG6igA5HP/Z)"></div><div class="akarin-util-text-gradient akarin-post-title"><div class="mdui-card-primary"><div class="mdui-card-primary-title mdui-text-color-white-text">使用 PHP 的 Ratchet 框架搭建 WebSocket 服务端</div></div></div></div><div class="mdui-valign mdui-card-header"><div><img class="akarin-hover-spin mdui-card-header-avatar" src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/img/avatar.jpg"><div class="mdui-card-header-title">✨小透明・宸✨</div><div class="mdui-card-header-subtitle">2020-01-10 22:27:32</div></div></div><article class="mdui-p-a-3 mdui-card-content mdui-typo"><blockquote><p>封面图：<a href="https://www.pixiv.net/artworks/78461776" target="_blank" rel="noopener">Pixiv ID: 78461776 「お団子」 by tama2396</a></p></blockquote><p>几个月前，小透明尝试过<a href="/2019/09/03/use-polling-and-sse/">使用短轮询、长轮询、Server-Sent Events 三种不同的方式</a>实现了一个简单的留言板。</p><p>在查找相关资料时，小透明也已经知道了 HTML5 新增的 WebSocket 协议是在客户端、服务端之间实时发送数据的<strong>最高效的方式</strong>。遗憾的是由于当时姿势水平还不够，小透明当时并没有对 WebSocket 进行哪怕是再深入一点点的研究，最后还是在某个小项目中选用了短轮询 (っ ̯ -｡)</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1358*403),403px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/U20c8fd4f70b04f308fb272150165904cZ.png" data-src-webp="https://ae01.alicdn.com/kf/H1206b262ce0d409c8f0229299abc1550p.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAJACADASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAIDB//EACQQAAEDAgQHAAAAAAAAAAAAAAEAAgMiMRFxkdEEExQhIzJD/8QAFAEBAAAAAAAAAAAAAAAAAAAAAv/EABsRAAICAwEAAAAAAAAAAAAAAAABAiEREpEx/9oADAMBAAIRAxEAPwDsUfFx8ptMmOA+Ltlv1UFNEt+/hfsjs9BkEpt25prTHkugSnVrgiJrJao2ECxDmuYdCEgwYAkjUqWWOao2RGf/2Q"></figure><p>虽然没有人在意屏幕上的消息为什么每隔一秒才会刷新一次，每秒数百个的 AJAX 请求也没有对服务器造成严重的压力，但是总觉得还是有点不对劲……</p><blockquote><p>大量的网络流量被用于请求头和响应头，而真正有价值的消息主体只占了极小一部分，这简直是对网络资源的极大浪费！(╯‵□′)╯︵┻━┻<br><span style="display:block;text-align:right">——沃兹基・硕德</span></p></blockquote><p>WebSocket 是建立在 TCP 连接上进行全双工通讯的协议，然鹅小透明当时才刚开始学计算机网络，不知道数据帧一般是什么结构、不知道 TCP 协议是什么、不知道什么是套接字、不知道什么是 bind/listen/accept/……然后查资料的时候又看到这种东西，就直接被劝退了：</p><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1305*890),890px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/H3b466a98774143e496b9cc0594714d9au.png" data-src-webp="https://ae01.alicdn.com/kf/Hc78943befbd441198194161407f4c40b2.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAWACADASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQf/xAAlEAABAwIFBAMAAAAAAAAAAAABAAIRAxIEISIx0TJhcoETQUP/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8A7cKTBN2Zn6gcp4FADok+SSWtud0nUd0Eahoz9IH20T+Pu4qgMwrTLQQexKQNgtQRurtzBYVhrhhcAySO44QhBVh/lrzaxoA3lx4VBoVRvZHkeEIQf//Z"></figure><p>自己查找资料造一个 WebSocket 服务端的轮子需要涉及到套接字编程、数据帧解析之类的知识。即使是现在学完了计算机网络，完全实现仍然是<strong>非常困难的</strong>。</p><p>后来在期末复习周摸鱼的时候，小透明找到了 <a href="http://socketo.me/" target="_blank" rel="noopener">Ratchet</a> 这个可以在 PHP 中搭建 WebSocket 服务端的框架，于是开始尝试了解它的使用方法～</p><p>这篇的重点是如何用 PHP 搭建 WebSocket 的服务端，至于客户端就是浏览器运行 JS 代码创建的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket" target="_blank" rel="noopener"><code>WebSocket</code></a> 对象。所有的主流浏览器（甚至还包括 IE 10！）都支持使用 WebSocket 协议。</p><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>这次仍然是使用一个十分简单、没有样式的留言板页面进行演示～</p><ul><li>发送消息：在文本框 <code>message</code> 中输入内容，点击按钮 <code>send</code> 发送。</li><li>接收消息：服务端将收到的消息纯文本发送给所有客户端，显示在 <code>timeline</code> 中。</li></ul><figure class="akarin-blurred-container"><div style="padding-bottom:min(calc(100%/1358*861),861px,480px)"></div><img class="mdui-hoverable mdui-img-rounded" data-src="https://ae01.alicdn.com/kf/H781ccef3ab864e00b0630aae8681298aD.png" data-src-webp="https://ae01.alicdn.com/kf/Hadb095831f894820b6fe6d001e95cef7l.jpg"> <img class="mdui-hoverable mdui-img-rounded akarin-blurred" src="data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAUACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAIBAwQH/8QAKBAAAQQBAQYHAQAAAAAAAAAAAQACAxEEEhMhMkGBkiIxQ1Fh0dJx/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/8QAGREBAQADAQAAAAAAAAAAAAAAAAESUZEh/9oADAMBAAIRAxEAPwDte2xt40M8yOIchaugaMl4MRh0jiZzPypZPnlgvCn6GP8ASnb54usKfoY/0rwu52JymrytZxmn0I+4/SV2KwAkwx9x+lU2fL1aZGlh9nab/vhJTbSSy2wN1qb4Q3LlDQAGpxmSk1TUIQSOyHtfYa26QJnOBJDUIWZ//9k"></figure><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>send<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Send<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>timeline<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
        <span class="token comment">// 设定URL建立WebSocket连接</span>
        <span class="token keyword">var</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:25252/chat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 成功建立连接</span>
        conn<span class="token punctuation">.</span><span class="token function function-variable">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 收到消息</span>
        conn<span class="token punctuation">.</span><span class="token function function-variable">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'timeline'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">+=</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'timeline'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> <span class="token string">'&lt;br>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 连接出错</span>
        conn<span class="token punctuation">.</span><span class="token function function-variable">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'WebSocket connection error.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 断开连接</span>
        conn<span class="token punctuation">.</span><span class="token function function-variable">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'WebSocket connection closed.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 发送消息</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'send'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function function-variable">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            conn<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="编写服务端代码"><a href="#编写服务端代码" class="headerlink" title="编写服务端代码"></a>编写服务端代码</h1><p>开始编写服务端之前，需要使用 Composer 安装 Ratchet 框架：</p><pre class="line-numbers language-none"><code class="language-none">composer require cboden/ratchet<span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre><p>官方网站上提供了一个简单的<a href="http://socketo.me/docs/hello-world#logic" target="_blank" rel="noopener">例子</a>可以作为参考。首先对框架进行导入：</p><pre class="language-php line-numbers" data-language="php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">Ratchet<span class="token punctuation">\</span>MessageComponentInterface</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Ratchet<span class="token punctuation">\</span>ConnectionInterface</span><span class="token punctuation">;</span>

<span class="token keyword">require_once</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span></span></code></pre><p>整个服务端“应用”可以当成是一个基于 <code>Ratchet\MessageComponentInterface</code> 的类，和前端代码类似，只要对建立连接 <code>onOpen</code>、收到消息 <code>onMessage</code>、连接出错 <code>onError</code>、断开连接 <code>onClose</code> 这四个事件编写函数即可。</p><p>与服务端建立连接的每个客户端都被视为一个对象，这些客户端将保存在 <code>$clients</code> 中。通过每个客户端对象的 <code>send($msg)</code> 方法可以实现服务端向某一个客户端发送消息，还可以遍历 <code>$clients</code> 实现消息广播。</p><pre class="language-php line-numbers" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name class-name-definition">MyChat</span> <span class="token keyword">implements</span> <span class="token class-name">MessageComponentInterface</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用于保存客户端信息</span>
    <span class="token keyword">protected</span> <span class="token variable">$clients</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新建SplObjectStorage用于保存对象</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">clients</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>SplObjectStorage</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// $conn是要与服务端建立连接的客户端对象</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">onOpen</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ConnectionInterface</span> <span class="token variable">$conn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 向$clients添加建立连接的客户端</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">clients</span><span class="token operator">-></span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 输出提示，resourceId可以用于标识客户端</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"New connection! Id: <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$conn</span><span class="token operator">-></span><span class="token property">resourceId</span><span class="token punctuation">}</span></span>\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">onClose</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ConnectionInterface</span> <span class="token variable">$conn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将关闭连接的客户端从$clients中删除</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">clients</span><span class="token operator">-></span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Connection <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$conn</span><span class="token operator">-></span><span class="token property">resourceId</span><span class="token punctuation">}</span></span> has disconnected\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">onError</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ConnectionInterface</span> <span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token class-name class-name-fully-qualified type-declaration"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$conn</span><span class="token operator">-></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// $msg是客户端发送的数据</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">onMessage</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ConnectionInterface</span> <span class="token variable">$from</span><span class="token punctuation">,</span> <span class="token variable">$msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历所有客户端，转发消息</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">clients</span> <span class="token keyword">as</span> <span class="token variable">$client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$client</span><span class="token operator">-></span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Client <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$from</span><span class="token operator">-></span><span class="token property">resourceId</span><span class="token punctuation">}</span></span>: <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$msg</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 也可以选择不转发给发送者自己</span>
            <span class="token comment">// if ($from !== $client) {</span>
            <span class="token comment">//     $client->send("Client {$from->resourceId}: {$msg}");</span>
            <span class="token comment">// }</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Client <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$from</span><span class="token operator">-></span><span class="token property">resourceId</span><span class="token punctuation">}</span></span>: <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$msg</span><span class="token punctuation">}</span></span>\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后新建一个类 <code>Ratchet\App</code>，设定端口，将上面的应用实例化并指定地址：</p><pre class="language-php line-numbers" data-language="php"><code class="language-php"><span class="token keyword">echo</span> <span class="token string double-quoted-string">"Server is running...\n"</span><span class="token punctuation">;</span>

<span class="token comment">// 在本机的25252端口启动Ratchet应用</span>
<span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Ratchet<span class="token punctuation">\</span>App</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">25252</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Ratchet自带的测试应用，原样返回客户端发送的消息</span>
<span class="token comment">// ws://localhost:25252/echo</span>
<span class="token variable">$app</span><span class="token operator">-></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/echo'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Ratchet<span class="token punctuation">\</span>Server<span class="token punctuation">\</span>EchoServer</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 上面的留言板应用</span>
<span class="token comment">// ws://localhost:25252/chat</span>
<span class="token variable">$app</span><span class="token operator">-></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/chat'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyChat</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$app</span><span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将以上代码保存为 <code>chat.php</code>，然后使用命令行 <code>php chat.php</code> 启动服务端程序。打开网页，浏览器就可以和服务端建立 WebSocket 连接，允许在留言板上发送消息，与此同时命令行也会输出建立/中断连接的提示。按下 <kbd>Ctrl+C</kbd> 就可以终止服务端程序的运行。</p><p><video controls poster="https://ae01.alicdn.com/kf/Hfa328d9ae2bd4c1a8787de0c0eb1c94ek.jpg" preload="metadata" src="https://files.catbox.moe/098wqc.mp4"></video></p><p>客户端和服务端通过 WebSocket 协议互相发送消息，可以看出所有客户端几乎同时收到了来自服务端的消息，客户端无须像传统的轮询一样频繁发送 AJAX 请求，效率较高。</p><h1 id="使用-WSS-协议建立加密连接"><a href="#使用-WSS-协议建立加密连接" class="headerlink" title="使用 WSS 协议建立加密连接"></a>使用 WSS 协议建立加密连接</h1><p>就像 HTTP 协议和 HTTPS 协议一样，WebSocket 的 WS 协议也有对应的安全加密传输协议 WSS，而且在使用了 HTTPS 的页面上是无法使用未加密的 WebSocket 连接的。一个简单的解决方法是使用 Nginx 的<strong>反向代理</strong>，客户端在公网上发送建立 WebSocket 加密连接的请求，Nginx 在内网将请求转发给相应的 WebSocket 应用。</p><pre class="line-numbers language-none"><code class="language-none">server {
    listen 443 ssl http2;
    server_name ...;
    ssl_certificate ...;
    ssl_certificate_key ...;

    ...

    location = /chat {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://localhost:25252/chat;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用了反向代理以后，客户端就可以使用类似于 <code>wss://***.com/chat</code> 的 URL 建立加密连接了，不需要添加端口号。</p><p>由于使用了反向代理，如果需要获取客户端的 IP 地址，就得将 IP 地址写在自定义请求头（上面的例子使用的是 <code>X-Real-IP</code> 和 <code>X-Forwarded-For</code>）上。在 Ratchet 应用中也可以获取客户端建立连接时的请求头消息，例如获取 IP 就可以使用 <code>$conn->httpRequest->getHeader('X-Real-IP')[0]</code>。</p><p>另外，Ratchet 应用默认只允许来自本机的客户端（localhost）连接，<a href="http://socketo.me/docs/troubleshooting" target="_blank" rel="noopener">官方网站上的解释</a>是为了安全性，使用反向代理后也可以跳过这个限制了。</p><blockquote><p>Q: I can connect locally but not remotely or when I run on my server.<br>A: This is also another security feature! By default Ratchet binds to 127.0.0.1 which only allows connections from itself. The recommended approach is to put Ratchet behind a proxy and only that proxy (locally) will connect.<br>If you want to open Ratchet up (not behind a proxy) set the third parameter of App to ‘0.0.0.0’.</p></blockquote><h1 id="定时执行垃圾回收"><a href="#定时执行垃圾回收" class="headerlink" title="定时执行垃圾回收"></a>定时执行垃圾回收</h1><p>Ratchet 使用 <a href="https://www.php.net/manual/zh/class.splobjectstorage.php" target="_blank" rel="noopener"><code>SplObjectStorage</code></a> 保存与服务端建立连接的客户端对象，通过 <code>attach()</code> 和 <code>detach()</code> 方法添加和删除，但这种方法存在<strong>内存泄漏</strong>问题，需要定期执行 <code>gc_collect_cycles()</code> 进行垃圾回收。</p><p>Ratchet 允许在创建应用时使用自定义的事件循环，在循环中自行加入定期执行的函数。</p><pre class="language-php line-numbers" data-language="php"><code class="language-php"><span class="token comment">// 新建事件循环</span>
<span class="token variable">$loop</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context">React<span class="token punctuation">\</span>EventLoop<span class="token punctuation">\</span>Factory</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 每分钟进行一次垃圾回收，并在控制台输出内存占用</span>
<span class="token variable">$loop</span><span class="token operator">-></span><span class="token function">addPeriodicTimer</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$memory_before</span> <span class="token operator">=</span> <span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gc_collect_cycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$memory_now</span> <span class="token operator">=</span> <span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$memory_before</span> <span class="token operator">!==</span> <span class="token variable">$memory_now</span><span class="token punctuation">)</span> <span class="token keyword">echo</span> <span class="token string double-quoted-string">"GC Collected: <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$memory_before</span><span class="token punctuation">}</span></span> bytes -> <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$memory_now</span><span class="token punctuation">}</span></span> bytes\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用自定义的事件循环创建应用</span>
<span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Ratchet<span class="token punctuation">\</span>App</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">25252</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token variable">$loop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="用-AJAX-发送请求，用-WebSocket-推送消息"><a href="#用-AJAX-发送请求，用-WebSocket-推送消息" class="headerlink" title="用 AJAX 发送请求，用 WebSocket 推送消息"></a>用 AJAX 发送请求，用 WebSocket 推送消息</h1><p>WebSocket 本身支持发送/接收纯文本或二进制数据，因此直接发送图片之类的东西也是没关系的～</p><p>但是有的时候又要发送文本又要发送二进制数据（比如做留言板的时候，有同时发送文本和图片的需求），这个时候就需要多折腾一下了……</p><p>常规的使用 POST 上传文件使用的 <code>multipart/form-data</code> 格式，实际发送的数据类似于这样：</p><pre class="line-numbers language-none"><code class="language-none">-----------------------------18467633426500
Content-Disposition: form-data; name="smfile"; filename="untitled.png"
Content-Type: image/png

（二进制数据）
-----------------------------18467633426500
Content-Disposition: form-data; name="file_id"

0
-----------------------------18467633426500--<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>发送的数据被“分割线”分割为多个部分，每个部分可以是文本或二进制数据，互不影响，服务端也很容易从中解析出不同部分的数据。如果造轮子在前端用 WebSocket 发送这种格式的数据，在服务端再自己造轮子进行解析，似乎也不是不可以……那为什么不直接使用 POST 方式发送数据呢？而且还可以继续使用 PHP 的 Session 机制保存用户状态。</p><p>原来的结构是客户端<strong>直接使用 WebSocket 向服务端发送数据</strong>，现在的结构就变成了客户端先<strong>使用 POST 向服务端的 <code>post.php</code> 发送数据</strong>，然后 <code>post.php</code> 在内网对消息进行处理后再向 WebSocket 应用发送用于推送的消息（这时已经可以使用纯文本了，例如包含了图片 URL 的 JSON 格式数据），客户端与服务端建立的 WebSocket 连接<strong>只用于接收推送消息</strong>。</p><p>由于客户端与服务端建立 WebSocket 连接必须经过 Nginx 的反向代理并添加上 <code>X-Real-IP</code> 之类的请求头，而从内网（例如 <code>post.php</code>）建立的连接无须经过反向代理，因此可以通过请求头判断发送给服务端的数据是否来自内网，防止客户端直接控制 WebSocket 应用推送任意消息。</p><p><a href="https://github.com/ratchetphp/Pawl" target="_blank" rel="noopener">Pawl</a> 是 Ratchet 框架的一个子项目，可以在 PHP 代码中使用 WebSocket 客户端的功能。使用 Pawl 就可以实现“从内网向 WebSocket 应用发送数据”，例如在 <code>post.php</code> 中可以写入以下代码（未包括处理图片部分，仅演示处理使用 POST 发送的数据）：</p><pre class="language-php line-numbers" data-language="php"><code class="language-php"><span class="token keyword">require_once</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">;</span>

<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 发送的内容不能为空</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 根据Session为新用户指定随机的ID</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'userid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'userid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 要发送给服务端的数据</span>
<span class="token variable">$send</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'userid'</span> <span class="token operator">=></span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'userid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'content'</span> <span class="token operator">=></span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'timestamp'</span> <span class="token operator">=></span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 向本机的 WebSocket 推送应用发送数据，这个写法有点类似于JS的Promise</span>
<span class="token comment">// 两个函数分别是与服务端连接成功或失败后执行的函数</span>
<span class="token function">Ratchet<span class="token punctuation">\</span>Client<span class="token punctuation">\</span>connect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ws://localhost:25252/push_server'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$send</span><span class="token punctuation">;</span>
        <span class="token variable">$conn</span><span class="token operator">-></span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$send</span><span class="token punctuation">,</span> <span class="token constant">JSON_UNESCAPED_UNICODE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$conn</span><span class="token operator">-></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Could not connect: <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n"</span><span class="token punctuation">;</span>
        <span class="token function">http_response_code</span><span class="token punctuation">(</span><span class="token number">503</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对应的 WebSocket 服务端代码：</p><pre class="language-php line-numbers" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">onMessage</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ConnectionInterface</span> <span class="token variable">$from</span><span class="token punctuation">,</span> <span class="token variable">$msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只接收未经过反向代理的，来自内网的客户端发送的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$from</span><span class="token operator">-></span><span class="token property">httpRequest</span><span class="token operator">-></span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'X-Real-IP'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">clients</span> <span class="token keyword">as</span> <span class="token variable">$client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$client</span><span class="token operator">-></span><span class="token function">send</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最终的效果演示：</p><p><video controls poster="https://ae01.alicdn.com/kf/H45cf4f763ccd40c880e89242a1d7f41cH.jpg" preload="metadata" src="https://files.catbox.moe/5hkb7q.mp4"></video></p><blockquote class="mdui-m-b-0 mdui-m-x-0 mdui-p-y-1" style="border-left:4px solid rgba(0,0,0,.36)"><strong>本作品采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。</strong><br><strong>本文作者：✨小透明・宸✨</strong><br><strong>本文链接：<a href="https://akarin.dev/2020/01/10/php-websocket-server/">https://akarin.dev/2020/01/10/php-websocket-server/</a></strong></blockquote></article><div class="mdui-p-a-3 mdui-color-white" id="lv-container" data-id="city" data-uid="MTAyMC80NDUwOC8yMTAzOQ=="><script>(()=>{const e=document.createElement("script");e.src="https://cdn-city.livere.com/js/embed.dist.js",e.async=!0,document.body.appendChild(e)})()</script></div></div><div class="mdui-valign mdui-m-t-2"><a href="../../../02/07/alicdn-video-hosting/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_left</i> </a><span class="mdui-typo-body-1-opacity mdui-text-left mdui-m-l-1" title="搞事情：用“图床”传视频，自带免费 CDN 加速（已失效，科普向）">上一篇</span> <span class="mdui-typo-body-1-opacity mdui-text-center" style="flex-grow:1"></span> <span class="mdui-typo-body-1-opacity mdui-text-right mdui-m-r-1" title="使用 waifu2x-caffe 和 ImageMagick 放大 GIF 动图">下一篇</span> <a href="../../../../2019/11/23/powershell-waifu2xgif/" class="mdui-ripple mdui-btn mdui-btn-icon"><i class="material-icons mdui-icon">chevron_right</i></a></div></main><footer class="mdui-container mdui-m-y-5 mdui-typo" style="display:flex;max-width:1024px"><div class="mdui-typo-body-1-opacity mdui-text-left">Copyright © 2023 ✨小透明・宸✨<br>Hosted by <a href="https://github.com/TransparentLC/transparentlc.github.io" target="_blank">Github Pages</a></div><div style="flex-grow:1"></div><div class="mdui-typo-body-1-opacity mdui-text-right">Powered by <a href="https://hexo.io" target="_blank">Hexo</a> <span class="mdui-hidden-xs-down">6.3.0</span><br>Theme - <a href="https://github.com/TransparentLC/hexo-theme-akarin" target="_blank">Akarin</a></div></footer><script src="https://gcore.jsdelivr.net/combine/gh/TransparentLC/transparentlc.github.io/js/mdui.min.js,npm/medium-zoom@1/dist/medium-zoom.min.js,npm/instant.page@5/instantpage.min.js,npm/aplayer@1/dist/APlayer.min.js,gh/TransparentLC/transparentlc.github.io@879beec/js/script.min.js"></script><script src="https://gcore.jsdelivr.net/gh/TransparentLC/transparentlc.github.io/js/bsz.min.js" async></script></body></html>